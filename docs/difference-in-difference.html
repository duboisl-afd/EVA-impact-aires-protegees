<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 5 Difference-in-difference | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 5 Difference-in-difference | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="vuillota/EVA-impact-aires-protegees.git" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 5 Difference-in-difference | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Antoine Vuillot" />
<meta name="author" content="Ingrid Dallmann" />
<meta name="author" content="Léa Poulin" />
<meta name="author" content="Pierre-Yves Durand" />


<meta name="date" content="2023-11-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="matching.html"/>
<link rel="next" href="references.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Impact analysis of protected areas funded by the AFD</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this website</a></li>
<li class="chapter" data-level="1" data-path="building-the-datasets.html"><a href="building-the-datasets.html"><i class="fa fa-check"></i><b>1</b> Building the datasets</a>
<ul>
<li class="chapter" data-level="1.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#initial-settings"><i class="fa fa-check"></i><b>1.1</b> Initial settings</a></li>
<li class="chapter" data-level="1.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-analysis"><i class="fa fa-check"></i><b>1.2</b> Datasets for analysis</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-pas-reporting-by-afd-technical-departments"><i class="fa fa-check"></i><b>1.2.1</b> Merge PAs reporting by AFD technical departments</a></li>
<li class="chapter" data-level="1.2.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-the-list-of-pas-to-afd-project-information-and-wdpa"><i class="fa fa-check"></i><b>1.2.2</b> Merge the list of PAs to AFD project information and WDPA</a></li>
<li class="chapter" data-level="1.2.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#correct-errors"><i class="fa fa-check"></i><b>1.2.3</b> Correct errors</a></li>
<li class="chapter" data-level="1.2.4" data-path="building-the-datasets.html"><a href="building-the-datasets.html#tidy-the-datasets"><i class="fa fa-check"></i><b>1.2.4</b> Tidy the datasets</a></li>
<li class="chapter" data-level="1.2.5" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-with-only-afd-project-variables"><i class="fa fa-check"></i><b>1.2.5</b> Dataset with only AFD project variables</a></li>
<li class="chapter" data-level="1.2.6" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-for-non-confidential-analysis"><i class="fa fa-check"></i><b>1.2.6</b> Dataset for non-confidential analysis</a></li>
<li class="chapter" data-level="1.2.7" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-confidential-analysis"><i class="fa fa-check"></i><b>1.2.7</b> Datasets for confidential analysis</a></li>
<li class="chapter" data-level="1.2.8" data-path="building-the-datasets.html"><a href="building-the-datasets.html#a-polygon-dataset-for-specific-use"><i class="fa fa-check"></i><b>1.2.8</b> A polygon dataset for specific use</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-covered-by-pas-in-the-sample"><i class="fa fa-check"></i><b>1.3</b> Computing total areas covered by PAs in the sample</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computations-of-polygons-area"><i class="fa fa-check"></i><b>1.3.1</b> Computations of polygons’ area</a></li>
<li class="chapter" data-level="1.3.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-the-intersection-at-country-region-world-level"><i class="fa fa-check"></i><b>1.3.2</b> Computing the intersection at country, region, world level</a></li>
<li class="chapter" data-level="1.3.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-without-intersection"><i class="fa fa-check"></i><b>1.3.3</b> Computing total areas without intersection</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Descriptive statistics</b></span></li>
<li class="chapter" data-level="2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html"><i class="fa fa-check"></i><b>2</b> Projects funded by the AFD</a>
<ul>
<li class="chapter" data-level="2.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#initial-settings-1"><i class="fa fa-check"></i><b>2.1</b> Initial settings</a></li>
<li class="chapter" data-level="2.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#importing-the-datasets"><i class="fa fa-check"></i><b>2.2</b> Importing the datasets</a></li>
<li class="chapter" data-level="2.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#performing-descriptive-statistics"><i class="fa fa-check"></i><b>2.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#iucn-categories"><i class="fa fa-check"></i><b>2.3.1</b> IUCN categories</a></li>
<li class="chapter" data-level="2.3.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#ecosystems-excluding-non-referenced-pas"><i class="fa fa-check"></i><b>2.3.2</b> Ecosystems (excluding non-referenced PAs)</a></li>
<li class="chapter" data-level="2.3.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#distribution-and-surface-of-pas-across-countries-and-regions"><i class="fa fa-check"></i><b>2.3.3</b> Distribution (# and surface) of PAs across countries and regions</a></li>
<li class="chapter" data-level="2.3.4" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#surface-of-pas"><i class="fa fa-check"></i><b>2.3.4</b> Surface of PAs</a></li>
<li class="chapter" data-level="2.3.5" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#temporal-evolution"><i class="fa fa-check"></i><b>2.3.5</b> Temporal evolution</a></li>
<li class="chapter" data-level="2.3.6" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#governance"><i class="fa fa-check"></i><b>2.3.6</b> Governance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html"><i class="fa fa-check"></i><b>3</b> Miscellaneous statistics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#initial-settings-2"><i class="fa fa-check"></i><b>3.1</b> Initial settings</a></li>
<li class="chapter" data-level="3.2" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#importing-datasets"><i class="fa fa-check"></i><b>3.2</b> Importing datasets</a></li>
<li class="chapter" data-level="3.3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#performing-descriptive-statistics-1"><i class="fa fa-check"></i><b>3.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#pa-of-interest-other-pa-and-all-pa-in-a-given-sample"><i class="fa fa-check"></i><b>3.3.1</b> PA of interest, other PA and all PA in a given sample</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-tree-cover-and-deforestation"><i class="fa fa-check"></i><b>3.4</b> Evolution of tree cover and deforestation</a></li>
<li class="chapter" data-level="3.5" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#forest-cover-by-country"><i class="fa fa-check"></i><b>3.5</b> Forest cover by country</a></li>
<li class="chapter" data-level="3.6" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-sample"><i class="fa fa-check"></i><b>3.6</b> Mapping of sample</a></li>
<li class="chapter" data-level="3.7" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-results"><i class="fa fa-check"></i><b>3.7</b> Mapping of results</a></li>
<li class="chapter" data-level="3.8" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-forest-cover-for-specific-polygons"><i class="fa fa-check"></i><b>3.8</b> Evolution of forest cover for specific polygons</a></li>
</ul></li>
<li class="part"><span><b>Impact analysis</b></span></li>
<li class="chapter" data-level="4" data-path="matching.html"><a href="matching.html"><i class="fa fa-check"></i><b>4</b> Matching</a>
<ul>
<li class="chapter" data-level="4.1" data-path="matching.html"><a href="matching.html#initial-settings-3"><i class="fa fa-check"></i><b>4.1</b> Initial settings</a></li>
<li class="chapter" data-level="4.2" data-path="matching.html"><a href="matching.html#datasets-and-critical-parameters"><i class="fa fa-check"></i><b>4.2</b> Datasets and critical parameters</a></li>
<li class="chapter" data-level="4.3" data-path="matching.html"><a href="matching.html#matching-process"><i class="fa fa-check"></i><b>4.3</b> Matching process</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="difference-in-difference.html"><a href="difference-in-difference.html"><i class="fa fa-check"></i><b>5</b> Difference-in-difference</a>
<ul>
<li class="chapter" data-level="5.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#initial-settings-4"><i class="fa fa-check"></i><b>5.1</b> Initial settings</a></li>
<li class="chapter" data-level="5.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#load-datasets-and-define-critical-parameters"><i class="fa fa-check"></i><b>5.2</b> Load datasets and define critical parameters</a></li>
<li class="chapter" data-level="5.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#computing-treatment-effects-at-protected-area-level"><i class="fa fa-check"></i><b>5.3</b> Computing treatment effects at protected area level</a></li>
<li class="chapter" data-level="5.4" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-quality-of-matching-and-pre-test"><i class="fa fa-check"></i><b>5.4</b> Assess the quality of matching and pre-test</a></li>
<li class="chapter" data-level="5.5" data-path="difference-in-difference.html"><a href="difference-in-difference.html#tidy-datasets-with-acceptable-quality"><i class="fa fa-check"></i><b>5.5</b> Tidy datasets with acceptable quality</a></li>
<li class="chapter" data-level="5.6" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-loss-of-observations"><i class="fa fa-check"></i><b>5.6</b> Assess the loss of observations</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-overlap-removal"><i class="fa fa-check"></i><b>5.6.1</b> Compute overlap removal</a></li>
<li class="chapter" data-level="5.6.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-losses-for-each-steps"><i class="fa fa-check"></i><b>5.6.2</b> Compute losses for each steps</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-aggregated-metrics-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7</b> Compute aggregated metrics at country and region level</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-treatment-effects"><i class="fa fa-check"></i><b>5.7.1</b> Aggregation of treatment effects</a></li>
<li class="chapter" data-level="5.7.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-annual-deforestation-rates"><i class="fa fa-check"></i><b>5.7.2</b> Aggregation of annual deforestation rates</a></li>
<li class="chapter" data-level="5.7.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#average-and-total-forest-loss-on-the-period-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7.3</b> Average and total forest loss on the period, at country and region level</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="difference-in-difference.html"><a href="difference-in-difference.html#display-treatment-effects"><i class="fa fa-check"></i><b>5.8</b> Display treatment effects</a></li>
<li class="chapter" data-level="5.9" data-path="difference-in-difference.html"><a href="difference-in-difference.html#in-figures-and-tables"><i class="fa fa-check"></i><b>5.9</b> In figures and tables</a>
<ul>
<li class="chapter" data-level="5.9.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#on-a-map"><i class="fa fa-check"></i><b>5.9.1</b> On a map</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="functions-for-matching-pre--and-post-processing.html"><a href="functions-for-matching-pre--and-post-processing.html"><i class="fa fa-check"></i><b>A</b> Functions for matching pre- and post-processing</a></li>
<li class="chapter" data-level="B" data-path="functions-for-difference-in-difference-computations.html"><a href="functions-for-difference-in-difference-computations.html"><i class="fa fa-check"></i><b>B</b> Functions for difference-in-difference computations</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="difference-in-difference" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">Section 5</span> Difference-in-difference<a href="difference-in-difference.html#difference-in-difference" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this script are performed the last steps of the analysis. Using the datasets of matched treated and control units, it is possible to compute the effect of the conservation for each protected area. Then these results can be aggregated at country and region level. Some secondary metrics are also computed : the annual deforestation rates faced by treated and control units, before and after treatment (à la Wolf et al. 2021); the total and average forest loss across groups of protected areas on the period considered, compared to the value in control units, before and after matching.</p>
<p>The process consists of the following steps.</p>
<ol style="list-style-type: decimal">
<li><p>For a given country, load the list of protected areas whose observational units (treated pixels composing this area) have been matched to control units.</p></li>
<li><p>For each protected area in this list :</p>
<ol style="list-style-type: decimal">
<li><p>Compute annual deforestation rates : before and after treatment for treated units, on the whole period for control units.</p></li>
<li><p>Compute treatment effect from matched treated and control pixels. Note that two functions exist depending on the portfolio analyzed : for AFD supported protected areas, funding-related information are added to the analysis (e.g year of funding). For the others, a general script is used.</p></li>
<li><p>Compute treatment effect for unmatched treated and control pixels. This can be useful to assess the bias induced by the selection into treatment. In other words, the bias due to not using matching. Indeed protected areas tend to be located in region less prone to deforestation (e.g further away from cities or roads). Simply using non-protected areas as a counterfactual, without matching, would then overestimate the effect of the conservation program. Note that this step can be time and computationally intensive, because the number of unmatched units is higher than the number of matched ones. It is usually skipped.</p></li>
<li><p>Plot the total area deforested on the period considered, in the protected area and its counterfactual, before and after matching. This is useful to illustrate the bias described above. Note that ideally the deforestation estimated in the protected area before and after matching should be the same. If note, the matched treated units are not representative of the overall protected area and the a local treatment effect will be estimated.</p></li>
<li><p>The treatment effects, pre-tests, annual deforestation rates and estimations of total deforested area computed for each protected areas are gathered in specific datasets. This makes it possible to compute metrics aggregated at country and region level. These datastes are saved to the storage, for each country and for all countries.</p></li>
</ol></li>
<li><p>Assess the quality of matching (for matched control and treated pixels, for matched and unmatched treated pixels) pre-test for all PA. Define non-academic and academic filtering to remove results of some PA potentially.</p></li>
<li><p>Assess the loss of observations on the whole data-processing : during pre-processing (due to filtering of PA we cannot analyse, overlap removal): post-processing (typically matching step) and DiD steps.</p></li>
<li><p>Results of the analysis at protected area level are aggregated at country and region level.</p></li>
<li><p>Finally, figures and tables are created to display the results.</p></li>
</ol>
<p>The methodology is not extensively described here to keep the documentation concise. The interested reader can refer to the working paper for more details.</p>
<div id="initial-settings-4" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> Initial settings<a href="difference-in-difference.html#initial-settings-4" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Configuring the Rmarkdown.</p>
<p>Downloading and importing relevant packages.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="difference-in-difference.html#cb134-1" tabindex="-1"></a><span class="co">#Install some libraries</span></span>
<span id="cb134-2"><a href="difference-in-difference.html#cb134-2" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;tictoc&quot;</span>, <span class="st">&quot;fixest&quot;</span>, <span class="st">&quot;cobalt&quot;</span>, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;progressr&quot;</span>, <span class="st">&quot;did&quot;</span>, <span class="st">&quot;latex2exp&quot;</span>, <span class="st">&quot;janitor&quot;</span>, <span class="st">&quot;stringi&quot;</span>))</span>
<span id="cb134-3"><a href="difference-in-difference.html#cb134-3" tabindex="-1"></a></span>
<span id="cb134-4"><a href="difference-in-difference.html#cb134-4" tabindex="-1"></a><span class="co"># Load Libraries</span></span>
<span id="cb134-5"><a href="difference-in-difference.html#cb134-5" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb134-6"><a href="difference-in-difference.html#cb134-6" tabindex="-1"></a><span class="fu">library</span>(stringi)</span>
<span id="cb134-7"><a href="difference-in-difference.html#cb134-7" tabindex="-1"></a><span class="fu">library</span>(tictoc) <span class="co">#For timing</span></span>
<span id="cb134-8"><a href="difference-in-difference.html#cb134-8" tabindex="-1"></a><span class="fu">library</span>(xtable)</span>
<span id="cb134-9"><a href="difference-in-difference.html#cb134-9" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb134-10"><a href="difference-in-difference.html#cb134-10" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb134-11"><a href="difference-in-difference.html#cb134-11" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># For plotting</span></span>
<span id="cb134-12"><a href="difference-in-difference.html#cb134-12" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb134-13"><a href="difference-in-difference.html#cb134-13" tabindex="-1"></a><span class="fu">library</span>(ggrepel)</span>
<span id="cb134-14"><a href="difference-in-difference.html#cb134-14" tabindex="-1"></a><span class="fu">library</span>(aws.s3)</span>
<span id="cb134-15"><a href="difference-in-difference.html#cb134-15" tabindex="-1"></a><span class="fu">library</span>(fixest) <span class="co">#For estimating the models</span></span>
<span id="cb134-16"><a href="difference-in-difference.html#cb134-16" tabindex="-1"></a><span class="fu">library</span>(did)</span>
<span id="cb134-17"><a href="difference-in-difference.html#cb134-17" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb134-18"><a href="difference-in-difference.html#cb134-18" tabindex="-1"></a><span class="fu">library</span>(janitor)</span></code></pre></div>
<p>To keep this document concise, each step calls a function defined in a R script. Interested reader can delve deeper into the data processing by looking at this script. The following chunk load the functions in the workspace.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="difference-in-difference.html#cb135-1" tabindex="-1"></a><span class="co">#Import functions</span></span>
<span id="cb135-2"><a href="difference-in-difference.html#cb135-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;scripts/functions/02_fns_did.R&quot;</span>)</span></code></pre></div>
</div>
<div id="load-datasets-and-define-critical-parameters" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Load datasets and define critical parameters<a href="difference-in-difference.html#load-datasets-and-define-critical-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="difference-in-difference.html#cb136-1" tabindex="-1"></a><span class="co">#Define working directories</span></span>
<span id="cb136-2"><a href="difference-in-difference.html#cb136-2" tabindex="-1"></a><span class="do">##Temporary directory</span></span>
<span id="cb136-3"><a href="difference-in-difference.html#cb136-3" tabindex="-1"></a>tmp_did <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;did&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb136-4"><a href="difference-in-difference.html#cb136-4" tabindex="-1"></a><span class="do">##Loading and saving directories on the storage. This is either define on today&#39;s date, or by a user-defined date. Loadin directory corresponds to the output of 02_matching.Rmd.</span></span>
<span id="cb136-5"><a href="difference-in-difference.html#cb136-5" tabindex="-1"></a><span class="co">#load_dir = paste(&quot;impact_analysis/matching&quot;, Sys.Date(), sep = &quot;/&quot;)</span></span>
<span id="cb136-6"><a href="difference-in-difference.html#cb136-6" tabindex="-1"></a>load_dir <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;impact_analysis/matching&quot;</span>, <span class="st">&quot;2023-11-22_PYD&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb136-7"><a href="difference-in-difference.html#cb136-7" tabindex="-1"></a><span class="co">#save_dir = paste(&quot;impact_analysis/did&quot;, Sys.Date(), sep = &quot;/&quot;)</span></span>
<span id="cb136-8"><a href="difference-in-difference.html#cb136-8" tabindex="-1"></a>save_dir <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;impact_analysis/did&quot;</span>, <span class="st">&quot;2023-11-22_PYD&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb136-9"><a href="difference-in-difference.html#cb136-9" tabindex="-1"></a></span>
<span id="cb136-10"><a href="difference-in-difference.html#cb136-10" tabindex="-1"></a><span class="do">## Dataset specific to the PAs portfolio to analyze. Only one is selected depending on the analysis one wants to perform. </span></span>
<span id="cb136-11"><a href="difference-in-difference.html#cb136-11" tabindex="-1"></a></span>
<span id="cb136-12"><a href="difference-in-difference.html#cb136-12" tabindex="-1"></a><span class="do">## AFD portfolio</span></span>
<span id="cb136-13"><a href="difference-in-difference.html#cb136-13" tabindex="-1"></a><span class="co"># data_pa =</span></span>
<span id="cb136-14"><a href="difference-in-difference.html#cb136-14" tabindex="-1"></a><span class="co">#   #fread(&quot;data_tidy/BDD_PA_AFD_ie.csv&quot; , encoding = &quot;UTF-8&quot;)</span></span>
<span id="cb136-15"><a href="difference-in-difference.html#cb136-15" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb136-16"><a href="difference-in-difference.html#cb136-16" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb136-17"><a href="difference-in-difference.html#cb136-17" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb136-18"><a href="difference-in-difference.html#cb136-18" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_AFD_ie.csv&quot;,</span></span>
<span id="cb136-19"><a href="difference-in-difference.html#cb136-19" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb136-20"><a href="difference-in-difference.html#cb136-20" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;)) %&gt;%</span></span>
<span id="cb136-21"><a href="difference-in-difference.html#cb136-21" tabindex="-1"></a><span class="co">#   #Sangha trinational (555547988) created in 2012 actually gathers three former PAs</span></span>
<span id="cb136-22"><a href="difference-in-difference.html#cb136-22" tabindex="-1"></a><span class="co">#   #in CAF (31458), CMR (1245) and COG (72332) implemented in</span></span>
<span id="cb136-23"><a href="difference-in-difference.html#cb136-23" tabindex="-1"></a><span class="co">#   #1990, 2001 and 1993 respectively.</span></span>
<span id="cb136-24"><a href="difference-in-difference.html#cb136-24" tabindex="-1"></a><span class="co">#   # Evaluating the trinational PA is not relevant here : our method relies on pre-treatment obervsations (for matching and DiD) and the outcome is likely to be affected by the initial PAs. On the other hand, evaluating the three earlier PAs might be irrelevant for us : are they funded by the AFD ?? In a first approach, the trinational is removed.</span></span>
<span id="cb136-25"><a href="difference-in-difference.html#cb136-25" tabindex="-1"></a><span class="co">#   filter(is.na(wdpaid) == TRUE | wdpaid != 555547988)</span></span>
<span id="cb136-26"><a href="difference-in-difference.html#cb136-26" tabindex="-1"></a></span>
<span id="cb136-27"><a href="difference-in-difference.html#cb136-27" tabindex="-1"></a><span class="do">##FAPBM</span></span>
<span id="cb136-28"><a href="difference-in-difference.html#cb136-28" tabindex="-1"></a><span class="co"># data_fapbm =</span></span>
<span id="cb136-29"><a href="difference-in-difference.html#cb136-29" tabindex="-1"></a><span class="co">#   #fread(&quot;data_tidy/BDD_PA_AFD_ie.csv&quot; , encoding = &quot;UTF-8&quot;)</span></span>
<span id="cb136-30"><a href="difference-in-difference.html#cb136-30" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb136-31"><a href="difference-in-difference.html#cb136-31" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb136-32"><a href="difference-in-difference.html#cb136-32" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb136-33"><a href="difference-in-difference.html#cb136-33" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_FAPBM.csv&quot;,</span></span>
<span id="cb136-34"><a href="difference-in-difference.html#cb136-34" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb136-35"><a href="difference-in-difference.html#cb136-35" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;))</span></span>
<span id="cb136-36"><a href="difference-in-difference.html#cb136-36" tabindex="-1"></a></span>
<span id="cb136-37"><a href="difference-in-difference.html#cb136-37" tabindex="-1"></a><span class="do">##Madagascar (all PAs)</span></span>
<span id="cb136-38"><a href="difference-in-difference.html#cb136-38" tabindex="-1"></a><span class="co"># data_pa =</span></span>
<span id="cb136-39"><a href="difference-in-difference.html#cb136-39" tabindex="-1"></a><span class="co">#   #fread(&quot;data_tidy/BDD_PA_AFD_ie.csv&quot; , encoding = &quot;UTF-8&quot;)</span></span>
<span id="cb136-40"><a href="difference-in-difference.html#cb136-40" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb136-41"><a href="difference-in-difference.html#cb136-41" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb136-42"><a href="difference-in-difference.html#cb136-42" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb136-43"><a href="difference-in-difference.html#cb136-43" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_MDG.csv&quot;,</span></span>
<span id="cb136-44"><a href="difference-in-difference.html#cb136-44" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb136-45"><a href="difference-in-difference.html#cb136-45" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;))</span></span>
<span id="cb136-46"><a href="difference-in-difference.html#cb136-46" tabindex="-1"></a></span>
<span id="cb136-47"><a href="difference-in-difference.html#cb136-47" tabindex="-1"></a><span class="co"># All PAs in Africa</span></span>
<span id="cb136-48"><a href="difference-in-difference.html#cb136-48" tabindex="-1"></a>data_pa <span class="ot">=</span></span>
<span id="cb136-49"><a href="difference-in-difference.html#cb136-49" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb136-50"><a href="difference-in-difference.html#cb136-50" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb136-51"><a href="difference-in-difference.html#cb136-51" tabindex="-1"></a>  <span class="at">encoding =</span> <span class="st">&quot;UTF-8&quot;</span>,</span>
<span id="cb136-52"><a href="difference-in-difference.html#cb136-52" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">&quot;data_tidy/BDD_PA_africa.csv&quot;</span>,</span>
<span id="cb136-53"><a href="difference-in-difference.html#cb136-53" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb136-54"><a href="difference-in-difference.html#cb136-54" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb136-55"><a href="difference-in-difference.html#cb136-55" tabindex="-1"></a></span>
<span id="cb136-56"><a href="difference-in-difference.html#cb136-56" tabindex="-1"></a></span>
<span id="cb136-57"><a href="difference-in-difference.html#cb136-57" tabindex="-1"></a><span class="co">#Specify the period of study to create the mapme.bidiversity portfolio</span></span>
<span id="cb136-58"><a href="difference-in-difference.html#cb136-58" tabindex="-1"></a><span class="do">## Start year</span></span>
<span id="cb136-59"><a href="difference-in-difference.html#cb136-59" tabindex="-1"></a>yr_first <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb136-60"><a href="difference-in-difference.html#cb136-60" tabindex="-1"></a><span class="do">## End year</span></span>
<span id="cb136-61"><a href="difference-in-difference.html#cb136-61" tabindex="-1"></a>yr_last <span class="ot">=</span> <span class="dv">2021</span></span>
<span id="cb136-62"><a href="difference-in-difference.html#cb136-62" tabindex="-1"></a><span class="do">## Year to start analysis</span></span>
<span id="cb136-63"><a href="difference-in-difference.html#cb136-63" tabindex="-1"></a>yr_min <span class="ot">=</span> yr_first <span class="sc">+</span> <span class="dv">2</span></span>
<span id="cb136-64"><a href="difference-in-difference.html#cb136-64" tabindex="-1"></a></span>
<span id="cb136-65"><a href="difference-in-difference.html#cb136-65" tabindex="-1"></a><span class="co">#Specify the margin of error to define confidence interval (0.05 corresponds 95% confidence interval).</span></span>
<span id="cb136-66"><a href="difference-in-difference.html#cb136-66" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fl">0.1</span> <span class="co">#09/11/2023 : changed to 90% confidence intervals</span></span>
<span id="cb136-67"><a href="difference-in-difference.html#cb136-67" tabindex="-1"></a></span>
<span id="cb136-68"><a href="difference-in-difference.html#cb136-68" tabindex="-1"></a><span class="co"># Criteria to assess matching quality</span></span>
<span id="cb136-69"><a href="difference-in-difference.html#cb136-69" tabindex="-1"></a><span class="do">## Standardized absolte mean difference : threshold</span></span>
<span id="cb136-70"><a href="difference-in-difference.html#cb136-70" tabindex="-1"></a>th_mean <span class="ot">=</span> <span class="fl">0.25</span> <span class="co">#Used in conservation science, see Desbureaux 2021 for instance</span></span>
<span id="cb136-71"><a href="difference-in-difference.html#cb136-71" tabindex="-1"></a><span class="do">## Variance ratio : thresholds</span></span>
<span id="cb136-72"><a href="difference-in-difference.html#cb136-72" tabindex="-1"></a>th_var_min <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb136-73"><a href="difference-in-difference.html#cb136-73" tabindex="-1"></a>th_var_max <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb136-74"><a href="difference-in-difference.html#cb136-74" tabindex="-1"></a></span>
<span id="cb136-75"><a href="difference-in-difference.html#cb136-75" tabindex="-1"></a><span class="co"># The list of countries (ISO3 codes) to analyze. This can be define manually or from the the dataset loaded.</span></span>
<span id="cb136-76"><a href="difference-in-difference.html#cb136-76" tabindex="-1"></a><span class="do">##List of African countries in the sample that have at least one PA supported by the AFD we can analyse</span></span>
<span id="cb136-77"><a href="difference-in-difference.html#cb136-77" tabindex="-1"></a><span class="co"># data_pa_ie = data_pa %&gt;%</span></span>
<span id="cb136-78"><a href="difference-in-difference.html#cb136-78" tabindex="-1"></a><span class="co">#   filter(region == &quot;Africa&quot; &amp; is.na(wdpaid) == FALSE &amp; area_km2 &gt;=1 &amp; marine %in% c(0,1) &amp; status_yr &gt;= yr_min)</span></span>
<span id="cb136-79"><a href="difference-in-difference.html#cb136-79" tabindex="-1"></a><span class="co"># data_pa_ie_focus = data_pa %&gt;%</span></span>
<span id="cb136-80"><a href="difference-in-difference.html#cb136-80" tabindex="-1"></a><span class="co">#   filter(region == &quot;Africa&quot; &amp; is.na(wdpaid) == FALSE &amp; area_km2 &gt;=1 &amp; marine %in% c(0,1) &amp; status_yr &gt;= yr_min &amp; focus == T)</span></span>
<span id="cb136-81"><a href="difference-in-difference.html#cb136-81" tabindex="-1"></a><span class="co"># list_iso_ie_focus = unique(data_pa_ie_focus$iso3)</span></span>
<span id="cb136-82"><a href="difference-in-difference.html#cb136-82" tabindex="-1"></a><span class="co"># list_pa_ie_focus = unique(data_pa_ie_focus$wdpaid)</span></span>
<span id="cb136-83"><a href="difference-in-difference.html#cb136-83" tabindex="-1"></a><span class="co">#list_iso = list_iso_ie_focus</span></span>
<span id="cb136-84"><a href="difference-in-difference.html#cb136-84" tabindex="-1"></a><span class="do">##Manual definition</span></span>
<span id="cb136-85"><a href="difference-in-difference.html#cb136-85" tabindex="-1"></a>list_iso <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;COM&quot;</span>,  <span class="st">&quot;GNB&quot;</span>)</span>
<span id="cb136-86"><a href="difference-in-difference.html#cb136-86" tabindex="-1"></a>list_iso_ie_focus <span class="ot">=</span> list_iso</span>
<span id="cb136-87"><a href="difference-in-difference.html#cb136-87" tabindex="-1"></a></span>
<span id="cb136-88"><a href="difference-in-difference.html#cb136-88" tabindex="-1"></a></span>
<span id="cb136-89"><a href="difference-in-difference.html#cb136-89" tabindex="-1"></a><span class="do">## Information on funding from AFD internal datasets, on AFD funded projects related to protected areas.</span></span>
<span id="cb136-90"><a href="difference-in-difference.html#cb136-90" tabindex="-1"></a>data_fund <span class="ot">=</span> </span>
<span id="cb136-91"><a href="difference-in-difference.html#cb136-91" tabindex="-1"></a>  <span class="co">#fread(&quot;data_tidy/BDD_PA_AFD_fund.csv&quot;)</span></span>
<span id="cb136-92"><a href="difference-in-difference.html#cb136-92" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb136-93"><a href="difference-in-difference.html#cb136-93" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb136-94"><a href="difference-in-difference.html#cb136-94" tabindex="-1"></a>  <span class="at">encoding =</span> <span class="st">&quot;UTF-8&quot;</span>,</span>
<span id="cb136-95"><a href="difference-in-difference.html#cb136-95" tabindex="-1"></a>  <span class="co"># Mettre les options de FUN ici</span></span>
<span id="cb136-96"><a href="difference-in-difference.html#cb136-96" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">&quot;data_tidy/BDD_PA_AFD_fund.csv&quot;</span>,</span>
<span id="cb136-97"><a href="difference-in-difference.html#cb136-97" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb136-98"><a href="difference-in-difference.html#cb136-98" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb136-99"><a href="difference-in-difference.html#cb136-99" tabindex="-1"></a>data_fund_nodupl <span class="ot">=</span> data_fund <span class="sc">%&gt;%</span></span>
<span id="cb136-100"><a href="difference-in-difference.html#cb136-100" tabindex="-1"></a>  <span class="fu">group_by</span>(id_projet) <span class="sc">%&gt;%</span></span>
<span id="cb136-101"><a href="difference-in-difference.html#cb136-101" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb136-102"><a href="difference-in-difference.html#cb136-102" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb136-103"><a href="difference-in-difference.html#cb136-103" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(<span class="st">&quot;mt_part_cofinancier_prevu_euro&quot;</span>, <span class="st">&quot;cofinanciers_siop&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb136-104"><a href="difference-in-difference.html#cb136-104" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">kfw =</span> <span class="fu">grepl</span>(<span class="st">&quot;kfw&quot;</span>, cofinanciers, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>),</span>
<span id="cb136-105"><a href="difference-in-difference.html#cb136-105" tabindex="-1"></a>         <span class="at">ffem =</span> <span class="fu">grepl</span>(<span class="st">&quot;ffem&quot;</span>, cofinanciers, <span class="at">ignore.case =</span> <span class="cn">TRUE</span>))</span>
<span id="cb136-106"><a href="difference-in-difference.html#cb136-106" tabindex="-1"></a></span>
<span id="cb136-107"><a href="difference-in-difference.html#cb136-107" tabindex="-1"></a><span class="do">## List of projects related to protected areas in AFD, reported by technical departments</span></span>
<span id="cb136-108"><a href="difference-in-difference.html#cb136-108" tabindex="-1"></a>data_pa_report <span class="ot">=</span> </span>
<span id="cb136-109"><a href="difference-in-difference.html#cb136-109" tabindex="-1"></a>  <span class="co">#read_delim(&quot;data_raw/BDD_PA_AFD.csv&quot;, delim = &quot;;&quot;)</span></span>
<span id="cb136-110"><a href="difference-in-difference.html#cb136-110" tabindex="-1"></a>  <span class="fu">s3read_using</span>(readr<span class="sc">::</span>read_delim,</span>
<span id="cb136-111"><a href="difference-in-difference.html#cb136-111" tabindex="-1"></a>                <span class="at">delim =</span> <span class="st">&quot;;&quot;</span>,</span>
<span id="cb136-112"><a href="difference-in-difference.html#cb136-112" tabindex="-1"></a>               <span class="at">show_col_types =</span> <span class="cn">FALSE</span>,</span>
<span id="cb136-113"><a href="difference-in-difference.html#cb136-113" tabindex="-1"></a>                <span class="at">object =</span> <span class="st">&quot;data_raw/BDD_PA_AFD.csv&quot;</span>,</span>
<span id="cb136-114"><a href="difference-in-difference.html#cb136-114" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb136-115"><a href="difference-in-difference.html#cb136-115" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb136-116"><a href="difference-in-difference.html#cb136-116" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">key =</span> <span class="fu">paste</span>(id_projet, nom_ap, wdpaid, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb136-117"><a href="difference-in-difference.html#cb136-117" tabindex="-1"></a>  <span class="fu">group_by</span>(key) <span class="sc">%&gt;%</span></span>
<span id="cb136-118"><a href="difference-in-difference.html#cb136-118" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>)</span></code></pre></div>
</div>
<div id="computing-treatment-effects-at-protected-area-level" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Computing treatment effects at protected area level<a href="difference-in-difference.html#computing-treatment-effects-at-protected-area-level" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="difference-in-difference.html#cb137-1" tabindex="-1"></a><span class="co"># The analysis is designed to analyze a portfolio of PA in different countries, using loop over countries and over PA. To better understand a function, or identify and debug an error, a good practice is to enter the loops using a single country or PA. Thus, it is possible to run the analysis step by step, and even enter into the functions to understand what is done « behind the doors ». For instance in « 02_matching.Rmd), set value i = « COM » in the first loop and j = 313046 to peform the analysis step by step for PA with WDPA ID 313046 in Comoros.</span></span>
<span id="cb137-2"><a href="difference-in-difference.html#cb137-2" tabindex="-1"></a></span>
<span id="cb137-3"><a href="difference-in-difference.html#cb137-3" tabindex="-1"></a></span>
<span id="cb137-4"><a href="difference-in-difference.html#cb137-4" tabindex="-1"></a><span class="co">#For each country in the list, the different steps of the processing are performed</span></span>
<span id="cb137-5"><a href="difference-in-difference.html#cb137-5" tabindex="-1"></a>count_i <span class="ot">=</span> <span class="dv">0</span> <span class="co">#Initialize counter</span></span>
<span id="cb137-6"><a href="difference-in-difference.html#cb137-6" tabindex="-1"></a>max_i <span class="ot">=</span> <span class="fu">length</span>(list_iso) <span class="co">#Max value of the counter</span></span>
<span id="cb137-7"><a href="difference-in-difference.html#cb137-7" tabindex="-1"></a>tic <span class="ot">=</span> <span class="fu">tic</span>() <span class="co">#Start timer</span></span>
<span id="cb137-8"><a href="difference-in-difference.html#cb137-8" tabindex="-1"></a><span class="co">#Initialize a dataframe to store the PA in inputs and outputs of the DiD. Useful to assess the potential loss during post-processing and DiD</span></span>
<span id="cb137-9"><a href="difference-in-difference.html#cb137-9" tabindex="-1"></a>df_list_did_in <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-10"><a href="difference-in-difference.html#cb137-10" tabindex="-1"></a>df_list_did_out <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-11"><a href="difference-in-difference.html#cb137-11" tabindex="-1"></a><span class="co">#Create empty dataframes that will store the treatment effects computed for each protected area in the portfolio. </span></span>
<span id="cb137-12"><a href="difference-in-difference.html#cb137-12" tabindex="-1"></a><span class="do">##Initialize a dataframe to store annual deforestation rate for each PA, à la Wolf et al. 2021</span></span>
<span id="cb137-13"><a href="difference-in-difference.html#cb137-13" tabindex="-1"></a><span class="co">#df_fl_annual_wolf = data.frame()</span></span>
<span id="cb137-14"><a href="difference-in-difference.html#cb137-14" tabindex="-1"></a><span class="do">##Initialize a dataframe to store treatment effects of all PA analyzed</span></span>
<span id="cb137-15"><a href="difference-in-difference.html#cb137-15" tabindex="-1"></a>df_fc_att <span class="ot">=</span> <span class="fu">data.frame</span>() <span class="co">#Effect on forest cover for matched units</span></span>
<span id="cb137-16"><a href="difference-in-difference.html#cb137-16" tabindex="-1"></a><span class="do">##df_fc_att_unm = data.frame() #Effect on forest cover for unmacthed units</span></span>
<span id="cb137-17"><a href="difference-in-difference.html#cb137-17" tabindex="-1"></a>df_fl_att <span class="ot">=</span> <span class="fu">data.frame</span>() <span class="co">#Effect on deforestation relative to 2000</span></span>
<span id="cb137-18"><a href="difference-in-difference.html#cb137-18" tabindex="-1"></a><span class="do">##Initialize a dataframe to store forest loss for visual evidence before/after matching</span></span>
<span id="cb137-19"><a href="difference-in-difference.html#cb137-19" tabindex="-1"></a>df_plot_forest_loss <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-20"><a href="difference-in-difference.html#cb137-20" tabindex="-1"></a><span class="co">#Initialize a dataframe to store pre-test of parallel trend assumption</span></span>
<span id="cb137-21"><a href="difference-in-difference.html#cb137-21" tabindex="-1"></a>df_pre_test <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-22"><a href="difference-in-difference.html#cb137-22" tabindex="-1"></a></span>
<span id="cb137-23"><a href="difference-in-difference.html#cb137-23" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> list_iso)</span>
<span id="cb137-24"><a href="difference-in-difference.html#cb137-24" tabindex="-1"></a>{</span>
<span id="cb137-25"><a href="difference-in-difference.html#cb137-25" tabindex="-1"></a>  <span class="co">#Update counter and show progress</span></span>
<span id="cb137-26"><a href="difference-in-difference.html#cb137-26" tabindex="-1"></a>  count_i <span class="ot">=</span> count_i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb137-27"><a href="difference-in-difference.html#cb137-27" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot; : country &quot;</span>, count_i, <span class="st">&quot;/&quot;</span>, max_i))</span>
<span id="cb137-28"><a href="difference-in-difference.html#cb137-28" tabindex="-1"></a>  </span>
<span id="cb137-29"><a href="difference-in-difference.html#cb137-29" tabindex="-1"></a>  <span class="co">#Initialize a dataframe to store treatment effects and pre-did dataframe of each PA in the country. Used later to aggregate results at country level</span></span>
<span id="cb137-30"><a href="difference-in-difference.html#cb137-30" tabindex="-1"></a>  df_fc_att_i <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-31"><a href="difference-in-difference.html#cb137-31" tabindex="-1"></a>  df_fl_att_i <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-32"><a href="difference-in-difference.html#cb137-32" tabindex="-1"></a>  df_pre_test_i <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb137-33"><a href="difference-in-difference.html#cb137-33" tabindex="-1"></a>  </span>
<span id="cb137-34"><a href="difference-in-difference.html#cb137-34" tabindex="-1"></a>  <span class="co">#Load the matching frame</span></span>
<span id="cb137-35"><a href="difference-in-difference.html#cb137-35" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;--Loading the list of PAs in the country considered&quot;</span>)</span>
<span id="cb137-36"><a href="difference-in-difference.html#cb137-36" tabindex="-1"></a>  </span>
<span id="cb137-37"><a href="difference-in-difference.html#cb137-37" tabindex="-1"></a>  output_pa_i <span class="ot">=</span> <span class="fu">fn_did_list_pa</span>(<span class="at">iso =</span> i, <span class="at">load_dir =</span> load_dir)</span>
<span id="cb137-38"><a href="difference-in-difference.html#cb137-38" tabindex="-1"></a>  <span class="cf">if</span>(output_pa_i<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>} <span class="cf">else</span> list_pa_in <span class="ot">=</span> output_pa_i<span class="sc">$</span>list_pa</span>
<span id="cb137-39"><a href="difference-in-difference.html#cb137-39" tabindex="-1"></a>  </span>
<span id="cb137-40"><a href="difference-in-difference.html#cb137-40" tabindex="-1"></a>  df_list_did_in <span class="ot">=</span> <span class="fu">rbind</span>(df_list_did_in, <span class="fu">data.frame</span>(<span class="st">&quot;iso3&quot;</span> <span class="ot">=</span> <span class="fu">rep</span>(i, <span class="fu">length</span>(list_pa_in)),</span>
<span id="cb137-41"><a href="difference-in-difference.html#cb137-41" tabindex="-1"></a>                                                   <span class="st">&quot;wdpaid&quot;</span> <span class="ot">=</span> list_pa_in))</span>
<span id="cb137-42"><a href="difference-in-difference.html#cb137-42" tabindex="-1"></a>  </span>
<span id="cb137-43"><a href="difference-in-difference.html#cb137-43" tabindex="-1"></a>  count_j <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb137-44"><a href="difference-in-difference.html#cb137-44" tabindex="-1"></a>  max_j <span class="ot">=</span> <span class="fu">length</span>(list_pa_in)</span>
<span id="cb137-45"><a href="difference-in-difference.html#cb137-45" tabindex="-1"></a>  </span>
<span id="cb137-46"><a href="difference-in-difference.html#cb137-46" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> list_pa_in)</span>
<span id="cb137-47"><a href="difference-in-difference.html#cb137-47" tabindex="-1"></a>  {</span>
<span id="cb137-48"><a href="difference-in-difference.html#cb137-48" tabindex="-1"></a>    </span>
<span id="cb137-49"><a href="difference-in-difference.html#cb137-49" tabindex="-1"></a>    count_j <span class="ot">=</span> count_j<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb137-50"><a href="difference-in-difference.html#cb137-50" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;WDPA ID &quot;</span>, j, <span class="st">&quot; : &quot;</span>, count_j, <span class="st">&quot;/&quot;</span>, max_j))</span>
<span id="cb137-51"><a href="difference-in-difference.html#cb137-51" tabindex="-1"></a>    </span>
<span id="cb137-52"><a href="difference-in-difference.html#cb137-52" tabindex="-1"></a>    <span class="co">#Compute annual deforestation rates in treated and control matched areas, à la Wolf et al. 2021.</span></span>
<span id="cb137-53"><a href="difference-in-difference.html#cb137-53" tabindex="-1"></a>    <span class="co"># print(&quot;--Compute average deforestation rates à la Wolf et al. 2021&quot;)</span></span>
<span id="cb137-54"><a href="difference-in-difference.html#cb137-54" tabindex="-1"></a>    <span class="co"># output_wolf_m_j = fn_fl_wolf(iso = i, </span></span>
<span id="cb137-55"><a href="difference-in-difference.html#cb137-55" tabindex="-1"></a>    <span class="co">#                             wdpaid = j, </span></span>
<span id="cb137-56"><a href="difference-in-difference.html#cb137-56" tabindex="-1"></a>    <span class="co">#                             alpha = alpha, </span></span>
<span id="cb137-57"><a href="difference-in-difference.html#cb137-57" tabindex="-1"></a>    <span class="co">#                             load_dir = load_dir)</span></span>
<span id="cb137-58"><a href="difference-in-difference.html#cb137-58" tabindex="-1"></a>    <span class="co"># </span></span>
<span id="cb137-59"><a href="difference-in-difference.html#cb137-59" tabindex="-1"></a>    <span class="co"># if(output_wolf_m_j$is_ok == FALSE) </span></span>
<span id="cb137-60"><a href="difference-in-difference.html#cb137-60" tabindex="-1"></a>    <span class="co">#   {next} else df_fl_wolf_m_j = output_wolf_m_j$df_fl_annual_wolf</span></span>
<span id="cb137-61"><a href="difference-in-difference.html#cb137-61" tabindex="-1"></a>    <span class="co"># df_fl_annual_wolf = rbind(df_fl_annual_wolf, df_fl_wolf_m_j)</span></span>
<span id="cb137-62"><a href="difference-in-difference.html#cb137-62" tabindex="-1"></a>    </span>
<span id="cb137-63"><a href="difference-in-difference.html#cb137-63" tabindex="-1"></a>    <span class="co">#Compute treatment effects</span></span>
<span id="cb137-64"><a href="difference-in-difference.html#cb137-64" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;--Compute treatment effects&quot;</span>)</span>
<span id="cb137-65"><a href="difference-in-difference.html#cb137-65" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----For matched units&quot;</span>)</span>
<span id="cb137-66"><a href="difference-in-difference.html#cb137-66" tabindex="-1"></a>    </span>
<span id="cb137-67"><a href="difference-in-difference.html#cb137-67" tabindex="-1"></a>    <span class="co">#For AFD projects (funding info)</span></span>
<span id="cb137-68"><a href="difference-in-difference.html#cb137-68" tabindex="-1"></a>    <span class="co"># output_att_m_j = fn_did_att_afd(iso = i, wdpaid = j, </span></span>
<span id="cb137-69"><a href="difference-in-difference.html#cb137-69" tabindex="-1"></a>    <span class="co">#                       is_m = TRUE,</span></span>
<span id="cb137-70"><a href="difference-in-difference.html#cb137-70" tabindex="-1"></a>    <span class="co">#                   data_pa = data_pa,</span></span>
<span id="cb137-71"><a href="difference-in-difference.html#cb137-71" tabindex="-1"></a>    <span class="co">#                   data_fund = data_fund_nodupl,</span></span>
<span id="cb137-72"><a href="difference-in-difference.html#cb137-72" tabindex="-1"></a>    <span class="co">#                   data_report = data_pa_report,</span></span>
<span id="cb137-73"><a href="difference-in-difference.html#cb137-73" tabindex="-1"></a>    <span class="co">#                   alpha = alpha,</span></span>
<span id="cb137-74"><a href="difference-in-difference.html#cb137-74" tabindex="-1"></a>    <span class="co">#                   load_dir = load_dir,</span></span>
<span id="cb137-75"><a href="difference-in-difference.html#cb137-75" tabindex="-1"></a>    <span class="co">#                   save_dir = save_dir)</span></span>
<span id="cb137-76"><a href="difference-in-difference.html#cb137-76" tabindex="-1"></a>    </span>
<span id="cb137-77"><a href="difference-in-difference.html#cb137-77" tabindex="-1"></a>    <span class="co">#For PAs in general (no funding info)</span></span>
<span id="cb137-78"><a href="difference-in-difference.html#cb137-78" tabindex="-1"></a>    output_att_m_j <span class="ot">=</span> <span class="fu">fn_did_att_general</span>(<span class="at">iso =</span> i, <span class="at">wdpaid =</span> j, </span>
<span id="cb137-79"><a href="difference-in-difference.html#cb137-79" tabindex="-1"></a>                        <span class="at">is_m =</span> <span class="cn">TRUE</span>,</span>
<span id="cb137-80"><a href="difference-in-difference.html#cb137-80" tabindex="-1"></a>                    <span class="at">data_pa =</span> data_pa,</span>
<span id="cb137-81"><a href="difference-in-difference.html#cb137-81" tabindex="-1"></a>                    <span class="at">alpha =</span> alpha,</span>
<span id="cb137-82"><a href="difference-in-difference.html#cb137-82" tabindex="-1"></a>                    <span class="at">load_dir =</span> load_dir,</span>
<span id="cb137-83"><a href="difference-in-difference.html#cb137-83" tabindex="-1"></a>                    <span class="at">save_dir =</span> save_dir)</span>
<span id="cb137-84"><a href="difference-in-difference.html#cb137-84" tabindex="-1"></a>    </span>
<span id="cb137-85"><a href="difference-in-difference.html#cb137-85" tabindex="-1"></a>    <span class="cf">if</span>(output_att_m_j<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>} </span>
<span id="cb137-86"><a href="difference-in-difference.html#cb137-86" tabindex="-1"></a>    </span>
<span id="cb137-87"><a href="difference-in-difference.html#cb137-87" tabindex="-1"></a>    df_fc_att_i <span class="ot">=</span> <span class="fu">rbind</span>(df_fc_att_i, output_att_m_j<span class="sc">$</span>df_fc_att)</span>
<span id="cb137-88"><a href="difference-in-difference.html#cb137-88" tabindex="-1"></a>    df_fl_att_i <span class="ot">=</span> <span class="fu">rbind</span>(df_fl_att_i, output_att_m_j<span class="sc">$</span>df_fl_att)</span>
<span id="cb137-89"><a href="difference-in-difference.html#cb137-89" tabindex="-1"></a>    df_pre_test_i <span class="ot">=</span> <span class="fu">rbind</span>(df_pre_test_i, output_att_m_j<span class="sc">$</span>df_pre_test)</span>
<span id="cb137-90"><a href="difference-in-difference.html#cb137-90" tabindex="-1"></a>        </span>
<span id="cb137-91"><a href="difference-in-difference.html#cb137-91" tabindex="-1"></a>    <span class="co">#print(&quot;----For unmatched units&quot;)</span></span>
<span id="cb137-92"><a href="difference-in-difference.html#cb137-92" tabindex="-1"></a>    </span>
<span id="cb137-93"><a href="difference-in-difference.html#cb137-93" tabindex="-1"></a>    <span class="co">#For AFD PAs (funding info known)</span></span>
<span id="cb137-94"><a href="difference-in-difference.html#cb137-94" tabindex="-1"></a>    <span class="co"># df_att_unm_j = fn_did_att_afd(iso = i, wdpaid = j, </span></span>
<span id="cb137-95"><a href="difference-in-difference.html#cb137-95" tabindex="-1"></a>    <span class="co">#                       is_m = FALSE,</span></span>
<span id="cb137-96"><a href="difference-in-difference.html#cb137-96" tabindex="-1"></a>    <span class="co">#                   data_pa = data_pa,</span></span>
<span id="cb137-97"><a href="difference-in-difference.html#cb137-97" tabindex="-1"></a>    <span class="co">#                   alpha = 0.05,</span></span>
<span id="cb137-98"><a href="difference-in-difference.html#cb137-98" tabindex="-1"></a>    <span class="co">#                   load_dir = load_dir,</span></span>
<span id="cb137-99"><a href="difference-in-difference.html#cb137-99" tabindex="-1"></a>    <span class="co">#                   ext_input = &quot;.csv&quot;,</span></span>
<span id="cb137-100"><a href="difference-in-difference.html#cb137-100" tabindex="-1"></a>    <span class="co">#                   save_dir = save_dir)</span></span>
<span id="cb137-101"><a href="difference-in-difference.html#cb137-101" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb137-102"><a href="difference-in-difference.html#cb137-102" tabindex="-1"></a>    <span class="co">#For general PAs (funding info unknown)</span></span>
<span id="cb137-103"><a href="difference-in-difference.html#cb137-103" tabindex="-1"></a>    <span class="co"># df_att_unm_j = fn_did_att_general(iso = i, wdpaid = j, </span></span>
<span id="cb137-104"><a href="difference-in-difference.html#cb137-104" tabindex="-1"></a>    <span class="co">#                       is_m = FALSE,</span></span>
<span id="cb137-105"><a href="difference-in-difference.html#cb137-105" tabindex="-1"></a>    <span class="co">#                   data_pa = data_pa,</span></span>
<span id="cb137-106"><a href="difference-in-difference.html#cb137-106" tabindex="-1"></a>    <span class="co">#                   alpha = 0.05,</span></span>
<span id="cb137-107"><a href="difference-in-difference.html#cb137-107" tabindex="-1"></a>    <span class="co">#                   load_dir = load_dir,</span></span>
<span id="cb137-108"><a href="difference-in-difference.html#cb137-108" tabindex="-1"></a>    <span class="co">#                   ext_input = &quot;.csv&quot;,</span></span>
<span id="cb137-109"><a href="difference-in-difference.html#cb137-109" tabindex="-1"></a>    <span class="co">#                   save_dir = save_dir)</span></span>
<span id="cb137-110"><a href="difference-in-difference.html#cb137-110" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb137-111"><a href="difference-in-difference.html#cb137-111" tabindex="-1"></a>    <span class="co">#if(output_att_m_j$is_ok == FALSE) {next} else df_att_m_j = output_att_m_j</span></span>
<span id="cb137-112"><a href="difference-in-difference.html#cb137-112" tabindex="-1"></a>    <span class="co">#df_pre_test_i = rbind(df_pre_test, df_att_m_j$df_pre_test)</span></span>
<span id="cb137-113"><a href="difference-in-difference.html#cb137-113" tabindex="-1"></a>    <span class="co"># df_fc_att_unm_i = rbind(df_fc_att_i, df_att_unm_j$df_fc_att)</span></span>
<span id="cb137-114"><a href="difference-in-difference.html#cb137-114" tabindex="-1"></a>    <span class="co"># df_fl_att_unm_i = rbind(df_fl_att_i, df_att_unm_j$df_fl_att)</span></span>
<span id="cb137-115"><a href="difference-in-difference.html#cb137-115" tabindex="-1"></a>    </span>
<span id="cb137-116"><a href="difference-in-difference.html#cb137-116" tabindex="-1"></a>    <span class="co">#Plot visual evidence before-after matching</span></span>
<span id="cb137-117"><a href="difference-in-difference.html#cb137-117" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;--Plot visual evidence before-after matching&quot;</span>)</span>
<span id="cb137-118"><a href="difference-in-difference.html#cb137-118" tabindex="-1"></a>    df_plot_forest_loss_j <span class="ot">=</span> <span class="fu">fn_plot_forest_loss</span>(<span class="at">iso =</span> i,</span>
<span id="cb137-119"><a href="difference-in-difference.html#cb137-119" tabindex="-1"></a>                                                <span class="at">wdpaid =</span> j,</span>
<span id="cb137-120"><a href="difference-in-difference.html#cb137-120" tabindex="-1"></a>                                                <span class="at">alpha =</span> alpha,</span>
<span id="cb137-121"><a href="difference-in-difference.html#cb137-121" tabindex="-1"></a>                                                <span class="at">data_pa =</span> data_pa,</span>
<span id="cb137-122"><a href="difference-in-difference.html#cb137-122" tabindex="-1"></a>                                                <span class="at">load_dir =</span> load_dir,</span>
<span id="cb137-123"><a href="difference-in-difference.html#cb137-123" tabindex="-1"></a>                                                <span class="at">save_dir =</span> save_dir)</span>
<span id="cb137-124"><a href="difference-in-difference.html#cb137-124" tabindex="-1"></a>    df_plot_forest_loss <span class="ot">=</span> <span class="fu">rbind</span>(df_plot_forest_loss, df_plot_forest_loss_j)</span>
<span id="cb137-125"><a href="difference-in-difference.html#cb137-125" tabindex="-1"></a>    </span>
<span id="cb137-126"><a href="difference-in-difference.html#cb137-126" tabindex="-1"></a>    <span class="co">#The PA has gone through all DiD steps : report it in the output dataframe</span></span>
<span id="cb137-127"><a href="difference-in-difference.html#cb137-127" tabindex="-1"></a>    df_list_did_out <span class="ot">=</span> <span class="fu">rbind</span>(df_list_did_out, <span class="fu">data.frame</span>(<span class="st">&quot;iso3&quot;</span> <span class="ot">=</span> i, <span class="st">&quot;wdpaid&quot;</span> <span class="ot">=</span> j))</span>
<span id="cb137-128"><a href="difference-in-difference.html#cb137-128" tabindex="-1"></a></span>
<span id="cb137-129"><a href="difference-in-difference.html#cb137-129" tabindex="-1"></a>  }  </span>
<span id="cb137-130"><a href="difference-in-difference.html#cb137-130" tabindex="-1"></a>  <span class="co">#Store the treatment effects dataframes of the country</span></span>
<span id="cb137-131"><a href="difference-in-difference.html#cb137-131" tabindex="-1"></a>  <span class="do">##Report country results in the dataframe</span></span>
<span id="cb137-132"><a href="difference-in-difference.html#cb137-132" tabindex="-1"></a>  <span class="do">###Forest cover</span></span>
<span id="cb137-133"><a href="difference-in-difference.html#cb137-133" tabindex="-1"></a>  df_fc_att <span class="ot">=</span> <span class="fu">rbind</span>(df_fc_att, df_fc_att_i)</span>
<span id="cb137-134"><a href="difference-in-difference.html#cb137-134" tabindex="-1"></a>  <span class="do">###Forest loss</span></span>
<span id="cb137-135"><a href="difference-in-difference.html#cb137-135" tabindex="-1"></a>  df_fl_att <span class="ot">=</span> <span class="fu">rbind</span>(df_fl_att, df_fl_att_i)</span>
<span id="cb137-136"><a href="difference-in-difference.html#cb137-136" tabindex="-1"></a>  <span class="do">##Save country results in the storage</span></span>
<span id="cb137-137"><a href="difference-in-difference.html#cb137-137" tabindex="-1"></a>  <span class="do">###Forest cover</span></span>
<span id="cb137-138"><a href="difference-in-difference.html#cb137-138" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-139"><a href="difference-in-difference.html#cb137-139" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-140"><a href="difference-in-difference.html#cb137-140" tabindex="-1"></a>  df_fc_att_i,</span>
<span id="cb137-141"><a href="difference-in-difference.html#cb137-141" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">paste</span>(save_dir, i, <span class="fu">paste0</span>(<span class="st">&quot;df_fc_att_&quot;</span>, i, <span class="st">&quot;.csv&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-142"><a href="difference-in-difference.html#cb137-142" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-143"><a href="difference-in-difference.html#cb137-143" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-144"><a href="difference-in-difference.html#cb137-144" tabindex="-1"></a>  <span class="do">###Forest loss</span></span>
<span id="cb137-145"><a href="difference-in-difference.html#cb137-145" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-146"><a href="difference-in-difference.html#cb137-146" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-147"><a href="difference-in-difference.html#cb137-147" tabindex="-1"></a>  df_fl_att_i,</span>
<span id="cb137-148"><a href="difference-in-difference.html#cb137-148" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">paste</span>(save_dir, i, <span class="fu">paste0</span>(<span class="st">&quot;df_fl_att_&quot;</span>, i, <span class="st">&quot;.csv&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-149"><a href="difference-in-difference.html#cb137-149" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-150"><a href="difference-in-difference.html#cb137-150" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-151"><a href="difference-in-difference.html#cb137-151" tabindex="-1"></a>  </span>
<span id="cb137-152"><a href="difference-in-difference.html#cb137-152" tabindex="-1"></a>  <span class="do">##Store the pre-did dataframe of the country </span></span>
<span id="cb137-153"><a href="difference-in-difference.html#cb137-153" tabindex="-1"></a>  <span class="do">##Report country results in the dataframe</span></span>
<span id="cb137-154"><a href="difference-in-difference.html#cb137-154" tabindex="-1"></a>  df_pre_test <span class="ot">=</span> <span class="fu">rbind</span>(df_pre_test, df_pre_test_i)</span>
<span id="cb137-155"><a href="difference-in-difference.html#cb137-155" tabindex="-1"></a>  <span class="do">##Save country results in the storage</span></span>
<span id="cb137-156"><a href="difference-in-difference.html#cb137-156" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-157"><a href="difference-in-difference.html#cb137-157" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-158"><a href="difference-in-difference.html#cb137-158" tabindex="-1"></a>  df_pre_test_i,</span>
<span id="cb137-159"><a href="difference-in-difference.html#cb137-159" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">paste</span>(save_dir, i, <span class="fu">paste0</span>(<span class="st">&quot;df_pre_test_&quot;</span>, i, <span class="st">&quot;.csv&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-160"><a href="difference-in-difference.html#cb137-160" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-161"><a href="difference-in-difference.html#cb137-161" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-162"><a href="difference-in-difference.html#cb137-162" tabindex="-1"></a>  </span>
<span id="cb137-163"><a href="difference-in-difference.html#cb137-163" tabindex="-1"></a>}</span>
<span id="cb137-164"><a href="difference-in-difference.html#cb137-164" tabindex="-1"></a></span>
<span id="cb137-165"><a href="difference-in-difference.html#cb137-165" tabindex="-1"></a><span class="co">#Save list of PA in input and output of DiD process</span></span>
<span id="cb137-166"><a href="difference-in-difference.html#cb137-166" tabindex="-1"></a><span class="do">##Input</span></span>
<span id="cb137-167"><a href="difference-in-difference.html#cb137-167" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-168"><a href="difference-in-difference.html#cb137-168" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-169"><a href="difference-in-difference.html#cb137-169" tabindex="-1"></a>df_list_did_in,</span>
<span id="cb137-170"><a href="difference-in-difference.html#cb137-170" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_did_in.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-171"><a href="difference-in-difference.html#cb137-171" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-172"><a href="difference-in-difference.html#cb137-172" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-173"><a href="difference-in-difference.html#cb137-173" tabindex="-1"></a><span class="do">##Output</span></span>
<span id="cb137-174"><a href="difference-in-difference.html#cb137-174" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-175"><a href="difference-in-difference.html#cb137-175" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-176"><a href="difference-in-difference.html#cb137-176" tabindex="-1"></a>df_list_did_out,</span>
<span id="cb137-177"><a href="difference-in-difference.html#cb137-177" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_did_out.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-178"><a href="difference-in-difference.html#cb137-178" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-179"><a href="difference-in-difference.html#cb137-179" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-180"><a href="difference-in-difference.html#cb137-180" tabindex="-1"></a></span>
<span id="cb137-181"><a href="difference-in-difference.html#cb137-181" tabindex="-1"></a><span class="co">#Save the pre-treatment tests </span></span>
<span id="cb137-182"><a href="difference-in-difference.html#cb137-182" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-183"><a href="difference-in-difference.html#cb137-183" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-184"><a href="difference-in-difference.html#cb137-184" tabindex="-1"></a>df_pre_test,</span>
<span id="cb137-185"><a href="difference-in-difference.html#cb137-185" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_pre_test.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-186"><a href="difference-in-difference.html#cb137-186" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-187"><a href="difference-in-difference.html#cb137-187" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-188"><a href="difference-in-difference.html#cb137-188" tabindex="-1"></a></span>
<span id="cb137-189"><a href="difference-in-difference.html#cb137-189" tabindex="-1"></a><span class="co">#Save the treatment effects computed for every protected areas analyzed</span></span>
<span id="cb137-190"><a href="difference-in-difference.html#cb137-190" tabindex="-1"></a><span class="do">## Treatment effect expressed in forest cover loss avoided (ha)</span></span>
<span id="cb137-191"><a href="difference-in-difference.html#cb137-191" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-192"><a href="difference-in-difference.html#cb137-192" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-193"><a href="difference-in-difference.html#cb137-193" tabindex="-1"></a>df_fc_att,</span>
<span id="cb137-194"><a href="difference-in-difference.html#cb137-194" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fc_att.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb137-195"><a href="difference-in-difference.html#cb137-195" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-196"><a href="difference-in-difference.html#cb137-196" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-197"><a href="difference-in-difference.html#cb137-197" tabindex="-1"></a><span class="do">## Treatment effect expressed in change of deforestation rate (percentage points)</span></span>
<span id="cb137-198"><a href="difference-in-difference.html#cb137-198" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-199"><a href="difference-in-difference.html#cb137-199" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-200"><a href="difference-in-difference.html#cb137-200" tabindex="-1"></a>df_fl_att,</span>
<span id="cb137-201"><a href="difference-in-difference.html#cb137-201" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_att.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb137-202"><a href="difference-in-difference.html#cb137-202" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-203"><a href="difference-in-difference.html#cb137-203" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-204"><a href="difference-in-difference.html#cb137-204" tabindex="-1"></a></span>
<span id="cb137-205"><a href="difference-in-difference.html#cb137-205" tabindex="-1"></a><span class="co">#Save forest loss on the 2000-2021 period computed for each PA</span></span>
<span id="cb137-206"><a href="difference-in-difference.html#cb137-206" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb137-207"><a href="difference-in-difference.html#cb137-207" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb137-208"><a href="difference-in-difference.html#cb137-208" tabindex="-1"></a>df_plot_forest_loss,</span>
<span id="cb137-209"><a href="difference-in-difference.html#cb137-209" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_2000_2021.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb137-210"><a href="difference-in-difference.html#cb137-210" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb137-211"><a href="difference-in-difference.html#cb137-211" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb137-212"><a href="difference-in-difference.html#cb137-212" tabindex="-1"></a></span>
<span id="cb137-213"><a href="difference-in-difference.html#cb137-213" tabindex="-1"></a>toc <span class="ot">=</span> <span class="fu">toc</span>()</span></code></pre></div>
</div>
<div id="assess-the-quality-of-matching-and-pre-test" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Assess the quality of matching and pre-test<a href="difference-in-difference.html#assess-the-quality-of-matching-and-pre-test" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The treatment effects are computed using a difference-in-difference framework where control are built from a matching procedure. The treatment effects computed can be biased if (1) matched control and treated units are too different on average; (2) matched and unmatched treated units are too different on average (Schleicher et al., 2020). Also, the estimation from difference-in-difference is biased if parallel trend assumption does not hold, which is likely if control and treated matched unit do no follow the same trend before treatment.</p>
<p>In matching and DiD procedures, we have computed for each PA some statistics to assess the quality of the matching process and the pre-treatment parallel trend assumption. Before plotting and aggregating treatment effects, we first remove a PA if these statistics suggest poor matching of pre-treatment parallel trend.</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="difference-in-difference.html#cb138-1" tabindex="-1"></a><span class="co">#Import the quality assessment datasets</span></span>
<span id="cb138-2"><a href="difference-in-difference.html#cb138-2" tabindex="-1"></a><span class="do">## Pre-treatment parallel trend assumption test</span></span>
<span id="cb138-3"><a href="difference-in-difference.html#cb138-3" tabindex="-1"></a>df_pre_test <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb138-4"><a href="difference-in-difference.html#cb138-4" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb138-5"><a href="difference-in-difference.html#cb138-5" tabindex="-1"></a>  <span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_pre_test.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb138-6"><a href="difference-in-difference.html#cb138-6" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb138-7"><a href="difference-in-difference.html#cb138-7" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-8"><a href="difference-in-difference.html#cb138-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_ok_fc =</span> pval_fc <span class="sc">&lt;=</span> alpha,</span>
<span id="cb138-9"><a href="difference-in-difference.html#cb138-9" tabindex="-1"></a>         <span class="at">is_ok_fl =</span> pval_fl <span class="sc">&lt;=</span> alpha)</span>
<span id="cb138-10"><a href="difference-in-difference.html#cb138-10" tabindex="-1"></a><span class="do">##Matching quality</span></span>
<span id="cb138-11"><a href="difference-in-difference.html#cb138-11" tabindex="-1"></a><span class="do">##Matched control and treated units</span></span>
<span id="cb138-12"><a href="difference-in-difference.html#cb138-12" tabindex="-1"></a>df_quality_ct <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb138-13"><a href="difference-in-difference.html#cb138-13" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb138-14"><a href="difference-in-difference.html#cb138-14" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(load_dir, <span class="st">&quot;df_quality_ct.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb138-15"><a href="difference-in-difference.html#cb138-15" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb138-16"><a href="difference-in-difference.html#cb138-16" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb138-17"><a href="difference-in-difference.html#cb138-17" tabindex="-1"></a><span class="do">##Treated units, before and after matching</span></span>
<span id="cb138-18"><a href="difference-in-difference.html#cb138-18" tabindex="-1"></a>df_quality_tt <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb138-19"><a href="difference-in-difference.html#cb138-19" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb138-20"><a href="difference-in-difference.html#cb138-20" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(load_dir, <span class="st">&quot;df_quality_tt.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb138-21"><a href="difference-in-difference.html#cb138-21" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb138-22"><a href="difference-in-difference.html#cb138-22" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb138-23"><a href="difference-in-difference.html#cb138-23" tabindex="-1"></a></span>
<span id="cb138-24"><a href="difference-in-difference.html#cb138-24" tabindex="-1"></a><span class="do">##Total forest cover in 2000 </span></span>
<span id="cb138-25"><a href="difference-in-difference.html#cb138-25" tabindex="-1"></a>df_fc_2000 <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb138-26"><a href="difference-in-difference.html#cb138-26" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb138-27"><a href="difference-in-difference.html#cb138-27" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_2000_2021.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb138-28"><a href="difference-in-difference.html#cb138-28" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb138-29"><a href="difference-in-difference.html#cb138-29" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-30"><a href="difference-in-difference.html#cb138-30" tabindex="-1"></a>  <span class="fu">filter</span>(group <span class="sc">==</span> <span class="st">&quot;Treated&quot;</span> <span class="sc">&amp;</span> matched <span class="sc">==</span> F <span class="sc">&amp;</span> year <span class="sc">==</span> <span class="dv">2000</span>) <span class="sc">%&gt;%</span></span>
<span id="cb138-31"><a href="difference-in-difference.html#cb138-31" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(region, iso3, country_en, wdpaid, focus, fc_tot_ha))</span>
<span id="cb138-32"><a href="difference-in-difference.html#cb138-32" tabindex="-1"></a></span>
<span id="cb138-33"><a href="difference-in-difference.html#cb138-33" tabindex="-1"></a><span class="co">#For pre-test, closer look to ...</span></span>
<span id="cb138-34"><a href="difference-in-difference.html#cb138-34" tabindex="-1"></a><span class="do">## PA of interest</span></span>
<span id="cb138-35"><a href="difference-in-difference.html#cb138-35" tabindex="-1"></a>df_pre_test_focus <span class="ot">=</span> df_pre_test <span class="sc">%&gt;%</span></span>
<span id="cb138-36"><a href="difference-in-difference.html#cb138-36" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus)</span>
<span id="cb138-37"><a href="difference-in-difference.html#cb138-37" tabindex="-1"></a><span class="do">## Other PA</span></span>
<span id="cb138-38"><a href="difference-in-difference.html#cb138-38" tabindex="-1"></a>df_pre_test_nofocus <span class="ot">=</span> df_pre_test <span class="sc">%&gt;%</span></span>
<span id="cb138-39"><a href="difference-in-difference.html#cb138-39" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus))</span>
<span id="cb138-40"><a href="difference-in-difference.html#cb138-40" tabindex="-1"></a></span>
<span id="cb138-41"><a href="difference-in-difference.html#cb138-41" tabindex="-1"></a><span class="co">#For matching quality, compute aggregated quality metrics</span></span>
<span id="cb138-42"><a href="difference-in-difference.html#cb138-42" tabindex="-1"></a><span class="do">##For all PA</span></span>
<span id="cb138-43"><a href="difference-in-difference.html#cb138-43" tabindex="-1"></a>df_quality_ct_agg <span class="ot">=</span> df_quality_ct <span class="sc">%&gt;%</span></span>
<span id="cb138-44"><a href="difference-in-difference.html#cb138-44" tabindex="-1"></a>  <span class="fu">group_by</span>(region, country_en, iso3,wdpaid) <span class="sc">%&gt;%</span></span>
<span id="cb138-45"><a href="difference-in-difference.html#cb138-45" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_mean_diff_agg =</span> <span class="fu">mean</span>(std_mean_diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb138-46"><a href="difference-in-difference.html#cb138-46" tabindex="-1"></a>            <span class="at">var_ratio_agg =</span> <span class="fu">mean</span>(var_ratio, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-47"><a href="difference-in-difference.html#cb138-47" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb138-48"><a href="difference-in-difference.html#cb138-48" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_mean_ok =</span> std_mean_diff_agg <span class="sc">&lt;=</span> th_mean,</span>
<span id="cb138-49"><a href="difference-in-difference.html#cb138-49" tabindex="-1"></a>         <span class="at">is_var_ok =</span> var_ratio_agg <span class="sc">&gt;=</span> th_var_min <span class="sc">&amp;</span> var_ratio_agg <span class="sc">&lt;=</span> th_var_max,</span>
<span id="cb138-50"><a href="difference-in-difference.html#cb138-50" tabindex="-1"></a>         <span class="at">is_ok =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(is_mean_ok<span class="sc">*</span>is_var_ok) <span class="sc">==</span> T <span class="sc">~</span> <span class="cn">FALSE</span>,</span>
<span id="cb138-51"><a href="difference-in-difference.html#cb138-51" tabindex="-1"></a>                           <span class="fu">is.na</span>(is_mean_ok<span class="sc">*</span>is_var_ok) <span class="sc">==</span> F <span class="sc">~</span> <span class="fu">as.logical</span>(is_mean_ok<span class="sc">*</span>is_var_ok)))</span>
<span id="cb138-52"><a href="difference-in-difference.html#cb138-52" tabindex="-1"></a>df_quality_tt_agg <span class="ot">=</span> df_quality_tt <span class="sc">%&gt;%</span></span>
<span id="cb138-53"><a href="difference-in-difference.html#cb138-53" tabindex="-1"></a>  <span class="fu">group_by</span>(region, country_en, iso3,wdpaid) <span class="sc">%&gt;%</span></span>
<span id="cb138-54"><a href="difference-in-difference.html#cb138-54" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">std_mean_diff_agg =</span> <span class="fu">mean</span>(std_mean_diff, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb138-55"><a href="difference-in-difference.html#cb138-55" tabindex="-1"></a>            <span class="at">var_ratio_agg =</span> <span class="fu">mean</span>(var_ratio, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb138-56"><a href="difference-in-difference.html#cb138-56" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb138-57"><a href="difference-in-difference.html#cb138-57" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">is_mean_ok =</span> std_mean_diff_agg <span class="sc">&lt;=</span> th_mean,</span>
<span id="cb138-58"><a href="difference-in-difference.html#cb138-58" tabindex="-1"></a>         <span class="at">is_var_ok =</span> var_ratio_agg <span class="sc">&gt;=</span> th_var_min <span class="sc">&amp;</span> var_ratio_agg <span class="sc">&lt;=</span> th_var_max,</span>
<span id="cb138-59"><a href="difference-in-difference.html#cb138-59" tabindex="-1"></a>         <span class="at">is_ok =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(is_mean_ok<span class="sc">*</span>is_var_ok) <span class="sc">==</span> T <span class="sc">~</span> <span class="cn">FALSE</span>,</span>
<span id="cb138-60"><a href="difference-in-difference.html#cb138-60" tabindex="-1"></a>                           <span class="fu">is.na</span>(is_mean_ok<span class="sc">*</span>is_var_ok) <span class="sc">==</span> F <span class="sc">~</span> <span class="fu">as.logical</span>(is_mean_ok<span class="sc">*</span>is_var_ok)))</span>
<span id="cb138-61"><a href="difference-in-difference.html#cb138-61" tabindex="-1"></a></span>
<span id="cb138-62"><a href="difference-in-difference.html#cb138-62" tabindex="-1"></a><span class="do">##For PA of interest</span></span>
<span id="cb138-63"><a href="difference-in-difference.html#cb138-63" tabindex="-1"></a>df_quality_ct_agg_focus <span class="ot">=</span> df_quality_ct_agg <span class="sc">%&gt;%</span></span>
<span id="cb138-64"><a href="difference-in-difference.html#cb138-64" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus)</span>
<span id="cb138-65"><a href="difference-in-difference.html#cb138-65" tabindex="-1"></a>df_quality_tt_agg_focus <span class="ot">=</span> df_quality_tt_agg <span class="sc">%&gt;%</span></span>
<span id="cb138-66"><a href="difference-in-difference.html#cb138-66" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus)</span>
<span id="cb138-67"><a href="difference-in-difference.html#cb138-67" tabindex="-1"></a></span>
<span id="cb138-68"><a href="difference-in-difference.html#cb138-68" tabindex="-1"></a><span class="do">##For other PA</span></span>
<span id="cb138-69"><a href="difference-in-difference.html#cb138-69" tabindex="-1"></a>df_quality_ct_agg_nofocus <span class="ot">=</span> df_quality_ct_agg <span class="sc">%&gt;%</span></span>
<span id="cb138-70"><a href="difference-in-difference.html#cb138-70" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus))</span>
<span id="cb138-71"><a href="difference-in-difference.html#cb138-71" tabindex="-1"></a>df_quality_tt_agg_nofocus <span class="ot">=</span> df_quality_tt_agg <span class="sc">%&gt;%</span></span>
<span id="cb138-72"><a href="difference-in-difference.html#cb138-72" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(wdpaid <span class="sc">%in%</span> list_pa_ie_focus))</span>
<span id="cb138-73"><a href="difference-in-difference.html#cb138-73" tabindex="-1"></a></span>
<span id="cb138-74"><a href="difference-in-difference.html#cb138-74" tabindex="-1"></a><span class="co">#List of PA with acceptable initial forest cover, matching and pre-test (strict criterion)</span></span>
<span id="cb138-75"><a href="difference-in-difference.html#cb138-75" tabindex="-1"></a>list_pa_fc_2000 <span class="ot">=</span> <span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_2000, fc_tot_ha <span class="sc">&gt;=</span> <span class="fl">0.5</span>)<span class="sc">$</span>wdpaid)</span>
<span id="cb138-76"><a href="difference-in-difference.html#cb138-76" tabindex="-1"></a>list_pa_good_ct <span class="ot">=</span> df_quality_ct_agg[df_quality_ct_agg<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">TRUE</span>,]<span class="sc">$</span>wdpaid</span>
<span id="cb138-77"><a href="difference-in-difference.html#cb138-77" tabindex="-1"></a>list_pa_good_tt <span class="ot">=</span> df_quality_tt_agg[df_quality_tt_agg<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">TRUE</span>,]<span class="sc">$</span>wdpaid</span>
<span id="cb138-78"><a href="difference-in-difference.html#cb138-78" tabindex="-1"></a>list_pa_good_pre_fc <span class="ot">=</span> df_pre_test[df_pre_test<span class="sc">$</span>is_ok_fc <span class="sc">==</span> <span class="cn">TRUE</span>,]<span class="sc">$</span>wdpaid</span>
<span id="cb138-79"><a href="difference-in-difference.html#cb138-79" tabindex="-1"></a>list_pa_good_pre_fl <span class="ot">=</span> df_pre_test[df_pre_test<span class="sc">$</span>is_ok_fl <span class="sc">==</span> <span class="cn">TRUE</span>,]<span class="sc">$</span>wdpaid</span>
<span id="cb138-80"><a href="difference-in-difference.html#cb138-80" tabindex="-1"></a>list_pa_keep_fc <span class="ot">=</span> data_pa[data_pa<span class="sc">$</span>wdpaid <span class="sc">%in%</span> list_pa_fc_2000</span>
<span id="cb138-81"><a href="difference-in-difference.html#cb138-81" tabindex="-1"></a>                          <span class="sc">&amp;</span> data_pa<span class="sc">$</span>wdpaid <span class="sc">%in%</span> list_pa_good_ct</span>
<span id="cb138-82"><a href="difference-in-difference.html#cb138-82" tabindex="-1"></a>                       <span class="sc">&amp;</span> data_pa<span class="sc">$</span>wdpaid <span class="sc">%in%</span> list_pa_good_tt</span>
<span id="cb138-83"><a href="difference-in-difference.html#cb138-83" tabindex="-1"></a>                       <span class="sc">&amp;</span> data_pa<span class="sc">$</span>wdpaid <span class="sc">%in%</span> list_pa_good_pre_fc,]<span class="sc">$</span>wdpaid</span></code></pre></div>
</div>
<div id="tidy-datasets-with-acceptable-quality" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Tidy datasets with acceptable quality<a href="difference-in-difference.html#tidy-datasets-with-acceptable-quality" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The previous section makes it possible to filter PA with acceptable initial forest cover, matching quality and pre-test. Then, it is possible to build a dataset of a subset of PA. For presentations to non-academic, we choose to maximize the number of operations, so we only remove PA with non-acceptable initial forest cover. For academic publications and comunications, we also remove PA with bad matching quality and pre-test.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="difference-in-difference.html#cb139-1" tabindex="-1"></a><span class="co">#Import datasets</span></span>
<span id="cb139-2"><a href="difference-in-difference.html#cb139-2" tabindex="-1"></a><span class="do">## Treatment effect expressed in forest cover loss avoided (ha)</span></span>
<span id="cb139-3"><a href="difference-in-difference.html#cb139-3" tabindex="-1"></a>df_fc_att <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb139-4"><a href="difference-in-difference.html#cb139-4" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb139-5"><a href="difference-in-difference.html#cb139-5" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fc_att.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb139-6"><a href="difference-in-difference.html#cb139-6" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-7"><a href="difference-in-difference.html#cb139-7" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb139-8"><a href="difference-in-difference.html#cb139-8" tabindex="-1"></a><span class="do">## Treatment effect expressed in change of deforestation rate (percentage points)</span></span>
<span id="cb139-9"><a href="difference-in-difference.html#cb139-9" tabindex="-1"></a>df_fl_att <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb139-10"><a href="difference-in-difference.html#cb139-10" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb139-11"><a href="difference-in-difference.html#cb139-11" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_att.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb139-12"><a href="difference-in-difference.html#cb139-12" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-13"><a href="difference-in-difference.html#cb139-13" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb139-14"><a href="difference-in-difference.html#cb139-14" tabindex="-1"></a></span>
<span id="cb139-15"><a href="difference-in-difference.html#cb139-15" tabindex="-1"></a><span class="co">#Tidy datasets for non-academic</span></span>
<span id="cb139-16"><a href="difference-in-difference.html#cb139-16" tabindex="-1"></a><span class="do">##The following are selected :</span></span>
<span id="cb139-17"><a href="difference-in-difference.html#cb139-17" tabindex="-1"></a><span class="do">### Acceptable forest cover in 2000</span></span>
<span id="cb139-18"><a href="difference-in-difference.html#cb139-18" tabindex="-1"></a>df_fc_att_tidy_noaca <span class="ot">=</span> df_fc_att <span class="sc">%&gt;%</span></span>
<span id="cb139-19"><a href="difference-in-difference.html#cb139-19" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_fc_2000)</span>
<span id="cb139-20"><a href="difference-in-difference.html#cb139-20" tabindex="-1"></a>df_fl_att_tidy_noaca <span class="ot">=</span> df_fl_att <span class="sc">%&gt;%</span></span>
<span id="cb139-21"><a href="difference-in-difference.html#cb139-21" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_fc_2000)</span>
<span id="cb139-22"><a href="difference-in-difference.html#cb139-22" tabindex="-1"></a></span>
<span id="cb139-23"><a href="difference-in-difference.html#cb139-23" tabindex="-1"></a><span class="co">#Tidy datasets for academic</span></span>
<span id="cb139-24"><a href="difference-in-difference.html#cb139-24" tabindex="-1"></a><span class="do">##The following are selected :</span></span>
<span id="cb139-25"><a href="difference-in-difference.html#cb139-25" tabindex="-1"></a><span class="do">### Acceptable forest cover in 2000</span></span>
<span id="cb139-26"><a href="difference-in-difference.html#cb139-26" tabindex="-1"></a><span class="do">## Acceptable matching quality (matched control and treated, treated)</span></span>
<span id="cb139-27"><a href="difference-in-difference.html#cb139-27" tabindex="-1"></a><span class="do">## Acceptable pre-test</span></span>
<span id="cb139-28"><a href="difference-in-difference.html#cb139-28" tabindex="-1"></a>df_fc_att_tidy_aca <span class="ot">=</span> df_fc_att <span class="sc">%&gt;%</span></span>
<span id="cb139-29"><a href="difference-in-difference.html#cb139-29" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_keep_fc)</span>
<span id="cb139-30"><a href="difference-in-difference.html#cb139-30" tabindex="-1"></a>df_fl_att_tidy_aca <span class="ot">=</span> df_fl_att <span class="sc">%&gt;%</span></span>
<span id="cb139-31"><a href="difference-in-difference.html#cb139-31" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_keep_fc)</span>
<span id="cb139-32"><a href="difference-in-difference.html#cb139-32" tabindex="-1"></a></span>
<span id="cb139-33"><a href="difference-in-difference.html#cb139-33" tabindex="-1"></a><span class="co">#Save the tidy datasets</span></span>
<span id="cb139-34"><a href="difference-in-difference.html#cb139-34" tabindex="-1"></a><span class="do">## Non-academic filtering</span></span>
<span id="cb139-35"><a href="difference-in-difference.html#cb139-35" tabindex="-1"></a><span class="do">### FC</span></span>
<span id="cb139-36"><a href="difference-in-difference.html#cb139-36" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb139-37"><a href="difference-in-difference.html#cb139-37" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb139-38"><a href="difference-in-difference.html#cb139-38" tabindex="-1"></a>df_fc_att_tidy_noaca,</span>
<span id="cb139-39"><a href="difference-in-difference.html#cb139-39" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fc_att_tidy_noaca.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb139-40"><a href="difference-in-difference.html#cb139-40" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-41"><a href="difference-in-difference.html#cb139-41" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb139-42"><a href="difference-in-difference.html#cb139-42" tabindex="-1"></a><span class="do">### FL</span></span>
<span id="cb139-43"><a href="difference-in-difference.html#cb139-43" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb139-44"><a href="difference-in-difference.html#cb139-44" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb139-45"><a href="difference-in-difference.html#cb139-45" tabindex="-1"></a>df_fl_att_tidy_noaca,</span>
<span id="cb139-46"><a href="difference-in-difference.html#cb139-46" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_att_tidy_noaca.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb139-47"><a href="difference-in-difference.html#cb139-47" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-48"><a href="difference-in-difference.html#cb139-48" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb139-49"><a href="difference-in-difference.html#cb139-49" tabindex="-1"></a><span class="do">## Academic filtering</span></span>
<span id="cb139-50"><a href="difference-in-difference.html#cb139-50" tabindex="-1"></a><span class="do">### FC</span></span>
<span id="cb139-51"><a href="difference-in-difference.html#cb139-51" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb139-52"><a href="difference-in-difference.html#cb139-52" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb139-53"><a href="difference-in-difference.html#cb139-53" tabindex="-1"></a>df_fc_att_tidy_aca,</span>
<span id="cb139-54"><a href="difference-in-difference.html#cb139-54" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fc_att_tidy_aca.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb139-55"><a href="difference-in-difference.html#cb139-55" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-56"><a href="difference-in-difference.html#cb139-56" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb139-57"><a href="difference-in-difference.html#cb139-57" tabindex="-1"></a><span class="do">### FL</span></span>
<span id="cb139-58"><a href="difference-in-difference.html#cb139-58" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb139-59"><a href="difference-in-difference.html#cb139-59" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb139-60"><a href="difference-in-difference.html#cb139-60" tabindex="-1"></a>df_fl_att_tidy_aca,</span>
<span id="cb139-61"><a href="difference-in-difference.html#cb139-61" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_att_tidy_aca.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb139-62"><a href="difference-in-difference.html#cb139-62" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb139-63"><a href="difference-in-difference.html#cb139-63" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span></code></pre></div>
</div>
<div id="assess-the-loss-of-observations" class="section level2 hasAnchor" number="5.6">
<h2><span class="header-section-number">5.6</span> Assess the loss of observations<a href="difference-in-difference.html#assess-the-loss-of-observations" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Some PA can be dropped during the matching and DiD process for several reasons : the PA without overlap can be too small compared to the initial area, no observation unit in a given PA is matched, matching quality is poor, pre-test does not hold. In any communication, it is necessary to be explicit about such losses. In both matching and DiD processes, dataframe are built to report the PAs in the different steps : before and after pre-processing, post-processing and DiD.</p>
<div id="compute-overlap-removal" class="section level3 hasAnchor" number="5.6.1">
<h3><span class="header-section-number">5.6.1</span> Compute overlap removal<a href="difference-in-difference.html#compute-overlap-removal" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>In the matching pre-processing, the PA analysed are removed any overlap with other PA polygon reported in the WDPA. If the overlap is greater than 10% of the initial area of the polygon reported in the WDPA, then the PA is removed from the sample. This operation is necessary to isolate the treatment effect of the PA of interest, not from a mix of different PA. The overlaps are also not considered for control. It is important to quantify the loss of area implied by this operation, and count how many PA are removed from our sample.</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="difference-in-difference.html#cb140-1" tabindex="-1"></a><span class="co">#Initialize a dataset where the area of each PA is reported : area reported in the WDPA, area without any overlap, </span></span>
<span id="cb140-2"><a href="difference-in-difference.html#cb140-2" tabindex="-1"></a>df_pa_overlap <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb140-3"><a href="difference-in-difference.html#cb140-3" tabindex="-1"></a>count_i <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb140-4"><a href="difference-in-difference.html#cb140-4" tabindex="-1"></a><span class="co">#For each country in the list of interest</span></span>
<span id="cb140-5"><a href="difference-in-difference.html#cb140-5" tabindex="-1"></a><span class="do">## Import country polygon, find its UTM code</span></span>
<span id="cb140-6"><a href="difference-in-difference.html#cb140-6" tabindex="-1"></a><span class="do">## Import the polygons from the WDPA, except points, and project it following the country UTM code</span></span>
<span id="cb140-7"><a href="difference-in-difference.html#cb140-7" tabindex="-1"></a><span class="do">## Compute the area of polygons reported in the WDAP</span></span>
<span id="cb140-8"><a href="difference-in-difference.html#cb140-8" tabindex="-1"></a><span class="do">## Compute a layer of polygons without overlap, compute the corresponding area, assess whether the PA should be kept or not</span></span>
<span id="cb140-9"><a href="difference-in-difference.html#cb140-9" tabindex="-1"></a><span class="do">## Store the overlaps</span></span>
<span id="cb140-10"><a href="difference-in-difference.html#cb140-10" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> list_iso) </span>
<span id="cb140-11"><a href="difference-in-difference.html#cb140-11" tabindex="-1"></a>{</span>
<span id="cb140-12"><a href="difference-in-difference.html#cb140-12" tabindex="-1"></a>  </span>
<span id="cb140-13"><a href="difference-in-difference.html#cb140-13" tabindex="-1"></a>    count_i <span class="ot">=</span> count_i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb140-14"><a href="difference-in-difference.html#cb140-14" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot; : country &quot;</span>, count_i, <span class="st">&quot;/&quot;</span>, <span class="fu">length</span>(list_iso)))</span>
<span id="cb140-15"><a href="difference-in-difference.html#cb140-15" tabindex="-1"></a>    gadm <span class="ot">=</span> <span class="fu">gadm</span>(<span class="at">country =</span> i, <span class="at">resolution =</span> <span class="dv">1</span>, <span class="at">level =</span> <span class="dv">0</span>, <span class="at">path =</span> <span class="fu">tempdir</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb140-16"><a href="difference-in-difference.html#cb140-16" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-17"><a href="difference-in-difference.html#cb140-17" tabindex="-1"></a>    <span class="fu">st_make_valid</span>() <span class="co">#Necessary for some polygons : e.g BEN</span></span>
<span id="cb140-18"><a href="difference-in-difference.html#cb140-18" tabindex="-1"></a>  </span>
<span id="cb140-19"><a href="difference-in-difference.html#cb140-19" tabindex="-1"></a>  <span class="co"># Find UTM zone of the country centroid</span></span>
<span id="cb140-20"><a href="difference-in-difference.html#cb140-20" tabindex="-1"></a>  centroid <span class="ot">=</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(gadm))</span>
<span id="cb140-21"><a href="difference-in-difference.html#cb140-21" tabindex="-1"></a>  utm_code <span class="ot">=</span> <span class="fu">fn_lonlat2UTM</span>(centroid)</span>
<span id="cb140-22"><a href="difference-in-difference.html#cb140-22" tabindex="-1"></a>  </span>
<span id="cb140-23"><a href="difference-in-difference.html#cb140-23" tabindex="-1"></a>    <span class="co"># The polygons of PAs are taken from WDPA, cleaned</span></span>
<span id="cb140-24"><a href="difference-in-difference.html#cb140-24" tabindex="-1"></a>  wdpa_prj <span class="ot">=</span> wdpa_wld_raw <span class="sc">%&gt;%</span></span>
<span id="cb140-25"><a href="difference-in-difference.html#cb140-25" tabindex="-1"></a>    <span class="fu">filter</span>(ISO3 <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb140-26"><a href="difference-in-difference.html#cb140-26" tabindex="-1"></a>    <span class="co">#st_make_valid() %&gt;%</span></span>
<span id="cb140-27"><a href="difference-in-difference.html#cb140-27" tabindex="-1"></a>    <span class="co">#celanign of PAs from the wdap_clean function :</span></span>
<span id="cb140-28"><a href="difference-in-difference.html#cb140-28" tabindex="-1"></a>    <span class="co">#Status filtering is performed manually juste after. </span></span>
<span id="cb140-29"><a href="difference-in-difference.html#cb140-29" tabindex="-1"></a>    <span class="co">#The geometry precision is set to default. Used to be 1000 in Kemmeng code</span></span>
<span id="cb140-30"><a href="difference-in-difference.html#cb140-30" tabindex="-1"></a>    <span class="co"># Overlaps are not erased because we rasterize polygons</span></span>
<span id="cb140-31"><a href="difference-in-difference.html#cb140-31" tabindex="-1"></a>    <span class="co">#UNESCO Biosphere Reserves are not excluded so that our analysis of AFD portfolio is the most extensive</span></span>
<span id="cb140-32"><a href="difference-in-difference.html#cb140-32" tabindex="-1"></a>    <span class="fu">wdpa_clean</span>(<span class="at">retain_status =</span> <span class="cn">NULL</span>,</span>
<span id="cb140-33"><a href="difference-in-difference.html#cb140-33" tabindex="-1"></a>               <span class="at">erase_overlaps =</span> <span class="cn">FALSE</span>,</span>
<span id="cb140-34"><a href="difference-in-difference.html#cb140-34" tabindex="-1"></a>               <span class="at">exclude_unesco =</span> <span class="cn">FALSE</span>,</span>
<span id="cb140-35"><a href="difference-in-difference.html#cb140-35" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb140-36"><a href="difference-in-difference.html#cb140-36" tabindex="-1"></a>    <span class="co"># Remove the PAs that are only proposed, or have geometry type &quot;point&quot;</span></span>
<span id="cb140-37"><a href="difference-in-difference.html#cb140-37" tabindex="-1"></a>    <span class="co">#filter(STATUS != &quot;Proposed&quot;) %&gt;%  #24/08/2023 : &quot;Proposed&quot; status concerns only 6 PAs in the sample, including one implemented after 2000.</span></span>
<span id="cb140-38"><a href="difference-in-difference.html#cb140-38" tabindex="-1"></a>    <span class="fu">filter</span>(GEOMETRY_TYPE <span class="sc">!=</span> <span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb140-39"><a href="difference-in-difference.html#cb140-39" tabindex="-1"></a>    <span class="co"># Project PA polygons to the previously determined UTM zone</span></span>
<span id="cb140-40"><a href="difference-in-difference.html#cb140-40" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> utm_code) </span>
<span id="cb140-41"><a href="difference-in-difference.html#cb140-41" tabindex="-1"></a>  </span>
<span id="cb140-42"><a href="difference-in-difference.html#cb140-42" tabindex="-1"></a>  <span class="co"># Numerous polygons reported in the WDPA overlap. This can lead be an issue : a pixel can be treated more than once, and the treatment effect of the PA of interest cannot be isolated a priori </span></span>
<span id="cb140-43"><a href="difference-in-difference.html#cb140-43" tabindex="-1"></a>  <span class="co"># Compute a layer of polygons without overlaps, and with overlaps only. The analysis will be performed on polygons with no overlap and whose non-overlapped area is not too small (10% at least of initial area). Also, the overlapped areas are assigned to a specific group so that they are not used as control.</span></span>
<span id="cb140-44"><a href="difference-in-difference.html#cb140-44" tabindex="-1"></a>  <span class="do">## Layer without overlap</span></span>
<span id="cb140-45"><a href="difference-in-difference.html#cb140-45" tabindex="-1"></a>  wdpa_prj_vect <span class="ot">=</span> wdpa_prj <span class="sc">%&gt;%</span> </span>
<span id="cb140-46"><a href="difference-in-difference.html#cb140-46" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">area_poly =</span> <span class="fu">expanse</span>(terra<span class="sc">::</span><span class="fu">vect</span>(geometry), <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb140-47"><a href="difference-in-difference.html#cb140-47" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>()</span>
<span id="cb140-48"><a href="difference-in-difference.html#cb140-48" tabindex="-1"></a>  </span>
<span id="cb140-49"><a href="difference-in-difference.html#cb140-49" tabindex="-1"></a>  wdpa_prj_noverlap <span class="ot">=</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">dim</span>(wdpa_prj_vect)[<span class="dv">1</span>], </span>
<span id="cb140-50"><a href="difference-in-difference.html#cb140-50" tabindex="-1"></a>                         <span class="cf">function</span>(X) {<span class="fu">erase</span>(wdpa_prj_vect[X,], wdpa_prj_vect[<span class="sc">-</span>X,])}) <span class="sc">%&gt;%</span> </span>
<span id="cb140-51"><a href="difference-in-difference.html#cb140-51" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">vect</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-52"><a href="difference-in-difference.html#cb140-52" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-53"><a href="difference-in-difference.html#cb140-53" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-54"><a href="difference-in-difference.html#cb140-54" tabindex="-1"></a>    <span class="co">#Compute</span></span>
<span id="cb140-55"><a href="difference-in-difference.html#cb140-55" tabindex="-1"></a>    <span class="do">## The area of the PA without overlap (erase (X, -X), with X the polygon of interest, -X other polygons)</span></span>
<span id="cb140-56"><a href="difference-in-difference.html#cb140-56" tabindex="-1"></a>    <span class="do">## dummy for removal : if the area without overlap is smaller than 10% of the initial area reported in the WDPA, then it is not considered</span></span>
<span id="cb140-57"><a href="difference-in-difference.html#cb140-57" tabindex="-1"></a>    <span class="do">## This is computed relative to the initial reported area in the WDPA, and the initial area of the polygon reported in the WDAP</span></span>
<span id="cb140-58"><a href="difference-in-difference.html#cb140-58" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">area_noverlap =</span> <span class="fu">expanse</span>(terra<span class="sc">::</span><span class="fu">vect</span>(geometry), <span class="at">unit =</span> <span class="st">&quot;km&quot;</span>),</span>
<span id="cb140-59"><a href="difference-in-difference.html#cb140-59" tabindex="-1"></a>           <span class="at">rm_poly =</span> area_noverlap <span class="sc">&lt;</span> <span class="fl">0.1</span><span class="sc">*</span>area_poly,)</span>
<span id="cb140-60"><a href="difference-in-difference.html#cb140-60" tabindex="-1"></a>  </span>
<span id="cb140-61"><a href="difference-in-difference.html#cb140-61" tabindex="-1"></a>  <span class="do">## Layer of overlaps</span></span>
<span id="cb140-62"><a href="difference-in-difference.html#cb140-62" tabindex="-1"></a>  <span class="co"># wdpa_prj_overlap = sapply(1:dim(wdpa_prj_vect)[1],</span></span>
<span id="cb140-63"><a href="difference-in-difference.html#cb140-63" tabindex="-1"></a>  <span class="co">#                       function(X) {intersect(wdpa_prj_vect[X,], wdpa_prj_vect[-X,])}) %&gt;%</span></span>
<span id="cb140-64"><a href="difference-in-difference.html#cb140-64" tabindex="-1"></a>  <span class="co">#   terra::vect() %&gt;%</span></span>
<span id="cb140-65"><a href="difference-in-difference.html#cb140-65" tabindex="-1"></a>  <span class="co">#   st_as_sf() %&gt;%</span></span>
<span id="cb140-66"><a href="difference-in-difference.html#cb140-66" tabindex="-1"></a>  <span class="co">#   clean_names()</span></span>
<span id="cb140-67"><a href="difference-in-difference.html#cb140-67" tabindex="-1"></a>  </span>
<span id="cb140-68"><a href="difference-in-difference.html#cb140-68" tabindex="-1"></a>  <span class="co">#Report areas without overlap for all PA in the country i</span></span>
<span id="cb140-69"><a href="difference-in-difference.html#cb140-69" tabindex="-1"></a>  <span class="co">#PA whose area without overlap is null are removed from wdpa_prj_noverlap : we create the dataframe of interest from the comprehensive wdpa_prj_vect, and assign to NA values for rm and area_noverlap a 0 or TRUE</span></span>
<span id="cb140-70"><a href="difference-in-difference.html#cb140-70" tabindex="-1"></a>  df_pa_overlap_i <span class="ot">=</span> wdpa_prj_vect <span class="sc">%&gt;%</span></span>
<span id="cb140-71"><a href="difference-in-difference.html#cb140-71" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-72"><a href="difference-in-difference.html#cb140-72" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-73"><a href="difference-in-difference.html#cb140-73" tabindex="-1"></a>    <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb140-74"><a href="difference-in-difference.html#cb140-74" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(iso3, wdpaid, wdpa_pid, name, rep_area, area_km2, area_poly)) <span class="sc">%&gt;%</span></span>
<span id="cb140-75"><a href="difference-in-difference.html#cb140-75" tabindex="-1"></a>    <span class="fu">left_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(wdpa_prj_noverlap, <span class="fu">c</span>(wdpa_pid, area_noverlap, rm_poly)), <span class="at">by =</span> <span class="st">&quot;wdpa_pid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb140-76"><a href="difference-in-difference.html#cb140-76" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">area_noverlap =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(area_noverlap) <span class="sc">==</span> T <span class="sc">~</span> <span class="dv">0</span>,</span>
<span id="cb140-77"><a href="difference-in-difference.html#cb140-77" tabindex="-1"></a>                                     <span class="cn">TRUE</span> <span class="sc">~</span> area_noverlap),</span>
<span id="cb140-78"><a href="difference-in-difference.html#cb140-78" tabindex="-1"></a>            <span class="at">rm_poly =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(rm_poly) <span class="sc">==</span> T <span class="sc">~</span> <span class="cn">TRUE</span>,</span>
<span id="cb140-79"><a href="difference-in-difference.html#cb140-79" tabindex="-1"></a>                           <span class="cn">TRUE</span> <span class="sc">~</span> rm_poly))</span>
<span id="cb140-80"><a href="difference-in-difference.html#cb140-80" tabindex="-1"></a>  <span class="co"># df_pa_overlap_i = wdpa_prj_noverlap %&gt;%</span></span>
<span id="cb140-81"><a href="difference-in-difference.html#cb140-81" tabindex="-1"></a>  <span class="co">#   clean_names() %&gt;% </span></span>
<span id="cb140-82"><a href="difference-in-difference.html#cb140-82" tabindex="-1"></a>  <span class="co">#   st_drop_geometry() %&gt;%</span></span>
<span id="cb140-83"><a href="difference-in-difference.html#cb140-83" tabindex="-1"></a>  <span class="co">#   dplyr::select(c(iso3, wdpaid, wdpa_pid, name, area_km2, area_poly, area_noverlap, rm))</span></span>
<span id="cb140-84"><a href="difference-in-difference.html#cb140-84" tabindex="-1"></a>  </span>
<span id="cb140-85"><a href="difference-in-difference.html#cb140-85" tabindex="-1"></a>  df_pa_overlap <span class="ot">=</span> <span class="fu">rbind</span>(df_pa_overlap, df_pa_overlap_i)</span>
<span id="cb140-86"><a href="difference-in-difference.html#cb140-86" tabindex="-1"></a>}</span>
<span id="cb140-87"><a href="difference-in-difference.html#cb140-87" tabindex="-1"></a></span>
<span id="cb140-88"><a href="difference-in-difference.html#cb140-88" tabindex="-1"></a><span class="co">#Then we asees losses in the sample</span></span>
<span id="cb140-89"><a href="difference-in-difference.html#cb140-89" tabindex="-1"></a><span class="do">## For each PA of the sample, is the overlap too important or not</span></span>
<span id="cb140-90"><a href="difference-in-difference.html#cb140-90" tabindex="-1"></a>df_pa_overlap_focus <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb140-91"><a href="difference-in-difference.html#cb140-91" tabindex="-1"></a>  <span class="fu">filter</span>(iso3 <span class="sc">%in%</span> list_iso) <span class="sc">%&gt;%</span></span>
<span id="cb140-92"><a href="difference-in-difference.html#cb140-92" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(wdpa_pid, focus, marine, status_yr, status)) <span class="sc">%&gt;%</span></span>
<span id="cb140-93"><a href="difference-in-difference.html#cb140-93" tabindex="-1"></a>  <span class="fu">left_join</span>(df_pa_overlap, <span class="at">by =</span> <span class="st">&quot;wdpa_pid&quot;</span>)</span>
<span id="cb140-94"><a href="difference-in-difference.html#cb140-94" tabindex="-1"></a><span class="do">## The PA we can analyse </span></span>
<span id="cb140-95"><a href="difference-in-difference.html#cb140-95" tabindex="-1"></a>df_pa_overlap_ie <span class="ot">=</span> df_pa_overlap_focus <span class="sc">%&gt;%</span></span>
<span id="cb140-96"><a href="difference-in-difference.html#cb140-96" tabindex="-1"></a>  <span class="fu">filter</span>(marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Proposed&quot;</span>, <span class="st">&quot;Designated&quot;</span>, <span class="st">&quot;Inscribed&quot;</span>, <span class="st">&quot;Established&quot;</span>))</span>
<span id="cb140-97"><a href="difference-in-difference.html#cb140-97" tabindex="-1"></a>df_pa_overlap_ie_focus <span class="ot">=</span> df_pa_overlap_focus <span class="sc">%&gt;%</span></span>
<span id="cb140-98"><a href="difference-in-difference.html#cb140-98" tabindex="-1"></a>  <span class="fu">filter</span>(marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Proposed&quot;</span>, <span class="st">&quot;Designated&quot;</span>, <span class="st">&quot;Inscribed&quot;</span>, <span class="st">&quot;Established&quot;</span>) <span class="sc">&amp;</span> focus <span class="sc">==</span> T)</span>
<span id="cb140-99"><a href="difference-in-difference.html#cb140-99" tabindex="-1"></a><span class="co">#The PA we can analyse and with acceptable overlap extent</span></span>
<span id="cb140-100"><a href="difference-in-difference.html#cb140-100" tabindex="-1"></a>df_pa_overlap_ie_rm <span class="ot">=</span> df_pa_overlap_focus <span class="sc">%&gt;%</span></span>
<span id="cb140-101"><a href="difference-in-difference.html#cb140-101" tabindex="-1"></a>  <span class="fu">filter</span>(marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> rm_poly <span class="sc">==</span> F <span class="sc">&amp;</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Proposed&quot;</span>, <span class="st">&quot;Designated&quot;</span>, <span class="st">&quot;Inscribed&quot;</span>, <span class="st">&quot;Established&quot;</span>))</span>
<span id="cb140-102"><a href="difference-in-difference.html#cb140-102" tabindex="-1"></a>df_pa_overlap_ie_rm_focus <span class="ot">=</span> df_pa_overlap_focus <span class="sc">%&gt;%</span></span>
<span id="cb140-103"><a href="difference-in-difference.html#cb140-103" tabindex="-1"></a>  <span class="fu">filter</span>(marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;</span> rm_poly <span class="sc">==</span> F <span class="sc">&amp;</span> status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Proposed&quot;</span>, <span class="st">&quot;Designated&quot;</span>, <span class="st">&quot;Inscribed&quot;</span>, <span class="st">&quot;Established&quot;</span>) <span class="sc">&amp;</span> focus <span class="sc">==</span> T)</span></code></pre></div>
</div>
<div id="compute-losses-for-each-steps" class="section level3 hasAnchor" number="5.6.2">
<h3><span class="header-section-number">5.6.2</span> Compute losses for each steps<a href="difference-in-difference.html#compute-losses-for-each-steps" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="difference-in-difference.html#cb141-1" tabindex="-1"></a><span class="co">#Import the datasets</span></span>
<span id="cb141-2"><a href="difference-in-difference.html#cb141-2" tabindex="-1"></a><span class="do">## Input to post-processing (=output of pre-processing) -&gt; losses due to remove of PA overlap</span></span>
<span id="cb141-3"><a href="difference-in-difference.html#cb141-3" tabindex="-1"></a>df_list_post_in <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb141-4"><a href="difference-in-difference.html#cb141-4" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb141-5"><a href="difference-in-difference.html#cb141-5" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(load_dir, <span class="st">&quot;df_list_post_in.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb141-6"><a href="difference-in-difference.html#cb141-6" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb141-7"><a href="difference-in-difference.html#cb141-7" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb141-8"><a href="difference-in-difference.html#cb141-8" tabindex="-1"></a><span class="do">## Output of post-processing -&gt; losses due to absence of matching</span></span>
<span id="cb141-9"><a href="difference-in-difference.html#cb141-9" tabindex="-1"></a>df_list_post_out <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb141-10"><a href="difference-in-difference.html#cb141-10" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb141-11"><a href="difference-in-difference.html#cb141-11" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(load_dir, <span class="st">&quot;df_list_post_out.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb141-12"><a href="difference-in-difference.html#cb141-12" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb141-13"><a href="difference-in-difference.html#cb141-13" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb141-14"><a href="difference-in-difference.html#cb141-14" tabindex="-1"></a><span class="do">## Input of DiD : equivalent to output of post-processing a priori</span></span>
<span id="cb141-15"><a href="difference-in-difference.html#cb141-15" tabindex="-1"></a>df_list_did_in <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb141-16"><a href="difference-in-difference.html#cb141-16" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb141-17"><a href="difference-in-difference.html#cb141-17" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_did_in.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb141-18"><a href="difference-in-difference.html#cb141-18" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb141-19"><a href="difference-in-difference.html#cb141-19" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb141-20"><a href="difference-in-difference.html#cb141-20" tabindex="-1"></a><span class="do">## Output of DiD : losses due to a too small never treated group to compute DiD</span></span>
<span id="cb141-21"><a href="difference-in-difference.html#cb141-21" tabindex="-1"></a>df_list_did_out <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb141-22"><a href="difference-in-difference.html#cb141-22" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb141-23"><a href="difference-in-difference.html#cb141-23" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_did_out.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb141-24"><a href="difference-in-difference.html#cb141-24" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb141-25"><a href="difference-in-difference.html#cb141-25" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb141-26"><a href="difference-in-difference.html#cb141-26" tabindex="-1"></a></span>
<span id="cb141-27"><a href="difference-in-difference.html#cb141-27" tabindex="-1"></a><span class="co">#Compute losses (PA and countries)</span></span>
<span id="cb141-28"><a href="difference-in-difference.html#cb141-28" tabindex="-1"></a><span class="do">## Initial sample</span></span>
<span id="cb141-29"><a href="difference-in-difference.html#cb141-29" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-30"><a href="difference-in-difference.html#cb141-30" tabindex="-1"></a>n_pa_ini <span class="ot">=</span> <span class="fu">nrow</span>(data_pa) </span>
<span id="cb141-31"><a href="difference-in-difference.html#cb141-31" tabindex="-1"></a>n_ctry_ini <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(data_pa<span class="sc">$</span>iso3)) </span>
<span id="cb141-32"><a href="difference-in-difference.html#cb141-32" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-33"><a href="difference-in-difference.html#cb141-33" tabindex="-1"></a>n_pa_ini_focus <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(data_pa, focus <span class="sc">==</span> T)) </span>
<span id="cb141-34"><a href="difference-in-difference.html#cb141-34" tabindex="-1"></a>n_ctry_ini_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(data_pa, focus <span class="sc">==</span> T)<span class="sc">$</span>iso3))</span>
<span id="cb141-35"><a href="difference-in-difference.html#cb141-35" tabindex="-1"></a><span class="do">## Sub-sample (if so)</span></span>
<span id="cb141-36"><a href="difference-in-difference.html#cb141-36" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-37"><a href="difference-in-difference.html#cb141-37" tabindex="-1"></a>n_pa <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(data_pa, iso3 <span class="sc">%in%</span> list_iso_ie_focus)) </span>
<span id="cb141-38"><a href="difference-in-difference.html#cb141-38" tabindex="-1"></a>n_ctry <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(data_pa, iso3 <span class="sc">%in%</span> list_iso_ie_focus)<span class="sc">$</span>iso3))</span>
<span id="cb141-39"><a href="difference-in-difference.html#cb141-39" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-40"><a href="difference-in-difference.html#cb141-40" tabindex="-1"></a>n_pa_focus <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(data_pa, iso3 <span class="sc">%in%</span> list_iso_ie_focus <span class="sc">&amp;</span> focus <span class="sc">==</span> T))</span>
<span id="cb141-41"><a href="difference-in-difference.html#cb141-41" tabindex="-1"></a>n_ctry_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(data_pa, iso3 <span class="sc">%in%</span> list_iso_ie_focus <span class="sc">&amp;</span> focus <span class="sc">==</span> T)<span class="sc">$</span>iso3))</span>
<span id="cb141-42"><a href="difference-in-difference.html#cb141-42" tabindex="-1"></a><span class="do">## After matching pre-processing</span></span>
<span id="cb141-43"><a href="difference-in-difference.html#cb141-43" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-44"><a href="difference-in-difference.html#cb141-44" tabindex="-1"></a>n_pa_pre <span class="ot">=</span> <span class="fu">nrow</span>(df_list_post_in) </span>
<span id="cb141-45"><a href="difference-in-difference.html#cb141-45" tabindex="-1"></a>n_ctry_pre <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_list_post_in<span class="sc">$</span>iso3))</span>
<span id="cb141-46"><a href="difference-in-difference.html#cb141-46" tabindex="-1"></a><span class="do">#### Part due to filtering</span></span>
<span id="cb141-47"><a href="difference-in-difference.html#cb141-47" tabindex="-1"></a>n_pa_pre_filt <span class="ot">=</span> n_pa <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie<span class="sc">$</span>wdpaid))</span>
<span id="cb141-48"><a href="difference-in-difference.html#cb141-48" tabindex="-1"></a>n_ctry_pre_filt <span class="ot">=</span> n_ctry <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie<span class="sc">$</span>iso3))</span>
<span id="cb141-49"><a href="difference-in-difference.html#cb141-49" tabindex="-1"></a><span class="do">#### Part due to filtering AND overlap removal</span></span>
<span id="cb141-50"><a href="difference-in-difference.html#cb141-50" tabindex="-1"></a>n_pa_pre_filt_over <span class="ot">=</span> n_pa <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_rm<span class="sc">$</span>wdpaid))</span>
<span id="cb141-51"><a href="difference-in-difference.html#cb141-51" tabindex="-1"></a>n_ctry_pre_filt_over <span class="ot">=</span> n_ctry <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_rm<span class="sc">$</span>iso3))</span>
<span id="cb141-52"><a href="difference-in-difference.html#cb141-52" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-53"><a href="difference-in-difference.html#cb141-53" tabindex="-1"></a>n_pa_pre_focus <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(df_list_post_in, wdpaid <span class="sc">%in%</span> list_pa_ie_focus)) </span>
<span id="cb141-54"><a href="difference-in-difference.html#cb141-54" tabindex="-1"></a>n_ctry_pre_focus  <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_list_post_in, wdpaid <span class="sc">%in%</span> list_pa_ie_focus)<span class="sc">$</span>iso3))</span>
<span id="cb141-55"><a href="difference-in-difference.html#cb141-55" tabindex="-1"></a><span class="do">#### Part due to filtering</span></span>
<span id="cb141-56"><a href="difference-in-difference.html#cb141-56" tabindex="-1"></a>n_pa_pre_filt_focus <span class="ot">=</span> n_pa_focus <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_focus<span class="sc">$</span>wdpaid))</span>
<span id="cb141-57"><a href="difference-in-difference.html#cb141-57" tabindex="-1"></a>n_ctry_pre_filt_focus <span class="ot">=</span> n_ctry_focus <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_focus<span class="sc">$</span>iso3))</span>
<span id="cb141-58"><a href="difference-in-difference.html#cb141-58" tabindex="-1"></a><span class="do">#### Part due to filtering AND overlap removal</span></span>
<span id="cb141-59"><a href="difference-in-difference.html#cb141-59" tabindex="-1"></a>n_pa_pre_filt_over_focus <span class="ot">=</span> n_pa_focus <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_rm_focus<span class="sc">$</span>wdpaid))</span>
<span id="cb141-60"><a href="difference-in-difference.html#cb141-60" tabindex="-1"></a>n_ctry_pre_filt_over_focus <span class="ot">=</span> n_ctry_focus <span class="sc">-</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_pa_overlap_ie_rm_focus<span class="sc">$</span>iso3))</span>
<span id="cb141-61"><a href="difference-in-difference.html#cb141-61" tabindex="-1"></a></span>
<span id="cb141-62"><a href="difference-in-difference.html#cb141-62" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb141-63"><a href="difference-in-difference.html#cb141-63" tabindex="-1"></a><span class="co">#/!\ Some PA in the WDPA have a polygon that is badly reported : it can be located in a different country. This can explain a mismatch between the PA in input of the post-processing, and the PA in input of pre-processing minus losses related to filtering and overlap.</span></span>
<span id="cb141-64"><a href="difference-in-difference.html#cb141-64" tabindex="-1"></a><span class="co">#The following code makes it possible to visualize them on a map</span></span>
<span id="cb141-65"><a href="difference-in-difference.html#cb141-65" tabindex="-1"></a><span class="co"># df_poly_bad_report = df_pa_overlap_ie_rm %&gt;%</span></span>
<span id="cb141-66"><a href="difference-in-difference.html#cb141-66" tabindex="-1"></a><span class="co">#    filter(!(wdpaid %in% df_list_post_in$wdpaid))</span></span>
<span id="cb141-67"><a href="difference-in-difference.html#cb141-67" tabindex="-1"></a><span class="co"># mapview::mapview(df_poly_bad_report)</span></span>
<span id="cb141-68"><a href="difference-in-difference.html#cb141-68" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb141-69"><a href="difference-in-difference.html#cb141-69" tabindex="-1"></a></span>
<span id="cb141-70"><a href="difference-in-difference.html#cb141-70" tabindex="-1"></a><span class="do">## After matching post-processing (= before DiD)</span></span>
<span id="cb141-71"><a href="difference-in-difference.html#cb141-71" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-72"><a href="difference-in-difference.html#cb141-72" tabindex="-1"></a>n_pa_post <span class="ot">=</span> <span class="fu">nrow</span>(df_list_post_out) </span>
<span id="cb141-73"><a href="difference-in-difference.html#cb141-73" tabindex="-1"></a>n_ctry_post <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_list_post_out<span class="sc">$</span>iso3))</span>
<span id="cb141-74"><a href="difference-in-difference.html#cb141-74" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-75"><a href="difference-in-difference.html#cb141-75" tabindex="-1"></a>n_pa_post_focus <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(df_list_post_out, wdpaid <span class="sc">%in%</span> list_pa_ie_focus)) </span>
<span id="cb141-76"><a href="difference-in-difference.html#cb141-76" tabindex="-1"></a>n_ctry_post_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_list_post_out, wdpaid <span class="sc">%in%</span> list_pa_ie_focus)<span class="sc">$</span>iso3))</span>
<span id="cb141-77"><a href="difference-in-difference.html#cb141-77" tabindex="-1"></a><span class="do">## After DiD</span></span>
<span id="cb141-78"><a href="difference-in-difference.html#cb141-78" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-79"><a href="difference-in-difference.html#cb141-79" tabindex="-1"></a>n_pa_did <span class="ot">=</span> <span class="fu">nrow</span>(df_list_did_out) </span>
<span id="cb141-80"><a href="difference-in-difference.html#cb141-80" tabindex="-1"></a>n_ctry_did <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_list_did_out<span class="sc">$</span>iso3))</span>
<span id="cb141-81"><a href="difference-in-difference.html#cb141-81" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-82"><a href="difference-in-difference.html#cb141-82" tabindex="-1"></a>n_pa_did_focus <span class="ot">=</span> <span class="fu">nrow</span>(<span class="fu">filter</span>(df_list_did_out, wdpaid <span class="sc">%in%</span> list_pa_ie_focus))</span>
<span id="cb141-83"><a href="difference-in-difference.html#cb141-83" tabindex="-1"></a>n_ctry_did_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_list_did_out, wdpaid <span class="sc">%in%</span> list_pa_ie_focus)<span class="sc">$</span>iso3))</span>
<span id="cb141-84"><a href="difference-in-difference.html#cb141-84" tabindex="-1"></a><span class="do">## After final filtering : matching quality, pre-test, non-null forest cover before treatment</span></span>
<span id="cb141-85"><a href="difference-in-difference.html#cb141-85" tabindex="-1"></a><span class="do">### With non-academic filtering (only non-null forest cover)</span></span>
<span id="cb141-86"><a href="difference-in-difference.html#cb141-86" tabindex="-1"></a><span class="do">#### All PA</span></span>
<span id="cb141-87"><a href="difference-in-difference.html#cb141-87" tabindex="-1"></a>n_pa_final_noaca <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_fc_att_tidy_noaca<span class="sc">$</span>wdpaid))</span>
<span id="cb141-88"><a href="difference-in-difference.html#cb141-88" tabindex="-1"></a>n_ctry_final_noaca <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_fc_att_tidy_noaca<span class="sc">$</span>iso3))</span>
<span id="cb141-89"><a href="difference-in-difference.html#cb141-89" tabindex="-1"></a><span class="do">#### PA of interest</span></span>
<span id="cb141-90"><a href="difference-in-difference.html#cb141-90" tabindex="-1"></a>n_pa_final_noaca_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_att_tidy_noaca, focus <span class="sc">==</span> T)<span class="sc">$</span>wdpaid))</span>
<span id="cb141-91"><a href="difference-in-difference.html#cb141-91" tabindex="-1"></a>n_ctry_final_noaca_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_att_tidy_noaca, focus <span class="sc">==</span> T)<span class="sc">$</span>iso3))</span>
<span id="cb141-92"><a href="difference-in-difference.html#cb141-92" tabindex="-1"></a><span class="do">### With academic filtering (all)</span></span>
<span id="cb141-93"><a href="difference-in-difference.html#cb141-93" tabindex="-1"></a><span class="do">### All PA</span></span>
<span id="cb141-94"><a href="difference-in-difference.html#cb141-94" tabindex="-1"></a>n_pa_final_aca <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_fc_att_tidy_aca<span class="sc">$</span>wdpaid))</span>
<span id="cb141-95"><a href="difference-in-difference.html#cb141-95" tabindex="-1"></a>n_ctry_final_aca <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(df_fc_att_tidy_aca<span class="sc">$</span>iso3))</span>
<span id="cb141-96"><a href="difference-in-difference.html#cb141-96" tabindex="-1"></a><span class="do">### PA of interest</span></span>
<span id="cb141-97"><a href="difference-in-difference.html#cb141-97" tabindex="-1"></a>n_pa_final_aca_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_att_tidy_aca, focus <span class="sc">==</span> T)<span class="sc">$</span>wdpaid))</span>
<span id="cb141-98"><a href="difference-in-difference.html#cb141-98" tabindex="-1"></a>n_ctry_final_aca_focus <span class="ot">=</span> <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_att_tidy_aca, focus <span class="sc">==</span> T)<span class="sc">$</span>iso3))</span></code></pre></div>
</div>
</div>
<div id="compute-aggregated-metrics-at-country-and-region-level" class="section level2 hasAnchor" number="5.7">
<h2><span class="header-section-number">5.7</span> Compute aggregated metrics at country and region level<a href="difference-in-difference.html#compute-aggregated-metrics-at-country-and-region-level" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The aggregation of results at country and regional level is not necessarily relevant when the number of protected areas by country or region is relatively small and results heterogenous across protected areas. Instead, a figure displaying the results for all protected areas in the sample might be mor relevant. See next section.</p>
<div id="aggregation-of-treatment-effects" class="section level3 hasAnchor" number="5.7.1">
<h3><span class="header-section-number">5.7.1</span> Aggregation of treatment effects<a href="difference-in-difference.html#aggregation-of-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb142-1"><a href="difference-in-difference.html#cb142-1" tabindex="-1"></a><span class="co">#Call the function to aggregate results at country level and save plots</span></span>
<span id="cb142-2"><a href="difference-in-difference.html#cb142-2" tabindex="-1"></a><span class="do">##After non-academic filtering</span></span>
<span id="cb142-3"><a href="difference-in-difference.html#cb142-3" tabindex="-1"></a><span class="do">### For PA of interest</span></span>
<span id="cb142-4"><a href="difference-in-difference.html#cb142-4" tabindex="-1"></a><span class="fu">fn_plot_att_agg</span>(<span class="at">df_fc_att =</span> df_fc_att_tidy_noaca,</span>
<span id="cb142-5"><a href="difference-in-difference.html#cb142-5" tabindex="-1"></a>                <span class="at">df_fl_att =</span> df_fl_att_tidy_noaca,</span>
<span id="cb142-6"><a href="difference-in-difference.html#cb142-6" tabindex="-1"></a>                <span class="at">is_focus =</span> T,</span>
<span id="cb142-7"><a href="difference-in-difference.html#cb142-7" tabindex="-1"></a>                <span class="at">alpha =</span> alpha,</span>
<span id="cb142-8"><a href="difference-in-difference.html#cb142-8" tabindex="-1"></a>                <span class="at">save_dir =</span> save_dir)</span>
<span id="cb142-9"><a href="difference-in-difference.html#cb142-9" tabindex="-1"></a><span class="do">### For other PA</span></span>
<span id="cb142-10"><a href="difference-in-difference.html#cb142-10" tabindex="-1"></a><span class="fu">fn_plot_att_agg</span>(<span class="at">df_fc_att =</span> df_fc_att_tidy_noaca,</span>
<span id="cb142-11"><a href="difference-in-difference.html#cb142-11" tabindex="-1"></a>                <span class="at">df_fl_att =</span> df_fl_att_tidy_noaca,</span>
<span id="cb142-12"><a href="difference-in-difference.html#cb142-12" tabindex="-1"></a>                <span class="at">is_focus =</span> F,</span>
<span id="cb142-13"><a href="difference-in-difference.html#cb142-13" tabindex="-1"></a>                <span class="at">alpha =</span> alpha,</span>
<span id="cb142-14"><a href="difference-in-difference.html#cb142-14" tabindex="-1"></a>                <span class="at">save_dir =</span> save_dir)</span></code></pre></div>
</div>
<div id="aggregation-of-annual-deforestation-rates" class="section level3 hasAnchor" number="5.7.2">
<h3><span class="header-section-number">5.7.2</span> Aggregation of annual deforestation rates<a href="difference-in-difference.html#aggregation-of-annual-deforestation-rates" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="difference-in-difference.html#cb143-1" tabindex="-1"></a><span class="co">#Aggregate at region level</span></span>
<span id="cb143-2"><a href="difference-in-difference.html#cb143-2" tabindex="-1"></a><span class="do">## Compute for each region, for treated units, average annual deforestation rate before treatment, after treatment and on the full period. Confidence intervals are also computed.</span></span>
<span id="cb143-3"><a href="difference-in-difference.html#cb143-3" tabindex="-1"></a><span class="co"># avg_fl_annual_wolf_region = df_fl_annual_wolf %&gt;%</span></span>
<span id="cb143-4"><a href="difference-in-difference.html#cb143-4" tabindex="-1"></a><span class="co">#   filter(group == &quot;Treated&quot;) %&gt;%</span></span>
<span id="cb143-5"><a href="difference-in-difference.html#cb143-5" tabindex="-1"></a><span class="co">#   group_by(region) %&gt;%</span></span>
<span id="cb143-6"><a href="difference-in-difference.html#cb143-6" tabindex="-1"></a><span class="co">#   summarize(avg_FL_annual_wolf_pre = mean(avgFL_annual_wolf_pre, na.rm = TRUE),</span></span>
<span id="cb143-7"><a href="difference-in-difference.html#cb143-7" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_pre_ci_up = mean(avgFL_annual_wolf_pre, na.rm = TRUE) +  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_pre, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-8"><a href="difference-in-difference.html#cb143-8" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_pre_ci_lower = mean(avgFL_annual_wolf_pre, na.rm = TRUE) -  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_pre, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-9"><a href="difference-in-difference.html#cb143-9" tabindex="-1"></a><span class="co">#             med_FL_annual_wolf_pre_ci_up = median(avgFL_annual_wolf_pre, na.rm = TRUE),</span></span>
<span id="cb143-10"><a href="difference-in-difference.html#cb143-10" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot = mean(avgFL_annual_wolf_tot, na.rm = TRUE),</span></span>
<span id="cb143-11"><a href="difference-in-difference.html#cb143-11" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot_ci_up = mean(avgFL_annual_wolf_tot, na.rm = TRUE) +  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_tot, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-12"><a href="difference-in-difference.html#cb143-12" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot_ci_lower = mean(avgFL_annual_wolf_tot, na.rm = TRUE) -  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_tot, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-13"><a href="difference-in-difference.html#cb143-13" tabindex="-1"></a><span class="co">#             med_FL_annual_wolf_tot_ci_up = median(avgFL_annual_wolf_tot, na.rm = TRUE)) </span></span>
<span id="cb143-14"><a href="difference-in-difference.html#cb143-14" tabindex="-1"></a></span>
<span id="cb143-15"><a href="difference-in-difference.html#cb143-15" tabindex="-1"></a><span class="co">#Aggregate at country level</span></span>
<span id="cb143-16"><a href="difference-in-difference.html#cb143-16" tabindex="-1"></a><span class="do">## Same that at region level.</span></span>
<span id="cb143-17"><a href="difference-in-difference.html#cb143-17" tabindex="-1"></a><span class="co"># avg_fl_annual_wolf_country = df_fl_annual_wolf %&gt;%</span></span>
<span id="cb143-18"><a href="difference-in-difference.html#cb143-18" tabindex="-1"></a><span class="co">#   filter(group == &quot;Treated&quot;) %&gt;%</span></span>
<span id="cb143-19"><a href="difference-in-difference.html#cb143-19" tabindex="-1"></a><span class="co">#   group_by(iso3) %&gt;%</span></span>
<span id="cb143-20"><a href="difference-in-difference.html#cb143-20" tabindex="-1"></a><span class="co">#   summarize(avg_FL_annual_wolf_pre = mean(avgFL_annual_wolf_pre, na.rm = TRUE),</span></span>
<span id="cb143-21"><a href="difference-in-difference.html#cb143-21" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_pre_ci_up = mean(avgFL_annual_wolf_pre, na.rm = TRUE) +  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_pre, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-22"><a href="difference-in-difference.html#cb143-22" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_pre_ci_lower = mean(avgFL_annual_wolf_pre, na.rm = TRUE) -  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_pre, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-23"><a href="difference-in-difference.html#cb143-23" tabindex="-1"></a><span class="co">#             med_FL_annual_wolf_pre_ci_up = median(avgFL_annual_wolf_pre, na.rm = TRUE),</span></span>
<span id="cb143-24"><a href="difference-in-difference.html#cb143-24" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot = mean(avgFL_annual_wolf_tot, na.rm = TRUE),</span></span>
<span id="cb143-25"><a href="difference-in-difference.html#cb143-25" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot_ci_up = mean(avgFL_annual_wolf_tot, na.rm = TRUE) +  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_tot, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-26"><a href="difference-in-difference.html#cb143-26" tabindex="-1"></a><span class="co">#             avg_FL_annual_wolf_tot_ci_lower = mean(avgFL_annual_wolf_tot, na.rm = TRUE) -  qt((1-alpha)/2,df=21-1)*sd(avgFL_annual_wolf_tot, na.rm = TRUE)/sqrt(21),</span></span>
<span id="cb143-27"><a href="difference-in-difference.html#cb143-27" tabindex="-1"></a><span class="co">#             med_FL_annual_wolf_tot_ci_up = median(avgFL_annual_wolf_tot, na.rm = TRUE)) %&gt;%</span></span>
<span id="cb143-28"><a href="difference-in-difference.html#cb143-28" tabindex="-1"></a><span class="co">#   ungroup() </span></span></code></pre></div>
</div>
<div id="average-and-total-forest-loss-on-the-period-at-country-and-region-level" class="section level3 hasAnchor" number="5.7.3">
<h3><span class="header-section-number">5.7.3</span> Average and total forest loss on the period, at country and region level<a href="difference-in-difference.html#average-and-total-forest-loss-on-the-period-at-country-and-region-level" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For each protected area, the total deforestation is estimated on the period in the protected area and a counterfactual, before and after matching. This metric can be aggregated at country and region level : the sum of total deforestation or its average. This can be computed for all protected areas in the sample, a specific subset of protected areas, but also at country or region level.</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb144-1"><a href="difference-in-difference.html#cb144-1" tabindex="-1"></a><span class="co">#Import datasets</span></span>
<span id="cb144-2"><a href="difference-in-difference.html#cb144-2" tabindex="-1"></a>df_plot_forest_loss <span class="ot">=</span> aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb144-3"><a href="difference-in-difference.html#cb144-3" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb144-4"><a href="difference-in-difference.html#cb144-4" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_fl_2000_2021.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb144-5"><a href="difference-in-difference.html#cb144-5" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb144-6"><a href="difference-in-difference.html#cb144-6" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb144-7"><a href="difference-in-difference.html#cb144-7" tabindex="-1"></a></span>
<span id="cb144-8"><a href="difference-in-difference.html#cb144-8" tabindex="-1"></a></span>
<span id="cb144-9"><a href="difference-in-difference.html#cb144-9" tabindex="-1"></a><span class="co">#After non-academic filtering</span></span>
<span id="cb144-10"><a href="difference-in-difference.html#cb144-10" tabindex="-1"></a>df_plot_forest_loss_noaca <span class="ot">=</span> df_plot_forest_loss <span class="sc">%&gt;%</span></span>
<span id="cb144-11"><a href="difference-in-difference.html#cb144-11" tabindex="-1"></a>  <span class="fu">filter</span>(wdpaid <span class="sc">%in%</span> list_pa_fc_2000)</span>
<span id="cb144-12"><a href="difference-in-difference.html#cb144-12" tabindex="-1"></a></span>
<span id="cb144-13"><a href="difference-in-difference.html#cb144-13" tabindex="-1"></a><span class="co">#Call a fcuntion to plot total and average forest loss on the 2000-2021 period, for PA of interest and others</span></span>
<span id="cb144-14"><a href="difference-in-difference.html#cb144-14" tabindex="-1"></a><span class="fu">fn_plot_forest_loss_agg</span>(<span class="at">df_plot_forest_loss =</span> df_plot_forest_loss_noaca,</span>
<span id="cb144-15"><a href="difference-in-difference.html#cb144-15" tabindex="-1"></a>                        <span class="at">alpha =</span> alpha,</span>
<span id="cb144-16"><a href="difference-in-difference.html#cb144-16" tabindex="-1"></a>                        <span class="at">save_dir =</span> save_dir)</span></code></pre></div>
</div>
</div>
<div id="display-treatment-effects" class="section level2 hasAnchor" number="5.8">
<h2><span class="header-section-number">5.8</span> Display treatment effects<a href="difference-in-difference.html#display-treatment-effects" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="in-figures-and-tables" class="section level2 hasAnchor" number="5.9">
<h2><span class="header-section-number">5.9</span> In figures and tables<a href="difference-in-difference.html#in-figures-and-tables" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The treatment effects computed for each protected areas can be displayed in figures or tables. Again, a function is used for protected areas supported by the AFD to include information on funding (funding year for instance), and an other for non-supported ones.</p>
<p>Note some protected areas can be removed from the display, because the matching is not satisfying or pre-treatment trends are too different between treated and control units (thus the matched control risk to be an irrelevant counterfactual). Also, one might want to highlight some protected areas. For instance when comparing a subset of protected areas in a given country to the others (protected areas in Madagascar supported by the AFD versus the others for instance).</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="difference-in-difference.html#cb145-1" tabindex="-1"></a><span class="co"># Define a list of protected areas where a focus is needed</span></span>
<span id="cb145-2"><a href="difference-in-difference.html#cb145-2" tabindex="-1"></a>list_wdpa_focus <span class="ot">=</span> list_pa_ie_focus</span>
<span id="cb145-3"><a href="difference-in-difference.html#cb145-3" tabindex="-1"></a>list_iso_focus <span class="ot">=</span> <span class="fu">unique</span>(<span class="fu">filter</span>(df_fc_att_tidy_noaca, focus <span class="sc">==</span> T)<span class="sc">$</span>iso3)</span>
<span id="cb145-4"><a href="difference-in-difference.html#cb145-4" tabindex="-1"></a></span>
<span id="cb145-5"><a href="difference-in-difference.html#cb145-5" tabindex="-1"></a><span class="co"># A function to create figures and tables</span></span>
<span id="cb145-6"><a href="difference-in-difference.html#cb145-6" tabindex="-1"></a><span class="do">##For AFD supported protected areas (funding info)</span></span>
<span id="cb145-7"><a href="difference-in-difference.html#cb145-7" tabindex="-1"></a><span class="do">### For each WDPAID supported by AFD, is it at least once supported by KfW or FFEM ?</span></span>
<span id="cb145-8"><a href="difference-in-difference.html#cb145-8" tabindex="-1"></a>df_fund_cof <span class="ot">=</span> data_fund_nodupl <span class="sc">%&gt;%</span></span>
<span id="cb145-9"><a href="difference-in-difference.html#cb145-9" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> F) <span class="sc">%&gt;%</span></span>
<span id="cb145-10"><a href="difference-in-difference.html#cb145-10" tabindex="-1"></a>  <span class="fu">group_by</span>(wdpaid) <span class="sc">%&gt;%</span></span>
<span id="cb145-11"><a href="difference-in-difference.html#cb145-11" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">id_projet =</span> <span class="fu">paste</span>(id_projet, <span class="at">collapse =</span> <span class="st">&quot;,&quot;</span>),</span>
<span id="cb145-12"><a href="difference-in-difference.html#cb145-12" tabindex="-1"></a>            <span class="at">ffem =</span> <span class="fu">sum</span>(ffem, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb145-13"><a href="difference-in-difference.html#cb145-13" tabindex="-1"></a>            <span class="at">kfw =</span> <span class="fu">sum</span>(kfw, <span class="at">na.rm =</span> T)) <span class="sc">%&gt;%</span></span>
<span id="cb145-14"><a href="difference-in-difference.html#cb145-14" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb145-15"><a href="difference-in-difference.html#cb145-15" tabindex="-1"></a></span>
<span id="cb145-16"><a href="difference-in-difference.html#cb145-16" tabindex="-1"></a>df_fc_att_tidy_noaca_afd <span class="ot">=</span> df_fc_att_tidy_noaca <span class="sc">%&gt;%</span></span>
<span id="cb145-17"><a href="difference-in-difference.html#cb145-17" tabindex="-1"></a>  <span class="fu">left_join</span>(df_fund_cof, <span class="at">by =</span> <span class="st">&quot;wdpaid&quot;</span>) </span>
<span id="cb145-18"><a href="difference-in-difference.html#cb145-18" tabindex="-1"></a>df_fl_att_tidy_noaca_afd <span class="ot">=</span> df_fl_att_tidy_noaca <span class="sc">%&gt;%</span></span>
<span id="cb145-19"><a href="difference-in-difference.html#cb145-19" tabindex="-1"></a>  <span class="fu">left_join</span>(df_fund_cof, <span class="at">by =</span> <span class="st">&quot;wdpaid&quot;</span>)</span>
<span id="cb145-20"><a href="difference-in-difference.html#cb145-20" tabindex="-1"></a></span>
<span id="cb145-21"><a href="difference-in-difference.html#cb145-21" tabindex="-1"></a><span class="fu">fn_plot_att_afd</span>(<span class="at">df_fc_att =</span> df_fc_att_tidy_noaca_afd,</span>
<span id="cb145-22"><a href="difference-in-difference.html#cb145-22" tabindex="-1"></a>            <span class="at">df_fl_att =</span> df_fl_att_tidy_noaca_afd,</span>
<span id="cb145-23"><a href="difference-in-difference.html#cb145-23" tabindex="-1"></a>            <span class="at">list_pa_focus =</span> list_wdpa_focus,</span>
<span id="cb145-24"><a href="difference-in-difference.html#cb145-24" tabindex="-1"></a>            <span class="at">list_iso_focus =</span> list_iso_focus,</span>
<span id="cb145-25"><a href="difference-in-difference.html#cb145-25" tabindex="-1"></a>            <span class="at">alpha =</span> alpha,</span>
<span id="cb145-26"><a href="difference-in-difference.html#cb145-26" tabindex="-1"></a>            <span class="at">save_dir =</span> save_dir)</span>
<span id="cb145-27"><a href="difference-in-difference.html#cb145-27" tabindex="-1"></a></span>
<span id="cb145-28"><a href="difference-in-difference.html#cb145-28" tabindex="-1"></a><span class="do">##For other protected areas (no funding info in plots)</span></span>
<span id="cb145-29"><a href="difference-in-difference.html#cb145-29" tabindex="-1"></a><span class="co"># fn_plot_att_general(df_fc_att = df_fc_att_tidy_noaca,</span></span>
<span id="cb145-30"><a href="difference-in-difference.html#cb145-30" tabindex="-1"></a><span class="co">#             df_fl_att = df_fl_att_tidy_noaca, </span></span>
<span id="cb145-31"><a href="difference-in-difference.html#cb145-31" tabindex="-1"></a><span class="co">#             list_focus = list_wdpa_focus,</span></span>
<span id="cb145-32"><a href="difference-in-difference.html#cb145-32" tabindex="-1"></a><span class="co">#             alpha = alpha,</span></span>
<span id="cb145-33"><a href="difference-in-difference.html#cb145-33" tabindex="-1"></a><span class="co">#             save_dir = save_dir)</span></span></code></pre></div>
<div id="on-a-map" class="section level3 hasAnchor" number="5.9.1">
<h3><span class="header-section-number">5.9.1</span> On a map<a href="difference-in-difference.html#on-a-map" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>On a map, we want to plot for each country the polygon of all PA (of interest and others), their estimated treatment effect (5 and 10 years) , their significance. <em>This step is still under development.</em></p>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="difference-in-difference.html#cb146-1" tabindex="-1"></a><span class="co">#For forest cover, non-academic filtering</span></span>
<span id="cb146-2"><a href="difference-in-difference.html#cb146-2" tabindex="-1"></a>df_att_map <span class="ot">=</span> df_fc_att_tidy_noaca <span class="sc">%&gt;%</span></span>
<span id="cb146-3"><a href="difference-in-difference.html#cb146-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(att_pa, att_pix,  cband_lower_pix, cband_upper_pix, cband_lower_pa, cband_upper_pa, cband_lower_per, cband_upper_per, sig, sig_end, alpha, c, se, n)) <span class="sc">%&gt;%</span></span>
<span id="cb146-4"><a href="difference-in-difference.html#cb146-4" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>))</span>
<span id="cb146-5"><a href="difference-in-difference.html#cb146-5" tabindex="-1"></a><span class="do">##Reste à pivoter et ajouter polygone depuis la WDPA avec WDPA_PID. </span></span></code></pre></div>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="matching.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="references.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vuillota/EVA-impact-aires-protegees/edit/main/02_did.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/vuillota/EVA-impact-aires-protegees/raw/main/02_did.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"code_folding": "hide"
});
});
</script>

</body>

</html>
