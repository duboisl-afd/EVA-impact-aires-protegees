<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>A Functions for matching pre- and post-processing | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="A Functions for matching pre- and post-processing | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="vuillota/EVA-impact-aires-protegees.git" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="A Functions for matching pre- and post-processing | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Antoine Vuillot" />
<meta name="author" content="Ingrid Dallmann" />
<meta name="author" content="Léa Poulin" />
<meta name="author" content="Pierre-Yves Durand" />


<meta name="date" content="2023-11-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="references.html"/>
<link rel="next" href="functions-for-difference-in-difference-computations.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Impact analysis of protected areas funded by the AFD</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this website</a></li>
<li class="chapter" data-level="1" data-path="building-the-datasets.html"><a href="building-the-datasets.html"><i class="fa fa-check"></i><b>1</b> Building the datasets</a>
<ul>
<li class="chapter" data-level="1.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#initial-settings"><i class="fa fa-check"></i><b>1.1</b> Initial settings</a></li>
<li class="chapter" data-level="1.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-analysis"><i class="fa fa-check"></i><b>1.2</b> Datasets for analysis</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-pas-reporting-by-afd-technical-departments"><i class="fa fa-check"></i><b>1.2.1</b> Merge PAs reporting by AFD technical departments</a></li>
<li class="chapter" data-level="1.2.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-the-list-of-pas-to-afd-project-information-and-wdpa"><i class="fa fa-check"></i><b>1.2.2</b> Merge the list of PAs to AFD project information and WDPA</a></li>
<li class="chapter" data-level="1.2.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#correct-errors"><i class="fa fa-check"></i><b>1.2.3</b> Correct errors</a></li>
<li class="chapter" data-level="1.2.4" data-path="building-the-datasets.html"><a href="building-the-datasets.html#tidy-the-datasets"><i class="fa fa-check"></i><b>1.2.4</b> Tidy the datasets</a></li>
<li class="chapter" data-level="1.2.5" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-with-only-afd-project-variables"><i class="fa fa-check"></i><b>1.2.5</b> Dataset with only AFD project variables</a></li>
<li class="chapter" data-level="1.2.6" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-for-non-confidential-analysis"><i class="fa fa-check"></i><b>1.2.6</b> Dataset for non-confidential analysis</a></li>
<li class="chapter" data-level="1.2.7" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-confidential-analysis"><i class="fa fa-check"></i><b>1.2.7</b> Datasets for confidential analysis</a></li>
<li class="chapter" data-level="1.2.8" data-path="building-the-datasets.html"><a href="building-the-datasets.html#a-polygon-dataset-for-specific-use"><i class="fa fa-check"></i><b>1.2.8</b> A polygon dataset for specific use</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-covered-by-pas-in-the-sample"><i class="fa fa-check"></i><b>1.3</b> Computing total areas covered by PAs in the sample</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computations-of-polygons-area"><i class="fa fa-check"></i><b>1.3.1</b> Computations of polygons’ area</a></li>
<li class="chapter" data-level="1.3.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-the-intersection-at-country-region-world-level"><i class="fa fa-check"></i><b>1.3.2</b> Computing the intersection at country, region, world level</a></li>
<li class="chapter" data-level="1.3.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-without-intersection"><i class="fa fa-check"></i><b>1.3.3</b> Computing total areas without intersection</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Descriptive statistics</b></span></li>
<li class="chapter" data-level="2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html"><i class="fa fa-check"></i><b>2</b> Projects funded by the AFD</a>
<ul>
<li class="chapter" data-level="2.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#initial-settings-1"><i class="fa fa-check"></i><b>2.1</b> Initial settings</a></li>
<li class="chapter" data-level="2.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#importing-the-datasets"><i class="fa fa-check"></i><b>2.2</b> Importing the datasets</a></li>
<li class="chapter" data-level="2.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#performing-descriptive-statistics"><i class="fa fa-check"></i><b>2.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#iucn-categories"><i class="fa fa-check"></i><b>2.3.1</b> IUCN categories</a></li>
<li class="chapter" data-level="2.3.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#ecosystems-excluding-non-referenced-pas"><i class="fa fa-check"></i><b>2.3.2</b> Ecosystems (excluding non-referenced PAs)</a></li>
<li class="chapter" data-level="2.3.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#distribution-and-surface-of-pas-across-countries-and-regions"><i class="fa fa-check"></i><b>2.3.3</b> Distribution (# and surface) of PAs across countries and regions</a></li>
<li class="chapter" data-level="2.3.4" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#surface-of-pas"><i class="fa fa-check"></i><b>2.3.4</b> Surface of PAs</a></li>
<li class="chapter" data-level="2.3.5" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#temporal-evolution"><i class="fa fa-check"></i><b>2.3.5</b> Temporal evolution</a></li>
<li class="chapter" data-level="2.3.6" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#governance"><i class="fa fa-check"></i><b>2.3.6</b> Governance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html"><i class="fa fa-check"></i><b>3</b> Miscellaneous statistics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#initial-settings-2"><i class="fa fa-check"></i><b>3.1</b> Initial settings</a></li>
<li class="chapter" data-level="3.2" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#importing-datasets"><i class="fa fa-check"></i><b>3.2</b> Importing datasets</a></li>
<li class="chapter" data-level="3.3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#performing-descriptive-statistics-1"><i class="fa fa-check"></i><b>3.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#pa-of-interest-other-pa-and-all-pa-in-a-given-sample"><i class="fa fa-check"></i><b>3.3.1</b> PA of interest, other PA and all PA in a given sample</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-tree-cover-and-deforestation"><i class="fa fa-check"></i><b>3.4</b> Evolution of tree cover and deforestation</a></li>
<li class="chapter" data-level="3.5" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#forest-cover-by-country"><i class="fa fa-check"></i><b>3.5</b> Forest cover by country</a></li>
<li class="chapter" data-level="3.6" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-sample"><i class="fa fa-check"></i><b>3.6</b> Mapping of sample</a></li>
<li class="chapter" data-level="3.7" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-results"><i class="fa fa-check"></i><b>3.7</b> Mapping of results</a></li>
<li class="chapter" data-level="3.8" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-forest-cover-for-specific-polygons"><i class="fa fa-check"></i><b>3.8</b> Evolution of forest cover for specific polygons</a></li>
</ul></li>
<li class="part"><span><b>Impact analysis</b></span></li>
<li class="chapter" data-level="4" data-path="matching.html"><a href="matching.html"><i class="fa fa-check"></i><b>4</b> Matching</a>
<ul>
<li class="chapter" data-level="4.1" data-path="matching.html"><a href="matching.html#initial-settings-3"><i class="fa fa-check"></i><b>4.1</b> Initial settings</a></li>
<li class="chapter" data-level="4.2" data-path="matching.html"><a href="matching.html#datasets-and-critical-parameters"><i class="fa fa-check"></i><b>4.2</b> Datasets and critical parameters</a></li>
<li class="chapter" data-level="4.3" data-path="matching.html"><a href="matching.html#matching-process"><i class="fa fa-check"></i><b>4.3</b> Matching process</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="difference-in-difference.html"><a href="difference-in-difference.html"><i class="fa fa-check"></i><b>5</b> Difference-in-difference</a>
<ul>
<li class="chapter" data-level="5.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#initial-settings-4"><i class="fa fa-check"></i><b>5.1</b> Initial settings</a></li>
<li class="chapter" data-level="5.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#load-datasets-and-define-critical-parameters"><i class="fa fa-check"></i><b>5.2</b> Load datasets and define critical parameters</a></li>
<li class="chapter" data-level="5.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#computing-treatment-effects-at-protected-area-level"><i class="fa fa-check"></i><b>5.3</b> Computing treatment effects at protected area level</a></li>
<li class="chapter" data-level="5.4" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-quality-of-matching-and-pre-test"><i class="fa fa-check"></i><b>5.4</b> Assess the quality of matching and pre-test</a></li>
<li class="chapter" data-level="5.5" data-path="difference-in-difference.html"><a href="difference-in-difference.html#tidy-datasets-with-acceptable-quality"><i class="fa fa-check"></i><b>5.5</b> Tidy datasets with acceptable quality</a></li>
<li class="chapter" data-level="5.6" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-loss-of-observations"><i class="fa fa-check"></i><b>5.6</b> Assess the loss of observations</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-overlap-removal"><i class="fa fa-check"></i><b>5.6.1</b> Compute overlap removal</a></li>
<li class="chapter" data-level="5.6.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-losses-for-each-steps"><i class="fa fa-check"></i><b>5.6.2</b> Compute losses for each steps</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-aggregated-metrics-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7</b> Compute aggregated metrics at country and region level</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-treatment-effects"><i class="fa fa-check"></i><b>5.7.1</b> Aggregation of treatment effects</a></li>
<li class="chapter" data-level="5.7.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-annual-deforestation-rates"><i class="fa fa-check"></i><b>5.7.2</b> Aggregation of annual deforestation rates</a></li>
<li class="chapter" data-level="5.7.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#average-and-total-forest-loss-on-the-period-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7.3</b> Average and total forest loss on the period, at country and region level</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="difference-in-difference.html"><a href="difference-in-difference.html#display-treatment-effects"><i class="fa fa-check"></i><b>5.8</b> Display treatment effects</a></li>
<li class="chapter" data-level="5.9" data-path="difference-in-difference.html"><a href="difference-in-difference.html#in-figures-and-tables"><i class="fa fa-check"></i><b>5.9</b> In figures and tables</a>
<ul>
<li class="chapter" data-level="5.9.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#on-a-map"><i class="fa fa-check"></i><b>5.9.1</b> On a map</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="functions-for-matching-pre--and-post-processing.html"><a href="functions-for-matching-pre--and-post-processing.html"><i class="fa fa-check"></i><b>A</b> Functions for matching pre- and post-processing</a></li>
<li class="chapter" data-level="B" data-path="functions-for-difference-in-difference-computations.html"><a href="functions-for-difference-in-difference-computations.html"><i class="fa fa-check"></i><b>B</b> Functions for difference-in-difference computations</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="functions-for-matching-pre--and-post-processing" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">A</span> Functions for matching pre- and post-processing<a href="functions-for-matching-pre--and-post-processing.html#functions-for-matching-pre--and-post-processing" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb147-2"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2" tabindex="-1"></a><span class="co">#Functions for matching process</span></span>
<span id="cb147-3"><a href="functions-for-matching-pre--and-post-processing.html#cb147-3" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb147-4"><a href="functions-for-matching-pre--and-post-processing.html#cb147-4" tabindex="-1"></a></span>
<span id="cb147-5"><a href="functions-for-matching-pre--and-post-processing.html#cb147-5" tabindex="-1"></a><span class="co">#For each function, the aim of the function, inputs, outputs, data saved and notes are detailed. This takes the following form :</span></span>
<span id="cb147-6"><a href="functions-for-matching-pre--and-post-processing.html#cb147-6" tabindex="-1"></a><span class="co">#Aim of the function</span></span>
<span id="cb147-7"><a href="functions-for-matching-pre--and-post-processing.html#cb147-7" tabindex="-1"></a><span class="do">##INPUTS : the arguments needed in the function</span></span>
<span id="cb147-8"><a href="functions-for-matching-pre--and-post-processing.html#cb147-8" tabindex="-1"></a><span class="do">###INPUT 1 to N</span></span>
<span id="cb147-9"><a href="functions-for-matching-pre--and-post-processing.html#cb147-9" tabindex="-1"></a><span class="do">##OUTPUTS : the information returned by the function (data frames, numeric, characters, etc.) and necessary to pursue to processing</span></span>
<span id="cb147-10"><a href="functions-for-matching-pre--and-post-processing.html#cb147-10" tabindex="-1"></a><span class="do">### OUTPUT 1 to N</span></span>
<span id="cb147-11"><a href="functions-for-matching-pre--and-post-processing.html#cb147-11" tabindex="-1"></a><span class="do">##DATA SAVED : information put in the storage but not necessarily need to pursue the processing (figures, tables, data frames, etc.)</span></span>
<span id="cb147-12"><a href="functions-for-matching-pre--and-post-processing.html#cb147-12" tabindex="-1"></a><span class="do">### ...</span></span>
<span id="cb147-13"><a href="functions-for-matching-pre--and-post-processing.html#cb147-13" tabindex="-1"></a><span class="do">##NOTES : any useful remark</span></span>
<span id="cb147-14"><a href="functions-for-matching-pre--and-post-processing.html#cb147-14" tabindex="-1"></a><span class="do">### ...</span></span>
<span id="cb147-15"><a href="functions-for-matching-pre--and-post-processing.html#cb147-15" tabindex="-1"></a></span>
<span id="cb147-16"><a href="functions-for-matching-pre--and-post-processing.html#cb147-16" tabindex="-1"></a><span class="co">#Remarks :</span></span>
<span id="cb147-17"><a href="functions-for-matching-pre--and-post-processing.html#cb147-17" tabindex="-1"></a><span class="do">##most functions are adapted for errors handling using base::withCallingHandlers(). Basically, the computation steps are declared in a block of withCallingHandlers function, while two other blocks specify what to do in case the first block face a warning or error. In our case, errors led to return a boolean indicating an error has occured and append the log with the error message. Warnings return a boolean but do not block the iteration. They also edit the log with the warning message.</span></span>
<span id="cb147-18"><a href="functions-for-matching-pre--and-post-processing.html#cb147-18" tabindex="-1"></a><span class="do">##PA is used for &quot;protected area(s)&quot;.</span></span>
<span id="cb147-19"><a href="functions-for-matching-pre--and-post-processing.html#cb147-19" tabindex="-1"></a><span class="do">##To save plots and tables : save on temporary folder in the R session then put the saved object in the storage. Indeed print() and ggplot::ggsave() cannot write directly on s3 storage</span></span>
<span id="cb147-20"><a href="functions-for-matching-pre--and-post-processing.html#cb147-20" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb147-21"><a href="functions-for-matching-pre--and-post-processing.html#cb147-21" tabindex="-1"></a></span>
<span id="cb147-22"><a href="functions-for-matching-pre--and-post-processing.html#cb147-22" tabindex="-1"></a></span>
<span id="cb147-23"><a href="functions-for-matching-pre--and-post-processing.html#cb147-23" tabindex="-1"></a><span class="co">#Pre-processing</span></span>
<span id="cb147-24"><a href="functions-for-matching-pre--and-post-processing.html#cb147-24" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb147-25"><a href="functions-for-matching-pre--and-post-processing.html#cb147-25" tabindex="-1"></a></span>
<span id="cb147-26"><a href="functions-for-matching-pre--and-post-processing.html#cb147-26" tabindex="-1"></a><span class="co">#Create a log to track progress of the processing (warnings, errors, parameters, country and PAs analyzed, etc.)</span></span>
<span id="cb147-27"><a href="functions-for-matching-pre--and-post-processing.html#cb147-27" tabindex="-1"></a><span class="do">##INPUTS :</span></span>
<span id="cb147-28"><a href="functions-for-matching-pre--and-post-processing.html#cb147-28" tabindex="-1"></a><span class="do">###list_iso : the list of ISO3 code corresponding to the countries analyzed</span></span>
<span id="cb147-29"><a href="functions-for-matching-pre--and-post-processing.html#cb147-29" tabindex="-1"></a><span class="do">### buffer : the buffer width in meter</span></span>
<span id="cb147-30"><a href="functions-for-matching-pre--and-post-processing.html#cb147-30" tabindex="-1"></a><span class="do">### sampling : the sampling specified by the user for the smaller area in the country considered</span></span>
<span id="cb147-31"><a href="functions-for-matching-pre--and-post-processing.html#cb147-31" tabindex="-1"></a><span class="do">### yr_first : the first year of the period where the analysis takes place</span></span>
<span id="cb147-32"><a href="functions-for-matching-pre--and-post-processing.html#cb147-32" tabindex="-1"></a><span class="do">### yr_last : the last year of the period where the analysis takes place</span></span>
<span id="cb147-33"><a href="functions-for-matching-pre--and-post-processing.html#cb147-33" tabindex="-1"></a><span class="do">### yr_min : the minimum treatment year to be considered in the analysis. As some matching covariates are defined with pre-treatment data (e.g average tree cover loss before treatment), this minimal year is greater than yr_first</span></span>
<span id="cb147-34"><a href="functions-for-matching-pre--and-post-processing.html#cb147-34" tabindex="-1"></a><span class="do">### name : specify the name of the log file to save</span></span>
<span id="cb147-35"><a href="functions-for-matching-pre--and-post-processing.html#cb147-35" tabindex="-1"></a><span class="do">### notes : any notes on the analysis performed</span></span>
<span id="cb147-36"><a href="functions-for-matching-pre--and-post-processing.html#cb147-36" tabindex="-1"></a><span class="do">##OUTPUTS :</span></span>
<span id="cb147-37"><a href="functions-for-matching-pre--and-post-processing.html#cb147-37" tabindex="-1"></a><span class="do">###log : a text file in the R session memory that will be edited through the data processing</span></span>
<span id="cb147-38"><a href="functions-for-matching-pre--and-post-processing.html#cb147-38" tabindex="-1"></a>fn_pre_log <span class="ot">=</span> <span class="cf">function</span>(list_iso, buffer, sampling, yr_first, yr_last, yr_min, name, notes)</span>
<span id="cb147-39"><a href="functions-for-matching-pre--and-post-processing.html#cb147-39" tabindex="-1"></a>{</span>
<span id="cb147-40"><a href="functions-for-matching-pre--and-post-processing.html#cb147-40" tabindex="-1"></a>  str_iso <span class="ot">=</span> <span class="fu">paste</span>(list_iso, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>)</span>
<span id="cb147-41"><a href="functions-for-matching-pre--and-post-processing.html#cb147-41" tabindex="-1"></a>  log <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), name, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb147-42"><a href="functions-for-matching-pre--and-post-processing.html#cb147-42" tabindex="-1"></a>  <span class="fu">file.create</span>(log)</span>
<span id="cb147-43"><a href="functions-for-matching-pre--and-post-processing.html#cb147-43" tabindex="-1"></a>  <span class="co">#Do not forget to end the writing with a \n to avoid warnings</span></span>
<span id="cb147-44"><a href="functions-for-matching-pre--and-post-processing.html#cb147-44" tabindex="-1"></a>  <span class="co">#cat(paste(&quot;#####\nCOUNTRY :&quot;, iso, &quot;\nTIME :&quot;, print(Sys.time(), tz = &quot;UTC-2&quot;), &quot;\n#####\n\n###\nPRE-PROCESSING\n###\n\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-45"><a href="functions-for-matching-pre--and-post-processing.html#cb147-45" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;STARTING TIME :&quot;</span>, <span class="fu">print</span>(<span class="fu">Sys.time</span>(), <span class="at">tz =</span> <span class="st">&quot;UTC-2&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">PARAMETERS : buffer =&quot;</span>, buffer, <span class="st">&quot;m, sampling size of&quot;</span>, sampling, <span class="st">&quot;, period of analysis&quot;</span>, yr_first, <span class="st">&quot;to&quot;</span>, yr_last, <span class="st">&quot;, minimum treatment year is&quot;</span>, yr_min, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">COUNTRIES :&quot;</span>, str_iso, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">NOTES :&quot;</span>, notes, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">##########</span><span class="sc">\n</span><span class="st">PRE-PROCESSING</span><span class="sc">\n</span><span class="st">##########</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-46"><a href="functions-for-matching-pre--and-post-processing.html#cb147-46" tabindex="-1"></a>  </span>
<span id="cb147-47"><a href="functions-for-matching-pre--and-post-processing.html#cb147-47" tabindex="-1"></a>  <span class="fu">return</span>(log)</span>
<span id="cb147-48"><a href="functions-for-matching-pre--and-post-processing.html#cb147-48" tabindex="-1"></a>}</span>
<span id="cb147-49"><a href="functions-for-matching-pre--and-post-processing.html#cb147-49" tabindex="-1"></a></span>
<span id="cb147-50"><a href="functions-for-matching-pre--and-post-processing.html#cb147-50" tabindex="-1"></a></span>
<span id="cb147-51"><a href="functions-for-matching-pre--and-post-processing.html#cb147-51" tabindex="-1"></a><span class="co">#Find the UTM code for a given set of coordinates</span></span>
<span id="cb147-52"><a href="functions-for-matching-pre--and-post-processing.html#cb147-52" tabindex="-1"></a><span class="do">##INPUTS : </span></span>
<span id="cb147-53"><a href="functions-for-matching-pre--and-post-processing.html#cb147-53" tabindex="-1"></a><span class="do">### lonlat : coordinates</span></span>
<span id="cb147-54"><a href="functions-for-matching-pre--and-post-processing.html#cb147-54" tabindex="-1"></a><span class="do">##OUTPUTS : </span></span>
<span id="cb147-55"><a href="functions-for-matching-pre--and-post-processing.html#cb147-55" tabindex="-1"></a><span class="do">### UTM code</span></span>
<span id="cb147-56"><a href="functions-for-matching-pre--and-post-processing.html#cb147-56" tabindex="-1"></a>fn_lonlat2UTM <span class="ot">=</span> <span class="cf">function</span>(lonlat) </span>
<span id="cb147-57"><a href="functions-for-matching-pre--and-post-processing.html#cb147-57" tabindex="-1"></a>{</span>
<span id="cb147-58"><a href="functions-for-matching-pre--and-post-processing.html#cb147-58" tabindex="-1"></a>  utm <span class="ot">=</span> (<span class="fu">floor</span>((lonlat[<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">180</span>) <span class="sc">/</span> <span class="dv">6</span>) <span class="sc">%%</span> <span class="dv">60</span>) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb147-59"><a href="functions-for-matching-pre--and-post-processing.html#cb147-59" tabindex="-1"></a>  <span class="cf">if</span> (lonlat[<span class="dv">2</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb147-60"><a href="functions-for-matching-pre--and-post-processing.html#cb147-60" tabindex="-1"></a>    utm <span class="sc">+</span> <span class="dv">32600</span></span>
<span id="cb147-61"><a href="functions-for-matching-pre--and-post-processing.html#cb147-61" tabindex="-1"></a>  } <span class="cf">else</span>{</span>
<span id="cb147-62"><a href="functions-for-matching-pre--and-post-processing.html#cb147-62" tabindex="-1"></a>    utm <span class="sc">+</span> <span class="dv">32700</span></span>
<span id="cb147-63"><a href="functions-for-matching-pre--and-post-processing.html#cb147-63" tabindex="-1"></a>  }</span>
<span id="cb147-64"><a href="functions-for-matching-pre--and-post-processing.html#cb147-64" tabindex="-1"></a>  </span>
<span id="cb147-65"><a href="functions-for-matching-pre--and-post-processing.html#cb147-65" tabindex="-1"></a>}</span>
<span id="cb147-66"><a href="functions-for-matching-pre--and-post-processing.html#cb147-66" tabindex="-1"></a></span>
<span id="cb147-67"><a href="functions-for-matching-pre--and-post-processing.html#cb147-67" tabindex="-1"></a></span>
<span id="cb147-68"><a href="functions-for-matching-pre--and-post-processing.html#cb147-68" tabindex="-1"></a><span class="co">#Create the gridding of a given country. </span></span>
<span id="cb147-69"><a href="functions-for-matching-pre--and-post-processing.html#cb147-69" tabindex="-1"></a><span class="do">##INPUTS : </span></span>
<span id="cb147-70"><a href="functions-for-matching-pre--and-post-processing.html#cb147-70" tabindex="-1"></a><span class="do">### iso : ISO code </span></span>
<span id="cb147-71"><a href="functions-for-matching-pre--and-post-processing.html#cb147-71" tabindex="-1"></a><span class="do">### yr_min : the minimum treatment year to be considered in the analysis. As some matching covariates are defined with pre-treatment data (e.g average tree cover loss before treatment), this minimal year is greater than the first year in the period considered</span></span>
<span id="cb147-72"><a href="functions-for-matching-pre--and-post-processing.html#cb147-72" tabindex="-1"></a><span class="do">### path_tmp : temporary path for saving figures</span></span>
<span id="cb147-73"><a href="functions-for-matching-pre--and-post-processing.html#cb147-73" tabindex="-1"></a><span class="do">### data_pa : dataset with information on protected areas, and especially their surfaces</span></span>
<span id="cb147-74"><a href="functions-for-matching-pre--and-post-processing.html#cb147-74" tabindex="-1"></a><span class="do">### sampling : Number of pixels that subdivide the protected area with lowest area in the country considered</span></span>
<span id="cb147-75"><a href="functions-for-matching-pre--and-post-processing.html#cb147-75" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-76"><a href="functions-for-matching-pre--and-post-processing.html#cb147-76" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-77"><a href="functions-for-matching-pre--and-post-processing.html#cb147-77" tabindex="-1"></a><span class="do">##OUTPUTS (depending on potential errors)</span></span>
<span id="cb147-78"><a href="functions-for-matching-pre--and-post-processing.html#cb147-78" tabindex="-1"></a><span class="do">### gadm_prj : country shapefile </span></span>
<span id="cb147-79"><a href="functions-for-matching-pre--and-post-processing.html#cb147-79" tabindex="-1"></a><span class="do">### grid : gridding of the country</span></span>
<span id="cb147-80"><a href="functions-for-matching-pre--and-post-processing.html#cb147-80" tabindex="-1"></a><span class="do">### utm_code : UTM code of the country</span></span>
<span id="cb147-81"><a href="functions-for-matching-pre--and-post-processing.html#cb147-81" tabindex="-1"></a><span class="do">### gridSize : the resolution of gridding, defined from the area of the PA with the lowest area</span></span>
<span id="cb147-82"><a href="functions-for-matching-pre--and-post-processing.html#cb147-82" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-83"><a href="functions-for-matching-pre--and-post-processing.html#cb147-83" tabindex="-1"></a><span class="do">##DATA SAVED :</span></span>
<span id="cb147-84"><a href="functions-for-matching-pre--and-post-processing.html#cb147-84" tabindex="-1"></a><span class="do">### Gridding of the country considered</span></span>
<span id="cb147-85"><a href="functions-for-matching-pre--and-post-processing.html#cb147-85" tabindex="-1"></a>fn_pre_grid <span class="ot">=</span> <span class="cf">function</span>(iso, yr_min, path_tmp, data_pa, sampling, log, save_dir)</span>
<span id="cb147-86"><a href="functions-for-matching-pre--and-post-processing.html#cb147-86" tabindex="-1"></a>{</span>
<span id="cb147-87"><a href="functions-for-matching-pre--and-post-processing.html#cb147-87" tabindex="-1"></a>  </span>
<span id="cb147-88"><a href="functions-for-matching-pre--and-post-processing.html#cb147-88" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">withCallingHandlers</span>(</span>
<span id="cb147-89"><a href="functions-for-matching-pre--and-post-processing.html#cb147-89" tabindex="-1"></a>    </span>
<span id="cb147-90"><a href="functions-for-matching-pre--and-post-processing.html#cb147-90" tabindex="-1"></a>    {</span>
<span id="cb147-91"><a href="functions-for-matching-pre--and-post-processing.html#cb147-91" tabindex="-1"></a>      </span>
<span id="cb147-92"><a href="functions-for-matching-pre--and-post-processing.html#cb147-92" tabindex="-1"></a>  <span class="co"># Download country polygon</span></span>
<span id="cb147-93"><a href="functions-for-matching-pre--and-post-processing.html#cb147-93" tabindex="-1"></a>  gadm <span class="ot">=</span> <span class="fu">gadm</span>(<span class="at">country =</span> iso, <span class="at">resolution =</span> <span class="dv">1</span>, <span class="at">level =</span> <span class="dv">0</span>, <span class="at">path =</span> path_tmp) <span class="sc">%&gt;%</span> </span>
<span id="cb147-94"><a href="functions-for-matching-pre--and-post-processing.html#cb147-94" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-95"><a href="functions-for-matching-pre--and-post-processing.html#cb147-95" tabindex="-1"></a>    <span class="fu">st_make_valid</span>() <span class="co">#Necessary for some polygons : e.g BEN</span></span>
<span id="cb147-96"><a href="functions-for-matching-pre--and-post-processing.html#cb147-96" tabindex="-1"></a>  </span>
<span id="cb147-97"><a href="functions-for-matching-pre--and-post-processing.html#cb147-97" tabindex="-1"></a>  <span class="co"># Find UTM zone of the country centroid</span></span>
<span id="cb147-98"><a href="functions-for-matching-pre--and-post-processing.html#cb147-98" tabindex="-1"></a>  centroid <span class="ot">=</span> <span class="fu">st_coordinates</span>(<span class="fu">st_centroid</span>(gadm))</span>
<span id="cb147-99"><a href="functions-for-matching-pre--and-post-processing.html#cb147-99" tabindex="-1"></a>  utm_code <span class="ot">=</span> <span class="fu">fn_lonlat2UTM</span>(centroid)</span>
<span id="cb147-100"><a href="functions-for-matching-pre--and-post-processing.html#cb147-100" tabindex="-1"></a>  <span class="co"># Reproject GADM</span></span>
<span id="cb147-101"><a href="functions-for-matching-pre--and-post-processing.html#cb147-101" tabindex="-1"></a>  gadm_prj <span class="ot">=</span> gadm <span class="sc">%&gt;%</span> </span>
<span id="cb147-102"><a href="functions-for-matching-pre--and-post-processing.html#cb147-102" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> utm_code)</span>
<span id="cb147-103"><a href="functions-for-matching-pre--and-post-processing.html#cb147-103" tabindex="-1"></a>  </span>
<span id="cb147-104"><a href="functions-for-matching-pre--and-post-processing.html#cb147-104" tabindex="-1"></a>  <span class="co">#Determine relevant grid size</span></span>
<span id="cb147-105"><a href="functions-for-matching-pre--and-post-processing.html#cb147-105" tabindex="-1"></a>  <span class="do">##Select the PA in the country with minimum area. PAs with null areas, marine or treatment year before 2000 are discarded (not analyzed anyway)</span></span>
<span id="cb147-106"><a href="functions-for-matching-pre--and-post-processing.html#cb147-106" tabindex="-1"></a>  pa_min <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb147-107"><a href="functions-for-matching-pre--and-post-processing.html#cb147-107" tabindex="-1"></a>    <span class="fu">filter</span>(iso3 <span class="sc">==</span> iso <span class="sc">&amp;</span> <span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-108"><a href="functions-for-matching-pre--and-post-processing.html#cb147-108" tabindex="-1"></a>    <span class="fu">arrange</span>(area_km2) <span class="sc">%&gt;%</span></span>
<span id="cb147-109"><a href="functions-for-matching-pre--and-post-processing.html#cb147-109" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-110"><a href="functions-for-matching-pre--and-post-processing.html#cb147-110" tabindex="-1"></a>  <span class="do">##From this minimum area, define the grid size. </span></span>
<span id="cb147-111"><a href="functions-for-matching-pre--and-post-processing.html#cb147-111" tabindex="-1"></a>  <span class="do">##It depends on the sampling of the minimal area, i.e how many pixels we want to subdivide the PA with lowest area</span></span>
<span id="cb147-112"><a href="functions-for-matching-pre--and-post-processing.html#cb147-112" tabindex="-1"></a>  <span class="do">## To avoid a resolution higher than the one of our data, grid size is set to be 30m at least (resolution of tree cover data, Hansen et al. 2013)</span></span>
<span id="cb147-113"><a href="functions-for-matching-pre--and-post-processing.html#cb147-113" tabindex="-1"></a>  area_min <span class="ot">=</span> pa_min<span class="sc">$</span>area_km2 <span class="co">#in kilometer</span></span>
<span id="cb147-114"><a href="functions-for-matching-pre--and-post-processing.html#cb147-114" tabindex="-1"></a>  gridSize <span class="ot">=</span> <span class="fu">max</span>(<span class="fl">1e3</span>, <span class="fu">round</span>(<span class="fu">sqrt</span>(area_min<span class="sc">/</span>sampling)<span class="sc">*</span><span class="dv">1000</span>, <span class="dv">0</span>)) <span class="co">#Side of the pixel is expressed in meter and rounded, if above 1km. </span></span>
<span id="cb147-115"><a href="functions-for-matching-pre--and-post-processing.html#cb147-115" tabindex="-1"></a>  </span>
<span id="cb147-116"><a href="functions-for-matching-pre--and-post-processing.html#cb147-116" tabindex="-1"></a>  <span class="co"># Make bounding box of projected country polygon</span></span>
<span id="cb147-117"><a href="functions-for-matching-pre--and-post-processing.html#cb147-117" tabindex="-1"></a>  bbox <span class="ot">=</span> <span class="fu">st_bbox</span>(gadm_prj) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>() <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>() </span>
<span id="cb147-118"><a href="functions-for-matching-pre--and-post-processing.html#cb147-118" tabindex="-1"></a>  <span class="co"># Make a Grid to the extent of the bounding box</span></span>
<span id="cb147-119"><a href="functions-for-matching-pre--and-post-processing.html#cb147-119" tabindex="-1"></a>  grid.ini <span class="ot">=</span> <span class="fu">st_make_grid</span>(bbox, <span class="at">cellsize =</span> <span class="fu">c</span>(gridSize,gridSize))</span>
<span id="cb147-120"><a href="functions-for-matching-pre--and-post-processing.html#cb147-120" tabindex="-1"></a>  <span class="co"># Crop Grid to the extent of country boundary by</span></span>
<span id="cb147-121"><a href="functions-for-matching-pre--and-post-processing.html#cb147-121" tabindex="-1"></a>  <span class="co"># subsetting to the grid cells that intersect with the country</span></span>
<span id="cb147-122"><a href="functions-for-matching-pre--and-post-processing.html#cb147-122" tabindex="-1"></a>  grid.sub <span class="ot">=</span> grid.ini <span class="sc">%&gt;%</span> </span>
<span id="cb147-123"><a href="functions-for-matching-pre--and-post-processing.html#cb147-123" tabindex="-1"></a>    <span class="fu">st_intersects</span>(gadm_prj, .) <span class="sc">%&gt;%</span> </span>
<span id="cb147-124"><a href="functions-for-matching-pre--and-post-processing.html#cb147-124" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb147-125"><a href="functions-for-matching-pre--and-post-processing.html#cb147-125" tabindex="-1"></a>  <span class="co"># Filter the grid to the subset</span></span>
<span id="cb147-126"><a href="functions-for-matching-pre--and-post-processing.html#cb147-126" tabindex="-1"></a>  grid <span class="ot">=</span> grid.ini[<span class="fu">sort</span>(grid.sub)] <span class="sc">%&gt;%</span></span>
<span id="cb147-127"><a href="functions-for-matching-pre--and-post-processing.html#cb147-127" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-128"><a href="functions-for-matching-pre--and-post-processing.html#cb147-128" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">gridID =</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(.))) <span class="co"># Add id for grid cells</span></span>
<span id="cb147-129"><a href="functions-for-matching-pre--and-post-processing.html#cb147-129" tabindex="-1"></a>  </span>
<span id="cb147-130"><a href="functions-for-matching-pre--and-post-processing.html#cb147-130" tabindex="-1"></a>  <span class="co">#Extract country name</span></span>
<span id="cb147-131"><a href="functions-for-matching-pre--and-post-processing.html#cb147-131" tabindex="-1"></a>  country.name <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span> </span>
<span id="cb147-132"><a href="functions-for-matching-pre--and-post-processing.html#cb147-132" tabindex="-1"></a>    <span class="fu">filter</span>(iso3 <span class="sc">==</span> iso) <span class="sc">%&gt;%</span> </span>
<span id="cb147-133"><a href="functions-for-matching-pre--and-post-processing.html#cb147-133" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-134"><a href="functions-for-matching-pre--and-post-processing.html#cb147-134" tabindex="-1"></a>  country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-135"><a href="functions-for-matching-pre--and-post-processing.html#cb147-135" tabindex="-1"></a>  </span>
<span id="cb147-136"><a href="functions-for-matching-pre--and-post-processing.html#cb147-136" tabindex="-1"></a>  <span class="co">#Visualize and save the grid</span></span>
<span id="cb147-137"><a href="functions-for-matching-pre--and-post-processing.html#cb147-137" tabindex="-1"></a>  fig_grid <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb147-138"><a href="functions-for-matching-pre--and-post-processing.html#cb147-138" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_geometry</span>(bbox)) <span class="sc">+</span></span>
<span id="cb147-139"><a href="functions-for-matching-pre--and-post-processing.html#cb147-139" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_geometry</span>(gadm_prj)) <span class="sc">+</span></span>
<span id="cb147-140"><a href="functions-for-matching-pre--and-post-processing.html#cb147-140" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> <span class="fu">st_geometry</span>(grid), <span class="at">alpha =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb147-141"><a href="functions-for-matching-pre--and-post-processing.html#cb147-141" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Gridding of&quot;</span>, country.name))</span>
<span id="cb147-142"><a href="functions-for-matching-pre--and-post-processing.html#cb147-142" tabindex="-1"></a>  fig_save <span class="ot">=</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/fig_grid_&quot;</span>, iso, <span class="st">&quot;.png&quot;</span>)</span>
<span id="cb147-143"><a href="functions-for-matching-pre--and-post-processing.html#cb147-143" tabindex="-1"></a>  <span class="fu">ggsave</span>(fig_save,</span>
<span id="cb147-144"><a href="functions-for-matching-pre--and-post-processing.html#cb147-144" tabindex="-1"></a>         <span class="at">plot =</span> fig_grid,</span>
<span id="cb147-145"><a href="functions-for-matching-pre--and-post-processing.html#cb147-145" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-146"><a href="functions-for-matching-pre--and-post-processing.html#cb147-146" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-147"><a href="functions-for-matching-pre--and-post-processing.html#cb147-147" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> fig_save, </span>
<span id="cb147-148"><a href="functions-for-matching-pre--and-post-processing.html#cb147-148" tabindex="-1"></a>                     <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb147-149"><a href="functions-for-matching-pre--and-post-processing.html#cb147-149" tabindex="-1"></a>                     <span class="at">region =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb147-150"><a href="functions-for-matching-pre--and-post-processing.html#cb147-150" tabindex="-1"></a>                     <span class="at">show_progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-151"><a href="functions-for-matching-pre--and-post-processing.html#cb147-151" tabindex="-1"></a>  </span>
<span id="cb147-152"><a href="functions-for-matching-pre--and-post-processing.html#cb147-152" tabindex="-1"></a>  <span class="co">#Append the log </span></span>
<span id="cb147-153"><a href="functions-for-matching-pre--and-post-processing.html#cb147-153" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Generating observation units</span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-154"><a href="functions-for-matching-pre--and-post-processing.html#cb147-154" tabindex="-1"></a>  </span>
<span id="cb147-155"><a href="functions-for-matching-pre--and-post-processing.html#cb147-155" tabindex="-1"></a>  <span class="co">#Return outputs</span></span>
<span id="cb147-156"><a href="functions-for-matching-pre--and-post-processing.html#cb147-156" tabindex="-1"></a>  list_output <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;ctry_shp_prj&quot;</span> <span class="ot">=</span> gadm_prj, </span>
<span id="cb147-157"><a href="functions-for-matching-pre--and-post-processing.html#cb147-157" tabindex="-1"></a>                     <span class="st">&quot;grid&quot;</span> <span class="ot">=</span> grid, </span>
<span id="cb147-158"><a href="functions-for-matching-pre--and-post-processing.html#cb147-158" tabindex="-1"></a>                     <span class="st">&quot;gridSize&quot;</span> <span class="ot">=</span> gridSize, </span>
<span id="cb147-159"><a href="functions-for-matching-pre--and-post-processing.html#cb147-159" tabindex="-1"></a>                     <span class="st">&quot;utm_code&quot;</span> <span class="ot">=</span> utm_code,</span>
<span id="cb147-160"><a href="functions-for-matching-pre--and-post-processing.html#cb147-160" tabindex="-1"></a>                     <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-161"><a href="functions-for-matching-pre--and-post-processing.html#cb147-161" tabindex="-1"></a>  <span class="fu">return</span>(list_output)</span>
<span id="cb147-162"><a href="functions-for-matching-pre--and-post-processing.html#cb147-162" tabindex="-1"></a>  </span>
<span id="cb147-163"><a href="functions-for-matching-pre--and-post-processing.html#cb147-163" tabindex="-1"></a>    },</span>
<span id="cb147-164"><a href="functions-for-matching-pre--and-post-processing.html#cb147-164" tabindex="-1"></a>  </span>
<span id="cb147-165"><a href="functions-for-matching-pre--and-post-processing.html#cb147-165" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-166"><a href="functions-for-matching-pre--and-post-processing.html#cb147-166" tabindex="-1"></a>  {</span>
<span id="cb147-167"><a href="functions-for-matching-pre--and-post-processing.html#cb147-167" tabindex="-1"></a>    <span class="co">#Print the error and append the log</span></span>
<span id="cb147-168"><a href="functions-for-matching-pre--and-post-processing.html#cb147-168" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-169"><a href="functions-for-matching-pre--and-post-processing.html#cb147-169" tabindex="-1"></a>    <span class="co">#Append the log </span></span>
<span id="cb147-170"><a href="functions-for-matching-pre--and-post-processing.html#cb147-170" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Generating observation units</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-171"><a href="functions-for-matching-pre--and-post-processing.html#cb147-171" tabindex="-1"></a>    <span class="co">#Return string to inform user to skip</span></span>
<span id="cb147-172"><a href="functions-for-matching-pre--and-post-processing.html#cb147-172" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-173"><a href="functions-for-matching-pre--and-post-processing.html#cb147-173" tabindex="-1"></a>  },</span>
<span id="cb147-174"><a href="functions-for-matching-pre--and-post-processing.html#cb147-174" tabindex="-1"></a>  </span>
<span id="cb147-175"><a href="functions-for-matching-pre--and-post-processing.html#cb147-175" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cf">function</span>(w)</span>
<span id="cb147-176"><a href="functions-for-matching-pre--and-post-processing.html#cb147-176" tabindex="-1"></a>  {</span>
<span id="cb147-177"><a href="functions-for-matching-pre--and-post-processing.html#cb147-177" tabindex="-1"></a>    <span class="co">#Print the warning and append the log</span></span>
<span id="cb147-178"><a href="functions-for-matching-pre--and-post-processing.html#cb147-178" tabindex="-1"></a>    <span class="fu">print</span>(w)</span>
<span id="cb147-179"><a href="functions-for-matching-pre--and-post-processing.html#cb147-179" tabindex="-1"></a>    <span class="co">#Append the log </span></span>
<span id="cb147-180"><a href="functions-for-matching-pre--and-post-processing.html#cb147-180" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Generating observation units</span><span class="sc">\n</span><span class="st">-&gt; Warning :</span><span class="sc">\n</span><span class="st">&quot;</span>, w, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-181"><a href="functions-for-matching-pre--and-post-processing.html#cb147-181" tabindex="-1"></a>    <span class="co">#Return string to inform user to skip</span></span>
<span id="cb147-182"><a href="functions-for-matching-pre--and-post-processing.html#cb147-182" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-183"><a href="functions-for-matching-pre--and-post-processing.html#cb147-183" tabindex="-1"></a>  }</span>
<span id="cb147-184"><a href="functions-for-matching-pre--and-post-processing.html#cb147-184" tabindex="-1"></a>  </span>
<span id="cb147-185"><a href="functions-for-matching-pre--and-post-processing.html#cb147-185" tabindex="-1"></a>  )</span>
<span id="cb147-186"><a href="functions-for-matching-pre--and-post-processing.html#cb147-186" tabindex="-1"></a>  </span>
<span id="cb147-187"><a href="functions-for-matching-pre--and-post-processing.html#cb147-187" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-188"><a href="functions-for-matching-pre--and-post-processing.html#cb147-188" tabindex="-1"></a>}</span>
<span id="cb147-189"><a href="functions-for-matching-pre--and-post-processing.html#cb147-189" tabindex="-1"></a></span>
<span id="cb147-190"><a href="functions-for-matching-pre--and-post-processing.html#cb147-190" tabindex="-1"></a><span class="co">#Assign each pixel (observation unit) to a group : PA non-funded, funded and analyzed, funded and not analyzed, buffer, potential control. </span></span>
<span id="cb147-191"><a href="functions-for-matching-pre--and-post-processing.html#cb147-191" tabindex="-1"></a><span class="do">##INPUTS :</span></span>
<span id="cb147-192"><a href="functions-for-matching-pre--and-post-processing.html#cb147-192" tabindex="-1"></a><span class="do">### iso : country ISO code</span></span>
<span id="cb147-193"><a href="functions-for-matching-pre--and-post-processing.html#cb147-193" tabindex="-1"></a><span class="do">### path_tmp : temporary path to save figures</span></span>
<span id="cb147-194"><a href="functions-for-matching-pre--and-post-processing.html#cb147-194" tabindex="-1"></a><span class="do">### utm_code : UTM of the country centroid</span></span>
<span id="cb147-195"><a href="functions-for-matching-pre--and-post-processing.html#cb147-195" tabindex="-1"></a><span class="do">### buffer_m : buffer width, in meter</span></span>
<span id="cb147-196"><a href="functions-for-matching-pre--and-post-processing.html#cb147-196" tabindex="-1"></a><span class="do">### data : a dataframe with the WDPAID of PAs funded by the AFD</span></span>
<span id="cb147-197"><a href="functions-for-matching-pre--and-post-processing.html#cb147-197" tabindex="-1"></a><span class="do">### gadm_prj : country polygon, projected so that crs = UTM code</span></span>
<span id="cb147-198"><a href="functions-for-matching-pre--and-post-processing.html#cb147-198" tabindex="-1"></a><span class="do">### grid : gridding of the country</span></span>
<span id="cb147-199"><a href="functions-for-matching-pre--and-post-processing.html#cb147-199" tabindex="-1"></a><span class="do">### gridSize : resolution of the gridding</span></span>
<span id="cb147-200"><a href="functions-for-matching-pre--and-post-processing.html#cb147-200" tabindex="-1"></a><span class="do">##OUTPUTS (depending on potential errors): </span></span>
<span id="cb147-201"><a href="functions-for-matching-pre--and-post-processing.html#cb147-201" tabindex="-1"></a><span class="do">### grid.param : a raster representing the gridding of the country with two layers. One for the group each pixel belongs to (funded PA, non-funded PA, potential control, buffer), the other for the WDPAID corresponding to each pixel (0 if not a PA)</span></span>
<span id="cb147-202"><a href="functions-for-matching-pre--and-post-processing.html#cb147-202" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-203"><a href="functions-for-matching-pre--and-post-processing.html#cb147-203" tabindex="-1"></a><span class="do">##DATA SAVED :</span></span>
<span id="cb147-204"><a href="functions-for-matching-pre--and-post-processing.html#cb147-204" tabindex="-1"></a><span class="do">### grid.param</span></span>
<span id="cb147-205"><a href="functions-for-matching-pre--and-post-processing.html#cb147-205" tabindex="-1"></a><span class="do">### A plot of the country gridding with group of each pixel</span></span>
<span id="cb147-206"><a href="functions-for-matching-pre--and-post-processing.html#cb147-206" tabindex="-1"></a><span class="do">### The share of PAs in the portfolio considered that are reported in the WDPA</span></span>
<span id="cb147-207"><a href="functions-for-matching-pre--and-post-processing.html#cb147-207" tabindex="-1"></a><span class="do">### In the country considered, the share of PAs in the portfolio and analyzed, not analyzed or not in the portfolio</span></span>
<span id="cb147-208"><a href="functions-for-matching-pre--and-post-processing.html#cb147-208" tabindex="-1"></a><span class="do">### Share of PAs reported in the WDPA and analyzed in the country considered</span></span>
<span id="cb147-209"><a href="functions-for-matching-pre--and-post-processing.html#cb147-209" tabindex="-1"></a><span class="do">##NOTES :</span></span>
<span id="cb147-210"><a href="functions-for-matching-pre--and-post-processing.html#cb147-210" tabindex="-1"></a><span class="do">### Errors can arise from the wdpa_clean() function, during &quot;formatting attribute data&quot; step. Can be settled playing with geometry_precision parameter</span></span>
<span id="cb147-211"><a href="functions-for-matching-pre--and-post-processing.html#cb147-211" tabindex="-1"></a>fn_pre_group <span class="ot">=</span> <span class="cf">function</span>(iso, wdpa_raw, status, yr_min, path_tmp, utm_code, buffer_m, data_pa, gadm_prj, grid, gridSize, log, save_dir)</span>
<span id="cb147-212"><a href="functions-for-matching-pre--and-post-processing.html#cb147-212" tabindex="-1"></a>{</span>
<span id="cb147-213"><a href="functions-for-matching-pre--and-post-processing.html#cb147-213" tabindex="-1"></a>  </span>
<span id="cb147-214"><a href="functions-for-matching-pre--and-post-processing.html#cb147-214" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">withCallingHandlers</span>(</span>
<span id="cb147-215"><a href="functions-for-matching-pre--and-post-processing.html#cb147-215" tabindex="-1"></a>    </span>
<span id="cb147-216"><a href="functions-for-matching-pre--and-post-processing.html#cb147-216" tabindex="-1"></a>    {</span>
<span id="cb147-217"><a href="functions-for-matching-pre--and-post-processing.html#cb147-217" tabindex="-1"></a></span>
<span id="cb147-218"><a href="functions-for-matching-pre--and-post-processing.html#cb147-218" tabindex="-1"></a>  <span class="co"># The polygons of PAs are taken from WDPA, cleaned</span></span>
<span id="cb147-219"><a href="functions-for-matching-pre--and-post-processing.html#cb147-219" tabindex="-1"></a>  wdpa_prj <span class="ot">=</span> wdpa_raw <span class="sc">%&gt;%</span></span>
<span id="cb147-220"><a href="functions-for-matching-pre--and-post-processing.html#cb147-220" tabindex="-1"></a>    <span class="fu">filter</span>(ISO3 <span class="sc">==</span> iso) <span class="sc">%&gt;%</span></span>
<span id="cb147-221"><a href="functions-for-matching-pre--and-post-processing.html#cb147-221" tabindex="-1"></a>    <span class="co">#st_make_valid() %&gt;%</span></span>
<span id="cb147-222"><a href="functions-for-matching-pre--and-post-processing.html#cb147-222" tabindex="-1"></a>    <span class="co">#celanign of PAs from the wdap_clean function :</span></span>
<span id="cb147-223"><a href="functions-for-matching-pre--and-post-processing.html#cb147-223" tabindex="-1"></a>    <span class="co">#Status filtering is performed manually juste after. </span></span>
<span id="cb147-224"><a href="functions-for-matching-pre--and-post-processing.html#cb147-224" tabindex="-1"></a>    <span class="co">#The geometry precision is set to default. Used to be 1000 in Kemmeng code</span></span>
<span id="cb147-225"><a href="functions-for-matching-pre--and-post-processing.html#cb147-225" tabindex="-1"></a>    <span class="co"># Overlaps are not erased because we rasterize polygons</span></span>
<span id="cb147-226"><a href="functions-for-matching-pre--and-post-processing.html#cb147-226" tabindex="-1"></a>    <span class="co">#UNESCO Biosphere Reserves are not excluded so that our analysis of AFD portfolio is the most extensive</span></span>
<span id="cb147-227"><a href="functions-for-matching-pre--and-post-processing.html#cb147-227" tabindex="-1"></a>    <span class="fu">wdpa_clean</span>(<span class="at">retain_status =</span> status, <span class="co">#NULL to remove proposed</span></span>
<span id="cb147-228"><a href="functions-for-matching-pre--and-post-processing.html#cb147-228" tabindex="-1"></a>               <span class="at">erase_overlaps =</span> <span class="cn">FALSE</span>,</span>
<span id="cb147-229"><a href="functions-for-matching-pre--and-post-processing.html#cb147-229" tabindex="-1"></a>               <span class="at">exclude_unesco =</span> <span class="cn">FALSE</span>,</span>
<span id="cb147-230"><a href="functions-for-matching-pre--and-post-processing.html#cb147-230" tabindex="-1"></a>               <span class="at">verbose =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-231"><a href="functions-for-matching-pre--and-post-processing.html#cb147-231" tabindex="-1"></a>    <span class="co"># Remove the PAs that are only proposed, or have geometry type &quot;point&quot;</span></span>
<span id="cb147-232"><a href="functions-for-matching-pre--and-post-processing.html#cb147-232" tabindex="-1"></a>    <span class="co">#filter(STATUS != &quot;Proposed&quot;) %&gt;%  #24/08/2023 : &quot;Proposed&quot; status concerns only 6 PAs in the sample, including one implemented after 2000.</span></span>
<span id="cb147-233"><a href="functions-for-matching-pre--and-post-processing.html#cb147-233" tabindex="-1"></a>    <span class="fu">filter</span>(GEOMETRY_TYPE <span class="sc">!=</span> <span class="st">&quot;POINT&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-234"><a href="functions-for-matching-pre--and-post-processing.html#cb147-234" tabindex="-1"></a>    <span class="co"># Project PA polygons to the previously determined UTM zone</span></span>
<span id="cb147-235"><a href="functions-for-matching-pre--and-post-processing.html#cb147-235" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs =</span> utm_code) </span>
<span id="cb147-236"><a href="functions-for-matching-pre--and-post-processing.html#cb147-236" tabindex="-1"></a>  </span>
<span id="cb147-237"><a href="functions-for-matching-pre--and-post-processing.html#cb147-237" tabindex="-1"></a>  <span class="co"># Make Buffers around all protected areas</span></span>
<span id="cb147-238"><a href="functions-for-matching-pre--and-post-processing.html#cb147-238" tabindex="-1"></a>  buffer <span class="ot">=</span> <span class="fu">st_buffer</span>(wdpa_prj, <span class="at">dist =</span> buffer_m) <span class="sc">%&gt;%</span> </span>
<span id="cb147-239"><a href="functions-for-matching-pre--and-post-processing.html#cb147-239" tabindex="-1"></a>    <span class="co"># Assign an ID &quot;5&quot; to the buffer group</span></span>
<span id="cb147-240"><a href="functions-for-matching-pre--and-post-processing.html#cb147-240" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group=</span><span class="dv">5</span>,</span>
<span id="cb147-241"><a href="functions-for-matching-pre--and-post-processing.html#cb147-241" tabindex="-1"></a>           <span class="at">group_name =</span> <span class="st">&quot;Buffer&quot;</span>)</span>
<span id="cb147-242"><a href="functions-for-matching-pre--and-post-processing.html#cb147-242" tabindex="-1"></a>  </span>
<span id="cb147-243"><a href="functions-for-matching-pre--and-post-processing.html#cb147-243" tabindex="-1"></a>  <span class="co"># Separate funded and non-funded protected areas</span></span>
<span id="cb147-244"><a href="functions-for-matching-pre--and-post-processing.html#cb147-244" tabindex="-1"></a>  <span class="do">##PAs funded by AFD </span></span>
<span id="cb147-245"><a href="functions-for-matching-pre--and-post-processing.html#cb147-245" tabindex="-1"></a>  <span class="do">###... which can bu used in impact evaluation : in the country of interest, wdpaid known, area above 1km² (Wolf et al. 2021), implemented after yr_min defined by the user, non-marine (terrestrial or coastal, Wolf et al. 2021)</span></span>
<span id="cb147-246"><a href="functions-for-matching-pre--and-post-processing.html#cb147-246" tabindex="-1"></a>  pa_afd_ie <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb147-247"><a href="functions-for-matching-pre--and-post-processing.html#cb147-247" tabindex="-1"></a>    <span class="fu">filter</span>(iso3 <span class="sc">==</span> iso <span class="sc">&amp;</span> <span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb147-248"><a href="functions-for-matching-pre--and-post-processing.html#cb147-248" tabindex="-1"></a>  wdpaID_afd_ie <span class="ot">=</span> pa_afd_ie[pa_afd_ie<span class="sc">$</span>iso3 <span class="sc">==</span> iso,]<span class="sc">$</span>wdpaid</span>
<span id="cb147-249"><a href="functions-for-matching-pre--and-post-processing.html#cb147-249" tabindex="-1"></a>  wdpa_afd_ie <span class="ot">=</span> wdpa_prj <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WDPAID <span class="sc">%in%</span> wdpaID_afd_ie) <span class="sc">%&gt;%</span></span>
<span id="cb147-250"><a href="functions-for-matching-pre--and-post-processing.html#cb147-250" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group=</span><span class="dv">2</span>,</span>
<span id="cb147-251"><a href="functions-for-matching-pre--and-post-processing.html#cb147-251" tabindex="-1"></a>           <span class="at">group_name =</span> <span class="st">&quot;Funded PA, analyzed&quot;</span>) <span class="co"># Assign an ID &quot;2&quot; to the funded PA group</span></span>
<span id="cb147-252"><a href="functions-for-matching-pre--and-post-processing.html#cb147-252" tabindex="-1"></a>  <span class="do">###...which cannot</span></span>
<span id="cb147-253"><a href="functions-for-matching-pre--and-post-processing.html#cb147-253" tabindex="-1"></a>  pa_afd_no_ie <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb147-254"><a href="functions-for-matching-pre--and-post-processing.html#cb147-254" tabindex="-1"></a>    <span class="fu">filter</span>(iso3 <span class="sc">==</span> iso <span class="sc">&amp;</span> (<span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">|</span> area_km2 <span class="sc">&lt;=</span> <span class="dv">1</span> <span class="sc">|</span> <span class="fu">is.na</span>(area_km2) <span class="sc">|</span> status_yr <span class="sc">&lt;</span> yr_min <span class="sc">|</span> marine <span class="sc">==</span> <span class="dv">2</span>)) <span class="co">#PAs not in WDPA, of area less than 1km2 (Wolf et al 2020), not terrestrial/coastal or implemented after yr_min are not analyzed</span></span>
<span id="cb147-255"><a href="functions-for-matching-pre--and-post-processing.html#cb147-255" tabindex="-1"></a>  wdpaID_afd_no_ie <span class="ot">=</span> pa_afd_no_ie[pa_afd_no_ie<span class="sc">$</span>iso3 <span class="sc">==</span> iso,]<span class="sc">$</span>wdpaid </span>
<span id="cb147-256"><a href="functions-for-matching-pre--and-post-processing.html#cb147-256" tabindex="-1"></a>  wdpa_afd_no_ie <span class="ot">=</span> wdpa_prj <span class="sc">%&gt;%</span> <span class="fu">filter</span>(WDPAID <span class="sc">%in%</span> wdpaID_afd_no_ie) <span class="sc">%&gt;%</span></span>
<span id="cb147-257"><a href="functions-for-matching-pre--and-post-processing.html#cb147-257" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group=</span><span class="dv">3</span>,</span>
<span id="cb147-258"><a href="functions-for-matching-pre--and-post-processing.html#cb147-258" tabindex="-1"></a>           <span class="at">group_name =</span> <span class="st">&quot;Funded PA, not analyzed&quot;</span>) <span class="co"># Assign an ID &quot;3&quot; to the funded PA group which cannot be stuided in the impact evaluation</span></span>
<span id="cb147-259"><a href="functions-for-matching-pre--and-post-processing.html#cb147-259" tabindex="-1"></a>  <span class="do">##PAs not funded by AFD</span></span>
<span id="cb147-260"><a href="functions-for-matching-pre--and-post-processing.html#cb147-260" tabindex="-1"></a>  wdpa_no_afd <span class="ot">=</span> wdpa_prj <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>WDPAID <span class="sc">%in%</span> <span class="fu">c</span>(wdpaID_afd_ie, wdpaID_afd_no_ie)) <span class="sc">%&gt;%</span> </span>
<span id="cb147-261"><a href="functions-for-matching-pre--and-post-processing.html#cb147-261" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group=</span><span class="dv">4</span>,</span>
<span id="cb147-262"><a href="functions-for-matching-pre--and-post-processing.html#cb147-262" tabindex="-1"></a>           <span class="at">group_name =</span> <span class="st">&quot;Non-funded PA&quot;</span>) <span class="co"># Assign an ID &quot;4&quot; to the non-funded PA group</span></span>
<span id="cb147-263"><a href="functions-for-matching-pre--and-post-processing.html#cb147-263" tabindex="-1"></a>  wdpaID_no_afd <span class="ot">=</span> wdpa_no_afd<span class="sc">$</span>WDPAID</span>
<span id="cb147-264"><a href="functions-for-matching-pre--and-post-processing.html#cb147-264" tabindex="-1"></a>  </span>
<span id="cb147-265"><a href="functions-for-matching-pre--and-post-processing.html#cb147-265" tabindex="-1"></a>  <span class="co"># Merge the dataframes of funded PAs, non-funded PAs and buffers</span></span>
<span id="cb147-266"><a href="functions-for-matching-pre--and-post-processing.html#cb147-266" tabindex="-1"></a>  <span class="co"># CAREFUL : the order of the arguments does matter. </span></span>
<span id="cb147-267"><a href="functions-for-matching-pre--and-post-processing.html#cb147-267" tabindex="-1"></a>  <span class="do">## During rasterization, in case a cell of the raster is on both funded analysed and non-funded, we want to cell to take the WDPAID of the funded analysed.</span></span>
<span id="cb147-268"><a href="functions-for-matching-pre--and-post-processing.html#cb147-268" tabindex="-1"></a>  <span class="do">## Same funded, not analyzed. As the first layer is taken, wdpa_afd_ie needs to be first !</span></span>
<span id="cb147-269"><a href="functions-for-matching-pre--and-post-processing.html#cb147-269" tabindex="-1"></a>  wdpa_groups <span class="ot">=</span> <span class="fu">rbind</span>(wdpa_afd_ie, wdpa_afd_no_ie, wdpa_no_afd, buffer)</span>
<span id="cb147-270"><a href="functions-for-matching-pre--and-post-processing.html#cb147-270" tabindex="-1"></a>  <span class="co"># Subset to polygons that intersect with country boundary</span></span>
<span id="cb147-271"><a href="functions-for-matching-pre--and-post-processing.html#cb147-271" tabindex="-1"></a>  wdpa.sub <span class="ot">=</span> wdpa_groups <span class="sc">%&gt;%</span> </span>
<span id="cb147-272"><a href="functions-for-matching-pre--and-post-processing.html#cb147-272" tabindex="-1"></a>    <span class="fu">st_intersects</span>(gadm_prj, .) <span class="sc">%&gt;%</span> </span>
<span id="cb147-273"><a href="functions-for-matching-pre--and-post-processing.html#cb147-273" tabindex="-1"></a>    <span class="fu">unlist</span>()</span>
<span id="cb147-274"><a href="functions-for-matching-pre--and-post-processing.html#cb147-274" tabindex="-1"></a>  <span class="co"># Filter the PA+buffer to the subset</span></span>
<span id="cb147-275"><a href="functions-for-matching-pre--and-post-processing.html#cb147-275" tabindex="-1"></a>  wdpa_groups <span class="ot">=</span> wdpa_groups[<span class="fu">sort</span>(wdpa.sub),] <span class="sc">%&gt;%</span></span>
<span id="cb147-276"><a href="functions-for-matching-pre--and-post-processing.html#cb147-276" tabindex="-1"></a>    <span class="fu">st_as_sf</span>()</span>
<span id="cb147-277"><a href="functions-for-matching-pre--and-post-processing.html#cb147-277" tabindex="-1"></a>  </span>
<span id="cb147-278"><a href="functions-for-matching-pre--and-post-processing.html#cb147-278" tabindex="-1"></a>  <span class="co"># Initialize an empty raster to the spatial extent of the country</span></span>
<span id="cb147-279"><a href="functions-for-matching-pre--and-post-processing.html#cb147-279" tabindex="-1"></a>  r.ini <span class="ot">=</span> <span class="fu">raster</span>()</span>
<span id="cb147-280"><a href="functions-for-matching-pre--and-post-processing.html#cb147-280" tabindex="-1"></a>  <span class="fu">extent</span>(r.ini) <span class="ot">=</span> <span class="fu">extent</span>(gadm_prj)</span>
<span id="cb147-281"><a href="functions-for-matching-pre--and-post-processing.html#cb147-281" tabindex="-1"></a>  <span class="co"># Specify the raster resolution as same as the pre-defined &#39;gridSize&#39;</span></span>
<span id="cb147-282"><a href="functions-for-matching-pre--and-post-processing.html#cb147-282" tabindex="-1"></a>  <span class="fu">res</span>(r.ini) <span class="ot">=</span> gridSize</span>
<span id="cb147-283"><a href="functions-for-matching-pre--and-post-processing.html#cb147-283" tabindex="-1"></a>  <span class="co"># Assign the raster pixels with &quot;Group&quot; values, </span></span>
<span id="cb147-284"><a href="functions-for-matching-pre--and-post-processing.html#cb147-284" tabindex="-1"></a>  <span class="co"># Take the minimal value if a pixel is covered by overlapped polygons, so that PA Group ID has higher priority than Buffer ID.</span></span>
<span id="cb147-285"><a href="functions-for-matching-pre--and-post-processing.html#cb147-285" tabindex="-1"></a>  <span class="co"># Assign value &quot;0&quot; to the background pixels (control candidates group)</span></span>
<span id="cb147-286"><a href="functions-for-matching-pre--and-post-processing.html#cb147-286" tabindex="-1"></a>  <span class="co"># fun = &quot;min&quot; can lead to bad group assignment. This issue is developed and tackled below</span></span>
<span id="cb147-287"><a href="functions-for-matching-pre--and-post-processing.html#cb147-287" tabindex="-1"></a>  r.group <span class="ot">=</span> <span class="fu">rasterize</span>(wdpa_groups, r.ini, <span class="at">field=</span><span class="st">&quot;group&quot;</span>, <span class="at">fun=</span><span class="st">&quot;min&quot;</span>, <span class="at">background=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-288"><a href="functions-for-matching-pre--and-post-processing.html#cb147-288" tabindex="-1"></a>    <span class="fu">mask</span>(., gadm_prj)</span>
<span id="cb147-289"><a href="functions-for-matching-pre--and-post-processing.html#cb147-289" tabindex="-1"></a>  <span class="co"># Rename Layer</span></span>
<span id="cb147-290"><a href="functions-for-matching-pre--and-post-processing.html#cb147-290" tabindex="-1"></a>  <span class="fu">names</span>(r.group) <span class="ot">=</span> <span class="st">&quot;group&quot;</span></span>
<span id="cb147-291"><a href="functions-for-matching-pre--and-post-processing.html#cb147-291" tabindex="-1"></a>  </span>
<span id="cb147-292"><a href="functions-for-matching-pre--and-post-processing.html#cb147-292" tabindex="-1"></a>  <span class="co"># Rasterize wdpaid</span></span>
<span id="cb147-293"><a href="functions-for-matching-pre--and-post-processing.html#cb147-293" tabindex="-1"></a>  <span class="do">## CAREFUL : as stated above, the wdpa_groups raster is ordered so that the first layer is the one of funded, analyzed PA. Thus one needs to have fun = &quot;first&quot;</span></span>
<span id="cb147-294"><a href="functions-for-matching-pre--and-post-processing.html#cb147-294" tabindex="-1"></a>  r.wdpaid <span class="ot">=</span> <span class="fu">rasterize</span>(wdpa_groups, r.ini, <span class="at">field=</span><span class="st">&quot;WDPAID&quot;</span>, <span class="at">fun=</span><span class="st">&quot;first&quot;</span>, <span class="at">background=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-295"><a href="functions-for-matching-pre--and-post-processing.html#cb147-295" tabindex="-1"></a>    <span class="fu">mask</span>(., gadm_prj)</span>
<span id="cb147-296"><a href="functions-for-matching-pre--and-post-processing.html#cb147-296" tabindex="-1"></a>  <span class="fu">names</span>(r.wdpaid) <span class="ot">=</span> <span class="st">&quot;wdpaid&quot;</span></span>
<span id="cb147-297"><a href="functions-for-matching-pre--and-post-processing.html#cb147-297" tabindex="-1"></a>  </span>
<span id="cb147-298"><a href="functions-for-matching-pre--and-post-processing.html#cb147-298" tabindex="-1"></a>  <span class="co"># Aggregate pixel values by taking the majority</span></span>
<span id="cb147-299"><a href="functions-for-matching-pre--and-post-processing.html#cb147-299" tabindex="-1"></a>  grid.group.ini <span class="ot">=</span> <span class="fu">exact_extract</span>(<span class="at">x=</span>r.group, <span class="at">y=</span>grid, <span class="at">fun=</span><span class="st">&#39;mode&#39;</span>, <span class="at">append_cols=</span><span class="st">&quot;gridID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-300"><a href="functions-for-matching-pre--and-post-processing.html#cb147-300" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">group =</span> mode)</span>
<span id="cb147-301"><a href="functions-for-matching-pre--and-post-processing.html#cb147-301" tabindex="-1"></a>  grid.wdpaid <span class="ot">=</span> <span class="fu">exact_extract</span>(<span class="at">x=</span>r.wdpaid, <span class="at">y=</span>grid, <span class="at">fun=</span><span class="st">&quot;mode&quot;</span>, <span class="at">append_cols=</span><span class="st">&quot;gridID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-302"><a href="functions-for-matching-pre--and-post-processing.html#cb147-302" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">wdpaid =</span> mode)</span>
<span id="cb147-303"><a href="functions-for-matching-pre--and-post-processing.html#cb147-303" tabindex="-1"></a></span>
<span id="cb147-304"><a href="functions-for-matching-pre--and-post-processing.html#cb147-304" tabindex="-1"></a>  <span class="co"># Randomly select background pixels as potential control pixels</span></span>
<span id="cb147-305"><a href="functions-for-matching-pre--and-post-processing.html#cb147-305" tabindex="-1"></a>  <span class="do">##Take the list of background pixels, the  number of background and treatment pixels</span></span>
<span id="cb147-306"><a href="functions-for-matching-pre--and-post-processing.html#cb147-306" tabindex="-1"></a>  list_back_ID <span class="ot">=</span> grid.group.ini[grid.group.ini<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(grid.group.ini<span class="sc">$</span>group) <span class="sc">==</span> <span class="cn">FALSE</span>,]<span class="sc">$</span>gridID</span>
<span id="cb147-307"><a href="functions-for-matching-pre--and-post-processing.html#cb147-307" tabindex="-1"></a>  n_back_ID <span class="ot">=</span> <span class="fu">length</span>(list_back_ID)</span>
<span id="cb147-308"><a href="functions-for-matching-pre--and-post-processing.html#cb147-308" tabindex="-1"></a>  n_treat <span class="ot">=</span> <span class="fu">length</span>(grid.group.ini[grid.group.ini<span class="sc">$</span>group <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(grid.group.ini<span class="sc">$</span>group) <span class="sc">==</span> <span class="cn">FALSE</span>,]<span class="sc">$</span>gridID)</span>
<span id="cb147-309"><a href="functions-for-matching-pre--and-post-processing.html#cb147-309" tabindex="-1"></a>  <span class="do">##The number of potential control units is five times the number of treatment units</span></span>
<span id="cb147-310"><a href="functions-for-matching-pre--and-post-processing.html#cb147-310" tabindex="-1"></a>  n_control <span class="ot">=</span> <span class="fu">min</span>(n_back_ID, n_treat<span class="sc">*</span><span class="dv">5</span>)</span>
<span id="cb147-311"><a href="functions-for-matching-pre--and-post-processing.html#cb147-311" tabindex="-1"></a>  <span class="do">##Select randomly the list of background pixels selected as controls</span></span>
<span id="cb147-312"><a href="functions-for-matching-pre--and-post-processing.html#cb147-312" tabindex="-1"></a>  <span class="do">### Note that we control for the case n_back_ID = 1, which causes weird behavior using sample()</span></span>
<span id="cb147-313"><a href="functions-for-matching-pre--and-post-processing.html#cb147-313" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">0</span>) <span class="co">#To ensure reproductibility of the random sampling</span></span>
<span id="cb147-314"><a href="functions-for-matching-pre--and-post-processing.html#cb147-314" tabindex="-1"></a>  <span class="cf">if</span>(n_back_ID <span class="sc">&lt;=</span> <span class="dv">1</span>) list_control_ID <span class="ot">=</span> list_back_ID <span class="cf">else</span> list_control_ID <span class="ot">=</span> <span class="fu">sample</span>(<span class="at">x =</span> list_back_ID, <span class="at">size =</span> n_control, <span class="at">replace =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-315"><a href="functions-for-matching-pre--and-post-processing.html#cb147-315" tabindex="-1"></a>  <span class="do">## Finally, assign the background pixel chosen to the control group, characterized by group = 1</span></span>
<span id="cb147-316"><a href="functions-for-matching-pre--and-post-processing.html#cb147-316" tabindex="-1"></a>  grid.group <span class="ot">=</span> grid.group.ini <span class="sc">%&gt;%</span></span>
<span id="cb147-317"><a href="functions-for-matching-pre--and-post-processing.html#cb147-317" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">case_when</span>(gridID <span class="sc">%in%</span> list_control_ID <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb147-318"><a href="functions-for-matching-pre--and-post-processing.html#cb147-318" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> group))</span>
<span id="cb147-319"><a href="functions-for-matching-pre--and-post-processing.html#cb147-319" tabindex="-1"></a>  </span>
<span id="cb147-320"><a href="functions-for-matching-pre--and-post-processing.html#cb147-320" tabindex="-1"></a></span>
<span id="cb147-321"><a href="functions-for-matching-pre--and-post-processing.html#cb147-321" tabindex="-1"></a>  <span class="co"># Merge data frames</span></span>
<span id="cb147-322"><a href="functions-for-matching-pre--and-post-processing.html#cb147-322" tabindex="-1"></a>  grid.param.ini <span class="ot">=</span> grid.group <span class="sc">%&gt;%</span></span>
<span id="cb147-323"><a href="functions-for-matching-pre--and-post-processing.html#cb147-323" tabindex="-1"></a>    <span class="fu">merge</span>(., grid.wdpaid, <span class="at">by=</span><span class="st">&quot;gridID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-324"><a href="functions-for-matching-pre--and-post-processing.html#cb147-324" tabindex="-1"></a>    <span class="fu">merge</span>(., grid, <span class="at">by=</span><span class="st">&quot;gridID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-325"><a href="functions-for-matching-pre--and-post-processing.html#cb147-325" tabindex="-1"></a>    <span class="co"># drop rows having &quot;NA&quot; in column &quot;group&quot;</span></span>
<span id="cb147-326"><a href="functions-for-matching-pre--and-post-processing.html#cb147-326" tabindex="-1"></a>    <span class="fu">drop_na</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb147-327"><a href="functions-for-matching-pre--and-post-processing.html#cb147-327" tabindex="-1"></a>    <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-328"><a href="functions-for-matching-pre--and-post-processing.html#cb147-328" tabindex="-1"></a>    <span class="co"># Grid is projected to WGS84 because mapme.biodiverty package merely works with this CRS</span></span>
<span id="cb147-329"><a href="functions-for-matching-pre--and-post-processing.html#cb147-329" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-330"><a href="functions-for-matching-pre--and-post-processing.html#cb147-330" tabindex="-1"></a>    <span class="co">#Add treatment year variable</span></span>
<span id="cb147-331"><a href="functions-for-matching-pre--and-post-processing.html#cb147-331" tabindex="-1"></a>    <span class="fu">left_join</span>(dplyr<span class="sc">::</span><span class="fu">select</span>(data_pa, <span class="fu">c</span>(region_afd, region, sub_region, country_en, iso3, wdpaid, status_yr, year_funding_first, year_funding_all)), <span class="at">by =</span> <span class="st">&quot;wdpaid&quot;</span>)</span>
<span id="cb147-332"><a href="functions-for-matching-pre--and-post-processing.html#cb147-332" tabindex="-1"></a>  </span>
<span id="cb147-333"><a href="functions-for-matching-pre--and-post-processing.html#cb147-333" tabindex="-1"></a>  <span class="co"># If two PAs in different groups overlap, then the rasterization with fun = &quot;min&quot; (as in r.group definition) can lead to bad assignment of pixels.</span></span>
<span id="cb147-334"><a href="functions-for-matching-pre--and-post-processing.html#cb147-334" tabindex="-1"></a>  <span class="co"># For instance, if a PA non-funded (group = 4) overlaps with a funded, analyzed one (group = 2), then the pixel will be assigned to the group 2</span></span>
<span id="cb147-335"><a href="functions-for-matching-pre--and-post-processing.html#cb147-335" tabindex="-1"></a>  <span class="co"># Same for group 3 (funded, not analyzed). Then, the following correction is applied.</span></span>
<span id="cb147-336"><a href="functions-for-matching-pre--and-post-processing.html#cb147-336" tabindex="-1"></a>  <span class="co"># Finally, each group is given a name for later plotting</span></span>
<span id="cb147-337"><a href="functions-for-matching-pre--and-post-processing.html#cb147-337" tabindex="-1"></a>  <span class="co"># grid.param = grid.param.ini %&gt;%</span></span>
<span id="cb147-338"><a href="functions-for-matching-pre--and-post-processing.html#cb147-338" tabindex="-1"></a>  <span class="co">#   mutate(group = case_when(wdpaid %in% wdpaID_no_afd &amp; group == 2 ~ 4,</span></span>
<span id="cb147-339"><a href="functions-for-matching-pre--and-post-processing.html#cb147-339" tabindex="-1"></a>  <span class="co">#                            wdpaid %in% wdpaID_afd_no_ie &amp; group == 2 ~3,</span></span>
<span id="cb147-340"><a href="functions-for-matching-pre--and-post-processing.html#cb147-340" tabindex="-1"></a>  <span class="co">#                            TRUE ~ group)) %&gt;%</span></span>
<span id="cb147-341"><a href="functions-for-matching-pre--and-post-processing.html#cb147-341" tabindex="-1"></a>  </span>
<span id="cb147-342"><a href="functions-for-matching-pre--and-post-processing.html#cb147-342" tabindex="-1"></a>  <span class="co">#/!\ For the moment, a pixel both non-funded and funded is considered funded !</span></span>
<span id="cb147-343"><a href="functions-for-matching-pre--and-post-processing.html#cb147-343" tabindex="-1"></a>  <span class="co">#But if funded not analyzed AND funded analyzed, then funded not analyzed.</span></span>
<span id="cb147-344"><a href="functions-for-matching-pre--and-post-processing.html#cb147-344" tabindex="-1"></a>  <span class="co">#Idea : the pixel could be treated out of the period considered, so not comparable to toher treatment pixels considered in funded, analyzed.</span></span>
<span id="cb147-345"><a href="functions-for-matching-pre--and-post-processing.html#cb147-345" tabindex="-1"></a>  <span class="co"># -&gt; Check with Léa, Ingrid and PY if that seems OK</span></span>
<span id="cb147-346"><a href="functions-for-matching-pre--and-post-processing.html#cb147-346" tabindex="-1"></a>  grid.param <span class="ot">=</span> grid.param.ini <span class="sc">%&gt;%</span></span>
<span id="cb147-347"><a href="functions-for-matching-pre--and-post-processing.html#cb147-347" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group =</span> <span class="fu">case_when</span>(wdpaid <span class="sc">%in%</span> wdpaID_afd_no_ie <span class="sc">&amp;</span> group <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb147-348"><a href="functions-for-matching-pre--and-post-processing.html#cb147-348" tabindex="-1"></a>                             <span class="cn">TRUE</span> <span class="sc">~</span> group)) <span class="sc">%&gt;%</span></span>
<span id="cb147-349"><a href="functions-for-matching-pre--and-post-processing.html#cb147-349" tabindex="-1"></a>    <span class="co">#Add name for the group</span></span>
<span id="cb147-350"><a href="functions-for-matching-pre--and-post-processing.html#cb147-350" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group_name =</span> <span class="fu">case_when</span>(group <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">&quot;Background&quot;</span>,</span>
<span id="cb147-351"><a href="functions-for-matching-pre--and-post-processing.html#cb147-351" tabindex="-1"></a>                                  group <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Potential control&quot;</span>,</span>
<span id="cb147-352"><a href="functions-for-matching-pre--and-post-processing.html#cb147-352" tabindex="-1"></a>                                  group <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">&quot;Funded PA, analyzed (potential treatment)&quot;</span>,</span>
<span id="cb147-353"><a href="functions-for-matching-pre--and-post-processing.html#cb147-353" tabindex="-1"></a>                                  group <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">&quot;Funded PA, not analyzed&quot;</span>,</span>
<span id="cb147-354"><a href="functions-for-matching-pre--and-post-processing.html#cb147-354" tabindex="-1"></a>                                  group <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">&quot;Non-funded PA&quot;</span>,</span>
<span id="cb147-355"><a href="functions-for-matching-pre--and-post-processing.html#cb147-355" tabindex="-1"></a>                                  group <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">&quot;Buffer&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-356"><a href="functions-for-matching-pre--and-post-processing.html#cb147-356" tabindex="-1"></a>  <span class="co">#Add spatial resolution in m : useful to compute share of forest area in a given pixel and extrapolate to the PA for instance</span></span>
<span id="cb147-357"><a href="functions-for-matching-pre--and-post-processing.html#cb147-357" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">res_m =</span> gridSize)</span>
<span id="cb147-358"><a href="functions-for-matching-pre--and-post-processing.html#cb147-358" tabindex="-1"></a>  </span>
<span id="cb147-359"><a href="functions-for-matching-pre--and-post-processing.html#cb147-359" tabindex="-1"></a>  </span>
<span id="cb147-360"><a href="functions-for-matching-pre--and-post-processing.html#cb147-360" tabindex="-1"></a>  <span class="co">#Save the grid</span></span>
<span id="cb147-361"><a href="functions-for-matching-pre--and-post-processing.html#cb147-361" tabindex="-1"></a>  <span class="fu">s3write_using</span>(grid.param,</span>
<span id="cb147-362"><a href="functions-for-matching-pre--and-post-processing.html#cb147-362" tabindex="-1"></a>                sf<span class="sc">::</span>write_sf,</span>
<span id="cb147-363"><a href="functions-for-matching-pre--and-post-processing.html#cb147-363" tabindex="-1"></a>                <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-364"><a href="functions-for-matching-pre--and-post-processing.html#cb147-364" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;grid_param_&quot;</span>, iso, <span class="st">&quot;.gpkg&quot;</span>)),</span>
<span id="cb147-365"><a href="functions-for-matching-pre--and-post-processing.html#cb147-365" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-366"><a href="functions-for-matching-pre--and-post-processing.html#cb147-366" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-367"><a href="functions-for-matching-pre--and-post-processing.html#cb147-367" tabindex="-1"></a>  </span>
<span id="cb147-368"><a href="functions-for-matching-pre--and-post-processing.html#cb147-368" tabindex="-1"></a>  <span class="co"># Visualize and save grouped grid cells</span></span>
<span id="cb147-369"><a href="functions-for-matching-pre--and-post-processing.html#cb147-369" tabindex="-1"></a>  </span>
<span id="cb147-370"><a href="functions-for-matching-pre--and-post-processing.html#cb147-370" tabindex="-1"></a>  <span class="do">## Extract country name</span></span>
<span id="cb147-371"><a href="functions-for-matching-pre--and-post-processing.html#cb147-371" tabindex="-1"></a>  country.name <span class="ot">=</span> grid.param <span class="sc">%&gt;%</span> </span>
<span id="cb147-372"><a href="functions-for-matching-pre--and-post-processing.html#cb147-372" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-373"><a href="functions-for-matching-pre--and-post-processing.html#cb147-373" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-374"><a href="functions-for-matching-pre--and-post-processing.html#cb147-374" tabindex="-1"></a>  country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-375"><a href="functions-for-matching-pre--and-post-processing.html#cb147-375" tabindex="-1"></a>  </span>
<span id="cb147-376"><a href="functions-for-matching-pre--and-post-processing.html#cb147-376" tabindex="-1"></a>  fig_grid_group <span class="ot">=</span> </span>
<span id="cb147-377"><a href="functions-for-matching-pre--and-post-processing.html#cb147-377" tabindex="-1"></a>    <span class="fu">ggplot</span>(grid.param) <span class="sc">+</span></span>
<span id="cb147-378"><a href="functions-for-matching-pre--and-post-processing.html#cb147-378" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">as.factor</span>(group_name)), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb147-379"><a href="functions-for-matching-pre--and-post-processing.html#cb147-379" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Gridding of&quot;</span>, country.name)) <span class="sc">+</span></span>
<span id="cb147-380"><a href="functions-for-matching-pre--and-post-processing.html#cb147-380" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">name =</span> <span class="st">&quot;Group&quot;</span>, <span class="at">type =</span> <span class="st">&quot;qual&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;YlGnBu&quot;</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb147-381"><a href="functions-for-matching-pre--and-post-processing.html#cb147-381" tabindex="-1"></a>    <span class="co"># scale_color_viridis_d(</span></span>
<span id="cb147-382"><a href="functions-for-matching-pre--and-post-processing.html#cb147-382" tabindex="-1"></a>    <span class="co">#   # legend title</span></span>
<span id="cb147-383"><a href="functions-for-matching-pre--and-post-processing.html#cb147-383" tabindex="-1"></a>    <span class="co">#   name=&quot;Group&quot;, </span></span>
<span id="cb147-384"><a href="functions-for-matching-pre--and-post-processing.html#cb147-384" tabindex="-1"></a>    <span class="co">#   # legend label</span></span>
<span id="cb147-385"><a href="functions-for-matching-pre--and-post-processing.html#cb147-385" tabindex="-1"></a>    <span class="co">#   labels=c(&quot;control candidate&quot;, &quot;treatment candidate&quot;, &quot;non-funded PA&quot;, &quot;buffer zone&quot;)) +</span></span>
<span id="cb147-386"><a href="functions-for-matching-pre--and-post-processing.html#cb147-386" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb147-387"><a href="functions-for-matching-pre--and-post-processing.html#cb147-387" tabindex="-1"></a>  fig_save <span class="ot">=</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/fig_grid_group_&quot;</span>, iso, <span class="st">&quot;.png&quot;</span>)</span>
<span id="cb147-388"><a href="functions-for-matching-pre--and-post-processing.html#cb147-388" tabindex="-1"></a>  <span class="fu">ggsave</span>(fig_save,</span>
<span id="cb147-389"><a href="functions-for-matching-pre--and-post-processing.html#cb147-389" tabindex="-1"></a>         <span class="at">plot =</span> fig_grid_group,</span>
<span id="cb147-390"><a href="functions-for-matching-pre--and-post-processing.html#cb147-390" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-391"><a href="functions-for-matching-pre--and-post-processing.html#cb147-391" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-392"><a href="functions-for-matching-pre--and-post-processing.html#cb147-392" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> fig_save,</span>
<span id="cb147-393"><a href="functions-for-matching-pre--and-post-processing.html#cb147-393" tabindex="-1"></a>                     <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-394"><a href="functions-for-matching-pre--and-post-processing.html#cb147-394" tabindex="-1"></a>                     <span class="at">region =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb147-395"><a href="functions-for-matching-pre--and-post-processing.html#cb147-395" tabindex="-1"></a>                     <span class="at">show_progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-396"><a href="functions-for-matching-pre--and-post-processing.html#cb147-396" tabindex="-1"></a>  </span>
<span id="cb147-397"><a href="functions-for-matching-pre--and-post-processing.html#cb147-397" tabindex="-1"></a>  </span>
<span id="cb147-398"><a href="functions-for-matching-pre--and-post-processing.html#cb147-398" tabindex="-1"></a>  <span class="co"># Pie plots</span></span>
<span id="cb147-399"><a href="functions-for-matching-pre--and-post-processing.html#cb147-399" tabindex="-1"></a>  df_pie_wdpa <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb147-400"><a href="functions-for-matching-pre--and-post-processing.html#cb147-400" tabindex="-1"></a>    <span class="fu">filter</span>(iso3 <span class="sc">==</span> iso) <span class="sc">%&gt;%</span></span>
<span id="cb147-401"><a href="functions-for-matching-pre--and-post-processing.html#cb147-401" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(iso3, wdpaid, name_pa, status_yr, area_km2)) <span class="sc">%&gt;%</span></span>
<span id="cb147-402"><a href="functions-for-matching-pre--and-post-processing.html#cb147-402" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group_wdpa =</span> <span class="fu">case_when</span>(<span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">~</span> <span class="st">&quot;WDPA&quot;</span>,</span>
<span id="cb147-403"><a href="functions-for-matching-pre--and-post-processing.html#cb147-403" tabindex="-1"></a>                             <span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">&quot;Not WDPA&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-404"><a href="functions-for-matching-pre--and-post-processing.html#cb147-404" tabindex="-1"></a>    <span class="fu">group_by</span>(iso3, group_wdpa) <span class="sc">%&gt;%</span></span>
<span id="cb147-405"><a href="functions-for-matching-pre--and-post-processing.html#cb147-405" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb147-406"><a href="functions-for-matching-pre--and-post-processing.html#cb147-406" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-407"><a href="functions-for-matching-pre--and-post-processing.html#cb147-407" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_tot =</span> <span class="fu">sum</span>(n),</span>
<span id="cb147-408"><a href="functions-for-matching-pre--and-post-processing.html#cb147-408" tabindex="-1"></a>           <span class="at">freq =</span> <span class="fu">round</span>(n<span class="sc">/</span>n_tot<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb147-409"><a href="functions-for-matching-pre--and-post-processing.html#cb147-409" tabindex="-1"></a>  </span>
<span id="cb147-410"><a href="functions-for-matching-pre--and-post-processing.html#cb147-410" tabindex="-1"></a>  df_pie_ie <span class="ot">=</span> wdpa_prj <span class="sc">%&gt;%</span></span>
<span id="cb147-411"><a href="functions-for-matching-pre--and-post-processing.html#cb147-411" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-412"><a href="functions-for-matching-pre--and-post-processing.html#cb147-412" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(ISO3, WDPAID)) <span class="sc">%&gt;%</span></span>
<span id="cb147-413"><a href="functions-for-matching-pre--and-post-processing.html#cb147-413" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group_ie =</span> <span class="fu">case_when</span>(<span class="sc">!</span>WDPAID <span class="sc">%in%</span> <span class="fu">c</span>(wdpaID_afd_ie, wdpaID_afd_no_ie) <span class="sc">~</span> <span class="st">&quot;Non-funded&quot;</span>,</span>
<span id="cb147-414"><a href="functions-for-matching-pre--and-post-processing.html#cb147-414" tabindex="-1"></a>                                WDPAID <span class="sc">%in%</span> wdpaID_afd_ie <span class="sc">~</span> <span class="st">&quot;Funded, analyzed&quot;</span>,</span>
<span id="cb147-415"><a href="functions-for-matching-pre--and-post-processing.html#cb147-415" tabindex="-1"></a>                                WDPAID <span class="sc">%in%</span> wdpaID_afd_no_ie <span class="sc">~</span> <span class="st">&quot;Funded, not analyzed&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-416"><a href="functions-for-matching-pre--and-post-processing.html#cb147-416" tabindex="-1"></a>    <span class="fu">group_by</span>(ISO3, group_ie) <span class="sc">%&gt;%</span></span>
<span id="cb147-417"><a href="functions-for-matching-pre--and-post-processing.html#cb147-417" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb147-418"><a href="functions-for-matching-pre--and-post-processing.html#cb147-418" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-419"><a href="functions-for-matching-pre--and-post-processing.html#cb147-419" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">n_tot =</span> <span class="fu">sum</span>(n),</span>
<span id="cb147-420"><a href="functions-for-matching-pre--and-post-processing.html#cb147-420" tabindex="-1"></a>           <span class="at">freq =</span> <span class="fu">round</span>(n<span class="sc">/</span>n_tot<span class="sc">*</span><span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb147-421"><a href="functions-for-matching-pre--and-post-processing.html#cb147-421" tabindex="-1"></a>  </span>
<span id="cb147-422"><a href="functions-for-matching-pre--and-post-processing.html#cb147-422" tabindex="-1"></a>  <span class="do">## PAs funded : reported in the WDPAID or not</span></span>
<span id="cb147-423"><a href="functions-for-matching-pre--and-post-processing.html#cb147-423" tabindex="-1"></a>  pie_wdpa <span class="ot">=</span> <span class="fu">ggplot</span>(df_pie_wdpa, </span>
<span id="cb147-424"><a href="functions-for-matching-pre--and-post-processing.html#cb147-424" tabindex="-1"></a>                        <span class="fu">aes</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span> freq, <span class="at">fill =</span> group_wdpa)) <span class="sc">%&gt;%</span></span>
<span id="cb147-425"><a href="functions-for-matching-pre--and-post-processing.html#cb147-425" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="fl">0.5</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">color=</span><span class="st">&quot;white&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-426"><a href="functions-for-matching-pre--and-post-processing.html#cb147-426" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-427"><a href="functions-for-matching-pre--and-post-processing.html#cb147-427" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">geom_label_repel</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fl">1.1</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(freq, <span class="dv">1</span>), <span class="st">&quot;% (&quot;</span>, n, <span class="st">&quot;)&quot;</span>)), </span>
<span id="cb147-428"><a href="functions-for-matching-pre--and-post-processing.html#cb147-428" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb147-429"><a href="functions-for-matching-pre--and-post-processing.html#cb147-429" tabindex="-1"></a>                       <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.55</span>), </span>
<span id="cb147-430"><a href="functions-for-matching-pre--and-post-processing.html#cb147-430" tabindex="-1"></a>                       <span class="at">size=</span><span class="dv">4</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-431"><a href="functions-for-matching-pre--and-post-processing.html#cb147-431" tabindex="-1"></a>    <span class="co"># + geom_label(aes(x=1.4, label = paste0(freq_iucn, &quot;%&quot;)), </span></span>
<span id="cb147-432"><a href="functions-for-matching-pre--and-post-processing.html#cb147-432" tabindex="-1"></a>    <span class="co">#              color = &quot;white&quot;, </span></span>
<span id="cb147-433"><a href="functions-for-matching-pre--and-post-processing.html#cb147-433" tabindex="-1"></a>    <span class="co">#              position = position_stack(vjust = 0.7), size=2.5, </span></span>
<span id="cb147-434"><a href="functions-for-matching-pre--and-post-processing.html#cb147-434" tabindex="-1"></a>    <span class="co">#              show.legend = FALSE) %&gt;%</span></span>
<span id="cb147-435"><a href="functions-for-matching-pre--and-post-processing.html#cb147-435" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb147-436"><a href="functions-for-matching-pre--and-post-processing.html#cb147-436" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">&quot;Share of PAs funded and reported in the WDPA&quot;</span>,</span>
<span id="cb147-437"><a href="functions-for-matching-pre--and-post-processing.html#cb147-437" tabindex="-1"></a>           <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;Sample :&quot;</span>, <span class="fu">sum</span>(df_pie_wdpa<span class="sc">$</span>n), <span class="st">&quot;funded protected areas in&quot;</span>, country.name)) <span class="sc">%&gt;%</span></span>
<span id="cb147-438"><a href="functions-for-matching-pre--and-post-processing.html#cb147-438" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">scale_fill_brewer</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Greens&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-439"><a href="functions-for-matching-pre--and-post-processing.html#cb147-439" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">theme_void</span>()</span>
<span id="cb147-440"><a href="functions-for-matching-pre--and-post-processing.html#cb147-440" tabindex="-1"></a>  </span>
<span id="cb147-441"><a href="functions-for-matching-pre--and-post-processing.html#cb147-441" tabindex="-1"></a>  <span class="do">## PAs in the WDPA : analyzed or not</span></span>
<span id="cb147-442"><a href="functions-for-matching-pre--and-post-processing.html#cb147-442" tabindex="-1"></a>  pie_ie <span class="ot">=</span> <span class="fu">ggplot</span>(df_pie_ie, </span>
<span id="cb147-443"><a href="functions-for-matching-pre--and-post-processing.html#cb147-443" tabindex="-1"></a>                    <span class="fu">aes</span>(<span class="at">x=</span><span class="st">&quot;&quot;</span>, <span class="at">y=</span> freq, <span class="at">fill =</span> group_ie)) <span class="sc">%&gt;%</span></span>
<span id="cb147-444"><a href="functions-for-matching-pre--and-post-processing.html#cb147-444" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">geom_bar</span>(<span class="at">width =</span> <span class="fl">0.5</span>, <span class="at">stat =</span> <span class="st">&quot;identity&quot;</span>, <span class="at">color=</span><span class="st">&quot;white&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-445"><a href="functions-for-matching-pre--and-post-processing.html#cb147-445" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">coord_polar</span>(<span class="st">&quot;y&quot;</span>, <span class="at">start=</span><span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-446"><a href="functions-for-matching-pre--and-post-processing.html#cb147-446" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">geom_label_repel</span>(<span class="fu">aes</span>(<span class="at">x=</span><span class="fl">1.1</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="fu">round</span>(freq, <span class="dv">1</span>), <span class="st">&quot;% (&quot;</span>, n, <span class="st">&quot;)&quot;</span>)), </span>
<span id="cb147-447"><a href="functions-for-matching-pre--and-post-processing.html#cb147-447" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb147-448"><a href="functions-for-matching-pre--and-post-processing.html#cb147-448" tabindex="-1"></a>                       <span class="at">position =</span> <span class="fu">position_stack</span>(<span class="at">vjust =</span> <span class="fl">0.55</span>), </span>
<span id="cb147-449"><a href="functions-for-matching-pre--and-post-processing.html#cb147-449" tabindex="-1"></a>                       <span class="at">size=</span><span class="dv">4</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-450"><a href="functions-for-matching-pre--and-post-processing.html#cb147-450" tabindex="-1"></a>    <span class="co"># + geom_label(aes(x=1.4, label = paste0(freq_iucn, &quot;%&quot;)), </span></span>
<span id="cb147-451"><a href="functions-for-matching-pre--and-post-processing.html#cb147-451" tabindex="-1"></a>    <span class="co">#              color = &quot;white&quot;, </span></span>
<span id="cb147-452"><a href="functions-for-matching-pre--and-post-processing.html#cb147-452" tabindex="-1"></a>    <span class="co">#              position = position_stack(vjust = 0.7), size=2.5, </span></span>
<span id="cb147-453"><a href="functions-for-matching-pre--and-post-processing.html#cb147-453" tabindex="-1"></a>    <span class="co">#              show.legend = FALSE) %&gt;%</span></span>
<span id="cb147-454"><a href="functions-for-matching-pre--and-post-processing.html#cb147-454" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;&quot;</span>, <span class="at">y =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb147-455"><a href="functions-for-matching-pre--and-post-processing.html#cb147-455" tabindex="-1"></a>           <span class="at">title =</span> <span class="st">&quot;Share of PAs reported in the WDPA and analyzed&quot;</span>,</span>
<span id="cb147-456"><a href="functions-for-matching-pre--and-post-processing.html#cb147-456" tabindex="-1"></a>           <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">&quot;Sample :&quot;</span>, <span class="fu">sum</span>(df_pie_ie<span class="sc">$</span>n), <span class="st">&quot;funded protected areas in&quot;</span>, country.name)) <span class="sc">%&gt;%</span></span>
<span id="cb147-457"><a href="functions-for-matching-pre--and-post-processing.html#cb147-457" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">scale_fill_brewer</span>(<span class="at">name =</span> <span class="st">&quot;&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;Greens&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-458"><a href="functions-for-matching-pre--and-post-processing.html#cb147-458" tabindex="-1"></a>    <span class="sc">+</span> <span class="fu">theme_void</span>()</span>
<span id="cb147-459"><a href="functions-for-matching-pre--and-post-processing.html#cb147-459" tabindex="-1"></a>  </span>
<span id="cb147-460"><a href="functions-for-matching-pre--and-post-processing.html#cb147-460" tabindex="-1"></a>  <span class="do">##Saving plots</span></span>
<span id="cb147-461"><a href="functions-for-matching-pre--and-post-processing.html#cb147-461" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;fig&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb147-462"><a href="functions-for-matching-pre--and-post-processing.html#cb147-462" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;pie_funded_wdpa_&quot;</span>, iso, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-463"><a href="functions-for-matching-pre--and-post-processing.html#cb147-463" tabindex="-1"></a>         <span class="at">plot =</span> pie_wdpa,</span>
<span id="cb147-464"><a href="functions-for-matching-pre--and-post-processing.html#cb147-464" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-465"><a href="functions-for-matching-pre--and-post-processing.html#cb147-465" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-466"><a href="functions-for-matching-pre--and-post-processing.html#cb147-466" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;pie_wdpa_ie_&quot;</span>, iso, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-467"><a href="functions-for-matching-pre--and-post-processing.html#cb147-467" tabindex="-1"></a>         <span class="at">plot =</span> pie_ie,</span>
<span id="cb147-468"><a href="functions-for-matching-pre--and-post-processing.html#cb147-468" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-469"><a href="functions-for-matching-pre--and-post-processing.html#cb147-469" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-470"><a href="functions-for-matching-pre--and-post-processing.html#cb147-470" tabindex="-1"></a>  </span>
<span id="cb147-471"><a href="functions-for-matching-pre--and-post-processing.html#cb147-471" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-472"><a href="functions-for-matching-pre--and-post-processing.html#cb147-472" tabindex="-1"></a>  <span class="do">##Add each file in the bucket (same foler for every file in the temp)</span></span>
<span id="cb147-473"><a href="functions-for-matching-pre--and-post-processing.html#cb147-473" tabindex="-1"></a>  <span class="cf">for</span>(f <span class="cf">in</span> files) </span>
<span id="cb147-474"><a href="functions-for-matching-pre--and-post-processing.html#cb147-474" tabindex="-1"></a>  {</span>
<span id="cb147-475"><a href="functions-for-matching-pre--and-post-processing.html#cb147-475" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Uploading file&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;&#39;&quot;</span>, f, <span class="st">&quot;&#39;&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb147-476"><a href="functions-for-matching-pre--and-post-processing.html#cb147-476" tabindex="-1"></a>    aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> f,</span>
<span id="cb147-477"><a href="functions-for-matching-pre--and-post-processing.html#cb147-477" tabindex="-1"></a>                       <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-478"><a href="functions-for-matching-pre--and-post-processing.html#cb147-478" tabindex="-1"></a>                       <span class="at">region =</span> <span class="st">&quot;&quot;</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-479"><a href="functions-for-matching-pre--and-post-processing.html#cb147-479" tabindex="-1"></a>  }</span>
<span id="cb147-480"><a href="functions-for-matching-pre--and-post-processing.html#cb147-480" tabindex="-1"></a>  <span class="fu">do.call</span>(file.remove, <span class="fu">list</span>(<span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb147-481"><a href="functions-for-matching-pre--and-post-processing.html#cb147-481" tabindex="-1"></a>  </span>
<span id="cb147-482"><a href="functions-for-matching-pre--and-post-processing.html#cb147-482" tabindex="-1"></a>  <span class="co">#Append the log </span></span>
<span id="cb147-483"><a href="functions-for-matching-pre--and-post-processing.html#cb147-483" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Determining Group IDs and WDPA IDs</span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-484"><a href="functions-for-matching-pre--and-post-processing.html#cb147-484" tabindex="-1"></a>  </span>
<span id="cb147-485"><a href="functions-for-matching-pre--and-post-processing.html#cb147-485" tabindex="-1"></a>  <span class="co">#Return the output</span></span>
<span id="cb147-486"><a href="functions-for-matching-pre--and-post-processing.html#cb147-486" tabindex="-1"></a>  list_output <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;grid.param&quot;</span> <span class="ot">=</span> grid.param, <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-487"><a href="functions-for-matching-pre--and-post-processing.html#cb147-487" tabindex="-1"></a>  <span class="fu">return</span>(list_output)</span>
<span id="cb147-488"><a href="functions-for-matching-pre--and-post-processing.html#cb147-488" tabindex="-1"></a>  </span>
<span id="cb147-489"><a href="functions-for-matching-pre--and-post-processing.html#cb147-489" tabindex="-1"></a>    },</span>
<span id="cb147-490"><a href="functions-for-matching-pre--and-post-processing.html#cb147-490" tabindex="-1"></a>  </span>
<span id="cb147-491"><a href="functions-for-matching-pre--and-post-processing.html#cb147-491" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-492"><a href="functions-for-matching-pre--and-post-processing.html#cb147-492" tabindex="-1"></a>  {</span>
<span id="cb147-493"><a href="functions-for-matching-pre--and-post-processing.html#cb147-493" tabindex="-1"></a>    <span class="co">#Print the error and append the log</span></span>
<span id="cb147-494"><a href="functions-for-matching-pre--and-post-processing.html#cb147-494" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-495"><a href="functions-for-matching-pre--and-post-processing.html#cb147-495" tabindex="-1"></a>    <span class="co">#Append the log </span></span>
<span id="cb147-496"><a href="functions-for-matching-pre--and-post-processing.html#cb147-496" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Determining Group IDs and WDPA IDs</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-497"><a href="functions-for-matching-pre--and-post-processing.html#cb147-497" tabindex="-1"></a>    <span class="co">#Return string to inform user to skip</span></span>
<span id="cb147-498"><a href="functions-for-matching-pre--and-post-processing.html#cb147-498" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-499"><a href="functions-for-matching-pre--and-post-processing.html#cb147-499" tabindex="-1"></a>  },</span>
<span id="cb147-500"><a href="functions-for-matching-pre--and-post-processing.html#cb147-500" tabindex="-1"></a>  </span>
<span id="cb147-501"><a href="functions-for-matching-pre--and-post-processing.html#cb147-501" tabindex="-1"></a>  <span class="at">warning =</span> <span class="cf">function</span>(w)</span>
<span id="cb147-502"><a href="functions-for-matching-pre--and-post-processing.html#cb147-502" tabindex="-1"></a>  {</span>
<span id="cb147-503"><a href="functions-for-matching-pre--and-post-processing.html#cb147-503" tabindex="-1"></a>    <span class="co">#Print the warning and append the log</span></span>
<span id="cb147-504"><a href="functions-for-matching-pre--and-post-processing.html#cb147-504" tabindex="-1"></a>    <span class="fu">print</span>(w)</span>
<span id="cb147-505"><a href="functions-for-matching-pre--and-post-processing.html#cb147-505" tabindex="-1"></a>    <span class="co">#Append the log </span></span>
<span id="cb147-506"><a href="functions-for-matching-pre--and-post-processing.html#cb147-506" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Determining Group IDs and WDPA IDs</span><span class="sc">\n</span><span class="st">-&gt; Warning :</span><span class="sc">\n</span><span class="st">&quot;</span>, w, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-507"><a href="functions-for-matching-pre--and-post-processing.html#cb147-507" tabindex="-1"></a>    <span class="co">#Return string to inform user to skip</span></span>
<span id="cb147-508"><a href="functions-for-matching-pre--and-post-processing.html#cb147-508" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-509"><a href="functions-for-matching-pre--and-post-processing.html#cb147-509" tabindex="-1"></a>  }</span>
<span id="cb147-510"><a href="functions-for-matching-pre--and-post-processing.html#cb147-510" tabindex="-1"></a>  </span>
<span id="cb147-511"><a href="functions-for-matching-pre--and-post-processing.html#cb147-511" tabindex="-1"></a>  )</span>
<span id="cb147-512"><a href="functions-for-matching-pre--and-post-processing.html#cb147-512" tabindex="-1"></a>  </span>
<span id="cb147-513"><a href="functions-for-matching-pre--and-post-processing.html#cb147-513" tabindex="-1"></a>  <span class="co">#Return outputs</span></span>
<span id="cb147-514"><a href="functions-for-matching-pre--and-post-processing.html#cb147-514" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-515"><a href="functions-for-matching-pre--and-post-processing.html#cb147-515" tabindex="-1"></a>  </span>
<span id="cb147-516"><a href="functions-for-matching-pre--and-post-processing.html#cb147-516" tabindex="-1"></a>}</span>
<span id="cb147-517"><a href="functions-for-matching-pre--and-post-processing.html#cb147-517" tabindex="-1"></a></span>
<span id="cb147-518"><a href="functions-for-matching-pre--and-post-processing.html#cb147-518" tabindex="-1"></a></span>
<span id="cb147-519"><a href="functions-for-matching-pre--and-post-processing.html#cb147-519" tabindex="-1"></a></span>
<span id="cb147-520"><a href="functions-for-matching-pre--and-post-processing.html#cb147-520" tabindex="-1"></a><span class="co">#Building a matching dataframe for the country considered : for each pixel in treated and control groups, the data needed for the analysis are downloaded and the indicators computed. Eventually a dataset is obtained that is ready to enter a matching algorithm</span></span>
<span id="cb147-521"><a href="functions-for-matching-pre--and-post-processing.html#cb147-521" tabindex="-1"></a><span class="do">##INPUTS :</span></span>
<span id="cb147-522"><a href="functions-for-matching-pre--and-post-processing.html#cb147-522" tabindex="-1"></a><span class="do">### grid.param : a raster representing the gridding of the country with two layers. One for the group each pixel belongs to (funded PA, non-funded PA, potential control, buffer), the other for the WDPAID corresponding to each pixel (0 if not a PA)</span></span>
<span id="cb147-523"><a href="functions-for-matching-pre--and-post-processing.html#cb147-523" tabindex="-1"></a><span class="do">### path_tmp : a temporary folder to store figures</span></span>
<span id="cb147-524"><a href="functions-for-matching-pre--and-post-processing.html#cb147-524" tabindex="-1"></a><span class="do">### iso : ISO code of the country of interest</span></span>
<span id="cb147-525"><a href="functions-for-matching-pre--and-post-processing.html#cb147-525" tabindex="-1"></a><span class="do">### name_output : the name of the matching frame to save</span></span>
<span id="cb147-526"><a href="functions-for-matching-pre--and-post-processing.html#cb147-526" tabindex="-1"></a><span class="do">### ext_output : the file extension of the matching to save </span></span>
<span id="cb147-527"><a href="functions-for-matching-pre--and-post-processing.html#cb147-527" tabindex="-1"></a><span class="do">### yr_first : the first year of the period where the analysis takes place</span></span>
<span id="cb147-528"><a href="functions-for-matching-pre--and-post-processing.html#cb147-528" tabindex="-1"></a><span class="do">### yr_last : the last year of the period where the analysis takes place</span></span>
<span id="cb147-529"><a href="functions-for-matching-pre--and-post-processing.html#cb147-529" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-530"><a href="functions-for-matching-pre--and-post-processing.html#cb147-530" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-531"><a href="functions-for-matching-pre--and-post-processing.html#cb147-531" tabindex="-1"></a><span class="do">##OUTPUTS :</span></span>
<span id="cb147-532"><a href="functions-for-matching-pre--and-post-processing.html#cb147-532" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-533"><a href="functions-for-matching-pre--and-post-processing.html#cb147-533" tabindex="-1"></a><span class="do">##DATA SAVED</span></span>
<span id="cb147-534"><a href="functions-for-matching-pre--and-post-processing.html#cb147-534" tabindex="-1"></a><span class="do">### pivot.all : a dataframe with variables of interest (outcome, matching covariates) for all treated and potential control pixels</span></span>
<span id="cb147-535"><a href="functions-for-matching-pre--and-post-processing.html#cb147-535" tabindex="-1"></a></span>
<span id="cb147-536"><a href="functions-for-matching-pre--and-post-processing.html#cb147-536" tabindex="-1"></a>fn_pre_mf_parallel <span class="ot">=</span> <span class="cf">function</span>(grid.param, path_tmp, iso, name_output, ext_output, yr_first, yr_last, log, save_dir) </span>
<span id="cb147-537"><a href="functions-for-matching-pre--and-post-processing.html#cb147-537" tabindex="-1"></a>{</span>
<span id="cb147-538"><a href="functions-for-matching-pre--and-post-processing.html#cb147-538" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-539"><a href="functions-for-matching-pre--and-post-processing.html#cb147-539" tabindex="-1"></a>    </span>
<span id="cb147-540"><a href="functions-for-matching-pre--and-post-processing.html#cb147-540" tabindex="-1"></a>    {</span>
<span id="cb147-541"><a href="functions-for-matching-pre--and-post-processing.html#cb147-541" tabindex="-1"></a>  tic <span class="ot">=</span> <span class="fu">tic</span>()</span>
<span id="cb147-542"><a href="functions-for-matching-pre--and-post-processing.html#cb147-542" tabindex="-1"></a>  </span>
<span id="cb147-543"><a href="functions-for-matching-pre--and-post-processing.html#cb147-543" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;----Initialize portfolio&quot;</span>)</span>
<span id="cb147-544"><a href="functions-for-matching-pre--and-post-processing.html#cb147-544" tabindex="-1"></a>  <span class="co"># Take only potential control (group = 1) and treatment (group = 2) in the country gridding to lower the number of computations to perform</span></span>
<span id="cb147-545"><a href="functions-for-matching-pre--and-post-processing.html#cb147-545" tabindex="-1"></a>  grid.aoi <span class="ot">=</span> grid.param <span class="sc">%&gt;%</span></span>
<span id="cb147-546"><a href="functions-for-matching-pre--and-post-processing.html#cb147-546" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb147-547"><a href="functions-for-matching-pre--and-post-processing.html#cb147-547" tabindex="-1"></a>  <span class="co"># Create a mapme.biodiversity portfolio for the area of interest (aoi). This specifies the period considered and the geospatial units where data are downloaded and indicators computed (here, the treated and control pixels in the country gridding)</span></span>
<span id="cb147-548"><a href="functions-for-matching-pre--and-post-processing.html#cb147-548" tabindex="-1"></a>  aoi <span class="ot">=</span> <span class="fu">init_portfolio</span>(grid.aoi,</span>
<span id="cb147-549"><a href="functions-for-matching-pre--and-post-processing.html#cb147-549" tabindex="-1"></a>                       <span class="at">years =</span> yr_first<span class="sc">:</span>yr_last,</span>
<span id="cb147-550"><a href="functions-for-matching-pre--and-post-processing.html#cb147-550" tabindex="-1"></a>                       <span class="at">outdir =</span> path_tmp,</span>
<span id="cb147-551"><a href="functions-for-matching-pre--and-post-processing.html#cb147-551" tabindex="-1"></a>                       <span class="at">add_resources =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-552"><a href="functions-for-matching-pre--and-post-processing.html#cb147-552" tabindex="-1"></a>  </span>
<span id="cb147-553"><a href="functions-for-matching-pre--and-post-processing.html#cb147-553" tabindex="-1"></a>  <span class="co">#Extract a dataframe with pixels ID in the grid and the portfolio : useful for latter plotting of matched control and treated units. </span></span>
<span id="cb147-554"><a href="functions-for-matching-pre--and-post-processing.html#cb147-554" tabindex="-1"></a>  df_gridID_assetID <span class="ot">=</span> aoi <span class="sc">%&gt;%</span></span>
<span id="cb147-555"><a href="functions-for-matching-pre--and-post-processing.html#cb147-555" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-556"><a href="functions-for-matching-pre--and-post-processing.html#cb147-556" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-557"><a href="functions-for-matching-pre--and-post-processing.html#cb147-557" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(gridID, assetid))</span>
<span id="cb147-558"><a href="functions-for-matching-pre--and-post-processing.html#cb147-558" tabindex="-1"></a>  <span class="fu">s3write_using</span>(df_gridID_assetID,</span>
<span id="cb147-559"><a href="functions-for-matching-pre--and-post-processing.html#cb147-559" tabindex="-1"></a>                data.table<span class="sc">::</span>fwrite,</span>
<span id="cb147-560"><a href="functions-for-matching-pre--and-post-processing.html#cb147-560" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, <span class="st">&quot;df_gridID_assetID_&quot;</span>, iso, <span class="st">&quot;.csv&quot;</span>),</span>
<span id="cb147-561"><a href="functions-for-matching-pre--and-post-processing.html#cb147-561" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-562"><a href="functions-for-matching-pre--and-post-processing.html#cb147-562" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-563"><a href="functions-for-matching-pre--and-post-processing.html#cb147-563" tabindex="-1"></a>  </span>
<span id="cb147-564"><a href="functions-for-matching-pre--and-post-processing.html#cb147-564" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;----Download data&quot;</span>)</span>
<span id="cb147-565"><a href="functions-for-matching-pre--and-post-processing.html#cb147-565" tabindex="-1"></a>  <span class="co"># Download Data</span></span>
<span id="cb147-566"><a href="functions-for-matching-pre--and-post-processing.html#cb147-566" tabindex="-1"></a>  <span class="do">## Version of Global Forest Cover data to consider</span></span>
<span id="cb147-567"><a href="functions-for-matching-pre--and-post-processing.html#cb147-567" tabindex="-1"></a>  list_version_gfc <span class="ot">=</span> mapme.biodiversity<span class="sc">:::</span><span class="fu">.available_gfw_versions</span>() <span class="co">#all versions available</span></span>
<span id="cb147-568"><a href="functions-for-matching-pre--and-post-processing.html#cb147-568" tabindex="-1"></a>  version_gfc <span class="ot">=</span> list_version_gfc[<span class="fu">length</span>(list_version_gfc)] <span class="co">#last version considered</span></span>
<span id="cb147-569"><a href="functions-for-matching-pre--and-post-processing.html#cb147-569" tabindex="-1"></a>  <span class="do">## Soil characteristics</span></span>
<span id="cb147-570"><a href="functions-for-matching-pre--and-post-processing.html#cb147-570" tabindex="-1"></a>  dl.soil <span class="ot">=</span> <span class="fu">get_resources</span>(aoi, </span>
<span id="cb147-571"><a href="functions-for-matching-pre--and-post-processing.html#cb147-571" tabindex="-1"></a>                          <span class="at">resources =</span> <span class="fu">c</span>(<span class="st">&quot;soilgrids&quot;</span>), </span>
<span id="cb147-572"><a href="functions-for-matching-pre--and-post-processing.html#cb147-572" tabindex="-1"></a>                          <span class="at">layers =</span> <span class="fu">c</span>(<span class="st">&quot;clay&quot;</span>), <span class="co"># resource specific argument</span></span>
<span id="cb147-573"><a href="functions-for-matching-pre--and-post-processing.html#cb147-573" tabindex="-1"></a>                          <span class="at">depths =</span> <span class="fu">c</span>(<span class="st">&quot;0-5cm&quot;</span>), <span class="co"># resource specific argument</span></span>
<span id="cb147-574"><a href="functions-for-matching-pre--and-post-processing.html#cb147-574" tabindex="-1"></a>                          <span class="at">stats =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>))</span>
<span id="cb147-575"><a href="functions-for-matching-pre--and-post-processing.html#cb147-575" tabindex="-1"></a>  <span class="do">## Accessibility</span></span>
<span id="cb147-576"><a href="functions-for-matching-pre--and-post-processing.html#cb147-576" tabindex="-1"></a>  dl.travelT <span class="ot">=</span> <span class="fu">get_resources</span>(aoi, <span class="at">resources =</span> <span class="st">&quot;nelson_et_al&quot;</span>,</span>
<span id="cb147-577"><a href="functions-for-matching-pre--and-post-processing.html#cb147-577" tabindex="-1"></a>                             <span class="at">range_traveltime =</span> <span class="fu">c</span>(<span class="st">&quot;5k_110mio&quot;</span>))</span>
<span id="cb147-578"><a href="functions-for-matching-pre--and-post-processing.html#cb147-578" tabindex="-1"></a>  <span class="do">## Tree cover evolution on the period</span></span>
<span id="cb147-579"><a href="functions-for-matching-pre--and-post-processing.html#cb147-579" tabindex="-1"></a>  dl.tree <span class="ot">=</span> <span class="fu">get_resources</span>(aoi, </span>
<span id="cb147-580"><a href="functions-for-matching-pre--and-post-processing.html#cb147-580" tabindex="-1"></a>                          <span class="at">resources =</span> <span class="fu">c</span>(<span class="st">&quot;gfw_treecover&quot;</span>, <span class="st">&quot;gfw_lossyear&quot;</span>),</span>
<span id="cb147-581"><a href="functions-for-matching-pre--and-post-processing.html#cb147-581" tabindex="-1"></a>                          <span class="at">vers_treecover =</span> version_gfc,</span>
<span id="cb147-582"><a href="functions-for-matching-pre--and-post-processing.html#cb147-582" tabindex="-1"></a>                          <span class="at">vers_lossyear =</span> version_gfc)</span>
<span id="cb147-583"><a href="functions-for-matching-pre--and-post-processing.html#cb147-583" tabindex="-1"></a>  <span class="do">## Elevation</span></span>
<span id="cb147-584"><a href="functions-for-matching-pre--and-post-processing.html#cb147-584" tabindex="-1"></a>  dl.elevation <span class="ot">=</span> <span class="fu">get_resources</span>(aoi, <span class="st">&quot;nasa_srtm&quot;</span>)</span>
<span id="cb147-585"><a href="functions-for-matching-pre--and-post-processing.html#cb147-585" tabindex="-1"></a>  <span class="do">## Terrain Ruggedness Index</span></span>
<span id="cb147-586"><a href="functions-for-matching-pre--and-post-processing.html#cb147-586" tabindex="-1"></a>  dl.tri <span class="ot">=</span> <span class="fu">get_resources</span>(aoi, <span class="st">&quot;nasa_srtm&quot;</span>)</span>
<span id="cb147-587"><a href="functions-for-matching-pre--and-post-processing.html#cb147-587" tabindex="-1"></a>  </span>
<span id="cb147-588"><a href="functions-for-matching-pre--and-post-processing.html#cb147-588" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;----Compute indicators&quot;</span>)</span>
<span id="cb147-589"><a href="functions-for-matching-pre--and-post-processing.html#cb147-589" tabindex="-1"></a>  <span class="co">#Compute indicators</span></span>
<span id="cb147-590"><a href="functions-for-matching-pre--and-post-processing.html#cb147-590" tabindex="-1"></a>  </span>
<span id="cb147-591"><a href="functions-for-matching-pre--and-post-processing.html#cb147-591" tabindex="-1"></a>  <span class="co">#Begin multisession : use of parallel computing (computations performed in separate R sessions in background) to speed up the computations of indicators</span></span>
<span id="cb147-592"><a href="functions-for-matching-pre--and-post-processing.html#cb147-592" tabindex="-1"></a>  <span class="co"># gc : optimize memory management for the background sessions.</span></span>
<span id="cb147-593"><a href="functions-for-matching-pre--and-post-processing.html#cb147-593" tabindex="-1"></a>  <span class="co"># Multisession with workers = 6 as in mapme.biodiversity tutorial : https://mapme-initiative.github.io/mapme.biodiversity/articles/quickstart.html?q=parall#enabling-parallel-computing</span></span>
<span id="cb147-594"><a href="functions-for-matching-pre--and-post-processing.html#cb147-594" tabindex="-1"></a>  <span class="co"># Careful to the format of command to call parallel computations here : VALUE TO COMPUTE %&lt;-% {EXPRESSION}.</span></span>
<span id="cb147-595"><a href="functions-for-matching-pre--and-post-processing.html#cb147-595" tabindex="-1"></a>  <span class="fu">plan</span>(multisession, <span class="at">workers =</span> <span class="dv">6</span>, <span class="at">gc =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-596"><a href="functions-for-matching-pre--and-post-processing.html#cb147-596" tabindex="-1"></a>  <span class="fu">with_progress</span>({</span>
<span id="cb147-597"><a href="functions-for-matching-pre--and-post-processing.html#cb147-597" tabindex="-1"></a>    get.soil <span class="sc">%&lt;-%</span> {<span class="fu">calc_indicators</span>(dl.soil,</span>
<span id="cb147-598"><a href="functions-for-matching-pre--and-post-processing.html#cb147-598" tabindex="-1"></a>                                <span class="at">indicators =</span> <span class="st">&quot;soilproperties&quot;</span>,</span>
<span id="cb147-599"><a href="functions-for-matching-pre--and-post-processing.html#cb147-599" tabindex="-1"></a>                                <span class="at">stats_soil =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>),</span>
<span id="cb147-600"><a href="functions-for-matching-pre--and-post-processing.html#cb147-600" tabindex="-1"></a>                                <span class="at">engine =</span> <span class="st">&quot;exactextract&quot;</span>)} <span class="co"># the &quot;exactextract&quot; engine is chosen as it is the faster one for large rasters (https://tmieno2.github.io/R-as-GIS-for-Economists/extraction-speed-comparison.html)</span></span>
<span id="cb147-601"><a href="functions-for-matching-pre--and-post-processing.html#cb147-601" tabindex="-1"></a></span>
<span id="cb147-602"><a href="functions-for-matching-pre--and-post-processing.html#cb147-602" tabindex="-1"></a>    get.travelT  <span class="sc">%&lt;-%</span> {<span class="fu">calc_indicators</span>(dl.travelT,</span>
<span id="cb147-603"><a href="functions-for-matching-pre--and-post-processing.html#cb147-603" tabindex="-1"></a>                                  <span class="at">indicators =</span> <span class="st">&quot;traveltime&quot;</span>,</span>
<span id="cb147-604"><a href="functions-for-matching-pre--and-post-processing.html#cb147-604" tabindex="-1"></a>                                  <span class="at">stats_accessibility =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>),  <span class="co">#Note KfW use &quot;median&quot; here, but for no specific reason a priori (mail to Kemmeng Liu, 28/09/2023). Mean is chosen coherently with the other covariates, though we could test in a second time whether this changes anything to the results.</span></span>
<span id="cb147-605"><a href="functions-for-matching-pre--and-post-processing.html#cb147-605" tabindex="-1"></a>                                  <span class="at">engine =</span> <span class="st">&quot;exactextract&quot;</span>)}</span>
<span id="cb147-606"><a href="functions-for-matching-pre--and-post-processing.html#cb147-606" tabindex="-1"></a></span>
<span id="cb147-607"><a href="functions-for-matching-pre--and-post-processing.html#cb147-607" tabindex="-1"></a>    get.tree  <span class="sc">%&lt;-%</span> {<span class="fu">calc_indicators</span>(dl.tree,</span>
<span id="cb147-608"><a href="functions-for-matching-pre--and-post-processing.html#cb147-608" tabindex="-1"></a>                               <span class="at">indicators =</span> <span class="st">&quot;treecover_area&quot;</span>,</span>
<span id="cb147-609"><a href="functions-for-matching-pre--and-post-processing.html#cb147-609" tabindex="-1"></a>                               <span class="at">min_size=</span><span class="fl">0.5</span>, <span class="co"># FAO definition of forest :  Minimum treecover = 10%, minimum size =0.5 hectare (FAO 2020 Global Fores Resources Assessment, https://www.fao.org/3/I8661EN/i8661en.pdf)</span></span>
<span id="cb147-610"><a href="functions-for-matching-pre--and-post-processing.html#cb147-610" tabindex="-1"></a>                               <span class="at">min_cover=</span><span class="dv">10</span>)}</span>
<span id="cb147-611"><a href="functions-for-matching-pre--and-post-processing.html#cb147-611" tabindex="-1"></a>  </span>
<span id="cb147-612"><a href="functions-for-matching-pre--and-post-processing.html#cb147-612" tabindex="-1"></a>    get.elevation <span class="sc">%&lt;-%</span> {<span class="fu">calc_indicators</span>(dl.elevation,</span>
<span id="cb147-613"><a href="functions-for-matching-pre--and-post-processing.html#cb147-613" tabindex="-1"></a>                      <span class="at">indicators =</span> <span class="st">&quot;elevation&quot;</span>,</span>
<span id="cb147-614"><a href="functions-for-matching-pre--and-post-processing.html#cb147-614" tabindex="-1"></a>                      <span class="at">stats_elevation =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>),</span>
<span id="cb147-615"><a href="functions-for-matching-pre--and-post-processing.html#cb147-615" tabindex="-1"></a>                      <span class="at">engine =</span> <span class="st">&quot;exactextract&quot;</span>)}</span>
<span id="cb147-616"><a href="functions-for-matching-pre--and-post-processing.html#cb147-616" tabindex="-1"></a>    </span>
<span id="cb147-617"><a href="functions-for-matching-pre--and-post-processing.html#cb147-617" tabindex="-1"></a>    get.tri <span class="sc">%&lt;-%</span> {<span class="fu">calc_indicators</span>(dl.tri,</span>
<span id="cb147-618"><a href="functions-for-matching-pre--and-post-processing.html#cb147-618" tabindex="-1"></a>                      <span class="at">indicators =</span> <span class="st">&quot;tri&quot;</span>,</span>
<span id="cb147-619"><a href="functions-for-matching-pre--and-post-processing.html#cb147-619" tabindex="-1"></a>                      <span class="at">stats_tri =</span> <span class="fu">c</span>(<span class="st">&quot;mean&quot;</span>),</span>
<span id="cb147-620"><a href="functions-for-matching-pre--and-post-processing.html#cb147-620" tabindex="-1"></a>                      <span class="at">engine =</span> <span class="st">&quot;exactextract&quot;</span>)}</span>
<span id="cb147-621"><a href="functions-for-matching-pre--and-post-processing.html#cb147-621" tabindex="-1"></a>    </span>
<span id="cb147-622"><a href="functions-for-matching-pre--and-post-processing.html#cb147-622" tabindex="-1"></a>    })</span>
<span id="cb147-623"><a href="functions-for-matching-pre--and-post-processing.html#cb147-623" tabindex="-1"></a>  </span>
<span id="cb147-624"><a href="functions-for-matching-pre--and-post-processing.html#cb147-624" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;----Build indicators&#39; datasets&quot;</span>)</span>
<span id="cb147-625"><a href="functions-for-matching-pre--and-post-processing.html#cb147-625" tabindex="-1"></a>  <span class="co">#Build indicators&#39; datasets</span></span>
<span id="cb147-626"><a href="functions-for-matching-pre--and-post-processing.html#cb147-626" tabindex="-1"></a>  <span class="do">## Transform the output dataframe into a -ore convenient format</span></span>
<span id="cb147-627"><a href="functions-for-matching-pre--and-post-processing.html#cb147-627" tabindex="-1"></a>  data.soil <span class="ot">=</span> <span class="fu">unnest</span>(get.soil, soilproperties) <span class="sc">%&gt;%</span></span>
<span id="cb147-628"><a href="functions-for-matching-pre--and-post-processing.html#cb147-628" tabindex="-1"></a>    <span class="co">#mutate(across(c(&quot;mean&quot;), \(x) round(x, 3))) %&gt;% # Round numeric columns --&gt; rounding before the matching algorithm is irrelevant to me</span></span>
<span id="cb147-629"><a href="functions-for-matching-pre--and-post-processing.html#cb147-629" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="fu">c</span>(<span class="st">&quot;layer&quot;</span>, <span class="st">&quot;depth&quot;</span>, <span class="st">&quot;stat&quot;</span>), <span class="at">values_from =</span> <span class="st">&quot;mean&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-630"><a href="functions-for-matching-pre--and-post-processing.html#cb147-630" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="st">&quot;clay_0_5cm_mean&quot;</span> <span class="ot">=</span> <span class="st">&quot;clay_0-5cm_mean&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-631"><a href="functions-for-matching-pre--and-post-processing.html#cb147-631" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">clay_0_5cm_mean =</span> <span class="fu">case_when</span>(<span class="fu">is.nan</span>(clay_0_5cm_mean) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb147-632"><a href="functions-for-matching-pre--and-post-processing.html#cb147-632" tabindex="-1"></a>                                       <span class="cn">TRUE</span> <span class="sc">~</span> clay_0_5cm_mean))</span>
<span id="cb147-633"><a href="functions-for-matching-pre--and-post-processing.html#cb147-633" tabindex="-1"></a>  </span>
<span id="cb147-634"><a href="functions-for-matching-pre--and-post-processing.html#cb147-634" tabindex="-1"></a>  data.travelT <span class="ot">=</span> <span class="fu">unnest</span>(get.travelT, traveltime) <span class="sc">%&gt;%</span></span>
<span id="cb147-635"><a href="functions-for-matching-pre--and-post-processing.html#cb147-635" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">&quot;distance&quot;</span>, <span class="at">values_from =</span> <span class="st">&quot;minutes_median&quot;</span>, <span class="at">names_prefix =</span> <span class="st">&quot;minutes_median_&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-636"><a href="functions-for-matching-pre--and-post-processing.html#cb147-636" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">minutes_median_5k_110mio =</span> <span class="fu">case_when</span>(<span class="fu">is.nan</span>(minutes_median_5k_110mio) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb147-637"><a href="functions-for-matching-pre--and-post-processing.html#cb147-637" tabindex="-1"></a>                                       <span class="cn">TRUE</span> <span class="sc">~</span> minutes_median_5k_110mio))</span>
<span id="cb147-638"><a href="functions-for-matching-pre--and-post-processing.html#cb147-638" tabindex="-1"></a>  </span>
<span id="cb147-639"><a href="functions-for-matching-pre--and-post-processing.html#cb147-639" tabindex="-1"></a>  data.tree <span class="ot">=</span> <span class="fu">unnest</span>(get.tree, treecover_area) <span class="sc">%&gt;%</span></span>
<span id="cb147-640"><a href="functions-for-matching-pre--and-post-processing.html#cb147-640" tabindex="-1"></a>    <span class="fu">drop_na</span>(treecover) <span class="sc">%&gt;%</span> <span class="co">#get rid of units with NA values </span></span>
<span id="cb147-641"><a href="functions-for-matching-pre--and-post-processing.html#cb147-641" tabindex="-1"></a>    <span class="co">#mutate(across(c(&quot;treecover&quot;), \(x) round(x, 3))) %&gt;% # Round numeric columns</span></span>
<span id="cb147-642"><a href="functions-for-matching-pre--and-post-processing.html#cb147-642" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> <span class="st">&quot;years&quot;</span>, <span class="at">values_from =</span> <span class="st">&quot;treecover&quot;</span>, <span class="at">names_prefix =</span> <span class="st">&quot;treecover_&quot;</span>)</span>
<span id="cb147-643"><a href="functions-for-matching-pre--and-post-processing.html#cb147-643" tabindex="-1"></a>  </span>
<span id="cb147-644"><a href="functions-for-matching-pre--and-post-processing.html#cb147-644" tabindex="-1"></a>  data.tri <span class="ot">=</span> <span class="fu">unnest</span>(get.tri, tri) <span class="sc">%&gt;%</span></span>
<span id="cb147-645"><a href="functions-for-matching-pre--and-post-processing.html#cb147-645" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">tri_mean =</span> <span class="fu">case_when</span>(<span class="fu">is.nan</span>(tri_mean) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb147-646"><a href="functions-for-matching-pre--and-post-processing.html#cb147-646" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> tri_mean))</span>
<span id="cb147-647"><a href="functions-for-matching-pre--and-post-processing.html#cb147-647" tabindex="-1"></a>  </span>
<span id="cb147-648"><a href="functions-for-matching-pre--and-post-processing.html#cb147-648" tabindex="-1"></a>  data.elevation <span class="ot">=</span> <span class="fu">unnest</span>(get.elevation, elevation) <span class="sc">%&gt;%</span></span>
<span id="cb147-649"><a href="functions-for-matching-pre--and-post-processing.html#cb147-649" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">elevation_mean =</span> <span class="fu">case_when</span>(<span class="fu">is.nan</span>(elevation_mean) <span class="sc">~</span> <span class="cn">NA</span>,</span>
<span id="cb147-650"><a href="functions-for-matching-pre--and-post-processing.html#cb147-650" tabindex="-1"></a>                                <span class="cn">TRUE</span> <span class="sc">~</span> elevation_mean))</span>
<span id="cb147-651"><a href="functions-for-matching-pre--and-post-processing.html#cb147-651" tabindex="-1"></a>  </span>
<span id="cb147-652"><a href="functions-for-matching-pre--and-post-processing.html#cb147-652" tabindex="-1"></a>  <span class="do">## End parallel plan : close parallel sessions, so must be done once indicators&#39; datasets are built</span></span>
<span id="cb147-653"><a href="functions-for-matching-pre--and-post-processing.html#cb147-653" tabindex="-1"></a>  <span class="fu">plan</span>(sequential)</span>
<span id="cb147-654"><a href="functions-for-matching-pre--and-post-processing.html#cb147-654" tabindex="-1"></a>  </span>
<span id="cb147-655"><a href="functions-for-matching-pre--and-post-processing.html#cb147-655" tabindex="-1"></a>  <span class="co"># The calculation of tree loss area is performed at dataframe base</span></span>
<span id="cb147-656"><a href="functions-for-matching-pre--and-post-processing.html#cb147-656" tabindex="-1"></a>  <span class="co"># Get the column names of tree cover time series</span></span>
<span id="cb147-657"><a href="functions-for-matching-pre--and-post-processing.html#cb147-657" tabindex="-1"></a>  colnames_tree <span class="ot">=</span> <span class="fu">names</span>(data.tree)[<span class="fu">startsWith</span>(<span class="fu">names</span>(data.tree), <span class="st">&quot;treecover&quot;</span>)]</span>
<span id="cb147-658"><a href="functions-for-matching-pre--and-post-processing.html#cb147-658" tabindex="-1"></a>  <span class="co"># Drop the first year</span></span>
<span id="cb147-659"><a href="functions-for-matching-pre--and-post-processing.html#cb147-659" tabindex="-1"></a>  dropFirst <span class="ot">=</span> <span class="fu">tail</span>(colnames_tree, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb147-660"><a href="functions-for-matching-pre--and-post-processing.html#cb147-660" tabindex="-1"></a>  <span class="co"># Drop the last year</span></span>
<span id="cb147-661"><a href="functions-for-matching-pre--and-post-processing.html#cb147-661" tabindex="-1"></a>  dropLast <span class="ot">=</span> <span class="fu">head</span>(colnames_tree, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb147-662"><a href="functions-for-matching-pre--and-post-processing.html#cb147-662" tabindex="-1"></a>  <span class="co"># Set list of new column names for tree loss time series</span></span>
<span id="cb147-663"><a href="functions-for-matching-pre--and-post-processing.html#cb147-663" tabindex="-1"></a>  colnames_loss <span class="ot">=</span> dropFirst <span class="sc">%&gt;%</span> <span class="fu">str_split</span>(., <span class="st">&quot;_&quot;</span>)</span>
<span id="cb147-664"><a href="functions-for-matching-pre--and-post-processing.html#cb147-664" tabindex="-1"></a>  </span>
<span id="cb147-665"><a href="functions-for-matching-pre--and-post-processing.html#cb147-665" tabindex="-1"></a>  <span class="co"># Add new columns: treeloss_tn = treecover_tn - treecover_t(n-1)  </span></span>
<span id="cb147-666"><a href="functions-for-matching-pre--and-post-processing.html#cb147-666" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(dropFirst)) </span>
<span id="cb147-667"><a href="functions-for-matching-pre--and-post-processing.html#cb147-667" tabindex="-1"></a>  {</span>
<span id="cb147-668"><a href="functions-for-matching-pre--and-post-processing.html#cb147-668" tabindex="-1"></a>    new_colname <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;treeloss_&quot;</span>, colnames_loss[[i]][<span class="dv">2</span>]) </span>
<span id="cb147-669"><a href="functions-for-matching-pre--and-post-processing.html#cb147-669" tabindex="-1"></a>    data.tree[[new_colname]] <span class="ot">=</span> data.tree[[dropFirst[i]]] <span class="sc">-</span> data.tree[[dropLast[i]]]</span>
<span id="cb147-670"><a href="functions-for-matching-pre--and-post-processing.html#cb147-670" tabindex="-1"></a>  }</span>
<span id="cb147-671"><a href="functions-for-matching-pre--and-post-processing.html#cb147-671" tabindex="-1"></a>  </span>
<span id="cb147-672"><a href="functions-for-matching-pre--and-post-processing.html#cb147-672" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;----Export Matching Frame&quot;</span>)</span>
<span id="cb147-673"><a href="functions-for-matching-pre--and-post-processing.html#cb147-673" tabindex="-1"></a>  <span class="co"># Remove &quot;geometry&quot; column from dataframes</span></span>
<span id="cb147-674"><a href="functions-for-matching-pre--and-post-processing.html#cb147-674" tabindex="-1"></a>  df.tree <span class="ot">=</span> data.tree <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb147-675"><a href="functions-for-matching-pre--and-post-processing.html#cb147-675" tabindex="-1"></a>  df.travelT <span class="ot">=</span> data.travelT <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb147-676"><a href="functions-for-matching-pre--and-post-processing.html#cb147-676" tabindex="-1"></a>  df.soil <span class="ot">=</span> data.soil <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb147-677"><a href="functions-for-matching-pre--and-post-processing.html#cb147-677" tabindex="-1"></a>  df.elevation <span class="ot">=</span> data.elevation <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb147-678"><a href="functions-for-matching-pre--and-post-processing.html#cb147-678" tabindex="-1"></a>  df.tri <span class="ot">=</span> data.tri <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">x=</span><span class="cn">NULL</span>) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb147-679"><a href="functions-for-matching-pre--and-post-processing.html#cb147-679" tabindex="-1"></a>  </span>
<span id="cb147-680"><a href="functions-for-matching-pre--and-post-processing.html#cb147-680" tabindex="-1"></a>  <span class="co"># Make a dataframe containing only &quot;assetid&quot; and geometry</span></span>
<span id="cb147-681"><a href="functions-for-matching-pre--and-post-processing.html#cb147-681" tabindex="-1"></a>  <span class="co"># Use data.soil instead of data.tree, as some pixels are removed in data.tree (NA values from get.tree)</span></span>
<span id="cb147-682"><a href="functions-for-matching-pre--and-post-processing.html#cb147-682" tabindex="-1"></a>  df.geom <span class="ot">=</span> data.soil[, <span class="fu">c</span>(<span class="st">&quot;assetid&quot;</span>, <span class="st">&quot;x&quot;</span>)] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() </span>
<span id="cb147-683"><a href="functions-for-matching-pre--and-post-processing.html#cb147-683" tabindex="-1"></a>  </span>
<span id="cb147-684"><a href="functions-for-matching-pre--and-post-processing.html#cb147-684" tabindex="-1"></a>  <span class="co"># Merge all output dataframes </span></span>
<span id="cb147-685"><a href="functions-for-matching-pre--and-post-processing.html#cb147-685" tabindex="-1"></a>  pivot.all <span class="ot">=</span> <span class="fu">Reduce</span>(dplyr<span class="sc">::</span>full_join, <span class="fu">list</span>(df.travelT, df.soil, df.tree, df.elevation, df.tri, df.geom)) <span class="sc">%&gt;%</span></span>
<span id="cb147-686"><a href="functions-for-matching-pre--and-post-processing.html#cb147-686" tabindex="-1"></a>    <span class="fu">st_as_sf</span>()</span>
<span id="cb147-687"><a href="functions-for-matching-pre--and-post-processing.html#cb147-687" tabindex="-1"></a></span>
<span id="cb147-688"><a href="functions-for-matching-pre--and-post-processing.html#cb147-688" tabindex="-1"></a>  <span class="co"># Make column Group ID and WDPA ID have data type &quot;integer&quot;</span></span>
<span id="cb147-689"><a href="functions-for-matching-pre--and-post-processing.html#cb147-689" tabindex="-1"></a>  pivot.all<span class="sc">$</span>group <span class="ot">=</span> <span class="fu">as.integer</span>(pivot.all<span class="sc">$</span>group)</span>
<span id="cb147-690"><a href="functions-for-matching-pre--and-post-processing.html#cb147-690" tabindex="-1"></a>  pivot.all<span class="sc">$</span>wdpaid <span class="ot">=</span> <span class="fu">as.integer</span>(pivot.all<span class="sc">$</span>wdpaid)</span>
<span id="cb147-691"><a href="functions-for-matching-pre--and-post-processing.html#cb147-691" tabindex="-1"></a></span>
<span id="cb147-692"><a href="functions-for-matching-pre--and-post-processing.html#cb147-692" tabindex="-1"></a>  <span class="co"># Save this matching dataframe</span></span>
<span id="cb147-693"><a href="functions-for-matching-pre--and-post-processing.html#cb147-693" tabindex="-1"></a>  name_save <span class="ot">=</span> <span class="fu">paste0</span>(name_output, <span class="st">&quot;_&quot;</span>, iso, ext_output)</span>
<span id="cb147-694"><a href="functions-for-matching-pre--and-post-processing.html#cb147-694" tabindex="-1"></a>  <span class="fu">s3write_using</span>(pivot.all,</span>
<span id="cb147-695"><a href="functions-for-matching-pre--and-post-processing.html#cb147-695" tabindex="-1"></a>                sf<span class="sc">::</span>st_write,</span>
<span id="cb147-696"><a href="functions-for-matching-pre--and-post-processing.html#cb147-696" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, name_save),</span>
<span id="cb147-697"><a href="functions-for-matching-pre--and-post-processing.html#cb147-697" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-698"><a href="functions-for-matching-pre--and-post-processing.html#cb147-698" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-699"><a href="functions-for-matching-pre--and-post-processing.html#cb147-699" tabindex="-1"></a>  </span>
<span id="cb147-700"><a href="functions-for-matching-pre--and-post-processing.html#cb147-700" tabindex="-1"></a>  <span class="co">#Removing files in the temporary folder</span></span>
<span id="cb147-701"><a href="functions-for-matching-pre--and-post-processing.html#cb147-701" tabindex="-1"></a>  <span class="fu">do.call</span>(file.remove, <span class="fu">list</span>(<span class="fu">list.files</span>(tmp_pre, <span class="at">include.dirs =</span> F, <span class="at">full.names =</span> T, <span class="at">recursive =</span> T)))</span>
<span id="cb147-702"><a href="functions-for-matching-pre--and-post-processing.html#cb147-702" tabindex="-1"></a>  </span>
<span id="cb147-703"><a href="functions-for-matching-pre--and-post-processing.html#cb147-703" tabindex="-1"></a>  <span class="co">#End timer</span></span>
<span id="cb147-704"><a href="functions-for-matching-pre--and-post-processing.html#cb147-704" tabindex="-1"></a>  toc <span class="ot">=</span> <span class="fu">toc</span>()</span>
<span id="cb147-705"><a href="functions-for-matching-pre--and-post-processing.html#cb147-705" tabindex="-1"></a>  </span>
<span id="cb147-706"><a href="functions-for-matching-pre--and-post-processing.html#cb147-706" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-707"><a href="functions-for-matching-pre--and-post-processing.html#cb147-707" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Calculating outcome and other covariates</span><span class="sc">\n</span><span class="st">-&gt; OK :&quot;</span>, toc<span class="sc">$</span>callback_msg, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-708"><a href="functions-for-matching-pre--and-post-processing.html#cb147-708" tabindex="-1"></a></span>
<span id="cb147-709"><a href="functions-for-matching-pre--and-post-processing.html#cb147-709" tabindex="-1"></a>  <span class="co">#Return the output</span></span>
<span id="cb147-710"><a href="functions-for-matching-pre--and-post-processing.html#cb147-710" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-711"><a href="functions-for-matching-pre--and-post-processing.html#cb147-711" tabindex="-1"></a>  </span>
<span id="cb147-712"><a href="functions-for-matching-pre--and-post-processing.html#cb147-712" tabindex="-1"></a>    },</span>
<span id="cb147-713"><a href="functions-for-matching-pre--and-post-processing.html#cb147-713" tabindex="-1"></a>  </span>
<span id="cb147-714"><a href="functions-for-matching-pre--and-post-processing.html#cb147-714" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-715"><a href="functions-for-matching-pre--and-post-processing.html#cb147-715" tabindex="-1"></a>  {</span>
<span id="cb147-716"><a href="functions-for-matching-pre--and-post-processing.html#cb147-716" tabindex="-1"></a>    <span class="co">#Print the error and append the log</span></span>
<span id="cb147-717"><a href="functions-for-matching-pre--and-post-processing.html#cb147-717" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-718"><a href="functions-for-matching-pre--and-post-processing.html#cb147-718" tabindex="-1"></a>    <span class="co">#Append the log </span></span>
<span id="cb147-719"><a href="functions-for-matching-pre--and-post-processing.html#cb147-719" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Calculating outcome and other covariates</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-720"><a href="functions-for-matching-pre--and-post-processing.html#cb147-720" tabindex="-1"></a>    <span class="co">#Return string to inform user to skip</span></span>
<span id="cb147-721"><a href="functions-for-matching-pre--and-post-processing.html#cb147-721" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-722"><a href="functions-for-matching-pre--and-post-processing.html#cb147-722" tabindex="-1"></a>  }</span>
<span id="cb147-723"><a href="functions-for-matching-pre--and-post-processing.html#cb147-723" tabindex="-1"></a>  </span>
<span id="cb147-724"><a href="functions-for-matching-pre--and-post-processing.html#cb147-724" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-725"><a href="functions-for-matching-pre--and-post-processing.html#cb147-725" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-726"><a href="functions-for-matching-pre--and-post-processing.html#cb147-726" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-727"><a href="functions-for-matching-pre--and-post-processing.html#cb147-727" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-728"><a href="functions-for-matching-pre--and-post-processing.html#cb147-728" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-729"><a href="functions-for-matching-pre--and-post-processing.html#cb147-729" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;#Calculating outcome and other covariates\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-730"><a href="functions-for-matching-pre--and-post-processing.html#cb147-730" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-731"><a href="functions-for-matching-pre--and-post-processing.html#cb147-731" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-732"><a href="functions-for-matching-pre--and-post-processing.html#cb147-732" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-733"><a href="functions-for-matching-pre--and-post-processing.html#cb147-733" tabindex="-1"></a>  </span>
<span id="cb147-734"><a href="functions-for-matching-pre--and-post-processing.html#cb147-734" tabindex="-1"></a>  )</span>
<span id="cb147-735"><a href="functions-for-matching-pre--and-post-processing.html#cb147-735" tabindex="-1"></a>  </span>
<span id="cb147-736"><a href="functions-for-matching-pre--and-post-processing.html#cb147-736" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-737"><a href="functions-for-matching-pre--and-post-processing.html#cb147-737" tabindex="-1"></a>}</span>
<span id="cb147-738"><a href="functions-for-matching-pre--and-post-processing.html#cb147-738" tabindex="-1"></a></span>
<span id="cb147-739"><a href="functions-for-matching-pre--and-post-processing.html#cb147-739" tabindex="-1"></a></span>
<span id="cb147-740"><a href="functions-for-matching-pre--and-post-processing.html#cb147-740" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb147-741"><a href="functions-for-matching-pre--and-post-processing.html#cb147-741" tabindex="-1"></a><span class="do">###Post-processing</span></span>
<span id="cb147-742"><a href="functions-for-matching-pre--and-post-processing.html#cb147-742" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb147-743"><a href="functions-for-matching-pre--and-post-processing.html#cb147-743" tabindex="-1"></a></span>
<span id="cb147-744"><a href="functions-for-matching-pre--and-post-processing.html#cb147-744" tabindex="-1"></a></span>
<span id="cb147-745"><a href="functions-for-matching-pre--and-post-processing.html#cb147-745" tabindex="-1"></a><span class="co">#Load the matching dataframe obtained during pre-processing</span></span>
<span id="cb147-746"><a href="functions-for-matching-pre--and-post-processing.html#cb147-746" tabindex="-1"></a><span class="do">##INPUTS :</span></span>
<span id="cb147-747"><a href="functions-for-matching-pre--and-post-processing.html#cb147-747" tabindex="-1"></a><span class="do">### iso : the ISO code of the country considered</span></span>
<span id="cb147-748"><a href="functions-for-matching-pre--and-post-processing.html#cb147-748" tabindex="-1"></a><span class="do">### name_input : name of the file to import</span></span>
<span id="cb147-749"><a href="functions-for-matching-pre--and-post-processing.html#cb147-749" tabindex="-1"></a><span class="do">### ext_output : extension fo the file to import</span></span>
<span id="cb147-750"><a href="functions-for-matching-pre--and-post-processing.html#cb147-750" tabindex="-1"></a><span class="do">### yr_min : the minimum treatment year to be considered in the analysis. As some matching covariates are defined with pre-treatment data (e.g average tree cover loss before treatment), this minimal year is greater than the first year in the period considered</span></span>
<span id="cb147-751"><a href="functions-for-matching-pre--and-post-processing.html#cb147-751" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-752"><a href="functions-for-matching-pre--and-post-processing.html#cb147-752" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-753"><a href="functions-for-matching-pre--and-post-processing.html#cb147-753" tabindex="-1"></a><span class="do">##OUTPUTS :</span></span>
<span id="cb147-754"><a href="functions-for-matching-pre--and-post-processing.html#cb147-754" tabindex="-1"></a><span class="do">### mf : matching dataframe. More precisely, it gives for each observation units in a country values of different covariates to perform matching.</span></span>
<span id="cb147-755"><a href="functions-for-matching-pre--and-post-processing.html#cb147-755" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-756"><a href="functions-for-matching-pre--and-post-processing.html#cb147-756" tabindex="-1"></a><span class="do">##DATA SAVED</span></span>
<span id="cb147-757"><a href="functions-for-matching-pre--and-post-processing.html#cb147-757" tabindex="-1"></a><span class="do">### The list of PAs in the matching frame, characterized by their WDPAID. Useful to loop over each PAs we want to analyze in a given country</span></span>
<span id="cb147-758"><a href="functions-for-matching-pre--and-post-processing.html#cb147-758" tabindex="-1"></a>fn_post_load_mf <span class="ot">=</span> <span class="cf">function</span>(iso, yr_min, name_input, ext_input, log, save_dir)</span>
<span id="cb147-759"><a href="functions-for-matching-pre--and-post-processing.html#cb147-759" tabindex="-1"></a>{</span>
<span id="cb147-760"><a href="functions-for-matching-pre--and-post-processing.html#cb147-760" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-761"><a href="functions-for-matching-pre--and-post-processing.html#cb147-761" tabindex="-1"></a>    </span>
<span id="cb147-762"><a href="functions-for-matching-pre--and-post-processing.html#cb147-762" tabindex="-1"></a>    {</span>
<span id="cb147-763"><a href="functions-for-matching-pre--and-post-processing.html#cb147-763" tabindex="-1"></a>      </span>
<span id="cb147-764"><a href="functions-for-matching-pre--and-post-processing.html#cb147-764" tabindex="-1"></a>  <span class="co">#Load the matching dataframe</span></span>
<span id="cb147-765"><a href="functions-for-matching-pre--and-post-processing.html#cb147-765" tabindex="-1"></a>  object <span class="ot">=</span> <span class="fu">paste</span>(save_dir, iso, <span class="fu">paste0</span>(name_input, <span class="st">&quot;_&quot;</span>, iso, ext_input), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb147-766"><a href="functions-for-matching-pre--and-post-processing.html#cb147-766" tabindex="-1"></a>  mf <span class="ot">=</span> <span class="fu">s3read_using</span>(sf<span class="sc">::</span>st_read,</span>
<span id="cb147-767"><a href="functions-for-matching-pre--and-post-processing.html#cb147-767" tabindex="-1"></a>                      <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-768"><a href="functions-for-matching-pre--and-post-processing.html#cb147-768" tabindex="-1"></a>                      <span class="at">object =</span> object,</span>
<span id="cb147-769"><a href="functions-for-matching-pre--and-post-processing.html#cb147-769" tabindex="-1"></a>                      <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)) </span>
<span id="cb147-770"><a href="functions-for-matching-pre--and-post-processing.html#cb147-770" tabindex="-1"></a>  </span>
<span id="cb147-771"><a href="functions-for-matching-pre--and-post-processing.html#cb147-771" tabindex="-1"></a>  <span class="co">#Subset to control and treatment units with year of treatment &gt;= yr_min</span></span>
<span id="cb147-772"><a href="functions-for-matching-pre--and-post-processing.html#cb147-772" tabindex="-1"></a>  mf <span class="ot">=</span> mf <span class="sc">%&gt;%</span></span>
<span id="cb147-773"><a href="functions-for-matching-pre--and-post-processing.html#cb147-773" tabindex="-1"></a>    <span class="fu">filter</span>(group<span class="sc">==</span><span class="dv">1</span> <span class="sc">|</span> group<span class="sc">==</span><span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-774"><a href="functions-for-matching-pre--and-post-processing.html#cb147-774" tabindex="-1"></a>    <span class="co">#Remove observations with NA values only for covariates :</span></span>
<span id="cb147-775"><a href="functions-for-matching-pre--and-post-processing.html#cb147-775" tabindex="-1"></a>    <span class="do">## except for creation year, funding years, geographical location, country ISO and name, pixel resolution which are NA for control units</span></span>
<span id="cb147-776"><a href="functions-for-matching-pre--and-post-processing.html#cb147-776" tabindex="-1"></a>    <span class="fu">drop_na</span>(<span class="sc">-</span><span class="fu">c</span>(status_yr, year_funding_first, year_funding_all, region_afd, region, sub_region, iso3, country_en, res_m)) <span class="co">#%&gt;%</span></span>
<span id="cb147-777"><a href="functions-for-matching-pre--and-post-processing.html#cb147-777" tabindex="-1"></a>     <span class="co">#filter(status_yr &gt;= yr_min | is.na(status_yr))</span></span>
<span id="cb147-778"><a href="functions-for-matching-pre--and-post-processing.html#cb147-778" tabindex="-1"></a>  </span>
<span id="cb147-779"><a href="functions-for-matching-pre--and-post-processing.html#cb147-779" tabindex="-1"></a>  <span class="co">#Write the list of PAs matched</span></span>
<span id="cb147-780"><a href="functions-for-matching-pre--and-post-processing.html#cb147-780" tabindex="-1"></a>  list_pa <span class="ot">=</span> mf <span class="sc">%&gt;%</span></span>
<span id="cb147-781"><a href="functions-for-matching-pre--and-post-processing.html#cb147-781" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-782"><a href="functions-for-matching-pre--and-post-processing.html#cb147-782" tabindex="-1"></a>    <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-783"><a href="functions-for-matching-pre--and-post-processing.html#cb147-783" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(region_afd, region, sub_region, country_en, iso3, wdpaid, status_yr, year_funding_first, year_funding_all)) <span class="sc">%&gt;%</span></span>
<span id="cb147-784"><a href="functions-for-matching-pre--and-post-processing.html#cb147-784" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">iso3 =</span> iso, <span class="at">.before =</span> <span class="st">&quot;wdpaid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-785"><a href="functions-for-matching-pre--and-post-processing.html#cb147-785" tabindex="-1"></a>    <span class="fu">filter</span>(wdpaid <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-786"><a href="functions-for-matching-pre--and-post-processing.html#cb147-786" tabindex="-1"></a>    <span class="fu">group_by</span>(wdpaid) <span class="sc">%&gt;%</span></span>
<span id="cb147-787"><a href="functions-for-matching-pre--and-post-processing.html#cb147-787" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-788"><a href="functions-for-matching-pre--and-post-processing.html#cb147-788" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb147-789"><a href="functions-for-matching-pre--and-post-processing.html#cb147-789" tabindex="-1"></a>  </span>
<span id="cb147-790"><a href="functions-for-matching-pre--and-post-processing.html#cb147-790" tabindex="-1"></a>  <span class="fu">s3write_using</span>(list_pa,</span>
<span id="cb147-791"><a href="functions-for-matching-pre--and-post-processing.html#cb147-791" tabindex="-1"></a>                data.table<span class="sc">::</span>fwrite,</span>
<span id="cb147-792"><a href="functions-for-matching-pre--and-post-processing.html#cb147-792" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-793"><a href="functions-for-matching-pre--and-post-processing.html#cb147-793" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste</span>(save_dir, iso, <span class="fu">paste0</span>(<span class="st">&quot;list_pa_matched_&quot;</span>, iso, <span class="st">&quot;.csv&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-794"><a href="functions-for-matching-pre--and-post-processing.html#cb147-794" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-795"><a href="functions-for-matching-pre--and-post-processing.html#cb147-795" tabindex="-1"></a>  </span>
<span id="cb147-796"><a href="functions-for-matching-pre--and-post-processing.html#cb147-796" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-797"><a href="functions-for-matching-pre--and-post-processing.html#cb147-797" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;Loading the matching frame -&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-798"><a href="functions-for-matching-pre--and-post-processing.html#cb147-798" tabindex="-1"></a>  </span>
<span id="cb147-799"><a href="functions-for-matching-pre--and-post-processing.html#cb147-799" tabindex="-1"></a>  <span class="co">#Return output</span></span>
<span id="cb147-800"><a href="functions-for-matching-pre--and-post-processing.html#cb147-800" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;mf&quot;</span> <span class="ot">=</span> mf, <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-801"><a href="functions-for-matching-pre--and-post-processing.html#cb147-801" tabindex="-1"></a>  </span>
<span id="cb147-802"><a href="functions-for-matching-pre--and-post-processing.html#cb147-802" tabindex="-1"></a>    },</span>
<span id="cb147-803"><a href="functions-for-matching-pre--and-post-processing.html#cb147-803" tabindex="-1"></a>  </span>
<span id="cb147-804"><a href="functions-for-matching-pre--and-post-processing.html#cb147-804" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-805"><a href="functions-for-matching-pre--and-post-processing.html#cb147-805" tabindex="-1"></a>  {</span>
<span id="cb147-806"><a href="functions-for-matching-pre--and-post-processing.html#cb147-806" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-807"><a href="functions-for-matching-pre--and-post-processing.html#cb147-807" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;Error in loading the matching frame :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-808"><a href="functions-for-matching-pre--and-post-processing.html#cb147-808" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-809"><a href="functions-for-matching-pre--and-post-processing.html#cb147-809" tabindex="-1"></a>  }</span>
<span id="cb147-810"><a href="functions-for-matching-pre--and-post-processing.html#cb147-810" tabindex="-1"></a>  </span>
<span id="cb147-811"><a href="functions-for-matching-pre--and-post-processing.html#cb147-811" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-812"><a href="functions-for-matching-pre--and-post-processing.html#cb147-812" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-813"><a href="functions-for-matching-pre--and-post-processing.html#cb147-813" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-814"><a href="functions-for-matching-pre--and-post-processing.html#cb147-814" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-815"><a href="functions-for-matching-pre--and-post-processing.html#cb147-815" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-816"><a href="functions-for-matching-pre--and-post-processing.html#cb147-816" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;Warining while loading the matching frame :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-817"><a href="functions-for-matching-pre--and-post-processing.html#cb147-817" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-818"><a href="functions-for-matching-pre--and-post-processing.html#cb147-818" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-819"><a href="functions-for-matching-pre--and-post-processing.html#cb147-819" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-820"><a href="functions-for-matching-pre--and-post-processing.html#cb147-820" tabindex="-1"></a>  </span>
<span id="cb147-821"><a href="functions-for-matching-pre--and-post-processing.html#cb147-821" tabindex="-1"></a>  </span>
<span id="cb147-822"><a href="functions-for-matching-pre--and-post-processing.html#cb147-822" tabindex="-1"></a>  )</span>
<span id="cb147-823"><a href="functions-for-matching-pre--and-post-processing.html#cb147-823" tabindex="-1"></a>  </span>
<span id="cb147-824"><a href="functions-for-matching-pre--and-post-processing.html#cb147-824" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-825"><a href="functions-for-matching-pre--and-post-processing.html#cb147-825" tabindex="-1"></a>}</span>
<span id="cb147-826"><a href="functions-for-matching-pre--and-post-processing.html#cb147-826" tabindex="-1"></a></span>
<span id="cb147-827"><a href="functions-for-matching-pre--and-post-processing.html#cb147-827" tabindex="-1"></a></span>
<span id="cb147-828"><a href="functions-for-matching-pre--and-post-processing.html#cb147-828" tabindex="-1"></a><span class="co">#Compute average forest loss before PA creation, and add it to the matching frame as a covariate</span></span>
<span id="cb147-829"><a href="functions-for-matching-pre--and-post-processing.html#cb147-829" tabindex="-1"></a><span class="do">##INPUTS : </span></span>
<span id="cb147-830"><a href="functions-for-matching-pre--and-post-processing.html#cb147-830" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-831"><a href="functions-for-matching-pre--and-post-processing.html#cb147-831" tabindex="-1"></a><span class="do">### colname.flAvg : name of the average forest loss variable</span></span>
<span id="cb147-832"><a href="functions-for-matching-pre--and-post-processing.html#cb147-832" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-833"><a href="functions-for-matching-pre--and-post-processing.html#cb147-833" tabindex="-1"></a><span class="do">## OUTPUTS :</span></span>
<span id="cb147-834"><a href="functions-for-matching-pre--and-post-processing.html#cb147-834" tabindex="-1"></a><span class="do">### mf : matching frame with the new covariate</span></span>
<span id="cb147-835"><a href="functions-for-matching-pre--and-post-processing.html#cb147-835" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-836"><a href="functions-for-matching-pre--and-post-processing.html#cb147-836" tabindex="-1"></a></span>
<span id="cb147-837"><a href="functions-for-matching-pre--and-post-processing.html#cb147-837" tabindex="-1"></a>fn_post_avgLoss_prefund <span class="ot">=</span> <span class="cf">function</span>(mf, colname.flAvg, log)</span>
<span id="cb147-838"><a href="functions-for-matching-pre--and-post-processing.html#cb147-838" tabindex="-1"></a>{</span>
<span id="cb147-839"><a href="functions-for-matching-pre--and-post-processing.html#cb147-839" tabindex="-1"></a>  </span>
<span id="cb147-840"><a href="functions-for-matching-pre--and-post-processing.html#cb147-840" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-841"><a href="functions-for-matching-pre--and-post-processing.html#cb147-841" tabindex="-1"></a>    </span>
<span id="cb147-842"><a href="functions-for-matching-pre--and-post-processing.html#cb147-842" tabindex="-1"></a>    {</span>
<span id="cb147-843"><a href="functions-for-matching-pre--and-post-processing.html#cb147-843" tabindex="-1"></a>      </span>
<span id="cb147-844"><a href="functions-for-matching-pre--and-post-processing.html#cb147-844" tabindex="-1"></a>  <span class="co">#Extract treatment year</span></span>
<span id="cb147-845"><a href="functions-for-matching-pre--and-post-processing.html#cb147-845" tabindex="-1"></a>  treatment.year <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-846"><a href="functions-for-matching-pre--and-post-processing.html#cb147-846" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-847"><a href="functions-for-matching-pre--and-post-processing.html#cb147-847" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-848"><a href="functions-for-matching-pre--and-post-processing.html#cb147-848" tabindex="-1"></a>  treatment.year <span class="ot">=</span> treatment.year<span class="sc">$</span>status_yr</span>
<span id="cb147-849"><a href="functions-for-matching-pre--and-post-processing.html#cb147-849" tabindex="-1"></a>  </span>
<span id="cb147-850"><a href="functions-for-matching-pre--and-post-processing.html#cb147-850" tabindex="-1"></a>  <span class="co">#Extract first year treeloss is computed</span></span>
<span id="cb147-851"><a href="functions-for-matching-pre--and-post-processing.html#cb147-851" tabindex="-1"></a>  <span class="do">##Select cols with &quot;treeloss&quot; in mf, drop geometry, replace &quot;treeloss_&quot; by &quot;&quot;, convert to num and take min</span></span>
<span id="cb147-852"><a href="functions-for-matching-pre--and-post-processing.html#cb147-852" tabindex="-1"></a>  treeloss.ini.year <span class="ot">=</span> mf[<span class="fu">grepl</span>(<span class="st">&quot;treeloss&quot;</span>, <span class="fu">names</span>(mf))] <span class="sc">%&gt;%</span></span>
<span id="cb147-853"><a href="functions-for-matching-pre--and-post-processing.html#cb147-853" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-854"><a href="functions-for-matching-pre--and-post-processing.html#cb147-854" tabindex="-1"></a>    <span class="fu">names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-855"><a href="functions-for-matching-pre--and-post-processing.html#cb147-855" tabindex="-1"></a>    <span class="fu">gsub</span>(<span class="fu">paste0</span>(<span class="st">&quot;treeloss&quot;</span>, <span class="st">&quot;_&quot;</span>), <span class="st">&quot;&quot;</span>, .) <span class="sc">%&gt;%</span></span>
<span id="cb147-856"><a href="functions-for-matching-pre--and-post-processing.html#cb147-856" tabindex="-1"></a>    <span class="fu">as.numeric</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-857"><a href="functions-for-matching-pre--and-post-processing.html#cb147-857" tabindex="-1"></a>    <span class="fu">min</span>()</span>
<span id="cb147-858"><a href="functions-for-matching-pre--and-post-processing.html#cb147-858" tabindex="-1"></a>  </span>
<span id="cb147-859"><a href="functions-for-matching-pre--and-post-processing.html#cb147-859" tabindex="-1"></a>  <span class="co">#Define period to compute average loss</span></span>
<span id="cb147-860"><a href="functions-for-matching-pre--and-post-processing.html#cb147-860" tabindex="-1"></a>  <span class="do">##If 5 pre-treatment periods are available at least, then average pre-treatment deforestation is computed on this 5 years range</span></span>
<span id="cb147-861"><a href="functions-for-matching-pre--and-post-processing.html#cb147-861" tabindex="-1"></a>  <span class="do">## If less than 5 are available, compute on this restricted period</span></span>
<span id="cb147-862"><a href="functions-for-matching-pre--and-post-processing.html#cb147-862" tabindex="-1"></a>  <span class="do">## Note that by construction, treatment.year &gt;= treeloss.ini.year +1 (as yr_min = yr_first+2 in the parameters)</span></span>
<span id="cb147-863"><a href="functions-for-matching-pre--and-post-processing.html#cb147-863" tabindex="-1"></a>  <span class="cf">if</span>((treatment.year<span class="sc">-</span>treeloss.ini.year) <span class="sc">&gt;=</span><span class="dv">5</span>)</span>
<span id="cb147-864"><a href="functions-for-matching-pre--and-post-processing.html#cb147-864" tabindex="-1"></a>  {yr_start <span class="ot">=</span> (treatment.year)<span class="sc">-</span><span class="dv">5</span></span>
<span id="cb147-865"><a href="functions-for-matching-pre--and-post-processing.html#cb147-865" tabindex="-1"></a>  yr_end <span class="ot">=</span> (treatment.year)<span class="sc">-</span><span class="dv">1</span>} <span class="cf">else</span> <span class="cf">if</span>((treatment.year<span class="sc">-</span>treeloss.ini.year <span class="sc">&lt;</span><span class="dv">5</span>) <span class="sc">&amp;</span> (treatment.year<span class="sc">-</span>treeloss.ini.year <span class="sc">&gt;</span><span class="dv">0</span>))</span>
<span id="cb147-866"><a href="functions-for-matching-pre--and-post-processing.html#cb147-866" tabindex="-1"></a>  {yr_start <span class="ot">=</span> treeloss.ini.year</span>
<span id="cb147-867"><a href="functions-for-matching-pre--and-post-processing.html#cb147-867" tabindex="-1"></a>  yr_end <span class="ot">=</span> (treatment.year)<span class="sc">-</span><span class="dv">1</span>} </span>
<span id="cb147-868"><a href="functions-for-matching-pre--and-post-processing.html#cb147-868" tabindex="-1"></a>  <span class="co">#Transform it in variable suffix</span></span>
<span id="cb147-869"><a href="functions-for-matching-pre--and-post-processing.html#cb147-869" tabindex="-1"></a>  var_start <span class="ot">=</span> yr_start <span class="sc">-</span> <span class="dv">2000</span></span>
<span id="cb147-870"><a href="functions-for-matching-pre--and-post-processing.html#cb147-870" tabindex="-1"></a>  var_end <span class="ot">=</span> yr_end <span class="sc">-</span> <span class="dv">2000</span></span>
<span id="cb147-871"><a href="functions-for-matching-pre--and-post-processing.html#cb147-871" tabindex="-1"></a>  <span class="co">#Select only relevant variables</span></span>
<span id="cb147-872"><a href="functions-for-matching-pre--and-post-processing.html#cb147-872" tabindex="-1"></a>  df_fl <span class="ot">=</span> mf[<span class="fu">grepl</span>(<span class="st">&quot;treeloss&quot;</span>, <span class="fu">names</span>(mf))][var_start<span class="sc">:</span>var_end] <span class="sc">%&gt;%</span> </span>
<span id="cb147-873"><a href="functions-for-matching-pre--and-post-processing.html#cb147-873" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>()</span>
<span id="cb147-874"><a href="functions-for-matching-pre--and-post-processing.html#cb147-874" tabindex="-1"></a>  <span class="co">#Compute average loss for each pixel and store it in mf. Also add the start and end years of pre-treatment period where average loss is computed.</span></span>
<span id="cb147-875"><a href="functions-for-matching-pre--and-post-processing.html#cb147-875" tabindex="-1"></a>  mf<span class="sc">$</span>avgLoss_pre_fund <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">rowMeans</span>(df_fl), <span class="dv">2</span>)</span>
<span id="cb147-876"><a href="functions-for-matching-pre--and-post-processing.html#cb147-876" tabindex="-1"></a>  mf<span class="sc">$</span>start_pre_fund <span class="ot">=</span> yr_start</span>
<span id="cb147-877"><a href="functions-for-matching-pre--and-post-processing.html#cb147-877" tabindex="-1"></a>  mf<span class="sc">$</span>end_pre_fund <span class="ot">=</span> yr_end</span>
<span id="cb147-878"><a href="functions-for-matching-pre--and-post-processing.html#cb147-878" tabindex="-1"></a>  <span class="co">#Remove NA values</span></span>
<span id="cb147-879"><a href="functions-for-matching-pre--and-post-processing.html#cb147-879" tabindex="-1"></a>  mf <span class="ot">=</span> mf <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(avgLoss_pre_fund)</span>
<span id="cb147-880"><a href="functions-for-matching-pre--and-post-processing.html#cb147-880" tabindex="-1"></a>  </span>
<span id="cb147-881"><a href="functions-for-matching-pre--and-post-processing.html#cb147-881" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-882"><a href="functions-for-matching-pre--and-post-processing.html#cb147-882" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Add average pre-treatment treecover loss</span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-883"><a href="functions-for-matching-pre--and-post-processing.html#cb147-883" tabindex="-1"></a>  </span>
<span id="cb147-884"><a href="functions-for-matching-pre--and-post-processing.html#cb147-884" tabindex="-1"></a>  <span class="co">#Return output</span></span>
<span id="cb147-885"><a href="functions-for-matching-pre--and-post-processing.html#cb147-885" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;mf&quot;</span> <span class="ot">=</span> mf, <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-886"><a href="functions-for-matching-pre--and-post-processing.html#cb147-886" tabindex="-1"></a>  </span>
<span id="cb147-887"><a href="functions-for-matching-pre--and-post-processing.html#cb147-887" tabindex="-1"></a>    },</span>
<span id="cb147-888"><a href="functions-for-matching-pre--and-post-processing.html#cb147-888" tabindex="-1"></a>  </span>
<span id="cb147-889"><a href="functions-for-matching-pre--and-post-processing.html#cb147-889" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-890"><a href="functions-for-matching-pre--and-post-processing.html#cb147-890" tabindex="-1"></a>  {</span>
<span id="cb147-891"><a href="functions-for-matching-pre--and-post-processing.html#cb147-891" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-892"><a href="functions-for-matching-pre--and-post-processing.html#cb147-892" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Add average pre-treatment treecover loss</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-893"><a href="functions-for-matching-pre--and-post-processing.html#cb147-893" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-894"><a href="functions-for-matching-pre--and-post-processing.html#cb147-894" tabindex="-1"></a>  }</span>
<span id="cb147-895"><a href="functions-for-matching-pre--and-post-processing.html#cb147-895" tabindex="-1"></a>  </span>
<span id="cb147-896"><a href="functions-for-matching-pre--and-post-processing.html#cb147-896" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-897"><a href="functions-for-matching-pre--and-post-processing.html#cb147-897" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-898"><a href="functions-for-matching-pre--and-post-processing.html#cb147-898" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-899"><a href="functions-for-matching-pre--and-post-processing.html#cb147-899" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-900"><a href="functions-for-matching-pre--and-post-processing.html#cb147-900" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-901"><a href="functions-for-matching-pre--and-post-processing.html#cb147-901" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;#Add average pre-treatment treecover loss\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-902"><a href="functions-for-matching-pre--and-post-processing.html#cb147-902" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-903"><a href="functions-for-matching-pre--and-post-processing.html#cb147-903" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-904"><a href="functions-for-matching-pre--and-post-processing.html#cb147-904" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-905"><a href="functions-for-matching-pre--and-post-processing.html#cb147-905" tabindex="-1"></a>  </span>
<span id="cb147-906"><a href="functions-for-matching-pre--and-post-processing.html#cb147-906" tabindex="-1"></a>  )</span>
<span id="cb147-907"><a href="functions-for-matching-pre--and-post-processing.html#cb147-907" tabindex="-1"></a>  </span>
<span id="cb147-908"><a href="functions-for-matching-pre--and-post-processing.html#cb147-908" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-909"><a href="functions-for-matching-pre--and-post-processing.html#cb147-909" tabindex="-1"></a>}</span>
<span id="cb147-910"><a href="functions-for-matching-pre--and-post-processing.html#cb147-910" tabindex="-1"></a></span>
<span id="cb147-911"><a href="functions-for-matching-pre--and-post-processing.html#cb147-911" tabindex="-1"></a></span>
<span id="cb147-912"><a href="functions-for-matching-pre--and-post-processing.html#cb147-912" tabindex="-1"></a><span class="co">#Perform matching of treated and potential control units. </span></span>
<span id="cb147-913"><a href="functions-for-matching-pre--and-post-processing.html#cb147-913" tabindex="-1"></a><span class="do">##INPUTS :</span></span>
<span id="cb147-914"><a href="functions-for-matching-pre--and-post-processing.html#cb147-914" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-915"><a href="functions-for-matching-pre--and-post-processing.html#cb147-915" tabindex="-1"></a><span class="do">### iso : the ISO code of the country considered</span></span>
<span id="cb147-916"><a href="functions-for-matching-pre--and-post-processing.html#cb147-916" tabindex="-1"></a><span class="do">### dummy_int : should we consider the interaction of variables for matching ? Is recommended generally speaking (https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html). When using CEM matching, variables are binned then exact matching is performed on binned values. As a first approximation we can argue that if two units have the same binned values for two variables, then they likely have the same binned interaction value. It is not necessarily true though, as binned(A)*binned(B) can be different from binned(A*B).  </span></span>
<span id="cb147-917"><a href="functions-for-matching-pre--and-post-processing.html#cb147-917" tabindex="-1"></a><span class="do">### match_method : the matching method to use. See https://cran.r-project.org/web/packages/MatchIt/vignettes/matching-methods.html for a list of matching methods we can use with the MatchIT package </span></span>
<span id="cb147-918"><a href="functions-for-matching-pre--and-post-processing.html#cb147-918" tabindex="-1"></a><span class="do">### cutoff_method : the method to use for automatic histogram binning of the variables. See Iacus, King and Porro 2011 (https://gking.harvard.edu/files/political_analysis-2011-iacus-pan_mpr013.pdf), 5.5.1, or MathIT documentation. &quot;Sturges&quot; tend to have the best outcomes (number of matched units) in our case (Antoine Vuillot, 28/09/2023)</span></span>
<span id="cb147-919"><a href="functions-for-matching-pre--and-post-processing.html#cb147-919" tabindex="-1"></a><span class="do">### is_k2k : boolean. Should we use k2k matching ? If yes, each treated unit is eventually matched with a single control. For CEM matching, a treated unit is potentially associated with more than one control unit (exact matching on binned variables), and then the &quot;closest&#39; one is chosen with a metric defined in k2k_method</span></span>
<span id="cb147-920"><a href="functions-for-matching-pre--and-post-processing.html#cb147-920" tabindex="-1"></a><span class="do">### k2k_method : metric to use to choose the closest control among the control units matched with a treated unit in CEM matching.</span></span>
<span id="cb147-921"><a href="functions-for-matching-pre--and-post-processing.html#cb147-921" tabindex="-1"></a><span class="do">### th_mean :the maximum acceptable value for absolute standardized mean difference of covariates between matched treated and control units. Typically 0.1 (https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html) or 0.25 in conservation literature (e.g https://conbio.onlinelibrary.wiley.com/doi/abs/10.1111/cobi.13728) </span></span>
<span id="cb147-922"><a href="functions-for-matching-pre--and-post-processing.html#cb147-922" tabindex="-1"></a><span class="do">### th_var_min, th_var_max : the range of acceptable value for covariate variance ratio between matched treated and control units. Typicall 0.5 and 2, respectively (https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html)</span></span>
<span id="cb147-923"><a href="functions-for-matching-pre--and-post-processing.html#cb147-923" tabindex="-1"></a><span class="do">### colname.travelTime, colname.clayContent, colname.elevation, colname.tri, colname.fcIni, colname.flAvg : name of the matching covariates</span></span>
<span id="cb147-924"><a href="functions-for-matching-pre--and-post-processing.html#cb147-924" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-925"><a href="functions-for-matching-pre--and-post-processing.html#cb147-925" tabindex="-1"></a><span class="do">##OUTPUTS : </span></span>
<span id="cb147-926"><a href="functions-for-matching-pre--and-post-processing.html#cb147-926" tabindex="-1"></a><span class="do">### out.cem : an object with all information on matching (parameters, results, etc.)</span></span>
<span id="cb147-927"><a href="functions-for-matching-pre--and-post-processing.html#cb147-927" tabindex="-1"></a><span class="do">### df.cov.m : for each matching covariate, statistics to assess the quality of the match</span></span>
<span id="cb147-928"><a href="functions-for-matching-pre--and-post-processing.html#cb147-928" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-929"><a href="functions-for-matching-pre--and-post-processing.html#cb147-929" tabindex="-1"></a><span class="do">##NOTES</span></span>
<span id="cb147-930"><a href="functions-for-matching-pre--and-post-processing.html#cb147-930" tabindex="-1"></a><span class="do">### The matching method chosen is CEM though other exists. For a presentation of the different matching algorithms, see https://cran.r-project.org/web/packages/MatchIt/vignettes/matching-methods.html</span></span>
<span id="cb147-931"><a href="functions-for-matching-pre--and-post-processing.html#cb147-931" tabindex="-1"></a>fn_post_match_auto <span class="ot">=</span> <span class="cf">function</span>(mf,</span>
<span id="cb147-932"><a href="functions-for-matching-pre--and-post-processing.html#cb147-932" tabindex="-1"></a>                              iso,</span>
<span id="cb147-933"><a href="functions-for-matching-pre--and-post-processing.html#cb147-933" tabindex="-1"></a>                              dummy_int,</span>
<span id="cb147-934"><a href="functions-for-matching-pre--and-post-processing.html#cb147-934" tabindex="-1"></a>                              match_method,</span>
<span id="cb147-935"><a href="functions-for-matching-pre--and-post-processing.html#cb147-935" tabindex="-1"></a>                              cutoff_method,</span>
<span id="cb147-936"><a href="functions-for-matching-pre--and-post-processing.html#cb147-936" tabindex="-1"></a>                              is_k2k,</span>
<span id="cb147-937"><a href="functions-for-matching-pre--and-post-processing.html#cb147-937" tabindex="-1"></a>                              k2k_method,</span>
<span id="cb147-938"><a href="functions-for-matching-pre--and-post-processing.html#cb147-938" tabindex="-1"></a>                              th_mean, </span>
<span id="cb147-939"><a href="functions-for-matching-pre--and-post-processing.html#cb147-939" tabindex="-1"></a>                              th_var_min, th_var_max,</span>
<span id="cb147-940"><a href="functions-for-matching-pre--and-post-processing.html#cb147-940" tabindex="-1"></a>                              colname.travelTime, colname.clayContent, colname.elevation, colname.tri, colname.fcIni, colname.flAvg,</span>
<span id="cb147-941"><a href="functions-for-matching-pre--and-post-processing.html#cb147-941" tabindex="-1"></a>                              log)</span>
<span id="cb147-942"><a href="functions-for-matching-pre--and-post-processing.html#cb147-942" tabindex="-1"></a>{</span>
<span id="cb147-943"><a href="functions-for-matching-pre--and-post-processing.html#cb147-943" tabindex="-1"></a></span>
<span id="cb147-944"><a href="functions-for-matching-pre--and-post-processing.html#cb147-944" tabindex="-1"></a>  <span class="co">#Append the log file : CEM step</span></span>
<span id="cb147-945"><a href="functions-for-matching-pre--and-post-processing.html#cb147-945" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Run Coarsened Exact Matching</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb147-946"><a href="functions-for-matching-pre--and-post-processing.html#cb147-946" tabindex="-1"></a>      <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-947"><a href="functions-for-matching-pre--and-post-processing.html#cb147-947" tabindex="-1"></a>  </span>
<span id="cb147-948"><a href="functions-for-matching-pre--and-post-processing.html#cb147-948" tabindex="-1"></a>  <span class="do">## Matching handling errors due to absence of matching</span></span>
<span id="cb147-949"><a href="functions-for-matching-pre--and-post-processing.html#cb147-949" tabindex="-1"></a>  output <span class="ot">=</span> </span>
<span id="cb147-950"><a href="functions-for-matching-pre--and-post-processing.html#cb147-950" tabindex="-1"></a>    <span class="fu">tryCatch</span>(</span>
<span id="cb147-951"><a href="functions-for-matching-pre--and-post-processing.html#cb147-951" tabindex="-1"></a>    {</span>
<span id="cb147-952"><a href="functions-for-matching-pre--and-post-processing.html#cb147-952" tabindex="-1"></a>      <span class="co"># Formula</span></span>
<span id="cb147-953"><a href="functions-for-matching-pre--and-post-processing.html#cb147-953" tabindex="-1"></a>      formula <span class="ot">=</span> <span class="fu">eval</span>(<span class="fu">bquote</span>(group <span class="sc">~</span> .(<span class="fu">as.name</span>(colname.travelTime)) </span>
<span id="cb147-954"><a href="functions-for-matching-pre--and-post-processing.html#cb147-954" tabindex="-1"></a>                            <span class="sc">+</span> .(<span class="fu">as.name</span>(colname.clayContent))  </span>
<span id="cb147-955"><a href="functions-for-matching-pre--and-post-processing.html#cb147-955" tabindex="-1"></a>                            <span class="sc">+</span>  .(<span class="fu">as.name</span>(colname.fcIni)) </span>
<span id="cb147-956"><a href="functions-for-matching-pre--and-post-processing.html#cb147-956" tabindex="-1"></a>                            <span class="sc">+</span> .(<span class="fu">as.name</span>(colname.flAvg))</span>
<span id="cb147-957"><a href="functions-for-matching-pre--and-post-processing.html#cb147-957" tabindex="-1"></a>                            <span class="sc">+</span> .(<span class="fu">as.name</span>(colname.tri))</span>
<span id="cb147-958"><a href="functions-for-matching-pre--and-post-processing.html#cb147-958" tabindex="-1"></a>                            <span class="sc">+</span> .(<span class="fu">as.name</span>(colname.elevation))))</span>
<span id="cb147-959"><a href="functions-for-matching-pre--and-post-processing.html#cb147-959" tabindex="-1"></a>      </span>
<span id="cb147-960"><a href="functions-for-matching-pre--and-post-processing.html#cb147-960" tabindex="-1"></a>      <span class="co">#Try to perform matching</span></span>
<span id="cb147-961"><a href="functions-for-matching-pre--and-post-processing.html#cb147-961" tabindex="-1"></a>      out.cem <span class="ot">=</span> <span class="fu">matchit</span>(formula,</span>
<span id="cb147-962"><a href="functions-for-matching-pre--and-post-processing.html#cb147-962" tabindex="-1"></a>                        <span class="at">data =</span> mf,</span>
<span id="cb147-963"><a href="functions-for-matching-pre--and-post-processing.html#cb147-963" tabindex="-1"></a>                        <span class="at">method =</span> match_method,</span>
<span id="cb147-964"><a href="functions-for-matching-pre--and-post-processing.html#cb147-964" tabindex="-1"></a>                        <span class="at">cutpoints =</span> cutoff_method,</span>
<span id="cb147-965"><a href="functions-for-matching-pre--and-post-processing.html#cb147-965" tabindex="-1"></a>                        <span class="at">k2k =</span> is_k2k,</span>
<span id="cb147-966"><a href="functions-for-matching-pre--and-post-processing.html#cb147-966" tabindex="-1"></a>                        <span class="at">k2k.method =</span> k2k_method)</span>
<span id="cb147-967"><a href="functions-for-matching-pre--and-post-processing.html#cb147-967" tabindex="-1"></a>      </span>
<span id="cb147-968"><a href="functions-for-matching-pre--and-post-processing.html#cb147-968" tabindex="-1"></a>      <span class="co"># Then the performance of the matching is assessed, based on https://cran.r-project.org/web/packages/MatchIt/vignettes/assessing-balance.html</span></span>
<span id="cb147-969"><a href="functions-for-matching-pre--and-post-processing.html#cb147-969" tabindex="-1"></a>      <span class="do">## Covariate balance : standardized mean difference and variance ratio</span></span>
<span id="cb147-970"><a href="functions-for-matching-pre--and-post-processing.html#cb147-970" tabindex="-1"></a>      <span class="do">## For both tests and the joint one, a dummy variable is defined, with value TRUE is the test is passed</span></span>
<span id="cb147-971"><a href="functions-for-matching-pre--and-post-processing.html#cb147-971" tabindex="-1"></a>      df.cov.m <span class="ot">=</span> <span class="fu">summary</span>(out.cem, <span class="at">interactions =</span> dummy_int)<span class="sc">$</span>sum.matched <span class="sc">%&gt;%</span></span>
<span id="cb147-972"><a href="functions-for-matching-pre--and-post-processing.html#cb147-972" tabindex="-1"></a>        <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-973"><a href="functions-for-matching-pre--and-post-processing.html#cb147-973" tabindex="-1"></a>        <span class="fu">clean_names</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-974"><a href="functions-for-matching-pre--and-post-processing.html#cb147-974" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">is_var_ok =</span> var_ratio <span class="sc">&lt;</span> th_var_max <span class="sc">&amp;</span> var_ratio <span class="sc">&gt;</span> th_var_min, <span class="co">#Check variance ratio between treated and controls</span></span>
<span id="cb147-975"><a href="functions-for-matching-pre--and-post-processing.html#cb147-975" tabindex="-1"></a>               <span class="at">is_mean_ok =</span> <span class="fu">abs</span>(std_mean_diff) <span class="sc">&lt;</span> th_mean, <span class="co">#Check absolute standardized mean difference</span></span>
<span id="cb147-976"><a href="functions-for-matching-pre--and-post-processing.html#cb147-976" tabindex="-1"></a>               <span class="at">is_bal_ok =</span> <span class="fu">as.logical</span>(is_var_ok<span class="sc">*</span>is_mean_ok), <span class="co">#Binary : TRUE if both variance and mean difference check pass, 0 if at least one does not</span></span>
<span id="cb147-977"><a href="functions-for-matching-pre--and-post-processing.html#cb147-977" tabindex="-1"></a>               <span class="at">.after =</span> <span class="st">&quot;std_mean_diff&quot;</span>)</span>
<span id="cb147-978"><a href="functions-for-matching-pre--and-post-processing.html#cb147-978" tabindex="-1"></a>      </span>
<span id="cb147-979"><a href="functions-for-matching-pre--and-post-processing.html#cb147-979" tabindex="-1"></a>      <span class="co">#Add a warning if covariate balance tests are not passed</span></span>
<span id="cb147-980"><a href="functions-for-matching-pre--and-post-processing.html#cb147-980" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">sum</span>(df.cov.m<span class="sc">$</span>is_bal_ok) <span class="sc">&lt;</span> <span class="fu">nrow</span>(df.cov.m) <span class="sc">|</span> <span class="fu">is.na</span>(<span class="fu">sum</span>(df.cov.m<span class="sc">$</span>is_bal_ok)) <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-981"><a href="functions-for-matching-pre--and-post-processing.html#cb147-981" tabindex="-1"></a>      {</span>
<span id="cb147-982"><a href="functions-for-matching-pre--and-post-processing.html#cb147-982" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">&quot;Matched control and treated units are not balanced enough. Increase sample size, turn to less restrictive tests or visually check balance.&quot;</span>)</span>
<span id="cb147-983"><a href="functions-for-matching-pre--and-post-processing.html#cb147-983" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">&quot;-&gt; Careful : matched control and treated units are not balanced enough. Increase sample size, turn to less restrictive tests or visually check balance.</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb147-984"><a href="functions-for-matching-pre--and-post-processing.html#cb147-984" tabindex="-1"></a>            <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-985"><a href="functions-for-matching-pre--and-post-processing.html#cb147-985" tabindex="-1"></a>      }</span>
<span id="cb147-986"><a href="functions-for-matching-pre--and-post-processing.html#cb147-986" tabindex="-1"></a>      </span>
<span id="cb147-987"><a href="functions-for-matching-pre--and-post-processing.html#cb147-987" tabindex="-1"></a>      <span class="co">#Append the log : note the step has already been appended at the beginning of the function</span></span>
<span id="cb147-988"><a href="functions-for-matching-pre--and-post-processing.html#cb147-988" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">&quot;-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-989"><a href="functions-for-matching-pre--and-post-processing.html#cb147-989" tabindex="-1"></a>      </span>
<span id="cb147-990"><a href="functions-for-matching-pre--and-post-processing.html#cb147-990" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;out.cem&quot;</span> <span class="ot">=</span> out.cem, <span class="st">&quot;df.cov.m&quot;</span> <span class="ot">=</span> df.cov.m, <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-991"><a href="functions-for-matching-pre--and-post-processing.html#cb147-991" tabindex="-1"></a>      </span>
<span id="cb147-992"><a href="functions-for-matching-pre--and-post-processing.html#cb147-992" tabindex="-1"></a>    },</span>
<span id="cb147-993"><a href="functions-for-matching-pre--and-post-processing.html#cb147-993" tabindex="-1"></a>    </span>
<span id="cb147-994"><a href="functions-for-matching-pre--and-post-processing.html#cb147-994" tabindex="-1"></a>    <span class="at">error=</span><span class="cf">function</span>(e)</span>
<span id="cb147-995"><a href="functions-for-matching-pre--and-post-processing.html#cb147-995" tabindex="-1"></a>    {</span>
<span id="cb147-996"><a href="functions-for-matching-pre--and-post-processing.html#cb147-996" tabindex="-1"></a>      <span class="fu">print</span>(e)</span>
<span id="cb147-997"><a href="functions-for-matching-pre--and-post-processing.html#cb147-997" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-998"><a href="functions-for-matching-pre--and-post-processing.html#cb147-998" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-999"><a href="functions-for-matching-pre--and-post-processing.html#cb147-999" tabindex="-1"></a>    },</span>
<span id="cb147-1000"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1000" tabindex="-1"></a>    </span>
<span id="cb147-1001"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1001" tabindex="-1"></a>    <span class="at">warning =</span> <span class="cf">function</span>(w)</span>
<span id="cb147-1002"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1002" tabindex="-1"></a>    {</span>
<span id="cb147-1003"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1003" tabindex="-1"></a>      <span class="co">#Print the warning and append the log</span></span>
<span id="cb147-1004"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1004" tabindex="-1"></a>      <span class="co">#Append the log </span></span>
<span id="cb147-1005"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1005" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;-&gt; Warning :</span><span class="sc">\n</span><span class="st">&quot;</span>, w, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>),</span>
<span id="cb147-1006"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1006" tabindex="-1"></a>          <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1007"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1007" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>)) <span class="co">#Here warning comes from an absence of matching : thus must skip to next country</span></span>
<span id="cb147-1008"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1008" tabindex="-1"></a>    }</span>
<span id="cb147-1009"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1009" tabindex="-1"></a>    </span>
<span id="cb147-1010"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1010" tabindex="-1"></a>  )</span>
<span id="cb147-1011"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1011" tabindex="-1"></a>  </span>
<span id="cb147-1012"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1012" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-1013"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1013" tabindex="-1"></a>  </span>
<span id="cb147-1014"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1014" tabindex="-1"></a>}</span>
<span id="cb147-1015"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1015" tabindex="-1"></a>    </span>
<span id="cb147-1016"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1016" tabindex="-1"></a></span>
<span id="cb147-1017"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1017" tabindex="-1"></a></span>
<span id="cb147-1018"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1018" tabindex="-1"></a><span class="co">#Plot covariates balance (plots and summary table)</span></span>
<span id="cb147-1019"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1019" tabindex="-1"></a><span class="do">## INPUTS :</span></span>
<span id="cb147-1020"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1020" tabindex="-1"></a><span class="do">### out.cem : list of results from the CEM matching</span></span>
<span id="cb147-1021"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1021" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-1022"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1022" tabindex="-1"></a><span class="do">### colname.travelTime, colname.clayContent, colname.elevation, colname.tri, colname.fcIni, colname.flAvg : name of the matching covariates</span></span>
<span id="cb147-1023"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1023" tabindex="-1"></a><span class="do">### iso : ISO code of the country considered</span></span>
<span id="cb147-1024"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1024" tabindex="-1"></a><span class="do">### path_tmp : temporary folder to store figures</span></span>
<span id="cb147-1025"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1025" tabindex="-1"></a><span class="do">### wdpaid : the WDPA ID of the protected area considered</span></span>
<span id="cb147-1026"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1026" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-1027"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1027" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-1028"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1028" tabindex="-1"></a><span class="do">##OUTPUTS :</span></span>
<span id="cb147-1029"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1029" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-1030"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1030" tabindex="-1"></a><span class="do">## DATA SAVED :</span></span>
<span id="cb147-1031"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1031" tabindex="-1"></a><span class="do">### A covariate love plot</span></span>
<span id="cb147-1032"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1032" tabindex="-1"></a><span class="do">### A table with number of treated and control units, before and after matching</span></span>
<span id="cb147-1033"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1033" tabindex="-1"></a><span class="do">### A table with statistics on matched control and treated units </span></span>
<span id="cb147-1034"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1034" tabindex="-1"></a><span class="do">### A table with statistics on unmatched control and treated units,</span></span>
<span id="cb147-1035"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1035" tabindex="-1"></a>fn_post_covbal <span class="ot">=</span> <span class="cf">function</span>(out.cem, mf, </span>
<span id="cb147-1036"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1036" tabindex="-1"></a>                          colname.travelTime, colname.clayContent, colname.fcIni, colname.flAvg, colname.tri, colname.elevation, </span>
<span id="cb147-1037"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1037" tabindex="-1"></a>                          iso, path_tmp, wdpaid, log,</span>
<span id="cb147-1038"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1038" tabindex="-1"></a>                          save_dir)</span>
<span id="cb147-1039"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1039" tabindex="-1"></a>{</span>
<span id="cb147-1040"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1040" tabindex="-1"></a>  </span>
<span id="cb147-1041"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1041" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-1042"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1042" tabindex="-1"></a>    </span>
<span id="cb147-1043"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1043" tabindex="-1"></a>    {</span>
<span id="cb147-1044"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1044" tabindex="-1"></a>      </span>
<span id="cb147-1045"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1045" tabindex="-1"></a>  <span class="co">#Save summary table from matching</span></span>
<span id="cb147-1046"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1046" tabindex="-1"></a>  smry_cem <span class="ot">=</span> <span class="fu">summary</span>(out.cem)</span>
<span id="cb147-1047"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1047" tabindex="-1"></a>  tbl_cem_nn <span class="ot">=</span> smry_cem<span class="sc">$</span>nn</span>
<span id="cb147-1048"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1048" tabindex="-1"></a>  tbl_cem_m <span class="ot">=</span> smry_cem<span class="sc">$</span>sum.matched</span>
<span id="cb147-1049"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1049" tabindex="-1"></a>  tbl_cem_all <span class="ot">=</span> smry_cem<span class="sc">$</span>sum.all</span>
<span id="cb147-1050"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1050" tabindex="-1"></a>  </span>
<span id="cb147-1051"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1051" tabindex="-1"></a>  <span class="co">#Extract country name</span></span>
<span id="cb147-1052"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1052" tabindex="-1"></a>  country.name <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-1053"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1053" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1054"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1054" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1055"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1055" tabindex="-1"></a>  country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-1056"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1056" tabindex="-1"></a>  </span>
<span id="cb147-1057"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1057" tabindex="-1"></a>  <span class="co">#Extract start and end years of pre-treatment period where average loss is computed</span></span>
<span id="cb147-1058"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1058" tabindex="-1"></a>  year.start.prefund <span class="ot">=</span> mf <span class="sc">%&gt;%</span></span>
<span id="cb147-1059"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1059" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1060"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1060" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1061"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1061" tabindex="-1"></a>  year.start.prefund <span class="ot">=</span> year.start.prefund<span class="sc">$</span>start_pre_fund</span>
<span id="cb147-1062"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1062" tabindex="-1"></a>  </span>
<span id="cb147-1063"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1063" tabindex="-1"></a>  year.end.prefund <span class="ot">=</span> mf <span class="sc">%&gt;%</span></span>
<span id="cb147-1064"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1064" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1065"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1065" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1066"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1066" tabindex="-1"></a>  year.end.prefund <span class="ot">=</span> year.end.prefund<span class="sc">$</span>end_pre_fund</span>
<span id="cb147-1067"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1067" tabindex="-1"></a>  </span>
<span id="cb147-1068"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1068" tabindex="-1"></a>  <span class="co">#Plot covariate balance</span></span>
<span id="cb147-1069"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1069" tabindex="-1"></a>  colname.flAvg.new <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;Avg. Annual Forest </span><span class="sc">\n</span><span class="st"> Loss &quot;</span>,  year.start.prefund, <span class="st">&quot;-&quot;</span>, year.end.prefund)</span>
<span id="cb147-1070"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1070" tabindex="-1"></a>  c_name <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">old =</span> <span class="fu">c</span>(colname.travelTime, colname.clayContent, colname.tri, colname.elevation,</span>
<span id="cb147-1071"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1071" tabindex="-1"></a>                              colname.fcIni, colname.flAvg),</span>
<span id="cb147-1072"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1072" tabindex="-1"></a>                      <span class="at">new =</span> <span class="fu">c</span>(<span class="st">&quot;Accessibility&quot;</span>, <span class="st">&quot;Clay Content&quot;</span>, <span class="st">&quot;Terrain Ruggedness Index (TRI)&quot;</span>, <span class="st">&quot;Elevation (m)&quot;</span>, <span class="st">&quot;Forest Cover in 2000&quot;</span>,</span>
<span id="cb147-1073"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1073" tabindex="-1"></a>                              colname.flAvg.new))</span>
<span id="cb147-1074"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1074" tabindex="-1"></a>  </span>
<span id="cb147-1075"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1075" tabindex="-1"></a>  <span class="co"># Refer to cobalt::love.plot()</span></span>
<span id="cb147-1076"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1076" tabindex="-1"></a>  <span class="co"># https://cloud.r-project.org/web/packages/cobalt/vignettes/cobalt.html#love.plot</span></span>
<span id="cb147-1077"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1077" tabindex="-1"></a>  fig_covbal <span class="ot">=</span> <span class="fu">love.plot</span>(out.cem, </span>
<span id="cb147-1078"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1078" tabindex="-1"></a>                       <span class="at">binary =</span> <span class="st">&quot;std&quot;</span>, </span>
<span id="cb147-1079"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1079" tabindex="-1"></a>                       <span class="at">abs =</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-1080"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1080" tabindex="-1"></a>                       <span class="co">#thresholds = c(m = .1),</span></span>
<span id="cb147-1081"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1081" tabindex="-1"></a>                       <span class="at">var.order =</span> <span class="st">&quot;unadjusted&quot;</span>,</span>
<span id="cb147-1082"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1082" tabindex="-1"></a>                       <span class="at">var.names =</span> c_name,</span>
<span id="cb147-1083"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1083" tabindex="-1"></a>                       <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Covariate balance for WDPA ID &quot;</span>, wdpaid, <span class="st">&quot; in &quot;</span>, country.name),</span>
<span id="cb147-1084"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1084" tabindex="-1"></a>                       <span class="at">sample.names =</span> <span class="fu">c</span>(<span class="st">&quot;Discarded&quot;</span>, <span class="st">&quot;Selected&quot;</span>),</span>
<span id="cb147-1085"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1085" tabindex="-1"></a>                       <span class="at">wrap =</span> <span class="dv">25</span> <span class="co"># at how many characters does axis label break to new line</span></span>
<span id="cb147-1086"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1086" tabindex="-1"></a>  )</span>
<span id="cb147-1087"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1087" tabindex="-1"></a>  <span class="co"># Finetune Layouts using ggplot</span></span>
<span id="cb147-1088"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1088" tabindex="-1"></a>  fig_covbal <span class="sc">+</span> </span>
<span id="cb147-1089"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1089" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fl">0.1</span>, <span class="at">linetype=</span><span class="st">&quot;Acceptable </span><span class="sc">\n</span><span class="st"> Balance </span><span class="sc">\n</span><span class="st"> (x=0.1)&quot;</span>), <span class="at">color=</span><span class="fu">c</span>(<span class="st">&quot;#2ecc71&quot;</span>), <span class="at">linewidth=</span><span class="fl">0.35</span>) <span class="sc">+</span></span>
<span id="cb147-1090"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1090" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1091"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1091" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1092"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1092" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="fl">0.5</span>),</span>
<span id="cb147-1093"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1093" tabindex="-1"></a>      </span>
<span id="cb147-1094"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1094" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1095"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1095" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1096"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1096" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1097"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1097" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1098"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1098" tabindex="-1"></a>      </span>
<span id="cb147-1099"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1099" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1100"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1100" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1101"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1101" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1102"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1102" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1103"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1103" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1104"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1104" tabindex="-1"></a>      </span>
<span id="cb147-1105"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1105" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1106"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1106" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">2</span>)</span>
<span id="cb147-1107"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1107" tabindex="-1"></a>    ) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">linetype =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&quot;#2ecc71&quot;</span>))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1108"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1108" tabindex="-1"></a>  </span>
<span id="cb147-1109"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1109" tabindex="-1"></a></span>
<span id="cb147-1110"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1110" tabindex="-1"></a>  <span class="co">#Saving files</span></span>
<span id="cb147-1111"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1111" tabindex="-1"></a>  </span>
<span id="cb147-1112"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1112" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/CovBal/fig_covbal&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>),</span>
<span id="cb147-1113"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1113" tabindex="-1"></a>         <span class="at">plot =</span> fig_covbal,</span>
<span id="cb147-1114"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1114" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1115"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1115" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1116"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1116" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">xtable</span>(tbl_cem_nn, <span class="at">type =</span> <span class="st">&quot;latex&quot;</span>),</span>
<span id="cb147-1117"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1117" tabindex="-1"></a>        <span class="at">file =</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/CovBal/tbl_cem_nn&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.tex&quot;</span>))</span>
<span id="cb147-1118"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1118" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">xtable</span>(tbl_cem_m, <span class="at">type =</span> <span class="st">&quot;latex&quot;</span>),</span>
<span id="cb147-1119"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1119" tabindex="-1"></a>        <span class="at">file =</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/CovBal/tbl_cem_m&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.tex&quot;</span>))</span>
<span id="cb147-1120"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1120" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">xtable</span>(tbl_cem_all, <span class="at">type =</span> <span class="st">&quot;latex&quot;</span>),</span>
<span id="cb147-1121"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1121" tabindex="-1"></a>        <span class="at">file =</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/CovBal/tbl_cem_all&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.tex&quot;</span>))</span>
<span id="cb147-1122"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1122" tabindex="-1"></a>  </span>
<span id="cb147-1123"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1123" tabindex="-1"></a>  <span class="co">#Export to S3 storage</span></span>
<span id="cb147-1124"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1124" tabindex="-1"></a>  <span class="do">##List of files to save in the temp folder</span></span>
<span id="cb147-1125"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1125" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">paste</span>(path_tmp, <span class="st">&quot;CovBal&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1126"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1126" tabindex="-1"></a>  <span class="do">##Add each file in the bucket (same foler for every file in the temp)</span></span>
<span id="cb147-1127"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1127" tabindex="-1"></a>  <span class="cf">for</span>(f <span class="cf">in</span> files) </span>
<span id="cb147-1128"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1128" tabindex="-1"></a>  {</span>
<span id="cb147-1129"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1129" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Uploading file&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;&#39;&quot;</span>, f, <span class="st">&quot;&#39;&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb147-1130"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1130" tabindex="-1"></a>    aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> f, </span>
<span id="cb147-1131"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1131" tabindex="-1"></a>                       <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, wdpaid, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1132"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1132" tabindex="-1"></a>                       <span class="at">region =</span> <span class="st">&quot;&quot;</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1133"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1133" tabindex="-1"></a>  }</span>
<span id="cb147-1134"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1134" tabindex="-1"></a>  <span class="fu">do.call</span>(file.remove, <span class="fu">list</span>(<span class="fu">list.files</span>(<span class="fu">paste</span>(path_tmp, <span class="st">&quot;CovBal&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb147-1135"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1135" tabindex="-1"></a>  </span>
<span id="cb147-1136"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1136" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-1137"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1137" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Plot covariates balance</span><span class="sc">\n</span><span class="st">-&gt;OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1138"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1138" tabindex="-1"></a>  </span>
<span id="cb147-1139"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1139" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-1140"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1140" tabindex="-1"></a>  </span>
<span id="cb147-1141"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1141" tabindex="-1"></a>    },</span>
<span id="cb147-1142"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1142" tabindex="-1"></a>  </span>
<span id="cb147-1143"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1143" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e)</span>
<span id="cb147-1144"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1144" tabindex="-1"></a>  {</span>
<span id="cb147-1145"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1145" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-1146"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1146" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Plot covariates balance</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1147"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1147" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-1148"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1148" tabindex="-1"></a>  }</span>
<span id="cb147-1149"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1149" tabindex="-1"></a>  </span>
<span id="cb147-1150"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1150" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-1151"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1151" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-1152"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1152" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-1153"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1153" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-1154"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1154" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-1155"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1155" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;#Plot covariates balance\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-1156"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1156" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-1157"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1157" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-1158"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1158" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-1159"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1159" tabindex="-1"></a>  </span>
<span id="cb147-1160"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1160" tabindex="-1"></a>  )</span>
<span id="cb147-1161"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1161" tabindex="-1"></a>  </span>
<span id="cb147-1162"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1162" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-1163"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1163" tabindex="-1"></a></span>
<span id="cb147-1164"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1164" tabindex="-1"></a>}</span>
<span id="cb147-1165"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1165" tabindex="-1"></a></span>
<span id="cb147-1166"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1166" tabindex="-1"></a></span>
<span id="cb147-1167"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1167" tabindex="-1"></a><span class="co">#Density plots of covariates for control and treatment units, before and after matching</span></span>
<span id="cb147-1168"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1168" tabindex="-1"></a><span class="do">## INPUTS :</span></span>
<span id="cb147-1169"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1169" tabindex="-1"></a><span class="do">### out.cem : list of results from the CEM matching</span></span>
<span id="cb147-1170"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1170" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-1171"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1171" tabindex="-1"></a><span class="do">### colname.travelTime, colname.clayContent, colname.elevation, colname.tri, colname.fcIni, colname.flAvg : name of the matching covariates</span></span>
<span id="cb147-1172"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1172" tabindex="-1"></a><span class="do">### iso : ISO code of the country considered</span></span>
<span id="cb147-1173"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1173" tabindex="-1"></a><span class="do">### path_tmp : temporary folder to store figures</span></span>
<span id="cb147-1174"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1174" tabindex="-1"></a><span class="do">### wdpaid : the WDPA ID of the protected area considered</span></span>
<span id="cb147-1175"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1175" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-1176"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1176" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-1177"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1177" tabindex="-1"></a><span class="do">## OUTPUTS :</span></span>
<span id="cb147-1178"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1178" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-1179"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1179" tabindex="-1"></a><span class="do">## DATA SAVED :</span></span>
<span id="cb147-1180"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1180" tabindex="-1"></a><span class="do">### Density plots of the matching covariates considered, for matched treated and control units</span></span>
<span id="cb147-1181"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1181" tabindex="-1"></a>fn_post_plot_density <span class="ot">=</span> <span class="cf">function</span>(out.cem, mf, </span>
<span id="cb147-1182"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1182" tabindex="-1"></a>                                colname.travelTime, colname.clayContent, colname.fcIni, colname.flAvg, colname.tri, colname.elevation, </span>
<span id="cb147-1183"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1183" tabindex="-1"></a>                                iso, path_tmp, wdpaid, log, save_dir)</span>
<span id="cb147-1184"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1184" tabindex="-1"></a>{</span>
<span id="cb147-1185"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1185" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-1186"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1186" tabindex="-1"></a>    </span>
<span id="cb147-1187"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1187" tabindex="-1"></a>    {</span>
<span id="cb147-1188"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1188" tabindex="-1"></a>      </span>
<span id="cb147-1189"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1189" tabindex="-1"></a>  <span class="co"># Define Facet Labels</span></span>
<span id="cb147-1190"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1190" tabindex="-1"></a>  fnl <span class="ot">=</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Unadjusted Sample</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;Before Matching&quot;</span>,</span>
<span id="cb147-1191"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1191" tabindex="-1"></a>          <span class="st">`</span><span class="at">Adjusted Sample</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&quot;After Matching&quot;</span>)</span>
<span id="cb147-1192"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1192" tabindex="-1"></a>  </span>
<span id="cb147-1193"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1193" tabindex="-1"></a>  <span class="co">#Extract country name</span></span>
<span id="cb147-1194"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1194" tabindex="-1"></a>  country.name <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-1195"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1195" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1196"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1196" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1197"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1197" tabindex="-1"></a>  country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-1198"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1198" tabindex="-1"></a>  </span>
<span id="cb147-1199"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1199" tabindex="-1"></a>  <span class="co">#Define plots</span></span>
<span id="cb147-1200"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1200" tabindex="-1"></a>  <span class="do">## Density plot for Travel Time</span></span>
<span id="cb147-1201"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1201" tabindex="-1"></a>  fig_travel <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem, </span>
<span id="cb147-1202"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1202" tabindex="-1"></a>                      <span class="at">var.name =</span> colname.travelTime,</span>
<span id="cb147-1203"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1203" tabindex="-1"></a>                      <span class="co">#sample.names = c(&quot;Control&quot;, &quot;Treatment&quot;),</span></span>
<span id="cb147-1204"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1204" tabindex="-1"></a>                      <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1205"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1205" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1206"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1206" tabindex="-1"></a>    <span class="co">#scale_fill_viridis(discrete = T) +</span></span>
<span id="cb147-1207"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1207" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1208"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1208" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for accessibility&quot;</span>,</span>
<span id="cb147-1209"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1209" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1210"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1210" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Accessibility (min)&quot;</span>,</span>
<span id="cb147-1211"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1211" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1212"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1212" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1213"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1213" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1214"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1214" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1215"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1215" tabindex="-1"></a>      </span>
<span id="cb147-1216"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1216" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1217"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1217" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1218"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1218" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1219"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1219" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1220"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1220" tabindex="-1"></a>      </span>
<span id="cb147-1221"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1221" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1222"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1222" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1223"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1223" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1224"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1224" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1225"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1225" tabindex="-1"></a>      </span>
<span id="cb147-1226"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1226" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1227"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1227" tabindex="-1"></a>    )</span>
<span id="cb147-1228"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1228" tabindex="-1"></a>  </span>
<span id="cb147-1229"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1229" tabindex="-1"></a>  <span class="do">## Density plot for Clay Content</span></span>
<span id="cb147-1230"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1230" tabindex="-1"></a>  fig_clay <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem, </span>
<span id="cb147-1231"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1231" tabindex="-1"></a>                    <span class="at">var.name =</span> colname.clayContent,</span>
<span id="cb147-1232"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1232" tabindex="-1"></a>                    <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1233"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1233" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1234"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1234" tabindex="-1"></a>    <span class="co">#scale_fill_viridis(discrete = T) +</span></span>
<span id="cb147-1235"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1235" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1236"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1236" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for clay content&quot;</span>,</span>
<span id="cb147-1237"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1237" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1238"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1238" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Clay content at 0~20cm soil depth (%)&quot;</span>,</span>
<span id="cb147-1239"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1239" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1240"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1240" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1241"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1241" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1242"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1242" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="dv">0</span>),</span>
<span id="cb147-1243"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1243" tabindex="-1"></a>      </span>
<span id="cb147-1244"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1244" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1245"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1245" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1246"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1246" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1247"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1247" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1248"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1248" tabindex="-1"></a>      </span>
<span id="cb147-1249"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1249" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1250"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1250" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1251"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1251" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1252"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1252" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1253"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1253" tabindex="-1"></a>      </span>
<span id="cb147-1254"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1254" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1255"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1255" tabindex="-1"></a>    )</span>
<span id="cb147-1256"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1256" tabindex="-1"></a>  </span>
<span id="cb147-1257"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1257" tabindex="-1"></a>  <span class="do">## Density plot for Elevation</span></span>
<span id="cb147-1258"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1258" tabindex="-1"></a>  fig_elevation <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem,</span>
<span id="cb147-1259"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1259" tabindex="-1"></a>                      <span class="at">var.name =</span> colname.elevation,</span>
<span id="cb147-1260"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1260" tabindex="-1"></a>                      <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1261"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1261" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1262"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1262" tabindex="-1"></a>      <span class="co">#scale_fill_viridis(discrete = T) +</span></span>
<span id="cb147-1263"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1263" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1264"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1264" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for elevation&quot;</span>,</span>
<span id="cb147-1265"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1265" tabindex="-1"></a>           <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1266"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1266" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">&quot;Elevation (m)&quot;</span>,</span>
<span id="cb147-1267"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1267" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1268"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1268" tabindex="-1"></a>      <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1269"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1269" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb147-1270"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1270" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="dv">0</span>),</span>
<span id="cb147-1271"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1271" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1272"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1272" tabindex="-1"></a>          <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1273"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1273" tabindex="-1"></a>          <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1274"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1274" tabindex="-1"></a>          <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1275"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1275" tabindex="-1"></a></span>
<span id="cb147-1276"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1276" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1277"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1277" tabindex="-1"></a>          <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1278"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1278" tabindex="-1"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1279"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1279" tabindex="-1"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1280"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1280" tabindex="-1"></a></span>
<span id="cb147-1281"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1281" tabindex="-1"></a>          <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1282"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1282" tabindex="-1"></a>      )</span>
<span id="cb147-1283"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1283" tabindex="-1"></a>  </span>
<span id="cb147-1284"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1284" tabindex="-1"></a>  <span class="do">## Density plot for TRI</span></span>
<span id="cb147-1285"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1285" tabindex="-1"></a>  fig_tri <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem,</span>
<span id="cb147-1286"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1286" tabindex="-1"></a>                      <span class="at">var.name =</span> colname.tri,</span>
<span id="cb147-1287"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1287" tabindex="-1"></a>                      <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1288"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1288" tabindex="-1"></a>      <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1289"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1289" tabindex="-1"></a>      <span class="co">#scale_fill_viridis(discrete = T) +</span></span>
<span id="cb147-1290"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1290" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1291"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1291" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for Terrain Ruggedness Index (TRI)&quot;</span>,</span>
<span id="cb147-1292"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1292" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1293"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1293" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">&quot;TRI&quot;</span>,</span>
<span id="cb147-1294"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1294" tabindex="-1"></a>           <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1295"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1295" tabindex="-1"></a>      <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1296"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1296" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb147-1297"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1297" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="dv">0</span>),</span>
<span id="cb147-1298"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1298" tabindex="-1"></a></span>
<span id="cb147-1299"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1299" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1300"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1300" tabindex="-1"></a>          <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1301"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1301" tabindex="-1"></a>          <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1302"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1302" tabindex="-1"></a>          <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1303"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1303" tabindex="-1"></a></span>
<span id="cb147-1304"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1304" tabindex="-1"></a>          <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1305"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1305" tabindex="-1"></a>          <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1306"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1306" tabindex="-1"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1307"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1307" tabindex="-1"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1308"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1308" tabindex="-1"></a></span>
<span id="cb147-1309"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1309" tabindex="-1"></a>          <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1310"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1310" tabindex="-1"></a>      )</span>
<span id="cb147-1311"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1311" tabindex="-1"></a>  </span>
<span id="cb147-1312"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1312" tabindex="-1"></a>  <span class="do">## Density plot for covariate &quot;forest cover 2000&quot;</span></span>
<span id="cb147-1313"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1313" tabindex="-1"></a>  fig_fc <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem, </span>
<span id="cb147-1314"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1314" tabindex="-1"></a>                  <span class="at">var.name =</span> colname.fcIni,</span>
<span id="cb147-1315"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1315" tabindex="-1"></a>                  <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1316"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1316" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1317"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1317" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1318"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1318" tabindex="-1"></a>    <span class="co"># scale_x_continuous(trans = &quot;log10&quot;) +</span></span>
<span id="cb147-1319"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1319" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for forest cover in 2000&quot;</span>,</span>
<span id="cb147-1320"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1320" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1321"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1321" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Forest cover (ha)&quot;</span>,</span>
<span id="cb147-1322"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1322" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1323"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1323" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1324"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1324" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1325"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1325" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="dv">0</span>),</span>
<span id="cb147-1326"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1326" tabindex="-1"></a>      </span>
<span id="cb147-1327"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1327" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1328"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1328" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1329"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1329" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1330"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1330" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1331"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1331" tabindex="-1"></a>      </span>
<span id="cb147-1332"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1332" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1333"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1333" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1334"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1334" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1335"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1335" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1336"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1336" tabindex="-1"></a>      </span>
<span id="cb147-1337"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1337" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1338"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1338" tabindex="-1"></a>    )</span>
<span id="cb147-1339"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1339" tabindex="-1"></a>  </span>
<span id="cb147-1340"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1340" tabindex="-1"></a>  <span class="do">## Density plot for covariate &quot;avg. annual forest loss prior funding&quot;</span></span>
<span id="cb147-1341"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1341" tabindex="-1"></a>  fig_fl <span class="ot">=</span> <span class="fu">bal.plot</span>(out.cem, </span>
<span id="cb147-1342"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1342" tabindex="-1"></a>                  <span class="at">var.name =</span> colname.flAvg,</span>
<span id="cb147-1343"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1343" tabindex="-1"></a>                  <span class="at">which =</span> <span class="st">&quot;both&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1344"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1344" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(.<span class="sc">~</span>which, <span class="at">labeller =</span> <span class="fu">as_labeller</span>(fnl)) <span class="sc">+</span></span>
<span id="cb147-1345"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1345" tabindex="-1"></a>    <span class="co">#scale_fill_viridis(discrete = T) +</span></span>
<span id="cb147-1346"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1346" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>), <span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;#f5b041&quot;</span>,<span class="st">&quot;#5dade2&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1347"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1347" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Distributional balance for average pre-treatment forest loss&quot;</span>,</span>
<span id="cb147-1348"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1348" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1349"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1349" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Forest loss (%)&quot;</span>,</span>
<span id="cb147-1350"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1350" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1351"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1351" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1352"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1352" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1353"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1353" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">family=</span><span class="st">&quot;Arial Black&quot;</span>, <span class="at">size=</span><span class="dv">16</span>, <span class="at">hjust=</span><span class="dv">0</span>),</span>
<span id="cb147-1354"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1354" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1355"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1355" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1356"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1356" tabindex="-1"></a>      <span class="at">legend.spacing.x =</span> <span class="fu">unit</span>(<span class="fl">0.5</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1357"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1357" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1358"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1358" tabindex="-1"></a>      </span>
<span id="cb147-1359"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1359" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">12</span>),</span>
<span id="cb147-1360"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1360" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1361"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1361" tabindex="-1"></a>      <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">r =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1362"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1362" tabindex="-1"></a>      <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">margin =</span> <span class="fu">margin</span>(<span class="at">unit =</span> <span class="st">&#39;cm&#39;</span>, <span class="at">t =</span> <span class="fl">0.5</span>)),</span>
<span id="cb147-1363"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1363" tabindex="-1"></a>      </span>
<span id="cb147-1364"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1364" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1365"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1365" tabindex="-1"></a>    )</span>
<span id="cb147-1366"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1366" tabindex="-1"></a>  </span>
<span id="cb147-1367"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1367" tabindex="-1"></a>  <span class="co">#Saving plots</span></span>
<span id="cb147-1368"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1368" tabindex="-1"></a>  </span>
<span id="cb147-1369"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1369" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;fig&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb147-1370"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1370" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_travel_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1371"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1371" tabindex="-1"></a>         <span class="at">plot =</span> fig_travel,</span>
<span id="cb147-1372"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1372" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1373"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1373" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1374"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1374" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_clay_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1375"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1375" tabindex="-1"></a>         <span class="at">plot =</span> fig_clay,</span>
<span id="cb147-1376"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1376" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1377"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1377" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1378"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1378" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_elevation_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1379"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1379" tabindex="-1"></a>         <span class="at">plot =</span> fig_elevation,</span>
<span id="cb147-1380"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1380" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1381"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1381" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1382"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1382" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_tri_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1383"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1383" tabindex="-1"></a>         <span class="at">plot =</span> fig_tri,</span>
<span id="cb147-1384"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1384" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1385"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1385" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1386"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1386" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_fc_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1387"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1387" tabindex="-1"></a>         <span class="at">plot =</span> fig_fc,</span>
<span id="cb147-1388"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1388" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1389"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1389" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1390"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1390" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_fl_dplot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1391"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1391" tabindex="-1"></a>         <span class="at">plot =</span> fig_fl,</span>
<span id="cb147-1392"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1392" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1393"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1393" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1394"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1394" tabindex="-1"></a>  </span>
<span id="cb147-1395"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1395" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1396"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1396" tabindex="-1"></a>  <span class="do">##Add each file in the bucket (same foler for every file in the temp)</span></span>
<span id="cb147-1397"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1397" tabindex="-1"></a>  <span class="cf">for</span>(f <span class="cf">in</span> files) </span>
<span id="cb147-1398"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1398" tabindex="-1"></a>  {</span>
<span id="cb147-1399"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1399" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Uploading file&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;&#39;&quot;</span>, f, <span class="st">&quot;&#39;&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb147-1400"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1400" tabindex="-1"></a>    aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> f, </span>
<span id="cb147-1401"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1401" tabindex="-1"></a>                       <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, wdpaid, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1402"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1402" tabindex="-1"></a>                       <span class="at">region =</span> <span class="st">&quot;&quot;</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1403"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1403" tabindex="-1"></a>  }</span>
<span id="cb147-1404"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1404" tabindex="-1"></a>  <span class="fu">do.call</span>(file.remove, <span class="fu">list</span>(<span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb147-1405"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1405" tabindex="-1"></a>  </span>
<span id="cb147-1406"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1406" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-1407"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1407" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Plot covariates density</span><span class="sc">\n</span><span class="st">-&gt;OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1408"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1408" tabindex="-1"></a>  </span>
<span id="cb147-1409"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1409" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-1410"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1410" tabindex="-1"></a>  </span>
<span id="cb147-1411"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1411" tabindex="-1"></a>    },</span>
<span id="cb147-1412"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1412" tabindex="-1"></a>  </span>
<span id="cb147-1413"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1413" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e)</span>
<span id="cb147-1414"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1414" tabindex="-1"></a>  {</span>
<span id="cb147-1415"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1415" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-1416"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1416" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Plot covariates density</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1417"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1417" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-1418"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1418" tabindex="-1"></a>  }</span>
<span id="cb147-1419"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1419" tabindex="-1"></a>  </span>
<span id="cb147-1420"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1420" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-1421"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1421" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-1422"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1422" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-1423"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1423" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-1424"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1424" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-1425"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1425" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;#Plot covariates density\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-1426"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1426" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-1427"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1427" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-1428"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1428" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-1429"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1429" tabindex="-1"></a>  </span>
<span id="cb147-1430"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1430" tabindex="-1"></a>  )</span>
<span id="cb147-1431"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1431" tabindex="-1"></a>  </span>
<span id="cb147-1432"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1432" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-1433"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1433" tabindex="-1"></a>  </span>
<span id="cb147-1434"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1434" tabindex="-1"></a>}</span>
<span id="cb147-1435"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1435" tabindex="-1"></a></span>
<span id="cb147-1436"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1436" tabindex="-1"></a></span>
<span id="cb147-1437"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1437" tabindex="-1"></a><span class="co">#Define panel datasets (long, wide format) for control and treatment observation units, before and after matching.</span></span>
<span id="cb147-1438"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1438" tabindex="-1"></a><span class="do">## INPUTS :</span></span>
<span id="cb147-1439"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1439" tabindex="-1"></a><span class="do">### out.cem : list of results from the CEM matching</span></span>
<span id="cb147-1440"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1440" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-1441"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1441" tabindex="-1"></a><span class="do">### ext_output : extension fo the file to import</span></span>
<span id="cb147-1442"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1442" tabindex="-1"></a><span class="do">### iso : ISO code of the country considered</span></span>
<span id="cb147-1443"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1443" tabindex="-1"></a><span class="do">### wdpaid : the WDPA ID of the protected area considered</span></span>
<span id="cb147-1444"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1444" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-1445"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1445" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-1446"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1446" tabindex="-1"></a><span class="do">## OUTPUTS :</span></span>
<span id="cb147-1447"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1447" tabindex="-1"></a><span class="do">### a list of dataframes : (un)matched.wide/long. They contain covariates and outcomes for treatment and control units, before and after matching, in a wide or long format</span></span>
<span id="cb147-1448"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1448" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-1449"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1449" tabindex="-1"></a><span class="do">## DATA SAVED</span></span>
<span id="cb147-1450"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1450" tabindex="-1"></a><span class="do">### (un)matched.wide/long dataframes. They contain covariates and outcomes for treatment and control units, before and after matching, in a wide or long format</span></span>
<span id="cb147-1451"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1451" tabindex="-1"></a></span>
<span id="cb147-1452"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1452" tabindex="-1"></a>fn_post_panel <span class="ot">=</span> <span class="cf">function</span>(out.cem, mf, ext_output, wdpaid, iso, log, save_dir)</span>
<span id="cb147-1453"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1453" tabindex="-1"></a>{</span>
<span id="cb147-1454"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1454" tabindex="-1"></a>  </span>
<span id="cb147-1455"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1455" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-1456"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1456" tabindex="-1"></a>    </span>
<span id="cb147-1457"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1457" tabindex="-1"></a>    {</span>
<span id="cb147-1458"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1458" tabindex="-1"></a>      </span>
<span id="cb147-1459"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1459" tabindex="-1"></a>  <span class="co"># Convert dataframe of matched objects to pivot wide form</span></span>
<span id="cb147-1460"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1460" tabindex="-1"></a>  matched.wide <span class="ot">=</span> <span class="fu">match.data</span>(<span class="at">object=</span>out.cem, <span class="at">data=</span>mf)</span>
<span id="cb147-1461"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1461" tabindex="-1"></a>  </span>
<span id="cb147-1462"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1462" tabindex="-1"></a>  <span class="co"># Pivot Wide ==&gt; Pivot Long</span></span>
<span id="cb147-1463"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1463" tabindex="-1"></a>  matched.long <span class="ot">=</span> matched.wide <span class="sc">%&gt;%</span></span>
<span id="cb147-1464"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1464" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(region_afd, region, sub_region, country_en, iso3, group, wdpaid, status_yr, year_funding_first, year_funding_all, assetid, weights, <span class="fu">starts_with</span>(<span class="st">&quot;treecover&quot;</span>), res_m)) <span class="sc">%&gt;%</span></span>
<span id="cb147-1465"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1465" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(<span class="st">&quot;treecover&quot;</span>)),</span>
<span id="cb147-1466"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1466" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;var&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb147-1467"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1467" tabindex="-1"></a>                 <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb147-1468"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1468" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">&quot;fc_ha&quot;</span>)</span>
<span id="cb147-1469"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1469" tabindex="-1"></a>  </span>
<span id="cb147-1470"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1470" tabindex="-1"></a>  <span class="co"># Pivot wide Dataframe of un-matched objects</span></span>
<span id="cb147-1471"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1471" tabindex="-1"></a>  unmatched.wide <span class="ot">=</span> mf</span>
<span id="cb147-1472"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1472" tabindex="-1"></a>  </span>
<span id="cb147-1473"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1473" tabindex="-1"></a>  <span class="co"># Pivot Wide ==&gt; Pivot Long</span></span>
<span id="cb147-1474"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1474" tabindex="-1"></a>  unmatched.long <span class="ot">=</span> unmatched.wide <span class="sc">%&gt;%</span></span>
<span id="cb147-1475"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1475" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(region_afd, region, sub_region, iso3, country_en, group, wdpaid, status_yr, year_funding_first, year_funding_all, assetid, <span class="fu">starts_with</span>(treecover), res_m)) <span class="sc">%&gt;%</span></span>
<span id="cb147-1476"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1476" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="fu">starts_with</span>(treecover)),</span>
<span id="cb147-1477"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1477" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="fu">c</span>(<span class="st">&quot;var&quot;</span>, <span class="st">&quot;year&quot;</span>),</span>
<span id="cb147-1478"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1478" tabindex="-1"></a>                 <span class="at">names_sep =</span> <span class="st">&quot;_&quot;</span>,</span>
<span id="cb147-1479"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1479" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">&quot;fc_ha&quot;</span>)</span>
<span id="cb147-1480"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1480" tabindex="-1"></a>  </span>
<span id="cb147-1481"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1481" tabindex="-1"></a>  <span class="co">#Save the dataframes</span></span>
<span id="cb147-1482"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1482" tabindex="-1"></a>  <span class="fu">s3write_using</span>(matched.wide,</span>
<span id="cb147-1483"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1483" tabindex="-1"></a>                sf<span class="sc">::</span>st_write,</span>
<span id="cb147-1484"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1484" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, wdpaid, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;matched_wide&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, ext_output)),</span>
<span id="cb147-1485"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1485" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-1486"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1486" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-1487"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1487" tabindex="-1"></a>  <span class="fu">s3write_using</span>(unmatched.wide,</span>
<span id="cb147-1488"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1488" tabindex="-1"></a>                sf<span class="sc">::</span>st_write,</span>
<span id="cb147-1489"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1489" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, wdpaid, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;unmatched_wide&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, ext_output)),</span>
<span id="cb147-1490"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1490" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-1491"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1491" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-1492"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1492" tabindex="-1"></a>  <span class="fu">s3write_using</span>(matched.long,</span>
<span id="cb147-1493"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1493" tabindex="-1"></a>                sf<span class="sc">::</span>st_write,</span>
<span id="cb147-1494"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1494" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, wdpaid, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;matched_long&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, ext_output)),</span>
<span id="cb147-1495"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1495" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-1496"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1496" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-1497"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1497" tabindex="-1"></a>  <span class="fu">s3write_using</span>(unmatched.long,</span>
<span id="cb147-1498"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1498" tabindex="-1"></a>                sf<span class="sc">::</span>st_write,</span>
<span id="cb147-1499"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1499" tabindex="-1"></a>                <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, wdpaid, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;unmatched_long&quot;</span>, <span class="st">&quot;_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, ext_output)),</span>
<span id="cb147-1500"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1500" tabindex="-1"></a>                <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-1501"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1501" tabindex="-1"></a>                <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-1502"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1502" tabindex="-1"></a>  </span>
<span id="cb147-1503"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1503" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-1504"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1504" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Panelize dataframe</span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1505"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1505" tabindex="-1"></a>  </span>
<span id="cb147-1506"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1506" tabindex="-1"></a>  <span class="co">#Return outputs</span></span>
<span id="cb147-1507"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1507" tabindex="-1"></a>  list_output <span class="ot">=</span> <span class="fu">list</span>(<span class="st">&quot;matched.wide&quot;</span> <span class="ot">=</span> matched.wide, <span class="st">&quot;matched.long&quot;</span> <span class="ot">=</span> matched.long,</span>
<span id="cb147-1508"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1508" tabindex="-1"></a>                     <span class="st">&quot;unmatched.wide&quot;</span> <span class="ot">=</span> unmatched.wide, <span class="st">&quot;unmatched.long&quot;</span> <span class="ot">=</span> unmatched.long,</span>
<span id="cb147-1509"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1509" tabindex="-1"></a>                     <span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1510"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1510" tabindex="-1"></a>  <span class="fu">return</span>(list_output)</span>
<span id="cb147-1511"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1511" tabindex="-1"></a>  </span>
<span id="cb147-1512"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1512" tabindex="-1"></a>    },</span>
<span id="cb147-1513"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1513" tabindex="-1"></a>  </span>
<span id="cb147-1514"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1514" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e)</span>
<span id="cb147-1515"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1515" tabindex="-1"></a>{</span>
<span id="cb147-1516"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1516" tabindex="-1"></a>  <span class="fu">print</span>(e)</span>
<span id="cb147-1517"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1517" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Panelize dataframe</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1518"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1518" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-1519"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1519" tabindex="-1"></a>}</span>
<span id="cb147-1520"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1520" tabindex="-1"></a></span>
<span id="cb147-1521"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1521" tabindex="-1"></a><span class="co"># warning = function(w)</span></span>
<span id="cb147-1522"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1522" tabindex="-1"></a><span class="co"># {</span></span>
<span id="cb147-1523"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1523" tabindex="-1"></a><span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-1524"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1524" tabindex="-1"></a><span class="co">#   print(w)</span></span>
<span id="cb147-1525"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1525" tabindex="-1"></a><span class="co">#   #Append the log </span></span>
<span id="cb147-1526"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1526" tabindex="-1"></a><span class="co">#   cat(paste(&quot;#Panelize dataframe\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-1527"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1527" tabindex="-1"></a><span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-1528"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1528" tabindex="-1"></a><span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-1529"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1529" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb147-1530"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1530" tabindex="-1"></a></span>
<span id="cb147-1531"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1531" tabindex="-1"></a>  )</span>
<span id="cb147-1532"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1532" tabindex="-1"></a>  </span>
<span id="cb147-1533"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1533" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-1534"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1534" tabindex="-1"></a>  </span>
<span id="cb147-1535"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1535" tabindex="-1"></a>}   </span>
<span id="cb147-1536"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1536" tabindex="-1"></a></span>
<span id="cb147-1537"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1537" tabindex="-1"></a><span class="co">#Plot the average trend of control and treated units in a given country, before and after the matching</span></span>
<span id="cb147-1538"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1538" tabindex="-1"></a><span class="do">## INPUTS :</span></span>
<span id="cb147-1539"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1539" tabindex="-1"></a><span class="do">### (un)matched.long : dataframe with covariates and outcomes for each treatment and control unit, before and after matching, in a long format (one row : pixel+year)</span></span>
<span id="cb147-1540"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1540" tabindex="-1"></a><span class="do">### mf : the matching dataframe</span></span>
<span id="cb147-1541"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1541" tabindex="-1"></a><span class="do">### data_pa : dataframe with information on each PA considered in the analysis</span></span>
<span id="cb147-1542"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1542" tabindex="-1"></a><span class="do">### iso : ISO code of the country considered</span></span>
<span id="cb147-1543"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1543" tabindex="-1"></a><span class="do">### wdpaid : the WDPA ID of the protected area considered</span></span>
<span id="cb147-1544"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1544" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-1545"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1545" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-1546"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1546" tabindex="-1"></a><span class="do">## OUTPUTS : </span></span>
<span id="cb147-1547"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1547" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-1548"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1548" tabindex="-1"></a><span class="do">## DATA SAVED :</span></span>
<span id="cb147-1549"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1549" tabindex="-1"></a><span class="do">### Evolution of forest cover in a treated and control pixel on average, before and after matching</span></span>
<span id="cb147-1550"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1550" tabindex="-1"></a><span class="do">### Same for total forest cover (pixel*# of pixels in the PA)</span></span>
<span id="cb147-1551"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1551" tabindex="-1"></a><span class="do">### Cumulated deforestation relative to 2000 forest cover, in treated and control pixels, before and after matching</span></span>
<span id="cb147-1552"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1552" tabindex="-1"></a>fn_post_plot_trend <span class="ot">=</span> <span class="cf">function</span>(matched.long, unmatched.long, mf, data_pa, iso, wdpaid, log, save_dir) </span>
<span id="cb147-1553"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1553" tabindex="-1"></a>{</span>
<span id="cb147-1554"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1554" tabindex="-1"></a>    </span>
<span id="cb147-1555"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1555" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-1556"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1556" tabindex="-1"></a>    </span>
<span id="cb147-1557"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1557" tabindex="-1"></a>    {</span>
<span id="cb147-1558"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1558" tabindex="-1"></a>      <span class="co">#First extract some relevant information</span></span>
<span id="cb147-1559"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1559" tabindex="-1"></a>      <span class="co">#Extract spatial resolution of pixels res_m and define pixel area in ha</span></span>
<span id="cb147-1560"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1560" tabindex="-1"></a>      res_m <span class="ot">=</span> <span class="fu">unique</span>(mf<span class="sc">$</span>res_m)</span>
<span id="cb147-1561"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1561" tabindex="-1"></a>      res_ha <span class="ot">=</span> res_m<span class="sc">^</span><span class="dv">2</span><span class="sc">*</span><span class="fl">1e-4</span></span>
<span id="cb147-1562"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1562" tabindex="-1"></a>        </span>
<span id="cb147-1563"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1563" tabindex="-1"></a>      <span class="co">#Extract treatment year</span></span>
<span id="cb147-1564"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1564" tabindex="-1"></a>      treatment.year <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-1565"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1565" tabindex="-1"></a>        <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1566"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1566" tabindex="-1"></a>        <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1567"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1567" tabindex="-1"></a>      treatment.year <span class="ot">=</span> treatment.year<span class="sc">$</span>status_yr</span>
<span id="cb147-1568"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1568" tabindex="-1"></a>      </span>
<span id="cb147-1569"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1569" tabindex="-1"></a>      <span class="co">#Extract funding years</span></span>
<span id="cb147-1570"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1570" tabindex="-1"></a>      funding.years <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-1571"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1571" tabindex="-1"></a>        <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1572"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1572" tabindex="-1"></a>        <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1573"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1573" tabindex="-1"></a>      funding.years <span class="ot">=</span> funding.years<span class="sc">$</span>year_funding_first</span>
<span id="cb147-1574"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1574" tabindex="-1"></a>      <span class="co">#funding.years = as.numeric(unlist(strsplit(funding.years$year_funding_all, split = &quot;,&quot;)))</span></span>
<span id="cb147-1575"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1575" tabindex="-1"></a>      </span>
<span id="cb147-1576"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1576" tabindex="-1"></a>      <span class="co">#Extract country name</span></span>
<span id="cb147-1577"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1577" tabindex="-1"></a>      country.name <span class="ot">=</span> mf <span class="sc">%&gt;%</span> </span>
<span id="cb147-1578"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1578" tabindex="-1"></a>        <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-1579"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1579" tabindex="-1"></a>        <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-1580"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1580" tabindex="-1"></a>      country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-1581"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1581" tabindex="-1"></a>      </span>
<span id="cb147-1582"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1582" tabindex="-1"></a>      <span class="do">##Area of the PA</span></span>
<span id="cb147-1583"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1583" tabindex="-1"></a>      wdpa_id <span class="ot">=</span> wdpaid <span class="co">#Need to give a name to wdpaid (function argument) different from the varaible in the dataset (wdpaid)</span></span>
<span id="cb147-1584"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1584" tabindex="-1"></a>      area_ha <span class="ot">=</span> data_pa[data_pa<span class="sc">$</span>wdpaid <span class="sc">==</span> wdpa_id,]<span class="sc">$</span>area_km2<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb147-1585"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1585" tabindex="-1"></a>      </span>
<span id="cb147-1586"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1586" tabindex="-1"></a>      <span class="co">#Extract number of pixels in the PA</span></span>
<span id="cb147-1587"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1587" tabindex="-1"></a>      <span class="co">#n_pix_pa = length(unique(filter(unmatched.long, group == 2)$assetid))</span></span>
<span id="cb147-1588"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1588" tabindex="-1"></a>      n_pix_pa <span class="ot">=</span> area_ha<span class="sc">/</span>res_ha <span class="co">#This measure is imperfect for extrapolation of total deforestation avoided, as part of a PA can be coastal. Indeed, this extrapolation assumes implicitly that all the PA is covered by forest potentially deforested in absence of the conservation </span></span>
<span id="cb147-1589"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1589" tabindex="-1"></a>      </span>
<span id="cb147-1590"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1590" tabindex="-1"></a>     <span class="co">#Open a multisession for dataframe computations</span></span>
<span id="cb147-1591"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1591" tabindex="-1"></a>      <span class="co">#Note the computations on unmatched units are the slowest here due to the number of observations relatively higher than for matched units</span></span>
<span id="cb147-1592"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1592" tabindex="-1"></a>      <span class="fu">plan</span>(multisession, <span class="at">gc =</span> <span class="cn">TRUE</span>, <span class="at">workers =</span> <span class="dv">6</span>)</span>
<span id="cb147-1593"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1593" tabindex="-1"></a>      <span class="fu">with_progress</span>({</span>
<span id="cb147-1594"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1594" tabindex="-1"></a> </span>
<span id="cb147-1595"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1595" tabindex="-1"></a>  <span class="co"># Make dataframe for plotting trend</span></span>
<span id="cb147-1596"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1596" tabindex="-1"></a>  <span class="do">## Matched units</span></span>
<span id="cb147-1597"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1597" tabindex="-1"></a>  df.matched.trend  <span class="sc">%&lt;-%</span> {matched.long <span class="sc">%&gt;%</span></span>
<span id="cb147-1598"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1598" tabindex="-1"></a>    <span class="co">#First, compute deforestation relative to 2000 for each pixel (deforestation as computed in Wolf et al. 2021)</span></span>
<span id="cb147-1599"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1599" tabindex="-1"></a>    <span class="fu">group_by</span>(assetid) <span class="sc">%&gt;%</span></span>
<span id="cb147-1600"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1600" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">FL_2000_cum =</span> (fc_ha<span class="sc">-</span>fc_ha[year <span class="sc">==</span> <span class="dv">2000</span>])<span class="sc">/</span>fc_ha[year <span class="sc">==</span> <span class="dv">2000</span>]<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-1601"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1601" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-1602"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1602" tabindex="-1"></a>    <span class="co">#Then compute the average forest cover and deforestation in each year, for treated and control groups</span></span>
<span id="cb147-1603"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1603" tabindex="-1"></a>    <span class="co">#Standard deviation and 95% confidence interval is also computed for each variable</span></span>
<span id="cb147-1604"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1604" tabindex="-1"></a>    <span class="fu">group_by</span>(group, year) <span class="sc">%&gt;%</span></span>
<span id="cb147-1605"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1605" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb147-1606"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1606" tabindex="-1"></a>              <span class="at">avgFC =</span> <span class="fu">mean</span>(fc_ha, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="co">#Compute average forest cover in a pixel, its sd and ci</span></span>
<span id="cb147-1607"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1607" tabindex="-1"></a>              <span class="at">sdFC =</span> <span class="fu">sd</span>(fc_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb147-1608"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1608" tabindex="-1"></a>              <span class="at">ciFC_low =</span> avgFC <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1609"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1609" tabindex="-1"></a>              <span class="at">ciFC_up =</span> avgFC <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1610"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1610" tabindex="-1"></a>              <span class="at">avgFC_tot =</span> n_pix_pa<span class="sc">*</span><span class="fu">mean</span>(fc_ha, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="co">#Compute total average forest cover, sd and CI</span></span>
<span id="cb147-1611"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1611" tabindex="-1"></a>              <span class="at">sdFC_tot =</span> n_pix_pa<span class="sc">*</span>sdFC,</span>
<span id="cb147-1612"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1612" tabindex="-1"></a>              <span class="at">ciFC_tot_low =</span> avgFC_tot <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC_tot<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1613"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1613" tabindex="-1"></a>              <span class="at">ciFC_tot_up =</span> avgFC_tot <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC_tot<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1614"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1614" tabindex="-1"></a>              <span class="at">avgFL_2000_cum =</span> <span class="fu">mean</span>(FL_2000_cum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#Compute average forest loss relative to 2000 (Wolf et al 2021), sd and CI</span></span>
<span id="cb147-1615"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1615" tabindex="-1"></a>              <span class="at">sdFL_2000_cum =</span> <span class="fu">sd</span>(FL_2000_cum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb147-1616"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1616" tabindex="-1"></a>              <span class="at">ciFL_low =</span> avgFL_2000_cum <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFL_2000_cum<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1617"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1617" tabindex="-1"></a>              <span class="at">ciFL_up =</span> avgFL_2000_cum <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFL_2000_cum<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1618"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1618" tabindex="-1"></a>              <span class="at">matched =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-1619"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1619" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-1620"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1620" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() }</span>
<span id="cb147-1621"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1621" tabindex="-1"></a>  </span>
<span id="cb147-1622"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1622" tabindex="-1"></a>  <span class="do">##Unmatched</span></span>
<span id="cb147-1623"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1623" tabindex="-1"></a>  df.unmatched.trend  <span class="sc">%&lt;-%</span> {unmatched.long <span class="sc">%&gt;%</span></span>
<span id="cb147-1624"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1624" tabindex="-1"></a>      <span class="co">#First, compute deforestation relative to 2000 for each pixel (deforestation as computed in Wolf et al. 2021); compute percentage of forest cover in the pixel in 2000</span></span>
<span id="cb147-1625"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1625" tabindex="-1"></a>      <span class="fu">group_by</span>(assetid) <span class="sc">%&gt;%</span></span>
<span id="cb147-1626"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1626" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">FL_2000_cum =</span> (fc_ha<span class="sc">-</span>fc_ha[year <span class="sc">==</span> <span class="dv">2000</span>])<span class="sc">/</span>fc_ha[year <span class="sc">==</span> <span class="dv">2000</span>]<span class="sc">*</span><span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-1627"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1627" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> <span class="co">#Compute average percentage of FC in a pixel in 2000, for each group. Compute also standard deviation</span></span>
<span id="cb147-1628"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1628" tabindex="-1"></a>    <span class="co">#Then compute the average forest cover, average forest cover percentage, and deforestation in each year, for treated and control groups</span></span>
<span id="cb147-1629"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1629" tabindex="-1"></a>    <span class="co">#Standard deviation and 95% confidence interval is also computed for each variable</span></span>
<span id="cb147-1630"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1630" tabindex="-1"></a>    <span class="fu">group_by</span>(group, year) <span class="sc">%&gt;%</span></span>
<span id="cb147-1631"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1631" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">n =</span> <span class="fu">n</span>(),</span>
<span id="cb147-1632"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1632" tabindex="-1"></a>              <span class="at">avgFC =</span> <span class="fu">mean</span>(fc_ha, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="co">#Compute average forest cover in a pixel, its sd and ci</span></span>
<span id="cb147-1633"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1633" tabindex="-1"></a>              <span class="at">sdFC =</span> <span class="fu">sd</span>(fc_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb147-1634"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1634" tabindex="-1"></a>              <span class="at">ciFC_low =</span> avgFC <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1635"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1635" tabindex="-1"></a>              <span class="at">ciFC_up =</span> avgFC <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1636"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1636" tabindex="-1"></a>              <span class="at">avgFC_tot =</span> n_pix_pa<span class="sc">*</span><span class="fu">mean</span>(fc_ha, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="co">#Compute total average forest cover, sd and CI</span></span>
<span id="cb147-1637"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1637" tabindex="-1"></a>              <span class="at">sdFC_tot =</span> n_pix_pa<span class="sc">*</span>sdFC,</span>
<span id="cb147-1638"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1638" tabindex="-1"></a>              <span class="at">ciFC_tot_low =</span> avgFC_tot <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC_tot<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1639"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1639" tabindex="-1"></a>              <span class="at">ciFC_tot_up =</span> avgFC_tot <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFC_tot<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1640"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1640" tabindex="-1"></a>              <span class="at">avgFL_2000_cum =</span> <span class="fu">mean</span>(FL_2000_cum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co">#Compute average forest loss relative to 2000 (Wolf et al 2021), sd and CI</span></span>
<span id="cb147-1641"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1641" tabindex="-1"></a>              <span class="at">sdFL_2000_cum =</span> <span class="fu">sd</span>(FL_2000_cum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb147-1642"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1642" tabindex="-1"></a>              <span class="at">ciFL_low =</span> avgFL_2000_cum <span class="sc">-</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFL_2000_cum<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1643"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1643" tabindex="-1"></a>              <span class="at">ciFL_up =</span> avgFL_2000_cum <span class="sc">+</span> <span class="fu">qt</span>(<span class="fl">0.975</span>,<span class="at">df=</span>n<span class="dv">-1</span>)<span class="sc">*</span>sdFL_2000_cum<span class="sc">/</span><span class="fu">sqrt</span>(n),</span>
<span id="cb147-1644"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1644" tabindex="-1"></a>              <span class="at">matched =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-1645"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1645" tabindex="-1"></a>      <span class="co">#Compute total forest cover loss, knowing area of the PA and average forest cover in 2000 in treated pixels</span></span>
<span id="cb147-1646"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1646" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb147-1647"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1647" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>() }</span>
<span id="cb147-1648"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1648" tabindex="-1"></a>  </span>
<span id="cb147-1649"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1649" tabindex="-1"></a>      })</span>
<span id="cb147-1650"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1650" tabindex="-1"></a>  </span>
<span id="cb147-1651"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1651" tabindex="-1"></a>  df.trend <span class="ot">=</span> <span class="fu">rbind</span>(df.matched.trend, df.unmatched.trend)</span>
<span id="cb147-1652"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1652" tabindex="-1"></a>     </span>
<span id="cb147-1653"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1653" tabindex="-1"></a>  </span>
<span id="cb147-1654"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1654" tabindex="-1"></a>  <span class="co">#Close multisession</span></span>
<span id="cb147-1655"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1655" tabindex="-1"></a>  <span class="fu">plan</span>(sequential)</span>
<span id="cb147-1656"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1656" tabindex="-1"></a>  </span>
<span id="cb147-1657"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1657" tabindex="-1"></a>  <span class="co">#Plot</span></span>
<span id="cb147-1658"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1658" tabindex="-1"></a>  <span class="do">## Change Facet Labels</span></span>
<span id="cb147-1659"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1659" tabindex="-1"></a>  fct.labs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Before Matching&quot;</span>, <span class="st">&quot;After Matching&quot;</span>)</span>
<span id="cb147-1660"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1660" tabindex="-1"></a>  <span class="fu">names</span>(fct.labs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">FALSE</span>, <span class="cn">TRUE</span>)</span>
<span id="cb147-1661"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1661" tabindex="-1"></a>  </span>
<span id="cb147-1662"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1662" tabindex="-1"></a>  <span class="do">## Trend Plot for unmatched data</span></span>
<span id="cb147-1663"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1663" tabindex="-1"></a>  <span class="do">### Average forest cover in a pixel</span></span>
<span id="cb147-1664"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1664" tabindex="-1"></a>  fig_trend_unm_fc_pix <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFC)) <span class="sc">+</span></span>
<span id="cb147-1665"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1665" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1666"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1666" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1667"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1667" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFC_low, <span class="at">ymax =</span> ciFC_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1668"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1668" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1669"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1669" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1670"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1670" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span> </span>
<span id="cb147-1671"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1671" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1672"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1672" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(matched<span class="sc">~</span>., <span class="at">ncol =</span> <span class="dv">2</span>, <span class="co">#scales = &#39;free_x&#39;,</span></span>
<span id="cb147-1673"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1673" tabindex="-1"></a>               <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">matched =</span> fct.labs)) <span class="sc">+</span></span>
<span id="cb147-1674"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1674" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of forest cover in a pixel on average (unmatched units)&quot;</span>,</span>
<span id="cb147-1675"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1675" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1676"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1676" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals.</span><span class="sc">\n</span><span class="st">The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark  =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha and pixels have a resolution of&quot;</span>, res_ha, <span class="st">&quot;ha.&quot;</span>),</span>
<span id="cb147-1677"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1677" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Forest cover (ha)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1678"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1678" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1679"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1679" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1680"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1680" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1681"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1681" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1682"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1682" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1683"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1683" tabindex="-1"></a>      </span>
<span id="cb147-1684"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1684" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1685"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1685" tabindex="-1"></a>      </span>
<span id="cb147-1686"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1686" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1687"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1687" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1688"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1688" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1689"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1689" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1690"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1690" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1691"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1691" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1692"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1692" tabindex="-1"></a>      </span>
<span id="cb147-1693"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1693" tabindex="-1"></a>      </span>
<span id="cb147-1694"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1694" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1695"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1695" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1696"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1696" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1697"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1697" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1698"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1698" tabindex="-1"></a>      </span>
<span id="cb147-1699"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1699" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1700"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1700" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb147-1701"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1701" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1702"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1702" tabindex="-1"></a>  </span>
<span id="cb147-1703"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1703" tabindex="-1"></a>  <span class="do">### Total forest cover</span></span>
<span id="cb147-1704"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1704" tabindex="-1"></a>  fig_trend_unm_fc_tot <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFC_tot)) <span class="sc">+</span></span>
<span id="cb147-1705"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1705" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1706"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1706" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1707"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1707" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFC_tot_low, <span class="at">ymax =</span> ciFC_tot_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1708"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1708" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1709"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1709" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1710"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1710" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb147-1711"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1711" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1712"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1712" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(matched<span class="sc">~</span>., <span class="at">ncol =</span> <span class="dv">2</span>, <span class="co">#scales = &#39;free_x&#39;,</span></span>
<span id="cb147-1713"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1713" tabindex="-1"></a>               <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">matched =</span> fct.labs)) <span class="sc">+</span></span>
<span id="cb147-1714"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1714" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of total forest cover (unmatched units)&quot;</span>,</span>
<span id="cb147-1715"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1715" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1716"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1716" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals. The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha.</span><span class="sc">\n</span><span class="st">Total forest cover is extrapolated from average pixel forest cover, multiplied by the number of pixel in the protected area.&quot;</span>),</span>
<span id="cb147-1717"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1717" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Forest cover (ha)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1718"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1718" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1719"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1719" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1720"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1720" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1721"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1721" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1722"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1722" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1723"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1723" tabindex="-1"></a>      </span>
<span id="cb147-1724"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1724" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1725"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1725" tabindex="-1"></a>      </span>
<span id="cb147-1726"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1726" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1727"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1727" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1728"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1728" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1729"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1729" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1730"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1730" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1731"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1731" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1732"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1732" tabindex="-1"></a>      </span>
<span id="cb147-1733"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1733" tabindex="-1"></a>      </span>
<span id="cb147-1734"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1734" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1735"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1735" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1736"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1736" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1737"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1737" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1738"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1738" tabindex="-1"></a>      </span>
<span id="cb147-1739"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1739" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1740"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1740" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-1741"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1741" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1742"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1742" tabindex="-1"></a>  </span>
<span id="cb147-1743"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1743" tabindex="-1"></a>  <span class="do">### Cumulative deforestation relative to 2000</span></span>
<span id="cb147-1744"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1744" tabindex="-1"></a>  fig_trend_unm_defo <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFL_2000_cum)) <span class="sc">+</span></span>
<span id="cb147-1745"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1745" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1746"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1746" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1747"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1747" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFL_low, <span class="at">ymax =</span> ciFL_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1748"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1748" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1749"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1749" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1750"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1750" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb147-1751"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1751" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1752"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1752" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(matched<span class="sc">~</span>., <span class="at">ncol =</span> <span class="dv">2</span>, <span class="co">#scales = &#39;free_x&#39;,</span></span>
<span id="cb147-1753"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1753" tabindex="-1"></a>               <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">matched =</span> fct.labs)) <span class="sc">+</span></span>
<span id="cb147-1754"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1754" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Cumulated deforestation relative to 2000 (unmatched units)&quot;</span>,</span>
<span id="cb147-1755"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1755" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1756"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1756" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals. The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha.&quot;</span>),</span>
<span id="cb147-1757"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1757" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Forest loss relative to 2000 (%)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1758"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1758" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1759"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1759" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1760"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1760" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1761"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1761" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1762"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1762" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1763"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1763" tabindex="-1"></a>      </span>
<span id="cb147-1764"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1764" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1765"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1765" tabindex="-1"></a>      </span>
<span id="cb147-1766"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1766" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1767"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1767" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1768"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1768" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1769"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1769" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1770"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1770" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1771"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1771" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1772"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1772" tabindex="-1"></a>      </span>
<span id="cb147-1773"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1773" tabindex="-1"></a>      </span>
<span id="cb147-1774"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1774" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1775"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1775" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1776"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1776" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1777"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1777" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1778"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1778" tabindex="-1"></a>      </span>
<span id="cb147-1779"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1779" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1780"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1780" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-1781"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1781" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1782"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1782" tabindex="-1"></a>  </span>
<span id="cb147-1783"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1783" tabindex="-1"></a>  </span>
<span id="cb147-1784"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1784" tabindex="-1"></a>  <span class="co"># Trend Plot for matched data</span></span>
<span id="cb147-1785"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1785" tabindex="-1"></a>  <span class="do">### Average forest cover in a pixel</span></span>
<span id="cb147-1786"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1786" tabindex="-1"></a>  fig_trend_m_fc_pix <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.matched.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFC)) <span class="sc">+</span></span>
<span id="cb147-1787"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1787" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1788"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1788" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1789"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1789" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFC_low, <span class="at">ymax =</span> ciFC_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1790"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1790" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1791"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1791" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1792"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1792" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span> </span>
<span id="cb147-1793"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1793" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1794"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1794" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of forest cover in a pixel on average (matched units)&quot;</span>,</span>
<span id="cb147-1795"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1795" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1796"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1796" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals.</span><span class="sc">\n</span><span class="st">The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark  =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha and pixels have a resolution of&quot;</span>, res_ha, <span class="st">&quot;ha.&quot;</span>),</span>
<span id="cb147-1797"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1797" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Forest cover (ha)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1798"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1798" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1799"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1799" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1800"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1800" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1801"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1801" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1802"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1802" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1803"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1803" tabindex="-1"></a>      </span>
<span id="cb147-1804"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1804" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1805"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1805" tabindex="-1"></a>      </span>
<span id="cb147-1806"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1806" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1807"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1807" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1808"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1808" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1809"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1809" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1810"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1810" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1811"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1811" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1812"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1812" tabindex="-1"></a>      </span>
<span id="cb147-1813"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1813" tabindex="-1"></a>      </span>
<span id="cb147-1814"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1814" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1815"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1815" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1816"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1816" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1817"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1817" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1818"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1818" tabindex="-1"></a>      </span>
<span id="cb147-1819"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1819" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1820"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1820" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-1821"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1821" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1822"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1822" tabindex="-1"></a>  </span>
<span id="cb147-1823"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1823" tabindex="-1"></a>  <span class="do">### Total forest cover</span></span>
<span id="cb147-1824"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1824" tabindex="-1"></a>  fig_trend_m_fc_tot <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.matched.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFC_tot)) <span class="sc">+</span></span>
<span id="cb147-1825"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1825" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1826"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1826" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1827"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1827" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFC_tot_low, <span class="at">ymax =</span> ciFC_tot_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1828"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1828" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1829"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1829" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1830"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1830" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb147-1831"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1831" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1832"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1832" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Evolution of total forest cover (matched units)&quot;</span>,</span>
<span id="cb147-1833"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1833" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1834"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1834" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals. The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha.</span><span class="sc">\n</span><span class="st">Total forest cover is extrapolated from average pixel forest cover, multiplied by the number of pixel in the protected area.&quot;</span>),</span>
<span id="cb147-1835"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1835" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Total forest cover (ha)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1836"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1836" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1837"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1837" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1838"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1838" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1839"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1839" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1840"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1840" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1841"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1841" tabindex="-1"></a>      </span>
<span id="cb147-1842"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1842" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1843"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1843" tabindex="-1"></a>      </span>
<span id="cb147-1844"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1844" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1845"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1845" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1846"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1846" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1847"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1847" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1848"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1848" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1849"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1849" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1850"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1850" tabindex="-1"></a>      </span>
<span id="cb147-1851"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1851" tabindex="-1"></a>      </span>
<span id="cb147-1852"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1852" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1853"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1853" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1854"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1854" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1855"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1855" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1856"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1856" tabindex="-1"></a>      </span>
<span id="cb147-1857"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1857" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1858"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1858" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-1859"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1859" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1860"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1860" tabindex="-1"></a>  </span>
<span id="cb147-1861"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1861" tabindex="-1"></a>  <span class="do">### Cumulative deforestation relative to 2000</span></span>
<span id="cb147-1862"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1862" tabindex="-1"></a>  fig_trend_m_defo <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="at">data =</span> df.matched.trend, <span class="fu">aes</span>(<span class="at">x =</span> year, <span class="at">y =</span> avgFL_2000_cum)) <span class="sc">+</span></span>
<span id="cb147-1863"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1863" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> group, <span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1864"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1864" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.character</span>(group))) <span class="sc">+</span></span>
<span id="cb147-1865"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1865" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> ciFL_low, <span class="at">ymax =</span> ciFL_up, <span class="at">group =</span> group, <span class="at">fill =</span> <span class="fu">as.character</span>(group)), <span class="at">alpha =</span> .<span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb147-1866"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1866" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(treatment.year), <span class="at">size=</span><span class="st">&quot;Treatment year&quot;</span>), <span class="at">linetype=</span><span class="dv">1</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;orange&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1867"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1867" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept=</span><span class="fu">as.character</span>(funding.years), <span class="at">size=</span><span class="st">&quot;Funding year&quot;</span>), <span class="at">linetype=</span><span class="dv">2</span>, <span class="at">linewidth=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;grey30&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1868"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1868" tabindex="-1"></a>    <span class="fu">scale_x_discrete</span>(<span class="at">breaks=</span><span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>), <span class="at">labels=</span><span class="fu">paste</span>(<span class="fu">seq</span>(<span class="dv">2000</span>,<span class="dv">2020</span>,<span class="dv">5</span>))) <span class="sc">+</span></span>
<span id="cb147-1869"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1869" tabindex="-1"></a>    <span class="fu">scale_color_hue</span>(<span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Control&quot;</span>, <span class="st">&quot;Treatment&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-1870"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1870" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Cumulated deforestation relative to 2000 (matched units)&quot;</span>,</span>
<span id="cb147-1871"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1871" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">&quot;Protected area in &quot;</span>, country.name, <span class="st">&quot;, WDPAID &quot;</span>, wdpaid),</span>
<span id="cb147-1872"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1872" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">&quot;Ribbons represent 95% confidence intervals. The protected area has a surface of&quot;</span>, <span class="fu">format</span>(area_ha, <span class="at">big.mark =</span> <span class="st">&quot;,&quot;</span>), <span class="st">&quot;ha.&quot;</span>),</span>
<span id="cb147-1873"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1873" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Year&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Forest loss relative to 2000 (%)&quot;</span>, <span class="at">color =</span> <span class="st">&quot;Group&quot;</span>) <span class="sc">+</span></span>
<span id="cb147-1874"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1874" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb147-1875"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1875" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb147-1876"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1876" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="sc">-</span><span class="dv">20</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb147-1877"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1877" tabindex="-1"></a>      <span class="at">axis.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>),</span>
<span id="cb147-1878"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1878" tabindex="-1"></a>      <span class="at">axis.title=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1879"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1879" tabindex="-1"></a>      </span>
<span id="cb147-1880"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1880" tabindex="-1"></a>      <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>),</span>
<span id="cb147-1881"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1881" tabindex="-1"></a>      </span>
<span id="cb147-1882"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1882" tabindex="-1"></a>      <span class="co">#legend.position = &quot;bottom&quot;,</span></span>
<span id="cb147-1883"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1883" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb147-1884"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1884" tabindex="-1"></a>      <span class="at">legend.text=</span><span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">14</span>),</span>
<span id="cb147-1885"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1885" tabindex="-1"></a>      <span class="co">#legend.spacing.x = unit(1.0, &#39;cm&#39;),</span></span>
<span id="cb147-1886"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1886" tabindex="-1"></a>      <span class="at">legend.spacing.y =</span> <span class="fu">unit</span>(<span class="fl">0.75</span>, <span class="st">&#39;cm&#39;</span>),</span>
<span id="cb147-1887"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1887" tabindex="-1"></a>      <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">2</span>, <span class="st">&#39;line&#39;</span>),</span>
<span id="cb147-1888"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1888" tabindex="-1"></a>      </span>
<span id="cb147-1889"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1889" tabindex="-1"></a>      </span>
<span id="cb147-1890"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1890" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1891"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1891" tabindex="-1"></a>      <span class="at">panel.grid.minor.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1892"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1892" tabindex="-1"></a>      <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="dv">1</span>),</span>
<span id="cb147-1893"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1893" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">&#39;grey&#39;</span>, <span class="at">linewidth =</span> <span class="fl">0.2</span>, <span class="at">linetype =</span> <span class="dv">2</span>),</span>
<span id="cb147-1894"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1894" tabindex="-1"></a>      </span>
<span id="cb147-1895"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1895" tabindex="-1"></a>      <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>) <span class="co"># Facet Label</span></span>
<span id="cb147-1896"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1896" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb147-1897"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1897" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">size =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;grey30&quot;</span>, <span class="st">&quot;orange&quot;</span>)))) <span class="co"># Add legend for geom_vline</span></span>
<span id="cb147-1898"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1898" tabindex="-1"></a>  </span>
<span id="cb147-1899"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1899" tabindex="-1"></a>  <span class="do">##Saving plots</span></span>
<span id="cb147-1900"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1900" tabindex="-1"></a>  tmp <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;fig&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb147-1901"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1901" tabindex="-1"></a>  </span>
<span id="cb147-1902"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1902" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_unmatched_avgFC_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1903"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1903" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_unm_fc_pix,</span>
<span id="cb147-1904"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1904" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1905"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1905" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1906"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1906" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_matched_avgFC_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1907"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1907" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_m_fc_pix,</span>
<span id="cb147-1908"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1908" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1909"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1909" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1910"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1910" tabindex="-1"></a>  </span>
<span id="cb147-1911"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1911" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_unmatched_avgFC_tot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1912"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1912" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_unm_fc_tot,</span>
<span id="cb147-1913"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1913" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1914"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1914" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1915"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1915" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_matched_avgFC_tot_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1916"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1916" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_m_fc_tot,</span>
<span id="cb147-1917"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1917" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1918"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1918" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1919"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1919" tabindex="-1"></a>  </span>
<span id="cb147-1920"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1920" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_unmatched_avgFL_cum_2000_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1921"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1921" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_unm_defo,</span>
<span id="cb147-1922"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1922" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1923"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1923" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1924"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1924" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(tmp, <span class="fu">paste0</span>(<span class="st">&quot;fig_trend_matched_avgFL_cum_2000_&quot;</span>, iso, <span class="st">&quot;_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1925"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1925" tabindex="-1"></a>         <span class="at">plot =</span> fig_trend_m_defo,</span>
<span id="cb147-1926"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1926" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-1927"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1927" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-1928"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1928" tabindex="-1"></a>  </span>
<span id="cb147-1929"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1929" tabindex="-1"></a>  files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1930"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1930" tabindex="-1"></a>  <span class="do">##Add each file in the bucket (same foler for every file in the temp)</span></span>
<span id="cb147-1931"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1931" tabindex="-1"></a>  <span class="cf">for</span>(f <span class="cf">in</span> files) </span>
<span id="cb147-1932"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1932" tabindex="-1"></a>  {</span>
<span id="cb147-1933"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1933" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Uploading file&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;&#39;&quot;</span>, f, <span class="st">&quot;&#39;&quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb147-1934"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1934" tabindex="-1"></a>    aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> f, </span>
<span id="cb147-1935"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1935" tabindex="-1"></a>                       <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, wdpaid, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-1936"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1936" tabindex="-1"></a>                       <span class="at">region =</span> <span class="st">&quot;&quot;</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1937"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1937" tabindex="-1"></a>  }</span>
<span id="cb147-1938"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1938" tabindex="-1"></a>  <span class="fu">do.call</span>(file.remove, <span class="fu">list</span>(<span class="fu">list.files</span>(tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb147-1939"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1939" tabindex="-1"></a>  </span>
<span id="cb147-1940"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1940" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-1941"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1941" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">&quot;#Plot matched and unmatched trends</span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1942"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1942" tabindex="-1"></a>  </span>
<span id="cb147-1943"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1943" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-1944"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1944" tabindex="-1"></a>  </span>
<span id="cb147-1945"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1945" tabindex="-1"></a>    },</span>
<span id="cb147-1946"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1946" tabindex="-1"></a>  </span>
<span id="cb147-1947"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1947" tabindex="-1"></a>  <span class="at">error=</span><span class="cf">function</span>(e)</span>
<span id="cb147-1948"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1948" tabindex="-1"></a>  {</span>
<span id="cb147-1949"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1949" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-1950"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1950" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Plot matched and unmatched trends</span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-1951"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1951" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-1952"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1952" tabindex="-1"></a>  }</span>
<span id="cb147-1953"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1953" tabindex="-1"></a>  </span>
<span id="cb147-1954"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1954" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-1955"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1955" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-1956"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1956" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-1957"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1957" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-1958"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1958" tabindex="-1"></a>  <span class="co">#   #Append the log </span></span>
<span id="cb147-1959"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1959" tabindex="-1"></a>  <span class="co">#   cat(paste(&quot;#Plot matched and unmatched trends\n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-1960"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1960" tabindex="-1"></a>  <span class="co">#   #Return string to inform user to skip</span></span>
<span id="cb147-1961"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1961" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-1962"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1962" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-1963"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1963" tabindex="-1"></a>  </span>
<span id="cb147-1964"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1964" tabindex="-1"></a>  )</span>
<span id="cb147-1965"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1965" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-1966"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1966" tabindex="-1"></a>  </span>
<span id="cb147-1967"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1967" tabindex="-1"></a>}</span>
<span id="cb147-1968"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1968" tabindex="-1"></a></span>
<span id="cb147-1969"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1969" tabindex="-1"></a></span>
<span id="cb147-1970"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1970" tabindex="-1"></a><span class="co"># Plot the country grid with matched control and treated, for a given protected area (PA) or all protected areas in a country</span></span>
<span id="cb147-1971"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1971" tabindex="-1"></a><span class="do">##INPUTS</span></span>
<span id="cb147-1972"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1972" tabindex="-1"></a><span class="do">### iso : the ISO3 code of the country considered</span></span>
<span id="cb147-1973"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1973" tabindex="-1"></a><span class="do">### wdpaid : the WDPA ID of the PA considered</span></span>
<span id="cb147-1974"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1974" tabindex="-1"></a><span class="do">### is_pa : logical, whether the plotted grid is for a unique PA or all the PAs in the country considered</span></span>
<span id="cb147-1975"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1975" tabindex="-1"></a><span class="do">### df_pix_matched : dataframe with ID of matched pixels (ID from mapme.biodiversity portfolio)</span></span>
<span id="cb147-1976"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1976" tabindex="-1"></a><span class="do">### path_tmp : temporary folder to store figures</span></span>
<span id="cb147-1977"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1977" tabindex="-1"></a><span class="do">### log : a log file to track progress of the processing</span></span>
<span id="cb147-1978"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1978" tabindex="-1"></a><span class="do">### save_dir : saving directory</span></span>
<span id="cb147-1979"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1979" tabindex="-1"></a><span class="do">##OUTPUTS</span></span>
<span id="cb147-1980"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1980" tabindex="-1"></a><span class="do">### is_ok : a boolean indicating whether or not an error occured inside the function</span></span>
<span id="cb147-1981"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1981" tabindex="-1"></a><span class="do">##DATA SAVED</span></span>
<span id="cb147-1982"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1982" tabindex="-1"></a><span class="do">### Country grid with matched control and treated, for a given protected area (PA) or all protected areas in a country</span></span>
<span id="cb147-1983"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1983" tabindex="-1"></a>fn_post_plot_grid <span class="ot">=</span> <span class="cf">function</span>(iso, wdpaid, is_pa, df_pix_matched, path_tmp, log, save_dir)</span>
<span id="cb147-1984"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1984" tabindex="-1"></a>{</span>
<span id="cb147-1985"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1985" tabindex="-1"></a>  </span>
<span id="cb147-1986"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1986" tabindex="-1"></a>  output <span class="ot">=</span> <span class="fu">tryCatch</span>(</span>
<span id="cb147-1987"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1987" tabindex="-1"></a>    </span>
<span id="cb147-1988"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1988" tabindex="-1"></a>    {</span>
<span id="cb147-1989"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1989" tabindex="-1"></a>      </span>
<span id="cb147-1990"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1990" tabindex="-1"></a>  <span class="co">#Import dataframe where each pixel in the grid has both its grid ID and asset ID from the portfolio creation</span></span>
<span id="cb147-1991"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1991" tabindex="-1"></a>  df_gridID_assetID <span class="ot">=</span> <span class="fu">s3read_using</span>(data.table<span class="sc">::</span>fread,</span>
<span id="cb147-1992"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1992" tabindex="-1"></a>                                   <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;df_gridID_assetID_&quot;</span>, iso, <span class="st">&quot;.csv&quot;</span>)),</span>
<span id="cb147-1993"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1993" tabindex="-1"></a>                                   <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-1994"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1994" tabindex="-1"></a>                                   <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb147-1995"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1995" tabindex="-1"></a>  </span>
<span id="cb147-1996"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1996" tabindex="-1"></a>  <span class="co">#Importing the gridding of the country (funded and analyzed PAs, funded not analyzed PAs, non-funded PAs, buffer, control)</span></span>
<span id="cb147-1997"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1997" tabindex="-1"></a>  <span class="co">#Merge with a dataframe so that each pixel in the grid has both its grid ID and asset ID from the portfolio creation</span></span>
<span id="cb147-1998"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1998" tabindex="-1"></a>  <span class="co">#Merge with matched pixels dataframe</span></span>
<span id="cb147-1999"><a href="functions-for-matching-pre--and-post-processing.html#cb147-1999" tabindex="-1"></a>  grid <span class="ot">=</span>  <span class="fu">s3read_using</span>(sf<span class="sc">::</span>read_sf,</span>
<span id="cb147-2000"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2000" tabindex="-1"></a>                       <span class="at">object =</span> <span class="fu">paste0</span>(save_dir, <span class="st">&quot;/&quot;</span>, iso, <span class="st">&quot;/&quot;</span>, <span class="fu">paste0</span>(<span class="st">&quot;grid_param_&quot;</span>, iso, <span class="st">&quot;.gpkg&quot;</span>)),</span>
<span id="cb147-2001"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2001" tabindex="-1"></a>                       <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb147-2002"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2002" tabindex="-1"></a>                       <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb147-2003"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2003" tabindex="-1"></a>    <span class="fu">left_join</span>(df_gridID_assetID, <span class="at">by =</span> <span class="st">&quot;gridID&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-2004"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2004" tabindex="-1"></a>    <span class="fu">left_join</span>(df_pix_matched, <span class="at">by =</span> <span class="st">&quot;assetid&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb147-2005"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2005" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">group_plot =</span> <span class="fu">case_when</span>(group_matched <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">&quot;Control (matched)&quot;</span>,</span>
<span id="cb147-2006"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2006" tabindex="-1"></a>                                  group_matched <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">&quot;Treatment (matched)&quot;</span>,</span>
<span id="cb147-2007"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2007" tabindex="-1"></a>                                  <span class="cn">TRUE</span> <span class="sc">~</span> group_name))</span>
<span id="cb147-2008"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2008" tabindex="-1"></a>  </span>
<span id="cb147-2009"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2009" tabindex="-1"></a>  <span class="co">#Extract country name</span></span>
<span id="cb147-2010"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2010" tabindex="-1"></a>  country.name <span class="ot">=</span> grid <span class="sc">%&gt;%</span> </span>
<span id="cb147-2011"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2011" tabindex="-1"></a>    <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb147-2012"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2012" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb147-2013"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2013" tabindex="-1"></a>  country.name <span class="ot">=</span> country.name<span class="sc">$</span>country_en</span>
<span id="cb147-2014"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2014" tabindex="-1"></a>  </span>
<span id="cb147-2015"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2015" tabindex="-1"></a>  <span class="co"># Visualize and save grouped grid cells</span></span>
<span id="cb147-2016"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2016" tabindex="-1"></a>  fig_grid <span class="ot">=</span> </span>
<span id="cb147-2017"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2017" tabindex="-1"></a>    <span class="fu">ggplot</span>(grid) <span class="sc">+</span></span>
<span id="cb147-2018"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2018" tabindex="-1"></a>    <span class="co">#The original gridding as a first layer</span></span>
<span id="cb147-2019"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2019" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="fu">aes</span>(<span class="at">fill =</span> <span class="fu">as.factor</span>(group_plot)), <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb147-2020"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2020" tabindex="-1"></a>    <span class="fu">scale_fill_brewer</span>(<span class="at">name =</span> <span class="st">&quot;Group&quot;</span>, <span class="at">type =</span> <span class="st">&quot;qual&quot;</span>, <span class="at">palette =</span> <span class="st">&quot;BrBG&quot;</span>, <span class="at">direction =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb147-2021"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2021" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">&quot;Gridding of&quot;</span>, country.name, <span class="st">&quot;: matched units&quot;</span>),</span>
<span id="cb147-2022"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2022" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="fu">ifelse</span>(is_pa <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-2023"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2023" tabindex="-1"></a>                            <span class="at">yes =</span> <span class="fu">paste</span>(<span class="st">&quot;Focus on WDPAID&quot;</span>, wdpaid),</span>
<span id="cb147-2024"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2024" tabindex="-1"></a>                            <span class="at">no =</span> <span class="st">&quot;All protected areas analyzed&quot;</span>)) <span class="sc">+</span></span>
<span id="cb147-2025"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2025" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb147-2026"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2026" tabindex="-1"></a>  </span>
<span id="cb147-2027"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2027" tabindex="-1"></a>  fig_save <span class="ot">=</span> <span class="fu">ifelse</span>(is_pa <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-2028"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2028" tabindex="-1"></a>                    <span class="at">yes =</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/fig_grid_group_&quot;</span>, iso, <span class="st">&quot;_matched_&quot;</span>, wdpaid, <span class="st">&quot;.png&quot;</span>),</span>
<span id="cb147-2029"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2029" tabindex="-1"></a>                    <span class="at">no =</span> <span class="fu">paste0</span>(path_tmp, <span class="st">&quot;/fig_grid_group_&quot;</span>, iso, <span class="st">&quot;_matched_all&quot;</span>, <span class="st">&quot;.png&quot;</span>))</span>
<span id="cb147-2030"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2030" tabindex="-1"></a>  <span class="fu">ggsave</span>(fig_save,</span>
<span id="cb147-2031"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2031" tabindex="-1"></a>         <span class="at">plot =</span> fig_grid,</span>
<span id="cb147-2032"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2032" tabindex="-1"></a>         <span class="at">device =</span> <span class="st">&quot;png&quot;</span>,</span>
<span id="cb147-2033"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2033" tabindex="-1"></a>         <span class="at">height =</span> <span class="dv">6</span>, <span class="at">width =</span> <span class="dv">9</span>)</span>
<span id="cb147-2034"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2034" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> fig_save, </span>
<span id="cb147-2035"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2035" tabindex="-1"></a>                     <span class="at">bucket =</span> <span class="fu">ifelse</span>(is_pa <span class="sc">==</span> <span class="cn">TRUE</span>,</span>
<span id="cb147-2036"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2036" tabindex="-1"></a>                                     <span class="at">yes =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, wdpaid, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb147-2037"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2037" tabindex="-1"></a>                                     <span class="at">no =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, iso, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)),</span>
<span id="cb147-2038"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2038" tabindex="-1"></a>                     <span class="at">region =</span> <span class="st">&quot;&quot;</span>, </span>
<span id="cb147-2039"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2039" tabindex="-1"></a>                     <span class="at">show_progress =</span> <span class="cn">FALSE</span>)</span>
<span id="cb147-2040"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2040" tabindex="-1"></a>  </span>
<span id="cb147-2041"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2041" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb147-2042"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2042" tabindex="-1"></a>  <span class="cf">if</span>(is_pa <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2043"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2043" tabindex="-1"></a>  {</span>
<span id="cb147-2044"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2044" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;#Plot the grid with matched control and treated for the PA </span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2045"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2045" tabindex="-1"></a>  } <span class="cf">else</span> <span class="fu">cat</span>(<span class="st">&quot;#Plot the grid with matched control and treated for all PAs in the country </span><span class="sc">\n</span><span class="st">-&gt; OK</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2046"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2046" tabindex="-1"></a></span>
<span id="cb147-2047"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2047" tabindex="-1"></a>  </span>
<span id="cb147-2048"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2048" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">TRUE</span>))</span>
<span id="cb147-2049"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2049" tabindex="-1"></a>  </span>
<span id="cb147-2050"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2050" tabindex="-1"></a>    },</span>
<span id="cb147-2051"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2051" tabindex="-1"></a>  </span>
<span id="cb147-2052"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2052" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e)</span>
<span id="cb147-2053"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2053" tabindex="-1"></a>  {</span>
<span id="cb147-2054"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2054" tabindex="-1"></a>    <span class="fu">print</span>(e)</span>
<span id="cb147-2055"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2055" tabindex="-1"></a>    <span class="cf">if</span>(is_pa <span class="sc">==</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2056"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2056" tabindex="-1"></a>    {</span>
<span id="cb147-2057"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2057" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Plot the grid with matched control and treated for the PA </span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2058"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2058" tabindex="-1"></a>    } <span class="cf">else</span> <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#Plot the grid with matched control and treated for all the PAs in the country </span><span class="sc">\n</span><span class="st">-&gt; Error :</span><span class="sc">\n</span><span class="st">&quot;</span>, e, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb147-2059"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2059" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">list</span>(<span class="st">&quot;is_ok&quot;</span> <span class="ot">=</span> <span class="cn">FALSE</span>))</span>
<span id="cb147-2060"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2060" tabindex="-1"></a>  }</span>
<span id="cb147-2061"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2061" tabindex="-1"></a>  </span>
<span id="cb147-2062"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2062" tabindex="-1"></a>  <span class="co"># warning = function(w)</span></span>
<span id="cb147-2063"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2063" tabindex="-1"></a>  <span class="co"># {</span></span>
<span id="cb147-2064"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2064" tabindex="-1"></a>  <span class="co">#   #Print the warning and append the log</span></span>
<span id="cb147-2065"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2065" tabindex="-1"></a>  <span class="co">#   print(w)</span></span>
<span id="cb147-2066"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2066" tabindex="-1"></a>  <span class="co">#   if(is_pa == TRUE)</span></span>
<span id="cb147-2067"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2067" tabindex="-1"></a>  <span class="co">#   {</span></span>
<span id="cb147-2068"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2068" tabindex="-1"></a>  <span class="co">#     cat(paste(&quot;#Plot the grid with matched control and treated for the PA \n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-2069"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2069" tabindex="-1"></a>  <span class="co">#   } else cat(paste(&quot;#Plot the grid with matched control and treated for all the PAs in the country \n-&gt; Warning :\n&quot;, w, &quot;\n&quot;), file = log, append = TRUE)</span></span>
<span id="cb147-2070"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2070" tabindex="-1"></a>  <span class="co">#   return(list(&quot;is_ok&quot; = TRUE))</span></span>
<span id="cb147-2071"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2071" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb147-2072"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2072" tabindex="-1"></a>  </span>
<span id="cb147-2073"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2073" tabindex="-1"></a>  )</span>
<span id="cb147-2074"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2074" tabindex="-1"></a>  </span>
<span id="cb147-2075"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2075" tabindex="-1"></a>  <span class="fu">return</span>(output)</span>
<span id="cb147-2076"><a href="functions-for-matching-pre--and-post-processing.html#cb147-2076" tabindex="-1"></a>}</span></code></pre></div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="references.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="functions-for-difference-in-difference-computations.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vuillota/EVA-impact-aires-protegees/edit/main/appendix.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/vuillota/EVA-impact-aires-protegees/raw/main/appendix.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"code_folding": "hide"
});
});
</script>

</body>

</html>
