<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Section 4 Matching | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Section 4 Matching | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  <meta name="github-repo" content="vuillota/EVA-impact-aires-protegees.git" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Section 4 Matching | Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Antoine Vuillot" />
<meta name="author" content="Ingrid Dallmann" />
<meta name="author" content="Léa Poulin" />
<meta name="author" content="Pierre-Yves Durand" />


<meta name="date" content="2023-11-24" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="miscellaneous-statistics.html"/>
<link rel="next" href="difference-in-difference.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Impact analysis of protected areas funded by the AFD</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this website</a></li>
<li class="chapter" data-level="1" data-path="building-the-datasets.html"><a href="building-the-datasets.html"><i class="fa fa-check"></i><b>1</b> Building the datasets</a>
<ul>
<li class="chapter" data-level="1.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#initial-settings"><i class="fa fa-check"></i><b>1.1</b> Initial settings</a></li>
<li class="chapter" data-level="1.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-analysis"><i class="fa fa-check"></i><b>1.2</b> Datasets for analysis</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-pas-reporting-by-afd-technical-departments"><i class="fa fa-check"></i><b>1.2.1</b> Merge PAs reporting by AFD technical departments</a></li>
<li class="chapter" data-level="1.2.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#merge-the-list-of-pas-to-afd-project-information-and-wdpa"><i class="fa fa-check"></i><b>1.2.2</b> Merge the list of PAs to AFD project information and WDPA</a></li>
<li class="chapter" data-level="1.2.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#correct-errors"><i class="fa fa-check"></i><b>1.2.3</b> Correct errors</a></li>
<li class="chapter" data-level="1.2.4" data-path="building-the-datasets.html"><a href="building-the-datasets.html#tidy-the-datasets"><i class="fa fa-check"></i><b>1.2.4</b> Tidy the datasets</a></li>
<li class="chapter" data-level="1.2.5" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-with-only-afd-project-variables"><i class="fa fa-check"></i><b>1.2.5</b> Dataset with only AFD project variables</a></li>
<li class="chapter" data-level="1.2.6" data-path="building-the-datasets.html"><a href="building-the-datasets.html#dataset-for-non-confidential-analysis"><i class="fa fa-check"></i><b>1.2.6</b> Dataset for non-confidential analysis</a></li>
<li class="chapter" data-level="1.2.7" data-path="building-the-datasets.html"><a href="building-the-datasets.html#datasets-for-confidential-analysis"><i class="fa fa-check"></i><b>1.2.7</b> Datasets for confidential analysis</a></li>
<li class="chapter" data-level="1.2.8" data-path="building-the-datasets.html"><a href="building-the-datasets.html#a-polygon-dataset-for-specific-use"><i class="fa fa-check"></i><b>1.2.8</b> A polygon dataset for specific use</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-covered-by-pas-in-the-sample"><i class="fa fa-check"></i><b>1.3</b> Computing total areas covered by PAs in the sample</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computations-of-polygons-area"><i class="fa fa-check"></i><b>1.3.1</b> Computations of polygons’ area</a></li>
<li class="chapter" data-level="1.3.2" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-the-intersection-at-country-region-world-level"><i class="fa fa-check"></i><b>1.3.2</b> Computing the intersection at country, region, world level</a></li>
<li class="chapter" data-level="1.3.3" data-path="building-the-datasets.html"><a href="building-the-datasets.html#computing-total-areas-without-intersection"><i class="fa fa-check"></i><b>1.3.3</b> Computing total areas without intersection</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>Descriptive statistics</b></span></li>
<li class="chapter" data-level="2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html"><i class="fa fa-check"></i><b>2</b> Projects funded by the AFD</a>
<ul>
<li class="chapter" data-level="2.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#initial-settings-1"><i class="fa fa-check"></i><b>2.1</b> Initial settings</a></li>
<li class="chapter" data-level="2.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#importing-the-datasets"><i class="fa fa-check"></i><b>2.2</b> Importing the datasets</a></li>
<li class="chapter" data-level="2.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#performing-descriptive-statistics"><i class="fa fa-check"></i><b>2.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#iucn-categories"><i class="fa fa-check"></i><b>2.3.1</b> IUCN categories</a></li>
<li class="chapter" data-level="2.3.2" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#ecosystems-excluding-non-referenced-pas"><i class="fa fa-check"></i><b>2.3.2</b> Ecosystems (excluding non-referenced PAs)</a></li>
<li class="chapter" data-level="2.3.3" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#distribution-and-surface-of-pas-across-countries-and-regions"><i class="fa fa-check"></i><b>2.3.3</b> Distribution (# and surface) of PAs across countries and regions</a></li>
<li class="chapter" data-level="2.3.4" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#surface-of-pas"><i class="fa fa-check"></i><b>2.3.4</b> Surface of PAs</a></li>
<li class="chapter" data-level="2.3.5" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#temporal-evolution"><i class="fa fa-check"></i><b>2.3.5</b> Temporal evolution</a></li>
<li class="chapter" data-level="2.3.6" data-path="projects-funded-by-the-afd.html"><a href="projects-funded-by-the-afd.html#governance"><i class="fa fa-check"></i><b>2.3.6</b> Governance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html"><i class="fa fa-check"></i><b>3</b> Miscellaneous statistics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#initial-settings-2"><i class="fa fa-check"></i><b>3.1</b> Initial settings</a></li>
<li class="chapter" data-level="3.2" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#importing-datasets"><i class="fa fa-check"></i><b>3.2</b> Importing datasets</a></li>
<li class="chapter" data-level="3.3" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#performing-descriptive-statistics-1"><i class="fa fa-check"></i><b>3.3</b> Performing descriptive statistics</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#pa-of-interest-other-pa-and-all-pa-in-a-given-sample"><i class="fa fa-check"></i><b>3.3.1</b> PA of interest, other PA and all PA in a given sample</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-tree-cover-and-deforestation"><i class="fa fa-check"></i><b>3.4</b> Evolution of tree cover and deforestation</a></li>
<li class="chapter" data-level="3.5" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#forest-cover-by-country"><i class="fa fa-check"></i><b>3.5</b> Forest cover by country</a></li>
<li class="chapter" data-level="3.6" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-sample"><i class="fa fa-check"></i><b>3.6</b> Mapping of sample</a></li>
<li class="chapter" data-level="3.7" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#mapping-of-results"><i class="fa fa-check"></i><b>3.7</b> Mapping of results</a></li>
<li class="chapter" data-level="3.8" data-path="miscellaneous-statistics.html"><a href="miscellaneous-statistics.html#evolution-of-forest-cover-for-specific-polygons"><i class="fa fa-check"></i><b>3.8</b> Evolution of forest cover for specific polygons</a></li>
</ul></li>
<li class="part"><span><b>Impact analysis</b></span></li>
<li class="chapter" data-level="4" data-path="matching.html"><a href="matching.html"><i class="fa fa-check"></i><b>4</b> Matching</a>
<ul>
<li class="chapter" data-level="4.1" data-path="matching.html"><a href="matching.html#initial-settings-3"><i class="fa fa-check"></i><b>4.1</b> Initial settings</a></li>
<li class="chapter" data-level="4.2" data-path="matching.html"><a href="matching.html#datasets-and-critical-parameters"><i class="fa fa-check"></i><b>4.2</b> Datasets and critical parameters</a></li>
<li class="chapter" data-level="4.3" data-path="matching.html"><a href="matching.html#matching-process"><i class="fa fa-check"></i><b>4.3</b> Matching process</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="difference-in-difference.html"><a href="difference-in-difference.html"><i class="fa fa-check"></i><b>5</b> Difference-in-difference</a>
<ul>
<li class="chapter" data-level="5.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#initial-settings-4"><i class="fa fa-check"></i><b>5.1</b> Initial settings</a></li>
<li class="chapter" data-level="5.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#load-datasets-and-define-critical-parameters"><i class="fa fa-check"></i><b>5.2</b> Load datasets and define critical parameters</a></li>
<li class="chapter" data-level="5.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#computing-treatment-effects-at-protected-area-level"><i class="fa fa-check"></i><b>5.3</b> Computing treatment effects at protected area level</a></li>
<li class="chapter" data-level="5.4" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-quality-of-matching-and-pre-test"><i class="fa fa-check"></i><b>5.4</b> Assess the quality of matching and pre-test</a></li>
<li class="chapter" data-level="5.5" data-path="difference-in-difference.html"><a href="difference-in-difference.html#tidy-datasets-with-acceptable-quality"><i class="fa fa-check"></i><b>5.5</b> Tidy datasets with acceptable quality</a></li>
<li class="chapter" data-level="5.6" data-path="difference-in-difference.html"><a href="difference-in-difference.html#assess-the-loss-of-observations"><i class="fa fa-check"></i><b>5.6</b> Assess the loss of observations</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-overlap-removal"><i class="fa fa-check"></i><b>5.6.1</b> Compute overlap removal</a></li>
<li class="chapter" data-level="5.6.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-losses-for-each-steps"><i class="fa fa-check"></i><b>5.6.2</b> Compute losses for each steps</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="difference-in-difference.html"><a href="difference-in-difference.html#compute-aggregated-metrics-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7</b> Compute aggregated metrics at country and region level</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-treatment-effects"><i class="fa fa-check"></i><b>5.7.1</b> Aggregation of treatment effects</a></li>
<li class="chapter" data-level="5.7.2" data-path="difference-in-difference.html"><a href="difference-in-difference.html#aggregation-of-annual-deforestation-rates"><i class="fa fa-check"></i><b>5.7.2</b> Aggregation of annual deforestation rates</a></li>
<li class="chapter" data-level="5.7.3" data-path="difference-in-difference.html"><a href="difference-in-difference.html#average-and-total-forest-loss-on-the-period-at-country-and-region-level"><i class="fa fa-check"></i><b>5.7.3</b> Average and total forest loss on the period, at country and region level</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="difference-in-difference.html"><a href="difference-in-difference.html#display-treatment-effects"><i class="fa fa-check"></i><b>5.8</b> Display treatment effects</a></li>
<li class="chapter" data-level="5.9" data-path="difference-in-difference.html"><a href="difference-in-difference.html#in-figures-and-tables"><i class="fa fa-check"></i><b>5.9</b> In figures and tables</a>
<ul>
<li class="chapter" data-level="5.9.1" data-path="difference-in-difference.html"><a href="difference-in-difference.html#on-a-map"><i class="fa fa-check"></i><b>5.9.1</b> On a map</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="functions-for-matching-pre--and-post-processing.html"><a href="functions-for-matching-pre--and-post-processing.html"><i class="fa fa-check"></i><b>A</b> Functions for matching pre- and post-processing</a></li>
<li class="chapter" data-level="B" data-path="functions-for-difference-in-difference-computations.html"><a href="functions-for-difference-in-difference-computations.html"><i class="fa fa-check"></i><b>B</b> Functions for difference-in-difference computations</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Impact analysis of protected areas funded by the AFD : an open-guide for reproductibility</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="matching" class="section level1 hasAnchor" number="4">
<h1><span class="header-section-number">Section 4</span> Matching<a href="matching.html#matching" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In this R Markdown are performed the different steps to obtain a matched dataset, i.e a dataset with control and treated observational units to eventually compute the treatment effect. The treatment here is to be under protected area status, and we look at the impact on deforestation.</p>
<p>The steps are the following.</p>
<ol style="list-style-type: decimal">
<li><p>Pre-processing : in a loop for each country,</p>
<ol style="list-style-type: decimal">
<li><p>create a gridding of the country;</p></li>
<li><p>import geospatial data on protected areas (PAs) from the World Dataset on Protected Areas (WDPA) and assign each observation unit/pixel to a group : PA of interest and analyzed (treated), PA of interest but not analyzed, PA not of interest, buffer (pixel closed to but not in a PA), other (so potential control). A PA of interest can be a PA known to be supported by the Agence Française de Développement (AFD) for instance. Some PAs are of interest but cannot be analyzed due to the design of the methodology (e.g marine protected areas when the focus is on deforestation);</p></li>
<li><p>compute the covariates and outcome of interest in all pixels thanks to the mapme.biodiversity package;</p></li>
<li><p>build the matching data frame : each pixel is assigned to a group and has covariates and outcome values.</p></li>
</ol></li>
<li><p>Post-processing : in each country,</p>
<ol style="list-style-type: decimal">
<li><p>Load the matching dataframe obtained at the end of pre-processing for a given country, and extract the list of protected areas to process.</p></li>
<li><p>For each protected area,</p>
<ol style="list-style-type: decimal">
<li><p>perform the matching;</p></li>
<li><p>plot covariate balance and density plots to assess the quality of the match;</p></li>
<li><p>panelize the dataframe;</p></li>
<li><p>plot the evolution of forest cover in treated and control areas, before and after matching;</p></li>
<li><p>map the matched treated and control units.</p></li>
</ol></li>
<li><p>Map all matched treated and control units in the country.</p></li>
</ol></li>
</ol>
<p>The methodology is not extensively described here to keep the documentation concise. The interested reader can refer to the working paper for more details.</p>
<div id="initial-settings-3" class="section level2 hasAnchor" number="4.1">
<h2><span class="header-section-number">4.1</span> Initial settings<a href="matching.html#initial-settings-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Configuring the Rmarkdown</p>
<p>Downloading and installing the relevant packages</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="matching.html#cb130-1" tabindex="-1"></a><span class="co">#Install some libraries</span></span>
<span id="cb130-2"><a href="matching.html#cb130-2" tabindex="-1"></a><span class="do">## CRAN version</span></span>
<span id="cb130-3"><a href="matching.html#cb130-3" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">&quot;tictoc&quot;</span>, <span class="st">&quot;geodata&quot;</span>, <span class="st">&quot;wdpar&quot;</span>, <span class="st">&quot;exactextractr&quot;</span>, <span class="st">&quot;MatchIt&quot;</span>, <span class="st">&quot;fixest&quot;</span>, <span class="st">&quot;cobalt&quot;</span>, <span class="st">&quot;future&quot;</span>, <span class="st">&quot;progressr&quot;</span>, <span class="st">&quot;future.callr&quot;</span>, <span class="st">&quot;janitor&quot;</span>, <span class="st">&quot;geomtextpath&quot;</span>, <span class="st">&quot;rstac&quot;</span>))</span>
<span id="cb130-4"><a href="matching.html#cb130-4" tabindex="-1"></a><span class="do">## Github version (can be relevant if some features have not made it to CRAN version yet)</span></span>
<span id="cb130-5"><a href="matching.html#cb130-5" tabindex="-1"></a>remotes<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;mapme-initiative/mapme.biodiversity&quot;</span>, <span class="at">upgrade=</span><span class="st">&quot;always&quot;</span>)</span>
<span id="cb130-6"><a href="matching.html#cb130-6" tabindex="-1"></a><span class="co">#remotes::install_github(&quot;prioritizr/wdpar&quot;, upgrade=&quot;always&quot;)</span></span>
<span id="cb130-7"><a href="matching.html#cb130-7" tabindex="-1"></a></span>
<span id="cb130-8"><a href="matching.html#cb130-8" tabindex="-1"></a><span class="co">#Install the web driver to download wdpa data directly</span></span>
<span id="cb130-9"><a href="matching.html#cb130-9" tabindex="-1"></a>webdriver<span class="sc">::</span><span class="fu">install_phantomjs</span>()  </span>
<span id="cb130-10"><a href="matching.html#cb130-10" tabindex="-1"></a></span>
<span id="cb130-11"><a href="matching.html#cb130-11" tabindex="-1"></a><span class="co"># Load Libraries</span></span>
<span id="cb130-12"><a href="matching.html#cb130-12" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb130-13"><a href="matching.html#cb130-13" tabindex="-1"></a><span class="fu">library</span>(janitor) <span class="co">#Functions to automate name cleaning</span></span>
<span id="cb130-14"><a href="matching.html#cb130-14" tabindex="-1"></a><span class="fu">library</span>(tictoc) <span class="co">#For timing</span></span>
<span id="cb130-15"><a href="matching.html#cb130-15" tabindex="-1"></a><span class="fu">library</span>(xtable) <span class="co">#Export dataframes as tables</span></span>
<span id="cb130-16"><a href="matching.html#cb130-16" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb130-17"><a href="matching.html#cb130-17" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co">#String specific functions</span></span>
<span id="cb130-18"><a href="matching.html#cb130-18" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># For plotting</span></span>
<span id="cb130-19"><a href="matching.html#cb130-19" tabindex="-1"></a><span class="fu">library</span>(geomtextpath) <span class="co">#For annoted vertical lines in ggplot</span></span>
<span id="cb130-20"><a href="matching.html#cb130-20" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer) <span class="co">#Improved color palettes for plot legends</span></span>
<span id="cb130-21"><a href="matching.html#cb130-21" tabindex="-1"></a><span class="fu">library</span>(ggrepel) <span class="co">#Refine labelling of some figures</span></span>
<span id="cb130-22"><a href="matching.html#cb130-22" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># For handling vector data</span></span>
<span id="cb130-23"><a href="matching.html#cb130-23" tabindex="-1"></a><span class="fu">library</span>(terra) <span class="co"># For handling raster data</span></span>
<span id="cb130-24"><a href="matching.html#cb130-24" tabindex="-1"></a><span class="fu">library</span>(raster) <span class="co"># For handling raster data</span></span>
<span id="cb130-25"><a href="matching.html#cb130-25" tabindex="-1"></a><span class="co">#library(rgeos) </span></span>
<span id="cb130-26"><a href="matching.html#cb130-26" tabindex="-1"></a><span class="fu">library</span>(geodata) <span class="co"># For getting country files</span></span>
<span id="cb130-27"><a href="matching.html#cb130-27" tabindex="-1"></a><span class="fu">library</span>(wdpar) <span class="co"># For getting protected areas</span></span>
<span id="cb130-28"><a href="matching.html#cb130-28" tabindex="-1"></a><span class="fu">library</span>(exactextractr) <span class="co"># For zonal statistics</span></span>
<span id="cb130-29"><a href="matching.html#cb130-29" tabindex="-1"></a><span class="fu">library</span>(mapme.biodiversity) <span class="co">#Download geospatial data and compute specific indicators</span></span>
<span id="cb130-30"><a href="matching.html#cb130-30" tabindex="-1"></a><span class="fu">library</span>(rstac) <span class="co">#To downlad NASA SRTM data</span></span>
<span id="cb130-31"><a href="matching.html#cb130-31" tabindex="-1"></a><span class="fu">library</span>(aws.s3) <span class="co">#Access to storage</span></span>
<span id="cb130-32"><a href="matching.html#cb130-32" tabindex="-1"></a><span class="fu">library</span>(MatchIt) <span class="co">#For matching</span></span>
<span id="cb130-33"><a href="matching.html#cb130-33" tabindex="-1"></a><span class="fu">library</span>(fixest) <span class="co">#For estimating the models</span></span>
<span id="cb130-34"><a href="matching.html#cb130-34" tabindex="-1"></a><span class="fu">library</span>(cobalt) <span class="co">#To visualize density plots and covariate balance from MatchIt outcomes</span></span>
<span id="cb130-35"><a href="matching.html#cb130-35" tabindex="-1"></a><span class="fu">library</span>(future) <span class="co">#For parallel computing in mapme.biodiversity</span></span>
<span id="cb130-36"><a href="matching.html#cb130-36" tabindex="-1"></a><span class="fu">library</span>(future.callr)  <span class="co">#For parallel computing in mapme.biodiversity</span></span>
<span id="cb130-37"><a href="matching.html#cb130-37" tabindex="-1"></a><span class="fu">library</span>(progressr) <span class="co"># To display progress bar   </span></span></code></pre></div>
<p>Load the R functions called in the data processing</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="matching.html#cb131-1" tabindex="-1"></a><span class="co">#Import functions</span></span>
<span id="cb131-2"><a href="matching.html#cb131-2" tabindex="-1"></a><span class="fu">source</span>(<span class="st">&quot;scripts/functions/02_fns_matching.R&quot;</span>)      </span></code></pre></div>
</div>
<div id="datasets-and-critical-parameters" class="section level2 hasAnchor" number="4.2">
<h2><span class="header-section-number">4.2</span> Datasets and critical parameters<a href="matching.html#datasets-and-critical-parameters" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="matching.html#cb132-1" tabindex="-1"></a><span class="co"># Define working directories</span></span>
<span id="cb132-2"><a href="matching.html#cb132-2" tabindex="-1"></a><span class="do">## Define the path to a temporary, working directory processing steps.</span></span>
<span id="cb132-3"><a href="matching.html#cb132-3" tabindex="-1"></a>tmp_pre <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;matching_pre&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb132-4"><a href="matching.html#cb132-4" tabindex="-1"></a>tmp_post <span class="ot">=</span> <span class="fu">paste</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;matching_post&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb132-5"><a href="matching.html#cb132-5" tabindex="-1"></a><span class="do">## Define a directory where outputs are loaded from/stored in SSPCloud.</span></span>
<span id="cb132-6"><a href="matching.html#cb132-6" tabindex="-1"></a><span class="co">#save_dir = paste(&quot;impact_analysis/matching&quot;, Sys.Date(), sep = &quot;/&quot;) #Today&#39;s date</span></span>
<span id="cb132-7"><a href="matching.html#cb132-7" tabindex="-1"></a>save_dir <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;impact_analysis/matching&quot;</span>, <span class="st">&quot;2023-11-22_PYD&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>) <span class="co">#A specific date</span></span>
<span id="cb132-8"><a href="matching.html#cb132-8" tabindex="-1"></a>load_dir <span class="ot">=</span> <span class="fu">paste</span>(<span class="st">&quot;impact_analysis/matching&quot;</span>, <span class="st">&quot;2023-11-22_PYD&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>)</span>
<span id="cb132-9"><a href="matching.html#cb132-9" tabindex="-1"></a></span>
<span id="cb132-10"><a href="matching.html#cb132-10" tabindex="-1"></a><span class="co"># Load datasets</span></span>
<span id="cb132-11"><a href="matching.html#cb132-11" tabindex="-1"></a><span class="do">## WDPA database : just has to be done once to download last version of the WDPA database  </span></span>
<span id="cb132-12"><a href="matching.html#cb132-12" tabindex="-1"></a><span class="do">## Download and save</span></span>
<span id="cb132-13"><a href="matching.html#cb132-13" tabindex="-1"></a><span class="co"># wdpa_wld_raw = wdpa_fetch(x = &quot;global&quot;, wait = TRUE, download_dir = tmp_pre, page_wait = 2, verbose = TRUE)</span></span>
<span id="cb132-14"><a href="matching.html#cb132-14" tabindex="-1"></a><span class="co"># s3write_using(wdpa_wld_raw,</span></span>
<span id="cb132-15"><a href="matching.html#cb132-15" tabindex="-1"></a><span class="co">#               sf::st_write,</span></span>
<span id="cb132-16"><a href="matching.html#cb132-16" tabindex="-1"></a><span class="co">#               delete_dsn = TRUE,</span></span>
<span id="cb132-17"><a href="matching.html#cb132-17" tabindex="-1"></a><span class="co">#               object = paste0(&quot;data_raw/wdpa/wdpa_shp_global_raw.gpkg&quot;),</span></span>
<span id="cb132-18"><a href="matching.html#cb132-18" tabindex="-1"></a><span class="co">#               bucket = &quot;projet-afd-eva-ap&quot;,   </span></span>
<span id="cb132-19"><a href="matching.html#cb132-19" tabindex="-1"></a><span class="co">#               opts = list(&quot;region&quot; = &quot;&quot;))</span></span>
<span id="cb132-20"><a href="matching.html#cb132-20" tabindex="-1"></a></span>
<span id="cb132-21"><a href="matching.html#cb132-21" tabindex="-1"></a><span class="do">##Load</span></span>
<span id="cb132-22"><a href="matching.html#cb132-22" tabindex="-1"></a><span class="do">## /!\ Do not forget to specify SSP CLoud credentials (_00_acess_minio_credentials.Rmd)</span></span>
<span id="cb132-23"><a href="matching.html#cb132-23" tabindex="-1"></a>wdpa_wld_raw <span class="ot">=</span> <span class="fu">s3read_using</span>(</span>
<span id="cb132-24"><a href="matching.html#cb132-24" tabindex="-1"></a>              sf<span class="sc">::</span>st_read,</span>
<span id="cb132-25"><a href="matching.html#cb132-25" tabindex="-1"></a>              <span class="at">object =</span> <span class="st">&quot;data_raw/wdpa/wdpa_shp_global_raw.gpkg&quot;</span>,</span>
<span id="cb132-26"><a href="matching.html#cb132-26" tabindex="-1"></a>              <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb132-27"><a href="matching.html#cb132-27" tabindex="-1"></a>              <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb132-28"><a href="matching.html#cb132-28" tabindex="-1"></a></span>
<span id="cb132-29"><a href="matching.html#cb132-29" tabindex="-1"></a><span class="do">## Dataset specific to the PAs portfolio to analyze. Only one is selected depending on the analysis one wants to perform. </span></span>
<span id="cb132-30"><a href="matching.html#cb132-30" tabindex="-1"></a><span class="do">### PAs supported by the AFD</span></span>
<span id="cb132-31"><a href="matching.html#cb132-31" tabindex="-1"></a><span class="co"># data_pa =</span></span>
<span id="cb132-32"><a href="matching.html#cb132-32" tabindex="-1"></a><span class="co">#   #fread(&quot;data_tidy/BDD_PA_AFD_ie.csv&quot; , encoding = &quot;UTF-8&quot;)</span></span>
<span id="cb132-33"><a href="matching.html#cb132-33" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb132-34"><a href="matching.html#cb132-34" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb132-35"><a href="matching.html#cb132-35" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb132-36"><a href="matching.html#cb132-36" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_AFD_ie.csv&quot;,</span></span>
<span id="cb132-37"><a href="matching.html#cb132-37" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb132-38"><a href="matching.html#cb132-38" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;)) %&gt;%</span></span>
<span id="cb132-39"><a href="matching.html#cb132-39" tabindex="-1"></a><span class="co">#   #Sangha trinational (555547988) created in 2012 actually gathers three former PAs</span></span>
<span id="cb132-40"><a href="matching.html#cb132-40" tabindex="-1"></a><span class="co">#   #in CAF (31458), CMR (1245) and COG (72332) implemented in</span></span>
<span id="cb132-41"><a href="matching.html#cb132-41" tabindex="-1"></a><span class="co">#   #1990, 2001 and 1993 respectively.</span></span>
<span id="cb132-42"><a href="matching.html#cb132-42" tabindex="-1"></a><span class="co">#   # Evaluating the trinational PA is not relevant here : our method relies on pre-treatment obervsations (for matching and DiD) and the outcome is likely to be affected by the initial PAs. On the other hand, evaluating the three earlier PAs might be irrelevant for us : are they funded by the AFD ?? In a first approach, the trinational is removed.</span></span>
<span id="cb132-43"><a href="matching.html#cb132-43" tabindex="-1"></a><span class="co">#   filter(is.na(wdpaid) == TRUE | wdpaid != 555547988)</span></span>
<span id="cb132-44"><a href="matching.html#cb132-44" tabindex="-1"></a></span>
<span id="cb132-45"><a href="matching.html#cb132-45" tabindex="-1"></a><span class="do">## PAs supported by the FAPBM</span></span>
<span id="cb132-46"><a href="matching.html#cb132-46" tabindex="-1"></a><span class="co"># data_pa =</span></span>
<span id="cb132-47"><a href="matching.html#cb132-47" tabindex="-1"></a><span class="co">#   #fread(&quot;data_tidy/BDD_PA_AFD_ie.csv&quot; , encoding = &quot;UTF-8&quot;)</span></span>
<span id="cb132-48"><a href="matching.html#cb132-48" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb132-49"><a href="matching.html#cb132-49" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb132-50"><a href="matching.html#cb132-50" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb132-51"><a href="matching.html#cb132-51" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_FAPBM.csv&quot;,</span></span>
<span id="cb132-52"><a href="matching.html#cb132-52" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb132-53"><a href="matching.html#cb132-53" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;))</span></span>
<span id="cb132-54"><a href="matching.html#cb132-54" tabindex="-1"></a></span>
<span id="cb132-55"><a href="matching.html#cb132-55" tabindex="-1"></a><span class="do">## All PAs in Madagascar</span></span>
<span id="cb132-56"><a href="matching.html#cb132-56" tabindex="-1"></a><span class="co"># data_pa =</span></span>
<span id="cb132-57"><a href="matching.html#cb132-57" tabindex="-1"></a><span class="co">#   aws.s3::s3read_using(</span></span>
<span id="cb132-58"><a href="matching.html#cb132-58" tabindex="-1"></a><span class="co">#   FUN = data.table::fread,</span></span>
<span id="cb132-59"><a href="matching.html#cb132-59" tabindex="-1"></a><span class="co">#   encoding = &quot;UTF-8&quot;,</span></span>
<span id="cb132-60"><a href="matching.html#cb132-60" tabindex="-1"></a><span class="co">#   object = &quot;data_tidy/BDD_PA_MDG.csv&quot;,</span></span>
<span id="cb132-61"><a href="matching.html#cb132-61" tabindex="-1"></a><span class="co">#   bucket = &quot;projet-afd-eva-ap&quot;,</span></span>
<span id="cb132-62"><a href="matching.html#cb132-62" tabindex="-1"></a><span class="co">#   opts = list(&quot;region&quot; = &quot;&quot;))</span></span>
<span id="cb132-63"><a href="matching.html#cb132-63" tabindex="-1"></a></span>
<span id="cb132-64"><a href="matching.html#cb132-64" tabindex="-1"></a><span class="co"># All PAs in Africa</span></span>
<span id="cb132-65"><a href="matching.html#cb132-65" tabindex="-1"></a>data_pa <span class="ot">=</span></span>
<span id="cb132-66"><a href="matching.html#cb132-66" tabindex="-1"></a>  aws.s3<span class="sc">::</span><span class="fu">s3read_using</span>(</span>
<span id="cb132-67"><a href="matching.html#cb132-67" tabindex="-1"></a>  <span class="at">FUN =</span> data.table<span class="sc">::</span>fread,</span>
<span id="cb132-68"><a href="matching.html#cb132-68" tabindex="-1"></a>  <span class="at">encoding =</span> <span class="st">&quot;UTF-8&quot;</span>,</span>
<span id="cb132-69"><a href="matching.html#cb132-69" tabindex="-1"></a>  <span class="at">object =</span> <span class="st">&quot;data_tidy/BDD_PA_africa.csv&quot;</span>,</span>
<span id="cb132-70"><a href="matching.html#cb132-70" tabindex="-1"></a>  <span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb132-71"><a href="matching.html#cb132-71" tabindex="-1"></a>  <span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb132-72"><a href="matching.html#cb132-72" tabindex="-1"></a></span>
<span id="cb132-73"><a href="matching.html#cb132-73" tabindex="-1"></a></span>
<span id="cb132-74"><a href="matching.html#cb132-74" tabindex="-1"></a><span class="co"># Specify buffer width in meter</span></span>
<span id="cb132-75"><a href="matching.html#cb132-75" tabindex="-1"></a>buffer_m <span class="ot">=</span> <span class="dv">10000</span></span>
<span id="cb132-76"><a href="matching.html#cb132-76" tabindex="-1"></a><span class="co"># Specify the grid cell size in meter</span></span>
<span id="cb132-77"><a href="matching.html#cb132-77" tabindex="-1"></a>gridSize <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb132-78"><a href="matching.html#cb132-78" tabindex="-1"></a></span>
<span id="cb132-79"><a href="matching.html#cb132-79" tabindex="-1"></a><span class="co">#Specify the period of study to create the mapme.bidiversity portfolio</span></span>
<span id="cb132-80"><a href="matching.html#cb132-80" tabindex="-1"></a><span class="do">## Start year</span></span>
<span id="cb132-81"><a href="matching.html#cb132-81" tabindex="-1"></a>yr_first <span class="ot">=</span> <span class="dv">2000</span></span>
<span id="cb132-82"><a href="matching.html#cb132-82" tabindex="-1"></a><span class="do">## End year</span></span>
<span id="cb132-83"><a href="matching.html#cb132-83" tabindex="-1"></a>yr_last <span class="ot">=</span> <span class="dv">2021</span></span>
<span id="cb132-84"><a href="matching.html#cb132-84" tabindex="-1"></a></span>
<span id="cb132-85"><a href="matching.html#cb132-85" tabindex="-1"></a><span class="co">#Minimum treatment year</span></span>
<span id="cb132-86"><a href="matching.html#cb132-86" tabindex="-1"></a><span class="co">#At least two pre-treatment periods of forest cover are needed to compute average pre-treatment deforestation, used as a matching variable.</span></span>
<span id="cb132-87"><a href="matching.html#cb132-87" tabindex="-1"></a>yr_min <span class="ot">=</span> yr_first<span class="sc">+</span><span class="dv">2</span></span>
<span id="cb132-88"><a href="matching.html#cb132-88" tabindex="-1"></a></span>
<span id="cb132-89"><a href="matching.html#cb132-89" tabindex="-1"></a><span class="co"># Define column names of matching covariates</span></span>
<span id="cb132-90"><a href="matching.html#cb132-90" tabindex="-1"></a>colname.travelTime <span class="ot">=</span> <span class="st">&quot;minutes_mean_5k_110mio&quot;</span></span>
<span id="cb132-91"><a href="matching.html#cb132-91" tabindex="-1"></a>colname.clayContent <span class="ot">=</span> <span class="st">&quot;clay_0_5cm_mean&quot;</span></span>
<span id="cb132-92"><a href="matching.html#cb132-92" tabindex="-1"></a>colname.elevation <span class="ot">=</span> <span class="st">&quot;elevation_mean&quot;</span></span>
<span id="cb132-93"><a href="matching.html#cb132-93" tabindex="-1"></a>colname.tri <span class="ot">=</span> <span class="st">&quot;tri_mean&quot;</span> <span class="co">#Terrain Ruggedness Index</span></span>
<span id="cb132-94"><a href="matching.html#cb132-94" tabindex="-1"></a>colname.fcAvg <span class="ot">=</span> <span class="st">&quot;avgCover_pre_treat&quot;</span>  <span class="co">#Forest cover pre-treatment</span></span>
<span id="cb132-95"><a href="matching.html#cb132-95" tabindex="-1"></a>colname.flAvg <span class="ot">=</span> <span class="st">&quot;avgLoss_pre_treat&quot;</span> <span class="co">#Forest loss pre-treatment</span></span>
<span id="cb132-96"><a href="matching.html#cb132-96" tabindex="-1"></a>colname.biome <span class="ot">=</span> <span class="st">&quot;biomes&quot;</span></span>
<span id="cb132-97"><a href="matching.html#cb132-97" tabindex="-1"></a>list_cov <span class="ot">=</span> <span class="fu">paste</span>(colname.travelTime, colname.clayContent, colname.elevation, colname.tri, colname.fcAvg, colname.flAvg, colname.biome, <span class="at">sep =</span> <span class="st">&quot;;&quot;</span>)</span>
<span id="cb132-98"><a href="matching.html#cb132-98" tabindex="-1"></a></span>
<span id="cb132-99"><a href="matching.html#cb132-99" tabindex="-1"></a></span>
<span id="cb132-100"><a href="matching.html#cb132-100" tabindex="-1"></a><span class="co">#Matching </span></span>
<span id="cb132-101"><a href="matching.html#cb132-101" tabindex="-1"></a><span class="do">## Parameters</span></span>
<span id="cb132-102"><a href="matching.html#cb132-102" tabindex="-1"></a>match_method <span class="ot">=</span> <span class="st">&quot;cem&quot;</span></span>
<span id="cb132-103"><a href="matching.html#cb132-103" tabindex="-1"></a>cutoff_method <span class="ot">=</span> <span class="st">&quot;sturges&quot;</span></span>
<span id="cb132-104"><a href="matching.html#cb132-104" tabindex="-1"></a>k2k_method <span class="ot">=</span> <span class="st">&quot;mahalanobis&quot;</span></span>
<span id="cb132-105"><a href="matching.html#cb132-105" tabindex="-1"></a>is_k2k <span class="ot">=</span> <span class="cn">TRUE</span></span>
<span id="cb132-106"><a href="matching.html#cb132-106" tabindex="-1"></a><span class="do">## Criteria to assess matching quality</span></span>
<span id="cb132-107"><a href="matching.html#cb132-107" tabindex="-1"></a><span class="do">### Standardized absolte mean difference : threshold</span></span>
<span id="cb132-108"><a href="matching.html#cb132-108" tabindex="-1"></a>th_mean <span class="ot">=</span> <span class="fl">0.25</span> <span class="co">#Used in conservation science, see Desbureaux 2021 for instance</span></span>
<span id="cb132-109"><a href="matching.html#cb132-109" tabindex="-1"></a><span class="do">### Variance ratio : thresholds</span></span>
<span id="cb132-110"><a href="matching.html#cb132-110" tabindex="-1"></a>th_var_min <span class="ot">=</span> <span class="fl">0.5</span></span>
<span id="cb132-111"><a href="matching.html#cb132-111" tabindex="-1"></a>th_var_max <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb132-112"><a href="matching.html#cb132-112" tabindex="-1"></a>       </span>
<span id="cb132-113"><a href="matching.html#cb132-113" tabindex="-1"></a><span class="co"># The list of countries (ISO3 codes) to analyze. This can be define manually or from the the dataset loaded.</span></span>
<span id="cb132-114"><a href="matching.html#cb132-114" tabindex="-1"></a><span class="do">##List of African countries in the sample that have at least one PA supported by the AFD we can analyse</span></span>
<span id="cb132-115"><a href="matching.html#cb132-115" tabindex="-1"></a>data_pa_ie_africa_focus <span class="ot">=</span> data_pa <span class="sc">%&gt;%</span></span>
<span id="cb132-116"><a href="matching.html#cb132-116" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(region <span class="sc">==</span> <span class="st">&quot;Africa&quot;</span> <span class="sc">&amp;</span> <span class="fu">is.na</span>(wdpaid) <span class="sc">==</span> <span class="cn">FALSE</span> <span class="sc">&amp;</span> area_km2 <span class="sc">&gt;=</span><span class="dv">1</span> <span class="sc">&amp;</span> marine <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>) <span class="sc">&amp;</span> status_yr <span class="sc">&gt;=</span> yr_min <span class="sc">&amp;</span> focus <span class="sc">==</span> T)</span>
<span id="cb132-117"><a href="matching.html#cb132-117" tabindex="-1"></a><span class="co">#list_iso = unique(data_pa_ie_africa_focus$iso3)</span></span>
<span id="cb132-118"><a href="matching.html#cb132-118" tabindex="-1"></a><span class="do">## Manual definition</span></span>
<span id="cb132-119"><a href="matching.html#cb132-119" tabindex="-1"></a>list_iso <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;COM&quot;</span>, <span class="st">&quot;GNB&quot;</span>)</span></code></pre></div>
</div>
<div id="matching-process" class="section level2 hasAnchor" number="4.3">
<h2><span class="header-section-number">4.3</span> Matching process<a href="matching.html#matching-process" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following code is divided into pre- and post-processing steps (see above). At pre-processing stage, computations are done country-by-country. At post-proccessing stage, computations are done country-by-country and protected areas by protected areas. To facilitate the reading, each step consists in a call of a function define in an other R script.</p>
<p>During the process, a text file (so-called log) is edited to keep track of the differents steps. Then after each critical step, the code checks whether an error occured by interrogating the variable is_ok (defined in the function corresponding to the step). If the step is ok (is_ok = TRUE) then the processing continues. Otherwise, the code goes to the next iteration (next country for pre-processing, next protected area for post-processing). This is useful in a multi-country, multi-PA analysis, to avoid the code to stop when an error occurs. Instead, the code continue and the analyst can see in the log whether there have been errors during the processing, where it happened and whether he or she needs to launch the analysis again for a specific country/PA. Generally speaking, this log is useful to remember what has been analyzed and assess everything was fine after the processing (warnings, processing of all the countries and PAs, etc.).</p>
<p>For more details about the each step, please refer to the definition of the functions.</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="matching.html#cb133-1" tabindex="-1"></a><span class="do">##########</span></span>
<span id="cb133-2"><a href="matching.html#cb133-2" tabindex="-1"></a><span class="do">### PRE-PROCESSING</span></span>
<span id="cb133-3"><a href="matching.html#cb133-3" tabindex="-1"></a><span class="do">##########</span></span>
<span id="cb133-4"><a href="matching.html#cb133-4" tabindex="-1"></a></span>
<span id="cb133-5"><a href="matching.html#cb133-5" tabindex="-1"></a><span class="co"># The analysis is designed to analyze a portfolio of PA in different countries, using loop over countries and over PA. To better understand a function, or identify and debug an error, a good practice is to enter the loops using a single country or PA. Thus, it is possible to run the analysis step by step, and even enter into the functions to understand what is done « behind the doors ». For instance in « 02_matching.Rmd), set value i = « COM » in the first loop and j = 313046 to peform the analysis step by step for PA with WDPA ID 313046 in Comoros.</span></span>
<span id="cb133-6"><a href="matching.html#cb133-6" tabindex="-1"></a></span>
<span id="cb133-7"><a href="matching.html#cb133-7" tabindex="-1"></a></span>
<span id="cb133-8"><a href="matching.html#cb133-8" tabindex="-1"></a><span class="co">#For each country in the list, the different steps of the pre-processing are performed, and the process duration computed</span></span>
<span id="cb133-9"><a href="matching.html#cb133-9" tabindex="-1"></a>count <span class="ot">=</span> <span class="dv">0</span> <span class="co">#Initialize counter</span></span>
<span id="cb133-10"><a href="matching.html#cb133-10" tabindex="-1"></a>max_i <span class="ot">=</span> <span class="fu">length</span>(list_iso) <span class="co">#Max value of the counter</span></span>
<span id="cb133-11"><a href="matching.html#cb133-11" tabindex="-1"></a>tic_pre <span class="ot">=</span> <span class="fu">tic</span>() <span class="co">#Start timer</span></span>
<span id="cb133-12"><a href="matching.html#cb133-12" tabindex="-1"></a></span>
<span id="cb133-13"><a href="matching.html#cb133-13" tabindex="-1"></a><span class="co">#Create a log to track progress of the analysis</span></span>
<span id="cb133-14"><a href="matching.html#cb133-14" tabindex="-1"></a>log <span class="ot">=</span> <span class="fu">fn_pre_log</span>(list_iso,</span>
<span id="cb133-15"><a href="matching.html#cb133-15" tabindex="-1"></a>                 <span class="at">buffer =</span> buffer_m,</span>
<span id="cb133-16"><a href="matching.html#cb133-16" tabindex="-1"></a>                 <span class="at">gridSize =</span> gridSize,</span>
<span id="cb133-17"><a href="matching.html#cb133-17" tabindex="-1"></a>                 <span class="at">yr_first =</span> yr_first,</span>
<span id="cb133-18"><a href="matching.html#cb133-18" tabindex="-1"></a>                 <span class="at">yr_last =</span> yr_last,</span>
<span id="cb133-19"><a href="matching.html#cb133-19" tabindex="-1"></a>                 <span class="at">yr_min =</span> yr_min,</span>
<span id="cb133-20"><a href="matching.html#cb133-20" tabindex="-1"></a>                 <span class="at">list_cov =</span> list_cov,</span>
<span id="cb133-21"><a href="matching.html#cb133-21" tabindex="-1"></a>                 <span class="at">name =</span> <span class="fu">paste0</span>(<span class="st">&quot;log-&quot;</span>, <span class="fu">Sys.Date</span>(), <span class="st">&quot;-TEST.txt&quot;</span>),</span>
<span id="cb133-22"><a href="matching.html#cb133-22" tabindex="-1"></a>                 <span class="at">notes =</span> <span class="st">&quot;Specific notes or remarks.&quot;</span>)</span>
<span id="cb133-23"><a href="matching.html#cb133-23" tabindex="-1"></a></span>
<span id="cb133-24"><a href="matching.html#cb133-24" tabindex="-1"></a><span class="co"># Perform pre-processing steps country-by-country</span></span>
<span id="cb133-25"><a href="matching.html#cb133-25" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> list_iso)            </span>
<span id="cb133-26"><a href="matching.html#cb133-26" tabindex="-1"></a>{</span>
<span id="cb133-27"><a href="matching.html#cb133-27" tabindex="-1"></a>  <span class="co">#Update counter and display progress</span></span>
<span id="cb133-28"><a href="matching.html#cb133-28" tabindex="-1"></a>  count <span class="ot">=</span> count<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb133-29"><a href="matching.html#cb133-29" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot; : country &quot;</span>, count, <span class="st">&quot;/&quot;</span>, max_i))</span>
<span id="cb133-30"><a href="matching.html#cb133-30" tabindex="-1"></a>  </span>
<span id="cb133-31"><a href="matching.html#cb133-31" tabindex="-1"></a>  <span class="co">#Append the log to track progress of the process on country i</span></span>
<span id="cb133-32"><a href="matching.html#cb133-32" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#####</span><span class="sc">\n</span><span class="st">COUNTRY :&quot;</span>, i, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#####</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-33"><a href="matching.html#cb133-33" tabindex="-1"></a>     </span>
<span id="cb133-34"><a href="matching.html#cb133-34" tabindex="-1"></a>  <span class="co">#Generate observation units</span></span>
<span id="cb133-35"><a href="matching.html#cb133-35" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;--Generating observation units&quot;</span>)</span>
<span id="cb133-36"><a href="matching.html#cb133-36" tabindex="-1"></a>  output_grid <span class="ot">=</span> <span class="fu">fn_pre_grid</span>(<span class="at">iso =</span> i, </span>
<span id="cb133-37"><a href="matching.html#cb133-37" tabindex="-1"></a>                            <span class="at">yr_min =</span> yr_min,</span>
<span id="cb133-38"><a href="matching.html#cb133-38" tabindex="-1"></a>                            <span class="at">path_tmp =</span> tmp_pre, </span>
<span id="cb133-39"><a href="matching.html#cb133-39" tabindex="-1"></a>                            <span class="at">data_pa =</span> data_pa,</span>
<span id="cb133-40"><a href="matching.html#cb133-40" tabindex="-1"></a>                            <span class="at">gridSize =</span> gridSize,</span>
<span id="cb133-41"><a href="matching.html#cb133-41" tabindex="-1"></a>                            <span class="at">log =</span> log,</span>
<span id="cb133-42"><a href="matching.html#cb133-42" tabindex="-1"></a>                            <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-43"><a href="matching.html#cb133-43" tabindex="-1"></a>  <span class="cf">if</span>(output_grid<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}  </span>
<span id="cb133-44"><a href="matching.html#cb133-44" tabindex="-1"></a>  </span>
<span id="cb133-45"><a href="matching.html#cb133-45" tabindex="-1"></a>  <span class="co">#Load the outputs </span></span>
<span id="cb133-46"><a href="matching.html#cb133-46" tabindex="-1"></a>  utm_code <span class="ot">=</span> output_grid<span class="sc">$</span>utm_code <span class="co">#UTM code </span></span>
<span id="cb133-47"><a href="matching.html#cb133-47" tabindex="-1"></a>  gadm_prj <span class="ot">=</span> output_grid<span class="sc">$</span>ctry_shp_prj <span class="co">#The country polygon with relevant projection</span></span>
<span id="cb133-48"><a href="matching.html#cb133-48" tabindex="-1"></a>  grid <span class="ot">=</span> output_grid<span class="sc">$</span>grid <span class="co">#The country gridding</span></span>
<span id="cb133-49"><a href="matching.html#cb133-49" tabindex="-1"></a>  </span>
<span id="cb133-50"><a href="matching.html#cb133-50" tabindex="-1"></a>  <span class="co">#Determining Group IDs and WDPA IDs for all observation units</span></span>
<span id="cb133-51"><a href="matching.html#cb133-51" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;--Determining Group IDs and WDPA IDs&quot;</span>)</span>
<span id="cb133-52"><a href="matching.html#cb133-52" tabindex="-1"></a>  output_group <span class="ot">=</span> <span class="fu">fn_pre_group</span>(<span class="at">iso =</span> i, <span class="at">wdpa_raw =</span> wdpa_wld_raw,</span>
<span id="cb133-53"><a href="matching.html#cb133-53" tabindex="-1"></a>                              <span class="co">#status = c(&quot;Proposed&quot;, &quot;Designated&quot;, &quot;Inscribed&quot;, &quot;Established&quot;),</span></span>
<span id="cb133-54"><a href="matching.html#cb133-54" tabindex="-1"></a>                              <span class="at">status =</span> <span class="cn">NULL</span>,</span>
<span id="cb133-55"><a href="matching.html#cb133-55" tabindex="-1"></a>                            <span class="at">yr_min =</span> yr_min,</span>
<span id="cb133-56"><a href="matching.html#cb133-56" tabindex="-1"></a>                            <span class="at">path_tmp =</span> tmp_pre, <span class="at">utm_code =</span> utm_code,</span>
<span id="cb133-57"><a href="matching.html#cb133-57" tabindex="-1"></a>                            <span class="at">buffer_m =</span> buffer_m, <span class="at">data_pa =</span> data_pa,</span>
<span id="cb133-58"><a href="matching.html#cb133-58" tabindex="-1"></a>                            <span class="at">gadm_prj =</span> gadm_prj, <span class="at">grid =</span> grid, </span>
<span id="cb133-59"><a href="matching.html#cb133-59" tabindex="-1"></a>                            <span class="at">gridSize =</span> gridSize,</span>
<span id="cb133-60"><a href="matching.html#cb133-60" tabindex="-1"></a>                            <span class="at">log =</span> log,</span>
<span id="cb133-61"><a href="matching.html#cb133-61" tabindex="-1"></a>                            <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-62"><a href="matching.html#cb133-62" tabindex="-1"></a>  <span class="cf">if</span>(output_group<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>} <span class="cf">else</span> grid_param <span class="ot">=</span> output_group<span class="sc">$</span>grid.param</span>
<span id="cb133-63"><a href="matching.html#cb133-63" tabindex="-1"></a></span>
<span id="cb133-64"><a href="matching.html#cb133-64" tabindex="-1"></a>  <span class="co">#Calculating outcome and other covariates for all observation units</span></span>
<span id="cb133-65"><a href="matching.html#cb133-65" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;--Calculating outcome and other covariates&quot;</span>)</span>
<span id="cb133-66"><a href="matching.html#cb133-66" tabindex="-1"></a>  output_mf <span class="ot">=</span> </span>
<span id="cb133-67"><a href="matching.html#cb133-67" tabindex="-1"></a>    <span class="fu">fn_pre_mf_parallel</span>(<span class="at">grid.param =</span> grid_param, </span>
<span id="cb133-68"><a href="matching.html#cb133-68" tabindex="-1"></a>                       <span class="at">path_tmp =</span> tmp_pre, </span>
<span id="cb133-69"><a href="matching.html#cb133-69" tabindex="-1"></a>                       <span class="at">iso =</span> i,</span>
<span id="cb133-70"><a href="matching.html#cb133-70" tabindex="-1"></a>                       <span class="at">yr_first =</span> yr_first, <span class="at">yr_last =</span> yr_last,  </span>
<span id="cb133-71"><a href="matching.html#cb133-71" tabindex="-1"></a>                       <span class="at">log =</span> log,</span>
<span id="cb133-72"><a href="matching.html#cb133-72" tabindex="-1"></a>                       <span class="at">save_dir =</span> save_dir)  </span>
<span id="cb133-73"><a href="matching.html#cb133-73" tabindex="-1"></a>  <span class="cf">if</span>(output_mf<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}                                            </span>
<span id="cb133-74"><a href="matching.html#cb133-74" tabindex="-1"></a>  </span>
<span id="cb133-75"><a href="matching.html#cb133-75" tabindex="-1"></a>  <span class="co">#Remove files in the session memory, to avoid saturation</span></span>
<span id="cb133-76"><a href="matching.html#cb133-76" tabindex="-1"></a>  tmp_files <span class="ot">=</span> <span class="fu">list.files</span>(tmp_pre, <span class="at">include.dirs =</span> T, <span class="at">full.names =</span> T, <span class="at">recursive =</span> T)</span>
<span id="cb133-77"><a href="matching.html#cb133-77" tabindex="-1"></a>  <span class="fu">file.remove</span>(tmp_files)</span>
<span id="cb133-78"><a href="matching.html#cb133-78" tabindex="-1"></a>                                  </span>
<span id="cb133-79"><a href="matching.html#cb133-79" tabindex="-1"></a>}                            </span>
<span id="cb133-80"><a href="matching.html#cb133-80" tabindex="-1"></a>  </span>
<span id="cb133-81"><a href="matching.html#cb133-81" tabindex="-1"></a>  <span class="co">#End timer for pre-processing</span></span>
<span id="cb133-82"><a href="matching.html#cb133-82" tabindex="-1"></a>  toc_pre <span class="ot">=</span> <span class="fu">toc</span>()</span>
<span id="cb133-83"><a href="matching.html#cb133-83" tabindex="-1"></a>  </span>
<span id="cb133-84"><a href="matching.html#cb133-84" tabindex="-1"></a>  <span class="co">#Append the log</span></span>
<span id="cb133-85"><a href="matching.html#cb133-85" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;END OF PRE-PROCESSING :&quot;</span>, toc_pre<span class="sc">$</span>callback_msg, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>), </span>
<span id="cb133-86"><a href="matching.html#cb133-86" tabindex="-1"></a>      <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-87"><a href="matching.html#cb133-87" tabindex="-1"></a></span>
<span id="cb133-88"><a href="matching.html#cb133-88" tabindex="-1"></a>  </span>
<span id="cb133-89"><a href="matching.html#cb133-89" tabindex="-1"></a><span class="do">##########</span></span>
<span id="cb133-90"><a href="matching.html#cb133-90" tabindex="-1"></a><span class="do">### POST-PROCESSING</span></span>
<span id="cb133-91"><a href="matching.html#cb133-91" tabindex="-1"></a><span class="do">##########</span></span>
<span id="cb133-92"><a href="matching.html#cb133-92" tabindex="-1"></a></span>
<span id="cb133-93"><a href="matching.html#cb133-93" tabindex="-1"></a>  <span class="co"># The analysis is designed to analyze a portfolio of PA in different countries, using loop over countries and over PA. To better understand a function, or identify and debug an error, a good practice is to enter the loops using a single country or PA. Thus, it is possible to run the analysis step by step, and even enter into the functions to understand what is done « behind the doors ». For instance in « 02_matching.Rmd), set value i = « COM » in the first loop and j = 313046 to peform the analysis step by step for PA with WDPA ID 313046 in Comoros.</span></span>
<span id="cb133-94"><a href="matching.html#cb133-94" tabindex="-1"></a>  </span>
<span id="cb133-95"><a href="matching.html#cb133-95" tabindex="-1"></a>  </span>
<span id="cb133-96"><a href="matching.html#cb133-96" tabindex="-1"></a>           </span>
<span id="cb133-97"><a href="matching.html#cb133-97" tabindex="-1"></a><span class="co">#For each country in the list, the different steps of the post-processing are performed, and duration of the processing computed</span></span>
<span id="cb133-98"><a href="matching.html#cb133-98" tabindex="-1"></a>count_i <span class="ot">=</span> <span class="dv">0</span> <span class="co">#Initialize counter</span></span>
<span id="cb133-99"><a href="matching.html#cb133-99" tabindex="-1"></a>max_i <span class="ot">=</span> <span class="fu">length</span>(list_iso) <span class="co">#Max value of the counter</span></span>
<span id="cb133-100"><a href="matching.html#cb133-100" tabindex="-1"></a>tic_post <span class="ot">=</span> <span class="fu">tic</span>() <span class="co">#start timer</span></span>
<span id="cb133-101"><a href="matching.html#cb133-101" tabindex="-1"></a><span class="co"># Initialize two dataframes to record matching quality assessment : matched control and treated units, matched and unmatched treated</span></span>
<span id="cb133-102"><a href="matching.html#cb133-102" tabindex="-1"></a>df_quality_ct <span class="ot">=</span> <span class="fu">data.frame</span>() <span class="co">#For treated and control</span></span>
<span id="cb133-103"><a href="matching.html#cb133-103" tabindex="-1"></a>df_quality_tt <span class="ot">=</span> <span class="fu">data.frame</span>() <span class="co">#For treated units, before and after matching</span></span>
<span id="cb133-104"><a href="matching.html#cb133-104" tabindex="-1"></a><span class="co">#Initialize a dataframe to store the PA in inputs and outputs of the post-processing. Useful to assess the potential loss during pre-processing and post-processing</span></span>
<span id="cb133-105"><a href="matching.html#cb133-105" tabindex="-1"></a>df_list_post_in <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb133-106"><a href="matching.html#cb133-106" tabindex="-1"></a>df_list_post_out <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb133-107"><a href="matching.html#cb133-107" tabindex="-1"></a></span>
<span id="cb133-108"><a href="matching.html#cb133-108" tabindex="-1"></a><span class="co">#Append the log, and specify matching parameters and quality assessment</span></span>
<span id="cb133-109"><a href="matching.html#cb133-109" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;##########</span><span class="sc">\n</span><span class="st">POST-PROCESSING</span><span class="sc">\n</span><span class="st">##########</span><span class="sc">\n\n</span><span class="st">PARAMETERS :</span><span class="sc">\n</span><span class="st">Matching</span><span class="sc">\n</span><span class="st">#Parameters</span><span class="sc">\n</span><span class="st">##Method :&quot;</span>, match_method, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">##Automatic cutoffs :&quot;</span>, cutoff_method, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">##Is it K2K matching ?&quot;</span>, is_k2k, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">##K2K method :&quot;</span>, k2k_method, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#Quality assessement</span><span class="sc">\n</span><span class="st">##Absolute standardized mean difference (threshold)&quot;</span>, th_mean, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">##Variance ratio between&quot;</span>, th_var_min, <span class="st">&quot;and&quot;</span>, th_var_max, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>), </span>
<span id="cb133-110"><a href="matching.html#cb133-110" tabindex="-1"></a>    <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-111"><a href="matching.html#cb133-111" tabindex="-1"></a>  </span>
<span id="cb133-112"><a href="matching.html#cb133-112" tabindex="-1"></a><span class="co"># Perform post-processing steps country-by-country, area-by-area</span></span>
<span id="cb133-113"><a href="matching.html#cb133-113" tabindex="-1"></a><span class="do">## Loop over country</span></span>
<span id="cb133-114"><a href="matching.html#cb133-114" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> list_iso)</span>
<span id="cb133-115"><a href="matching.html#cb133-115" tabindex="-1"></a>{</span>
<span id="cb133-116"><a href="matching.html#cb133-116" tabindex="-1"></a>  <span class="co">#Update counter and show progress</span></span>
<span id="cb133-117"><a href="matching.html#cb133-117" tabindex="-1"></a>  count_i <span class="ot">=</span> count_i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb133-118"><a href="matching.html#cb133-118" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot; : country &quot;</span>, count_i, <span class="st">&quot;/&quot;</span>, max_i))</span>
<span id="cb133-119"><a href="matching.html#cb133-119" tabindex="-1"></a>  </span>
<span id="cb133-120"><a href="matching.html#cb133-120" tabindex="-1"></a>  <span class="co">#Append the log to track progress of the process on country i</span></span>
<span id="cb133-121"><a href="matching.html#cb133-121" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;#####</span><span class="sc">\n</span><span class="st">COUNTRY :&quot;</span>, i, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-122"><a href="matching.html#cb133-122" tabindex="-1"></a>  </span>
<span id="cb133-123"><a href="matching.html#cb133-123" tabindex="-1"></a>  <span class="co">#Initialize a dataframe to record matching quality assessment at country level</span></span>
<span id="cb133-124"><a href="matching.html#cb133-124" tabindex="-1"></a>  df_quality_ct_i <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb133-125"><a href="matching.html#cb133-125" tabindex="-1"></a>  df_quality_tt_i <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb133-126"><a href="matching.html#cb133-126" tabindex="-1"></a>  </span>
<span id="cb133-127"><a href="matching.html#cb133-127" tabindex="-1"></a>  <span class="co">#Load the matching frame, and report loaded PA in a dataframe</span></span>
<span id="cb133-128"><a href="matching.html#cb133-128" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;--Loading the matching frame&quot;</span>)</span>
<span id="cb133-129"><a href="matching.html#cb133-129" tabindex="-1"></a>  output_load <span class="ot">=</span> <span class="fu">fn_post_load_mf</span>(<span class="at">iso =</span> i, </span>
<span id="cb133-130"><a href="matching.html#cb133-130" tabindex="-1"></a>                           <span class="at">yr_min =</span> yr_min,</span>
<span id="cb133-131"><a href="matching.html#cb133-131" tabindex="-1"></a>                           <span class="at">log =</span> log,</span>
<span id="cb133-132"><a href="matching.html#cb133-132" tabindex="-1"></a>                           <span class="at">load_dir =</span> load_dir,</span>
<span id="cb133-133"><a href="matching.html#cb133-133" tabindex="-1"></a>                           <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-134"><a href="matching.html#cb133-134" tabindex="-1"></a>  <span class="cf">if</span>(output_load<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>} <span class="cf">else</span> mf_ini <span class="ot">=</span> output_load<span class="sc">$</span>mf</span>
<span id="cb133-135"><a href="matching.html#cb133-135" tabindex="-1"></a>  </span>
<span id="cb133-136"><a href="matching.html#cb133-136" tabindex="-1"></a>  list_pa_in <span class="ot">=</span> <span class="fu">unique</span>(mf_ini[mf_ini<span class="sc">$</span>wdpaid <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>wdpaid)</span>
<span id="cb133-137"><a href="matching.html#cb133-137" tabindex="-1"></a>  df_list_post_in <span class="ot">=</span> <span class="fu">rbind</span>(df_list_post_in, <span class="fu">data.frame</span>(<span class="st">&quot;iso3&quot;</span> <span class="ot">=</span> <span class="fu">rep</span>(i, <span class="fu">length</span>(list_pa_in)),</span>
<span id="cb133-138"><a href="matching.html#cb133-138" tabindex="-1"></a>                                                   <span class="st">&quot;wdpaid&quot;</span> <span class="ot">=</span> list_pa_in))</span>
<span id="cb133-139"><a href="matching.html#cb133-139" tabindex="-1"></a>  </span>
<span id="cb133-140"><a href="matching.html#cb133-140" tabindex="-1"></a>    <span class="co">#Append the log : list of PAs analyzed in the matching frame</span></span>
<span id="cb133-141"><a href="matching.html#cb133-141" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;LIST OF WDPAIDs :&quot;</span>, <span class="fu">paste</span>(list_pa_in, <span class="at">collapse =</span> <span class="st">&quot;, &quot;</span>), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">#####</span><span class="sc">\n\n</span><span class="st">&quot;</span>), </span>
<span id="cb133-142"><a href="matching.html#cb133-142" tabindex="-1"></a>      <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-143"><a href="matching.html#cb133-143" tabindex="-1"></a>    </span>
<span id="cb133-144"><a href="matching.html#cb133-144" tabindex="-1"></a>  <span class="co">#Initialization</span></span>
<span id="cb133-145"><a href="matching.html#cb133-145" tabindex="-1"></a>  <span class="do">##Counter</span></span>
<span id="cb133-146"><a href="matching.html#cb133-146" tabindex="-1"></a>  count_j <span class="ot">=</span> <span class="dv">0</span></span>
<span id="cb133-147"><a href="matching.html#cb133-147" tabindex="-1"></a>  max_j <span class="ot">=</span> <span class="fu">length</span>(list_pa_in)</span>
<span id="cb133-148"><a href="matching.html#cb133-148" tabindex="-1"></a>  <span class="do">##List of control and treatment pixels matched</span></span>
<span id="cb133-149"><a href="matching.html#cb133-149" tabindex="-1"></a>  df_pix_matched <span class="ot">=</span> <span class="fu">data.frame</span>()</span>
<span id="cb133-150"><a href="matching.html#cb133-150" tabindex="-1"></a>  </span>
<span id="cb133-151"><a href="matching.html#cb133-151" tabindex="-1"></a>  <span class="co">#Loop over the different PAs</span></span>
<span id="cb133-152"><a href="matching.html#cb133-152" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> list_pa_in)</span>
<span id="cb133-153"><a href="matching.html#cb133-153" tabindex="-1"></a>  {</span>
<span id="cb133-154"><a href="matching.html#cb133-154" tabindex="-1"></a>    <span class="co">#Update counter and show progress</span></span>
<span id="cb133-155"><a href="matching.html#cb133-155" tabindex="-1"></a>    count_j <span class="ot">=</span> count_j<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb133-156"><a href="matching.html#cb133-156" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;WDPAID : &quot;</span>, j, <span class="st">&quot; : &quot;</span>, count_j, <span class="st">&quot;/&quot;</span>, max_j))</span>
<span id="cb133-157"><a href="matching.html#cb133-157" tabindex="-1"></a>    </span>
<span id="cb133-158"><a href="matching.html#cb133-158" tabindex="-1"></a>    <span class="co">#Append the log to track progress of the process on PA j</span></span>
<span id="cb133-159"><a href="matching.html#cb133-159" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;###</span><span class="sc">\n</span><span class="st">WDPAID :&quot;</span>, j, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">###</span><span class="sc">\n\n</span><span class="st">&quot;</span>), <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-160"><a href="matching.html#cb133-160" tabindex="-1"></a>  </span>
<span id="cb133-161"><a href="matching.html#cb133-161" tabindex="-1"></a>    <span class="co">#In the matching frame, select control units and treated units in the PA of interest</span></span>
<span id="cb133-162"><a href="matching.html#cb133-162" tabindex="-1"></a>    mf_ini_j <span class="ot">=</span> mf_ini <span class="sc">%&gt;%</span></span>
<span id="cb133-163"><a href="matching.html#cb133-163" tabindex="-1"></a>      <span class="fu">filter</span>(group <span class="sc">==</span> <span class="dv">2</span> <span class="sc">|</span> (group <span class="sc">==</span> <span class="dv">3</span> <span class="sc">&amp;</span> wdpaid <span class="sc">==</span> j))</span>
<span id="cb133-164"><a href="matching.html#cb133-164" tabindex="-1"></a>    </span>
<span id="cb133-165"><a href="matching.html#cb133-165" tabindex="-1"></a>    <span class="co">#Add average forest cover and forest cover loss before treatment</span></span>
<span id="cb133-166"><a href="matching.html#cb133-166" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;--Add covariates : pre-treatment average forest loss and cover&quot;</span>)</span>
<span id="cb133-167"><a href="matching.html#cb133-167" tabindex="-1"></a>    output_add_cov <span class="ot">=</span> <span class="fu">fn_post_fl_fc_pre_treat</span>(<span class="at">mf =</span> mf_ini_j, </span>
<span id="cb133-168"><a href="matching.html#cb133-168" tabindex="-1"></a>                                             <span class="at">log =</span> log)</span>
<span id="cb133-169"><a href="matching.html#cb133-169" tabindex="-1"></a>    <span class="cf">if</span>(output_add_cov<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>} <span class="cf">else</span> mf_j <span class="ot">=</span> output_add_cov<span class="sc">$</span>mf</span>
<span id="cb133-170"><a href="matching.html#cb133-170" tabindex="-1"></a>    </span>
<span id="cb133-171"><a href="matching.html#cb133-171" tabindex="-1"></a>    <span class="co">#Run Coarsened Exact Matching</span></span>
<span id="cb133-172"><a href="matching.html#cb133-172" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;--Run CEM&quot;</span>)</span>
<span id="cb133-173"><a href="matching.html#cb133-173" tabindex="-1"></a>    output_cem <span class="ot">=</span> <span class="fu">fn_post_match_auto</span>(<span class="at">mf =</span> mf_j, <span class="at">iso =</span> i, </span>
<span id="cb133-174"><a href="matching.html#cb133-174" tabindex="-1"></a>                                   <span class="at">dummy_int =</span> <span class="cn">FALSE</span>,</span>
<span id="cb133-175"><a href="matching.html#cb133-175" tabindex="-1"></a>                                   <span class="at">match_method =</span> match_method,</span>
<span id="cb133-176"><a href="matching.html#cb133-176" tabindex="-1"></a>                                   <span class="at">cutoff_method =</span> cutoff_method,</span>
<span id="cb133-177"><a href="matching.html#cb133-177" tabindex="-1"></a>                                   <span class="at">is_k2k =</span> is_k2k,</span>
<span id="cb133-178"><a href="matching.html#cb133-178" tabindex="-1"></a>                                   <span class="at">k2k_method =</span> k2k_method,</span>
<span id="cb133-179"><a href="matching.html#cb133-179" tabindex="-1"></a>                                     <span class="at">th_mean =</span> th_mean, </span>
<span id="cb133-180"><a href="matching.html#cb133-180" tabindex="-1"></a>                                     <span class="at">th_var_min =</span> th_var_min, <span class="at">th_var_max =</span> th_var_max,</span>
<span id="cb133-181"><a href="matching.html#cb133-181" tabindex="-1"></a>                                   <span class="at">colname.travelTime =</span> colname.travelTime, </span>
<span id="cb133-182"><a href="matching.html#cb133-182" tabindex="-1"></a>                                   <span class="at">colname.clayContent =</span> colname.clayContent, </span>
<span id="cb133-183"><a href="matching.html#cb133-183" tabindex="-1"></a>                                   <span class="at">colname.elevation =</span> colname.elevation,</span>
<span id="cb133-184"><a href="matching.html#cb133-184" tabindex="-1"></a>                                   <span class="at">colname.tri =</span> colname.tri, </span>
<span id="cb133-185"><a href="matching.html#cb133-185" tabindex="-1"></a>                                   <span class="at">colname.fcAvg =</span> colname.fcAvg, </span>
<span id="cb133-186"><a href="matching.html#cb133-186" tabindex="-1"></a>                                   <span class="at">colname.flAvg =</span> colname.flAvg,</span>
<span id="cb133-187"><a href="matching.html#cb133-187" tabindex="-1"></a>                                   <span class="at">colname.biome =</span> colname.biome,</span>
<span id="cb133-188"><a href="matching.html#cb133-188" tabindex="-1"></a>                                   <span class="at">log =</span> log)</span>
<span id="cb133-189"><a href="matching.html#cb133-189" tabindex="-1"></a>    <span class="cf">if</span>(output_cem<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>){<span class="cf">next</span>} <span class="cf">else</span> out_cem_j <span class="ot">=</span> output_cem<span class="sc">$</span>out.cem</span>
<span id="cb133-190"><a href="matching.html#cb133-190" tabindex="-1"></a>    </span>
<span id="cb133-191"><a href="matching.html#cb133-191" tabindex="-1"></a>    <span class="do">##Add matching quality metrics of the PA matched in this iteration</span></span>
<span id="cb133-192"><a href="matching.html#cb133-192" tabindex="-1"></a>    tbl.quality.ct.j <span class="ot">=</span> output_cem<span class="sc">$</span>tbl.quality</span>
<span id="cb133-193"><a href="matching.html#cb133-193" tabindex="-1"></a>    df_quality_ct <span class="ot">=</span> <span class="fu">rbind</span>(df_quality_ct, tbl.quality.ct.j) </span>
<span id="cb133-194"><a href="matching.html#cb133-194" tabindex="-1"></a>    </span>
<span id="cb133-195"><a href="matching.html#cb133-195" tabindex="-1"></a>    <span class="co">#Plots : covariates</span></span>
<span id="cb133-196"><a href="matching.html#cb133-196" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;--Some plots : covariates&quot;</span>)</span>
<span id="cb133-197"><a href="matching.html#cb133-197" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Covariate balance&quot;</span>)</span>
<span id="cb133-198"><a href="matching.html#cb133-198" tabindex="-1"></a>    output_covbal <span class="ot">=</span> <span class="fu">fn_post_covbal</span>(<span class="at">out.cem =</span> out_cem_j,</span>
<span id="cb133-199"><a href="matching.html#cb133-199" tabindex="-1"></a>                                   <span class="at">tbl.quality =</span> tbl.quality.ct.j,</span>
<span id="cb133-200"><a href="matching.html#cb133-200" tabindex="-1"></a>                   <span class="at">mf =</span> mf_j,</span>
<span id="cb133-201"><a href="matching.html#cb133-201" tabindex="-1"></a>                   <span class="at">colname.travelTime =</span> colname.travelTime, </span>
<span id="cb133-202"><a href="matching.html#cb133-202" tabindex="-1"></a>                   <span class="at">colname.clayContent =</span> colname.clayContent,</span>
<span id="cb133-203"><a href="matching.html#cb133-203" tabindex="-1"></a>                   <span class="at">colname.fcAvg =</span> colname.fcAvg, </span>
<span id="cb133-204"><a href="matching.html#cb133-204" tabindex="-1"></a>                   <span class="at">colname.flAvg =</span> colname.flAvg,</span>
<span id="cb133-205"><a href="matching.html#cb133-205" tabindex="-1"></a>                   <span class="at">colname.tri =</span> colname.tri,</span>
<span id="cb133-206"><a href="matching.html#cb133-206" tabindex="-1"></a>                   <span class="at">colname.elevation =</span> colname.elevation,</span>
<span id="cb133-207"><a href="matching.html#cb133-207" tabindex="-1"></a>                   <span class="at">colname.biome =</span> colname.biome,</span>
<span id="cb133-208"><a href="matching.html#cb133-208" tabindex="-1"></a>                   <span class="at">th_mean =</span> th_mean,</span>
<span id="cb133-209"><a href="matching.html#cb133-209" tabindex="-1"></a>                   <span class="at">iso =</span> i,</span>
<span id="cb133-210"><a href="matching.html#cb133-210" tabindex="-1"></a>                   <span class="at">path_tmp =</span> tmp_post,</span>
<span id="cb133-211"><a href="matching.html#cb133-211" tabindex="-1"></a>                   <span class="at">wdpaid =</span> j,</span>
<span id="cb133-212"><a href="matching.html#cb133-212" tabindex="-1"></a>                   <span class="at">log =</span> log,</span>
<span id="cb133-213"><a href="matching.html#cb133-213" tabindex="-1"></a>                   <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-214"><a href="matching.html#cb133-214" tabindex="-1"></a>  <span class="cf">if</span>(output_covbal<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-215"><a href="matching.html#cb133-215" tabindex="-1"></a>    </span>
<span id="cb133-216"><a href="matching.html#cb133-216" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Density plots and histograms&quot;</span>)</span>
<span id="cb133-217"><a href="matching.html#cb133-217" tabindex="-1"></a>    <span class="co">#Density plots</span></span>
<span id="cb133-218"><a href="matching.html#cb133-218" tabindex="-1"></a>    output_density <span class="ot">=</span> <span class="fu">fn_post_plot_density</span>(<span class="at">out.cem =</span> out_cem_j,  </span>
<span id="cb133-219"><a href="matching.html#cb133-219" tabindex="-1"></a>                                         <span class="at">mf =</span> mf_j,</span>
<span id="cb133-220"><a href="matching.html#cb133-220" tabindex="-1"></a>                                         <span class="at">colname.travelTime =</span> colname.travelTime, </span>
<span id="cb133-221"><a href="matching.html#cb133-221" tabindex="-1"></a>                                         <span class="at">colname.clayContent =</span> colname.clayContent,</span>
<span id="cb133-222"><a href="matching.html#cb133-222" tabindex="-1"></a>                                         <span class="at">colname.fcAvg =</span> colname.fcAvg, </span>
<span id="cb133-223"><a href="matching.html#cb133-223" tabindex="-1"></a>                                         <span class="at">colname.flAvg =</span> colname.flAvg,</span>
<span id="cb133-224"><a href="matching.html#cb133-224" tabindex="-1"></a>                                         <span class="at">colname.tri =</span> colname.tri,</span>
<span id="cb133-225"><a href="matching.html#cb133-225" tabindex="-1"></a>                                         <span class="at">colname.elevation =</span> colname.elevation,</span>
<span id="cb133-226"><a href="matching.html#cb133-226" tabindex="-1"></a>                                         <span class="at">colname.biome =</span> colname.biome,</span>
<span id="cb133-227"><a href="matching.html#cb133-227" tabindex="-1"></a>                                         <span class="at">iso =</span> i,</span>
<span id="cb133-228"><a href="matching.html#cb133-228" tabindex="-1"></a>                                         <span class="at">path_tmp =</span> tmp_post,</span>
<span id="cb133-229"><a href="matching.html#cb133-229" tabindex="-1"></a>                                         <span class="at">wdpaid =</span> j,</span>
<span id="cb133-230"><a href="matching.html#cb133-230" tabindex="-1"></a>                                         <span class="at">log =</span> log,</span>
<span id="cb133-231"><a href="matching.html#cb133-231" tabindex="-1"></a>                                         <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-232"><a href="matching.html#cb133-232" tabindex="-1"></a>     <span class="cf">if</span>(output_density<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-233"><a href="matching.html#cb133-233" tabindex="-1"></a>    <span class="co">#Histograms</span></span>
<span id="cb133-234"><a href="matching.html#cb133-234" tabindex="-1"></a>    output_hist <span class="ot">=</span> <span class="fu">fn_post_plot_hist</span>(<span class="at">out.cem =</span> out_cem_j,  </span>
<span id="cb133-235"><a href="matching.html#cb133-235" tabindex="-1"></a>                                     <span class="at">mf =</span> mf_j,</span>
<span id="cb133-236"><a href="matching.html#cb133-236" tabindex="-1"></a>                                     <span class="at">colname.travelTime =</span> colname.travelTime, </span>
<span id="cb133-237"><a href="matching.html#cb133-237" tabindex="-1"></a>                                     <span class="at">colname.clayContent =</span> colname.clayContent,</span>
<span id="cb133-238"><a href="matching.html#cb133-238" tabindex="-1"></a>                                     <span class="at">colname.fcAvg =</span> colname.fcAvg, </span>
<span id="cb133-239"><a href="matching.html#cb133-239" tabindex="-1"></a>                                     <span class="at">colname.flAvg =</span> colname.flAvg,</span>
<span id="cb133-240"><a href="matching.html#cb133-240" tabindex="-1"></a>                                     <span class="at">colname.tri =</span> colname.tri,</span>
<span id="cb133-241"><a href="matching.html#cb133-241" tabindex="-1"></a>                                     <span class="at">colname.elevation =</span> colname.elevation,</span>
<span id="cb133-242"><a href="matching.html#cb133-242" tabindex="-1"></a>                                     <span class="at">colname.biome =</span> colname.biome,</span>
<span id="cb133-243"><a href="matching.html#cb133-243" tabindex="-1"></a>                                     <span class="at">iso =</span> i,</span>
<span id="cb133-244"><a href="matching.html#cb133-244" tabindex="-1"></a>                                     <span class="at">path_tmp =</span> tmp_post,</span>
<span id="cb133-245"><a href="matching.html#cb133-245" tabindex="-1"></a>                                     <span class="at">wdpaid =</span> j,</span>
<span id="cb133-246"><a href="matching.html#cb133-246" tabindex="-1"></a>                                     <span class="at">log =</span> log,</span>
<span id="cb133-247"><a href="matching.html#cb133-247" tabindex="-1"></a>                                     <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-248"><a href="matching.html#cb133-248" tabindex="-1"></a>     <span class="cf">if</span>(output_hist<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-249"><a href="matching.html#cb133-249" tabindex="-1"></a>    </span>
<span id="cb133-250"><a href="matching.html#cb133-250" tabindex="-1"></a>    <span class="co">#Panelize dataframes</span></span>
<span id="cb133-251"><a href="matching.html#cb133-251" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Panelize (Un-)Matched Dataframe&quot;</span>)</span>
<span id="cb133-252"><a href="matching.html#cb133-252" tabindex="-1"></a>    output_panel <span class="ot">=</span> <span class="fu">fn_post_panel</span>(<span class="at">out.cem =</span> out_cem_j, </span>
<span id="cb133-253"><a href="matching.html#cb133-253" tabindex="-1"></a>                                  <span class="at">mf =</span> mf_j,  </span>
<span id="cb133-254"><a href="matching.html#cb133-254" tabindex="-1"></a>                                  <span class="at">iso =</span> i,</span>
<span id="cb133-255"><a href="matching.html#cb133-255" tabindex="-1"></a>                                  <span class="at">wdpaid =</span> j,</span>
<span id="cb133-256"><a href="matching.html#cb133-256" tabindex="-1"></a>                                  <span class="at">log =</span> log,</span>
<span id="cb133-257"><a href="matching.html#cb133-257" tabindex="-1"></a>                                 <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-258"><a href="matching.html#cb133-258" tabindex="-1"></a>     <span class="cf">if</span>(output_panel<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-259"><a href="matching.html#cb133-259" tabindex="-1"></a>    </span>
<span id="cb133-260"><a href="matching.html#cb133-260" tabindex="-1"></a>    matched.wide.j <span class="ot">=</span> output_panel<span class="sc">$</span>matched.wide</span>
<span id="cb133-261"><a href="matching.html#cb133-261" tabindex="-1"></a>    unmatched.wide.j <span class="ot">=</span> output_panel<span class="sc">$</span>unmatched.wide</span>
<span id="cb133-262"><a href="matching.html#cb133-262" tabindex="-1"></a>    matched.long.j <span class="ot">=</span> output_panel<span class="sc">$</span>matched.long</span>
<span id="cb133-263"><a href="matching.html#cb133-263" tabindex="-1"></a>    unmatched.long.j <span class="ot">=</span> output_panel<span class="sc">$</span>unmatched.long </span>
<span id="cb133-264"><a href="matching.html#cb133-264" tabindex="-1"></a>    </span>
<span id="cb133-265"><a href="matching.html#cb133-265" tabindex="-1"></a>    <span class="co">#Assess the difference between matched and unmatched treated units</span></span>
<span id="cb133-266"><a href="matching.html#cb133-266" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Statistics on treated units before and after matching&quot;</span>)</span>
<span id="cb133-267"><a href="matching.html#cb133-267" tabindex="-1"></a>    </span>
<span id="cb133-268"><a href="matching.html#cb133-268" tabindex="-1"></a>    output_m_unm_treated <span class="ot">=</span> <span class="fu">fn_post_m_unm_treated</span>(<span class="at">df_m =</span> matched.wide.j,</span>
<span id="cb133-269"><a href="matching.html#cb133-269" tabindex="-1"></a>                                                 <span class="at">df_unm =</span> unmatched.wide.j,</span>
<span id="cb133-270"><a href="matching.html#cb133-270" tabindex="-1"></a>                                                 <span class="at">iso =</span> i,</span>
<span id="cb133-271"><a href="matching.html#cb133-271" tabindex="-1"></a>                                                 <span class="at">wdpaid =</span> j,</span>
<span id="cb133-272"><a href="matching.html#cb133-272" tabindex="-1"></a>                                                 <span class="at">th_mean =</span> th_mean, </span>
<span id="cb133-273"><a href="matching.html#cb133-273" tabindex="-1"></a>                                                 <span class="at">th_var_min =</span> th_var_min, </span>
<span id="cb133-274"><a href="matching.html#cb133-274" tabindex="-1"></a>                                                 <span class="at">th_var_max =</span> th_var_max,</span>
<span id="cb133-275"><a href="matching.html#cb133-275" tabindex="-1"></a>                                                 <span class="at">save_dir =</span> save_dir,</span>
<span id="cb133-276"><a href="matching.html#cb133-276" tabindex="-1"></a>                                                 <span class="at">log =</span> log)</span>
<span id="cb133-277"><a href="matching.html#cb133-277" tabindex="-1"></a>    <span class="cf">if</span>(output_m_unm_treated<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-278"><a href="matching.html#cb133-278" tabindex="-1"></a>    </span>
<span id="cb133-279"><a href="matching.html#cb133-279" tabindex="-1"></a>    <span class="do">##Add matching quality metrics of the PA matched in this iteration</span></span>
<span id="cb133-280"><a href="matching.html#cb133-280" tabindex="-1"></a>    tbl.quality.tt.j <span class="ot">=</span> output_m_unm_treated<span class="sc">$</span>tbl.quality</span>
<span id="cb133-281"><a href="matching.html#cb133-281" tabindex="-1"></a>    df_quality_tt <span class="ot">=</span> <span class="fu">rbind</span>(df_quality_tt, tbl.quality.tt.j) </span>
<span id="cb133-282"><a href="matching.html#cb133-282" tabindex="-1"></a>    </span>
<span id="cb133-283"><a href="matching.html#cb133-283" tabindex="-1"></a>    <span class="co">#Extract matched units and plot them on a grid</span></span>
<span id="cb133-284"><a href="matching.html#cb133-284" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Extract matched units and plot them on a grid&quot;</span>)</span>
<span id="cb133-285"><a href="matching.html#cb133-285" tabindex="-1"></a>    <span class="do">##Extract ID of treated and control pixels</span></span>
<span id="cb133-286"><a href="matching.html#cb133-286" tabindex="-1"></a>    df_pix_matched_j <span class="ot">=</span> matched.wide.j <span class="sc">%&gt;%</span></span>
<span id="cb133-287"><a href="matching.html#cb133-287" tabindex="-1"></a>      <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb133-288"><a href="matching.html#cb133-288" tabindex="-1"></a>      <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb133-289"><a href="matching.html#cb133-289" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(group, assetid)) <span class="sc">%&gt;%</span></span>
<span id="cb133-290"><a href="matching.html#cb133-290" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="st">&quot;group_matched&quot;</span> <span class="ot">=</span> <span class="st">&quot;group&quot;</span>) </span>
<span id="cb133-291"><a href="matching.html#cb133-291" tabindex="-1"></a>    df_pix_matched <span class="ot">=</span> <span class="fu">rbind</span>(df_pix_matched, df_pix_matched_j)</span>
<span id="cb133-292"><a href="matching.html#cb133-292" tabindex="-1"></a>    </span>
<span id="cb133-293"><a href="matching.html#cb133-293" tabindex="-1"></a>    <span class="do">##Plot the grid with matched control and treated for the PA</span></span>
<span id="cb133-294"><a href="matching.html#cb133-294" tabindex="-1"></a>    output_grid <span class="ot">=</span> <span class="fu">fn_post_plot_grid</span>(<span class="at">iso =</span> i, <span class="at">wdpaid =</span> j,</span>
<span id="cb133-295"><a href="matching.html#cb133-295" tabindex="-1"></a>                      <span class="at">is_pa =</span> <span class="cn">TRUE</span>,</span>
<span id="cb133-296"><a href="matching.html#cb133-296" tabindex="-1"></a>                      <span class="at">df_pix_matched =</span> df_pix_matched_j,</span>
<span id="cb133-297"><a href="matching.html#cb133-297" tabindex="-1"></a>                      <span class="at">path_tmp =</span> tmp_post,</span>
<span id="cb133-298"><a href="matching.html#cb133-298" tabindex="-1"></a>                      <span class="at">log =</span> log,</span>
<span id="cb133-299"><a href="matching.html#cb133-299" tabindex="-1"></a>                      <span class="at">load_dir =</span> load_dir,</span>
<span id="cb133-300"><a href="matching.html#cb133-300" tabindex="-1"></a>                      <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-301"><a href="matching.html#cb133-301" tabindex="-1"></a>     <span class="cf">if</span>(output_grid<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-302"><a href="matching.html#cb133-302" tabindex="-1"></a></span>
<span id="cb133-303"><a href="matching.html#cb133-303" tabindex="-1"></a>    <span class="co">#Plots the evolution of forest cover for treated and control units, before and after matching</span></span>
<span id="cb133-304"><a href="matching.html#cb133-304" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;----Plots again : trend&quot;</span>)</span>
<span id="cb133-305"><a href="matching.html#cb133-305" tabindex="-1"></a>    <span class="co">#/!\ 27/10/2023 : I have removed the plot for unmatched units : take too much time and useless for the next presentations we have to do !</span></span>
<span id="cb133-306"><a href="matching.html#cb133-306" tabindex="-1"></a>    output_trend <span class="ot">=</span> <span class="fu">fn_post_plot_trend</span>(<span class="at">matched.long =</span> matched.long.j, </span>
<span id="cb133-307"><a href="matching.html#cb133-307" tabindex="-1"></a>                       <span class="at">unmatched.long =</span> unmatched.long.j, </span>
<span id="cb133-308"><a href="matching.html#cb133-308" tabindex="-1"></a>                       <span class="at">mf =</span> mf_j,</span>
<span id="cb133-309"><a href="matching.html#cb133-309" tabindex="-1"></a>                       <span class="at">data_pa =</span> data_pa,</span>
<span id="cb133-310"><a href="matching.html#cb133-310" tabindex="-1"></a>                       <span class="at">iso =</span> i,</span>
<span id="cb133-311"><a href="matching.html#cb133-311" tabindex="-1"></a>                       <span class="at">wdpaid =</span> j,</span>
<span id="cb133-312"><a href="matching.html#cb133-312" tabindex="-1"></a>                       <span class="at">log =</span> log,</span>
<span id="cb133-313"><a href="matching.html#cb133-313" tabindex="-1"></a>                       <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-314"><a href="matching.html#cb133-314" tabindex="-1"></a>    <span class="cf">if</span>(output_trend<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-315"><a href="matching.html#cb133-315" tabindex="-1"></a>    </span>
<span id="cb133-316"><a href="matching.html#cb133-316" tabindex="-1"></a>    <span class="co">#The PA has gone through all post-processing steps : report it in the output dataframe</span></span>
<span id="cb133-317"><a href="matching.html#cb133-317" tabindex="-1"></a>    df_list_post_out <span class="ot">=</span> <span class="fu">rbind</span>(df_list_post_out, <span class="fu">data.frame</span>(<span class="st">&quot;iso3&quot;</span> <span class="ot">=</span> i, <span class="st">&quot;wdpaid&quot;</span> <span class="ot">=</span> j)) </span>
<span id="cb133-318"><a href="matching.html#cb133-318" tabindex="-1"></a></span>
<span id="cb133-319"><a href="matching.html#cb133-319" tabindex="-1"></a>  }</span>
<span id="cb133-320"><a href="matching.html#cb133-320" tabindex="-1"></a>    </span>
<span id="cb133-321"><a href="matching.html#cb133-321" tabindex="-1"></a>  <span class="co"># Plot the grid with matched control and treated for the country </span></span>
<span id="cb133-322"><a href="matching.html#cb133-322" tabindex="-1"></a>  output_grid <span class="ot">=</span> <span class="fu">fn_post_plot_grid</span>(<span class="at">iso =</span> i, <span class="at">wdpaid =</span> j,</span>
<span id="cb133-323"><a href="matching.html#cb133-323" tabindex="-1"></a>                    <span class="at">is_pa =</span> <span class="cn">FALSE</span>,</span>
<span id="cb133-324"><a href="matching.html#cb133-324" tabindex="-1"></a>                    <span class="at">df_pix_matched =</span> df_pix_matched,</span>
<span id="cb133-325"><a href="matching.html#cb133-325" tabindex="-1"></a>                    <span class="at">path_tmp =</span> tmp_post,</span>
<span id="cb133-326"><a href="matching.html#cb133-326" tabindex="-1"></a>                    <span class="at">log =</span> log,</span>
<span id="cb133-327"><a href="matching.html#cb133-327" tabindex="-1"></a>                    <span class="at">load_dir =</span> load_dir,</span>
<span id="cb133-328"><a href="matching.html#cb133-328" tabindex="-1"></a>                    <span class="at">save_dir =</span> save_dir)</span>
<span id="cb133-329"><a href="matching.html#cb133-329" tabindex="-1"></a>   <span class="cf">if</span>(output_grid<span class="sc">$</span>is_ok <span class="sc">==</span> <span class="cn">FALSE</span>) {<span class="cf">next</span>}</span>
<span id="cb133-330"><a href="matching.html#cb133-330" tabindex="-1"></a>  </span>
<span id="cb133-331"><a href="matching.html#cb133-331" tabindex="-1"></a>}       </span>
<span id="cb133-332"><a href="matching.html#cb133-332" tabindex="-1"></a></span>
<span id="cb133-333"><a href="matching.html#cb133-333" tabindex="-1"></a><span class="co">#Save the dataframe on matching quality</span></span>
<span id="cb133-334"><a href="matching.html#cb133-334" tabindex="-1"></a><span class="do">##Matched control and treated units</span></span>
<span id="cb133-335"><a href="matching.html#cb133-335" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb133-336"><a href="matching.html#cb133-336" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb133-337"><a href="matching.html#cb133-337" tabindex="-1"></a>df_quality_ct,</span>
<span id="cb133-338"><a href="matching.html#cb133-338" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_quality_ct.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb133-339"><a href="matching.html#cb133-339" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb133-340"><a href="matching.html#cb133-340" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb133-341"><a href="matching.html#cb133-341" tabindex="-1"></a><span class="do">##Treated units, before and after matching</span></span>
<span id="cb133-342"><a href="matching.html#cb133-342" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb133-343"><a href="matching.html#cb133-343" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb133-344"><a href="matching.html#cb133-344" tabindex="-1"></a>df_quality_tt,</span>
<span id="cb133-345"><a href="matching.html#cb133-345" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_quality_tt.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>), </span>
<span id="cb133-346"><a href="matching.html#cb133-346" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb133-347"><a href="matching.html#cb133-347" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb133-348"><a href="matching.html#cb133-348" tabindex="-1"></a><span class="co">#Save the dataframes reporting PAs in input and output of post-processing</span></span>
<span id="cb133-349"><a href="matching.html#cb133-349" tabindex="-1"></a><span class="do">##Input</span></span>
<span id="cb133-350"><a href="matching.html#cb133-350" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb133-351"><a href="matching.html#cb133-351" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb133-352"><a href="matching.html#cb133-352" tabindex="-1"></a>df_list_post_in,</span>
<span id="cb133-353"><a href="matching.html#cb133-353" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_post_in.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb133-354"><a href="matching.html#cb133-354" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb133-355"><a href="matching.html#cb133-355" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb133-356"><a href="matching.html#cb133-356" tabindex="-1"></a><span class="do">##Output</span></span>
<span id="cb133-357"><a href="matching.html#cb133-357" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">s3write_using</span>(</span>
<span id="cb133-358"><a href="matching.html#cb133-358" tabindex="-1"></a><span class="at">FUN =</span> data.table<span class="sc">::</span>fwrite,</span>
<span id="cb133-359"><a href="matching.html#cb133-359" tabindex="-1"></a>df_list_post_out,</span>
<span id="cb133-360"><a href="matching.html#cb133-360" tabindex="-1"></a><span class="at">object =</span> <span class="fu">paste</span>(save_dir, <span class="st">&quot;df_list_post_out.csv&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb133-361"><a href="matching.html#cb133-361" tabindex="-1"></a><span class="at">bucket =</span> <span class="st">&quot;projet-afd-eva-ap&quot;</span>,</span>
<span id="cb133-362"><a href="matching.html#cb133-362" tabindex="-1"></a><span class="at">opts =</span> <span class="fu">list</span>(<span class="st">&quot;region&quot;</span> <span class="ot">=</span> <span class="st">&quot;&quot;</span>))</span>
<span id="cb133-363"><a href="matching.html#cb133-363" tabindex="-1"></a></span>
<span id="cb133-364"><a href="matching.html#cb133-364" tabindex="-1"></a><span class="co">#End post-processing timer</span></span>
<span id="cb133-365"><a href="matching.html#cb133-365" tabindex="-1"></a>toc_post <span class="ot">=</span> <span class="fu">toc</span>()</span>
<span id="cb133-366"><a href="matching.html#cb133-366" tabindex="-1"></a></span>
<span id="cb133-367"><a href="matching.html#cb133-367" tabindex="-1"></a><span class="co">#Append the log and save it</span></span>
<span id="cb133-368"><a href="matching.html#cb133-368" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">paste</span>(<span class="st">&quot;END OF POST-PROCESSING :&quot;</span>, toc_post<span class="sc">$</span>callback_msg, <span class="st">&quot;</span><span class="sc">\n\n</span><span class="st">&quot;</span>),</span>
<span id="cb133-369"><a href="matching.html#cb133-369" tabindex="-1"></a>    <span class="at">file =</span> log, <span class="at">append =</span> <span class="cn">TRUE</span>)</span>
<span id="cb133-370"><a href="matching.html#cb133-370" tabindex="-1"></a>aws.s3<span class="sc">::</span><span class="fu">put_object</span>(<span class="at">file =</span> log,</span>
<span id="cb133-371"><a href="matching.html#cb133-371" tabindex="-1"></a>                   <span class="at">bucket =</span> <span class="fu">paste</span>(<span class="st">&quot;projet-afd-eva-ap&quot;</span>, save_dir, <span class="at">sep =</span> <span class="st">&quot;/&quot;</span>),</span>
<span id="cb133-372"><a href="matching.html#cb133-372" tabindex="-1"></a>                   <span class="at">region =</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb133-373"><a href="matching.html#cb133-373" tabindex="-1"></a>                   <span class="at">show_progress =</span> <span class="cn">FALSE</span>)  </span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="miscellaneous-statistics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="difference-in-difference.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": false
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/vuillota/EVA-impact-aires-protegees/edit/main/02_matching.Rmd",
"text": "Suggest an edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["https://github.com/vuillota/EVA-impact-aires-protegees/raw/main/02_matching.Rmd"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"code_folding": "hide"
});
});
</script>

</body>

</html>
