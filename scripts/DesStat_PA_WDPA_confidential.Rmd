---
title: "DesStat_PA_WDPA_confidential"
author: "Antoine Vuillot"
date: "05/07/2023"
output: 
  html_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: inline
---

# Confidential descriptive statistics

In this document are performed and plotted descriptive statistics of confidential data.

## Importing packages

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(stargazer)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(data.table)
#library(readxl)
#library(splitstackshape) 
library(janitor)
library(xtable)
library(questionr)
```

## Importing datasets

```{r}
#Both datasets are imported also in UTF8 encoding, for some variables
##A first dataset with some PA on more than one row (one line per funding for instance)
data_stat_fund = 
  fread("data_tidy/BDD_DesStat_fund.csv", encoding = "UTF-8")
  # aws.s3::s3read_using(
  # FUN = data.table::fread,
  # encoding = "UTF-8",
  # # Mettre les options de FUN ici
  # object = "data_tidy/BDD_DesStat_nopub.csv",
  # bucket = "projet-afd-eva-ap",
  # opts = list("region" = ""))

pa_area_ctry = fread("data_tidy/area/pa_area_ctry.csv")
pa_area_dr = fread("data_tidy/area/pa_area_dr.csv")
load("data_tidy/area/pa_area_wld.RDdata")
```

## Descriptive statistics

### Funding

This section provides several statistics on the funding of PAs : average funding by project, by contest, average funding by region or country, average funding by area, evolution over time, funding type.

#### Average funding

Create a dataset with one row per project (funding is given by project, so duplicates are avoided)

```{r}

data_stat_projet_nodupl = data_stat_fund %>%
  dplyr::distinct(id_projet, .keep_all = TRUE)

```

Distribution of project funding

```{r}

#Table
tbl_fund_proj = summary(data_stat_projet_nodupl$montant_total_projet) %>%
  format(scientific = FALSE) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::select(-c("1st Qu.","3rd Qu."))


#Boxplot
# fig_fund_proj = ggplot(data = data_stat_projet_nodupl,
#                        aes(y = montant_total_projet)) %>%
#   + geom_boxplot() %>%
#   + theme(legend.position = "bottom",
#       legend.key = element_rect(fill = "white"),
#       plot.title = element_text(size = 14, face = "bold"), 
#       axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
#       axis.title.x = element_text(margin = margin(t = 10)),
#       panel.background = element_rect(fill = 'white', colour = 'white', 
#                                       linewidth = 0.5, linetype = 'solid'),
#       panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
#       panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
#       plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#fig_fund_proj

```

Average funds given by each concours

/! Weird : montant_total_projet is similar for each row of ID_concours

```{r}

# tbl_fund_avg_concours = data_stat_fund %>%
#   group_by(id_concours) %>%
#   slice(1) %>%
#   summarize(Mean = mean(montant_prevu_concours_euro_octroi))

```

**Average fund received by each project in the different concours**

/! Weird : montant_total_projet is similar for each row of ID_projet

```{r}

# tbl_fund_avg_project = data_stat_fund %>%
#   group_by(id_projet) %>%
#   summarize(Mean = mean(montant_prevu_concours_euro_octroi))

```

**Average funding by country/region**

```{r}
#Attention un même projet peut concerner plusieurs pays
#CZZ1260; CZZ1282; CZZ1382; CZZ1419; CZZ1667; CZZ1879, CZZ1909; 	
#CZZ1914; CZZ3012; CZZ3092 ...
#On ne peut pas décomposer par Pays vu la base SIOP et ses variables ... mais pas DR oui !


#By country ...
tbl_fund_avg_ctry = data_stat_fund_nodupl %>%
  group_by(pays, iso3) %>%
  summarize(avg_fund = mean(montant_total_projet, na.rm = TRUE)) %>%
  arrange(avg_fund)

#By region
tbl_fund_avg_dr = data_stat_fund_nodupl %>%
  group_by(direction_regionale) %>%
  summarise(avg_fund = mean(montant_total_projet, na.rm = TRUE)) %>%
  arrange(avg_fund)



```

**Average funding per unit or area (marine and terrestrial), at regional and world level**

Some projects cover more than one country (e.g CZZ3012), but the total fund is given at project level. Thus it is not possible to compute funding per unit of area at country level for all countries. Still at country level, Tanzania, India, "Ocean Indien", "Multipays" and "Dr Asie du Sud" have no fund per area in the computations. In fact PAs are reported in these regions/countries, with area and total funding. But without WDPAID and PA name, so these PAs are not kept in the dataset without duplicates.

It is possible however at DR level. Note that the total superficie at world level is different from the total superficie from the DR, taking the overlap into account. Indeed, overlap between polygons from different DR is subtracted at world level but not at DR level.

```{r}
#By country ...
# data_fund_sum_ctry = data_stat_projet_nodupl %>%
#   group_by(pays, iso3) %>%
#   summarize(tot_fund = sum(montant_total_projet, na.rm = TRUE)) %>%
#   ungroup() %>%
#   arrange(tot_fund) 
# 
# data_fund_per_area_ctry = data_fund_sum_ctry %>%
#   left_join(select(pa_area_ctry, c(iso3, sprfc_tot_noint_km2)), by = "iso3") %>%
#   mutate(fund_per_area = tot_fund/sprfc_tot_noint_km2)
# names(data_fund_per_area_ctry) = c("Pays", "ISO3", "Montant total (€)", "Superficie totale (km2)", "Financement moyen par km2 (€/km2)")
#print(xtable(data_fund_per_area_ctry, type = "latex"), file = "DesStat/funding/tbl_fund_per_area_ctry.tex")


#By region 
data_fund_sum_dr = data_stat_projet_nodupl %>%
  group_by(direction_regionale) %>%
  summarize(tot_fund = sum(montant_total_projet, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(tot_fund)

data_fund_per_area_dr = data_fund_sum_dr %>%
  left_join(select(pa_area_dr, c(direction_regionale, sprfc_tot_noint_km2)), by = "direction_regionale") %>%
  mutate(fund_per_area = tot_fund/sprfc_tot_noint_km2)
names(data_fund_per_area_dr) = c("Direction régionale", "Montant total (€)", "Superficie totale (km2)", "Financement moyen par km2 (€/km2)")


#At world level
data_fund_per_area_wld = sum(data_stat_projet_nodupl$montant_total_projet)/pa_area_wld
tbl_fund_per_area_wld = data.frame(data_fund_per_area_wld) %>% format(digits = 4)
names(tbl_fund_per_area_wld) = c("Financement moyen par km2 (€/km2)")



```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_fund_proj, type = "latex"),
      file = paste(tmp, "tbl_fund_proj_stat.tex", sep  ="/"))
print(xtable(tbl_fund_avg_ctry, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_ctry.tex", sep  ="/"))
print(xtable(tbl_fund_avg_dr, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_dr.tex", sep  ="/"))
print(xtable(data_fund_per_area_dr, type = "latex"),
      file = paste(tmp, "tbl_fund_per_area_dr.tex", sep  ="/"))
print(xtable(tbl_fund_per_area_wld, type = "latex"),
      file = paste(tmp, "tbl_fund_per_area_wld.tex", sep  ="/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Evolution of funding over time

```{r}
data_fund_year = data_stat_projet_nodupl %>%
  group_by(annee_octroi) %>%
  summarize(tot_fund = sum(montant_total_projet))

#Total funding for each year
fig_fund_year = ggplot(data = data_fund_year,
                       aes(x = annee_octroi, y = tot_fund)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  + geom_text(aes(y = tot_fund, label = format(tot_fund, scientific = TRUE, digits = 2)),
              color = "black", size=2.5, vjust = -0.3) %>%
  + labs(title = "Evolution du financement des aires protégées",
         x = "Année",
         y = "Montants octroyés (€)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#fig_fund_year


#Cumulative funding over time
fig_fund_year_cum = ggplot(data = data_fund_year,
                       aes(x = annee_octroi, y = cumsum(tot_fund))) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  + geom_text(aes(y = cumsum(tot_fund), label = format(cumsum(tot_fund), scientific = TRUE, digits = 2)),
              color = "black", size=2.5, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée du financement des aires protégées",
         x = "Année",
         y = "Montants octroyés (€)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_fund_year_cum

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_fund_year.png", sep = "/"),
       plot = fig_fund_year,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_fund_year_cum.png", sep = "/"),
       plot = fig_fund_year_cum,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Type of funding

Distribution of funding types

```{r}
tbl_type_prod = data_stat_projet_nodupl_utf8 %>%
  group_by(libelle_produit) %>%
  #number of PAs per funding type
  summarize(n_type = n()) %>%
  ungroup() %>%
  #Frequency of funding types
  mutate(n_pa = sum(n_type),
         freq = n_type/n_pa*100,
         libelle_produit = case_when(libelle_produit == "PRETS SOUVERAINS FMI COMPATIBLE" ~ "Prêts souverains FMI-compatible", TRUE ~ libelle_produit)) %>%
  arrange(desc(libelle_produit)) %>%
  select(-n_pa) %>%
  arrange(-freq)
names(tbl_type_prod) <- c("Type de financement","Projets", "Proportion (%)")


#Pie chart INcluding non-referenced PAs
pie_type_prod = ggplot(tbl_type_prod, 
                      aes(x="", y= freq, fill = libelle_produit)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, 
                         label = paste0(round(freq, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Type de financement") %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_type_prod


```

Average fund by funding type

```{r}

tbl_fund_avg_type = data_stat_projet_nodupl_utf8 %>%
  group_by(libelle_produit) %>%
  summarize(n_type = n(),
            tot_fund = sum(montant_total_projet)
            ) %>%
  mutate(n_pa = sum(n_type),
         freq_pa = round(n_type/n_pa*100, 1),
         freq_fund = round(tot_fund/sum(tot_fund)*100, 1),
         libelle_produit = case_when(libelle_produit == "PRETS SOUVERAINS FMI COMPATIBLE" ~ "Prêts souverains FMI-compatible", TRUE ~ libelle_produit)) %>%
  select(c(libelle_produit, n_type, freq_pa, tot_fund, freq_fund)) %>%
  arrange(-freq_pa)
names(tbl_fund_avg_type) = c("Type de financement","Projets", "Proportion d'AP (%)", "Montants (€)", "Proportion des montants (%)")

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_type_prod, type = "latex"),
      file = paste(tmp, "tbl_fund_type.tex", sep  ="/"))
print(xtable(tbl_fund_avg_type, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_type.tex", sep  ="/"))
ggsave(paste(tmp, "pie_type_prod.png", sep = "/"),
       plot = pie_type_prod,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Co-funders

```{r}
#Create a table with number of projects funded by AFD, FFEM and KfW. Total fundings and average funds are also reported
tbl_fund_cofunder = 
  data.frame(cof = c("AFD", "FFEM", "KfW"),
             n = c(nrow(subset(data_stat_projet_nodupl, afd == TRUE)), 
                   nrow(subset(data_stat_projet_nodupl, ffem_bin == TRUE)),
                   nrow(subset(data_stat_projet_nodupl, kfw_bin == TRUE))),
             fund_tot = c(
               sum(subset(data_stat_projet_nodupl, afd == TRUE)$montant_total_projet, na.rm = TRUE),
               sum(subset(data_stat_projet_nodupl, ffem_bin == TRUE)$montant_total_projet, na.rm = TRUE),
               sum(subset(data_stat_projet_nodupl, kfw_bin == TRUE)$montant_total_projet, na.rm = TRUE))
                               
                               ) %>%
  mutate(n_tot = nrow(data_stat_projet_nodupl),
         freq = round(n/n_tot*100, 3),
         fund_avg = fund_tot/n) %>%
  select(c(cof, n, n_tot, freq, fund_tot, fund_avg))
names(tbl_fund_cofunder) = c("Cofinancier", "Nombre projets", "Nombre total projets", "Prop. projets (%)","Montant total projets (€)","Montant moyen projets (€)")

#print(xtable(tbl_fund_cofunder, type = "latex"), file = "DesStat/funding/tbl_fund_cofunder.tex")


```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_fund_cofunder, type = "latex"),
      file = paste(tmp, "tbl_fund_cofunder.tex", sep  ="/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```
