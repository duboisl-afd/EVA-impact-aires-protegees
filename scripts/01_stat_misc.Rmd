# Miscellaneous statistics

In this document are performed and plotted statistics for particular needs (analysis of a particular portfolio, some specific group of PAs, etc.)

## Initial settings

Configuring Rmarkdown.

\#`{r setup, include=FALSE, eval = FALSE} #knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) #`

Installing and importing relevant packages.

```{r message=FALSE, warning=FALSE, eval = FALSE}
install.packages(c("stargazer", "janitor", "questionr", "countrycode", "WDI"))
library(tidyverse)
library(stargazer)
library(dplyr)
library(sf)
library(ggplot2)  
library(ggrepel)
library(RColorBrewer)
library(countrycode)
library(data.table)
#library(readxl)
#library(splitstackshape) 
library(janitor)
library(xtable)
library(questionr)
library(aws.s3)
library(WDI)
library(countrycode)
```

## Importing datasets

A dataset with information for each protected area funded by the AFD, and datasets on aggregated size at country/region/world level and by year. The latter takes into account potential overlap between PAs reported in the World Database on Protected Areas (WDPA).

```{r, eval = FALSE}
#Dataset of AFD supported protected area, with one line per protected area
data_stat_nodupl = 
  #fread("data_tidy/BDD_PA_AFD_nofund_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_PA_AFD_nofund_nodupl.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

# Portfolio of protected areas supported by the FAPBM
data_pa_fapbm = 
  #fread("data_tidy/BDD_PA_AFD_ie.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_FAPBM.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

#Import WDPA data
## Download and save data
# data_wdpa = wdpa_fetch(x = "global", wait = TRUE, download_dir = "data_raw",
#                        page_wait = 2, verbose = TRUE)
# st_write(wdpa,
#          dsn = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
#          delete_dsn = TRUE)
## Load data
data_wdpa = 
  #st_read("data_raw/wdpa/wdpa_shp_global_raw.gpkg") %>%
  s3read_using(sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = "")) %>%
  #st_drop_geometry() %>%
  clean_names() %>%
  #Add region, sub-region and country names 
  mutate(region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.region.name"),
         sub_region = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.regionsub.name"),
         country_en = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.en"),
         country_fr = countrycode(sourcevar = iso3,
                              origin = "iso3c",
                              destination = "un.name.fr"),
         .after = "iso3") 

#Subset of WDPA data for Madagascar, with IUCN category description (English and French)
data_wdpa_mdg = data_wdpa %>%
  filter(iso3 == "MDG") %>%
  #Add the description of IUCN from its category
    mutate(iucn_des_fr = case_when(
  !is.na(wdpaid) & iucn_cat == "Ia" ~ "Réserve naturelle intégrale",
  !is.na(wdpaid) & iucn_cat == "Ib" ~ "Zone de nature sauvage",
  !is.na(wdpaid) & iucn_cat == "II" ~ "Parc national", 
  !is.na(wdpaid) & iucn_cat == "III" ~ "Monument naturel",
  !is.na(wdpaid) & iucn_cat == "IV" ~ "Gest. des habitats/espèces",
  !is.na(wdpaid) & iucn_cat == "V" ~ "Paysage protégé",
  !is.na(wdpaid) & iucn_cat == "VI" ~ "Gest. de ress. protégées",
  !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Non catégorisée",
  TRUE ~ "Non référencée"), .after = iucn_cat) %>%
      mutate(iucn_des_en = case_when(
  !is.na(wdpaid) & iucn_cat == "Ia" ~ "Strict nature reserve",
  !is.na(wdpaid) & iucn_cat == "Ib" ~ "Wilderness area",
  !is.na(wdpaid) & iucn_cat == "II" ~ "National park",
  !is.na(wdpaid) & iucn_cat == "III" ~ "Natural monument or feature",
  !is.na(wdpaid) & iucn_cat == "IV" ~ "Habitat or species management area",
  !is.na(wdpaid) & iucn_cat == "V" ~ "Protected landscape or seascape",
  !is.na(wdpaid) & iucn_cat == "VI" ~ "Protected area with sust. use of nat. res.",
  !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Not categorized",
  !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Not categorized",
  !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Not categorized",
  TRUE ~ "Not referenced"), .after = iucn_cat) %>%
  st_drop_geometry()

#To perform statistics on the distribution of PAs reported by the WDPA across countries/regions, we focus on not high-income countries.
#Precisely, we restrict to countries defined as low-income, lower middle-income, upper-middle income, minus Russia, and including Chile, Uruguay New Caledonia and Panama
df_ctry_stat_wdpa = WDI(country = "all", start = "1960", end = "2022", extra = TRUE, language = "en") %>%
  group_by(iso3c) %>%
  slice(1) %>%
  ungroup() %>%
  select(c("iso3c", "income")) %>%
  rename("iso3" = "iso3c",
         "wb_inc_grp" = "income") %>%
  filter((wb_inc_grp %in% c("Low income",  "Lower middle income", "Upper middle income") & iso3 != "RUS") | iso3 %in% c("CHL", "URY", "PAN", "NCL"))

lst_ctry_stat_wdpa = df_ctry_stat_wdpa$iso3


```

## Performing descriptive statistics

### FAPBM portfolio and Madagascar

#### IUCN : non-marine

FAPBM

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_fapbm %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_fapbm %>%
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas funded by FAPBM")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas funded by FAPBM")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/FAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/MDG/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar protected areas without FAPBM funded protected areas.

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "non-marine, not FAPBM funded protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of non-marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "non-marine, not FAPBM funded protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/MDG_noFAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### IUCN : marine

FAPBM

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_pa_fapbm %>%
  filter(marine ==2) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_pa_fapbm %>%
  filter(marine == 2) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine protected areas funded by FAPBM")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
  + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "marine protected areas funded by FAPBM")) %>%
  #+ scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/FAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "marine protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/MDG/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar protected areas without FAPBM funded protected areas.

```{r, eval = FALSE}
#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(desc(iucn_des_en)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 


##... and for referenced PAs only
data_cat_iucn_ref = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  #Remove not referenced PAs
  subset(!(iucn_des_fr %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des_en, iucn_des_fr) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = round(n_iucn/n_pa*100, 2)) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Pie charts
pie_cat_iucn_en = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn$n_iucn), "marine, not FAPBM funded protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
      + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_en

pie_cat_iucn_ref_en = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des_en)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Distribution of marine protected areas by IUCN categories \nexcept for not categorized (%)",
         subtitle = paste("Sample :", sum(data_cat_iucn_ref$n_iucn), "out of", sum(data_cat_iucn$n_iucn),  "marine, not FAPBM funded protected areas in Madagascar")) %>%
  # + scale_fill_brewer(name = "Categories", palette = "Dark2") %>%
    + scale_fill_manual(name = "Categories",
                      values = c("Not categorized" = "#7570B3",
                                 "Habitat or species management area" = "#E7298A",
                                 "Protected landscape or seascape" = "#66A61E",
                                 "Protected area with sust. use of nat. res." = "#D95F02",
                                 "National park" = "#1B9E77",
                                 "Strict nature reserve" = "#E6AB02")) %>%
  + theme_void()
pie_cat_iucn_ref_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_cat_iucn_en.png", sep = "/"),
       plot = pie_cat_iucn_en,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref_en.png", sep = "/"),
       plot = pie_cat_iucn_ref_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/IUCN/MDG_noFAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Ecosystem

FAPBM funded protected areas.

```{r, eval = FALSE}

#Build datasets
data_eco = data_pa_fapbm %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas funded by the FAPBM"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  #+ scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/ecosysteme/FAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}

#Build datasets
data_eco = data_wdpa_mdg %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas in Madagascar"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  # + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/ecosysteme/MDG", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))

```

Madagascar without FAPBM

```{r, eval = FALSE}

#Build datasets
data_eco = data_wdpa_mdg %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 2)*100) %>%
  ungroup()

#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas in Madagascar, not funded by the FAPBM"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  # + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + scale_fill_manual(name = "Ecosystem",
                      values = c("Marine" = "#1F78B4",
                                 "Terrestrial" = "#B2DF8A",
                                 "Coastal" = "#A6CEE3")) %>%
  + theme_void()
pie_eco_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/ecosysteme/MDG_noFAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Governance : non-marine

FAPBM funded protected areas

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_fapbm %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_fapbm %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "non-marine protected areas funded by FAPBM")) %>%
  # + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas funded by FAPBM (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/FAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_wdpa_mdg %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas in Madagascar")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas in Madagascar (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/MDG/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar without FAPBM funded protected areas

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_wdpa_mdg %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_wdpa_mdg %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  filter(marine %in% c(0,1)) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of non-marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas in Madagascar, not funded by the FAPBM")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of non-marine protected areas in Madagascar, not funded by the FAPBM (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/MDG_noFAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Governance : marine

FAPBM funded protected areas

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_pa_fapbm %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_pa_fapbm %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas funded by FAPBM")) %>%
  # + scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en


```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine protected areas funded by FAPBM (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/FAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_wdpa_mdg %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas in Madagascar")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine protected areas in Madagascar (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/MDG/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar without FAPBM funded protected areas

```{r, eval = FALSE}

#Table of the governance type distribution
##English version
data_gov_en = data_wdpa_mdg %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_en = data_gov_en
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")


#PAs with nureported or unreferenced governance types are removed
##Tables
###English
data_gov_knwn_en = data_wdpa_mdg %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  filter(marine == 2) %>%
  mutate(gov_type = case_when(is.na(gov_type) == TRUE ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,1)) %>%
  select(-n_tot) %>%
  arrange(-freq)

tbl_gov_knwn_en = data_gov_knwn_en
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")


##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(data_gov_knwn_en, 
       aes(x="", y= freq, fill= gov_type)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(freq, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of marine protected areas \nexcept for not reported governance",
         subtitle = paste("Sample :", sum(data_gov_knwn_en$n), "out of", sum(data_gov_en$n), "protected areas in Madagascar, not funded by the FAPBM")) %>%
  #+ scale_fill_brewer(name = "Governance", palette="Paired") %>%
  + scale_fill_manual(name = "Governance",
                      values = c("Not Reported" = "#A6CEE3",
                                 "Local communities" = "#1F78B4",
                                 "Government-delegated management" = "#B2DF8A",
                                 "Non-profit organisations" = "#33A02C",
                                 "Collaborative governance" = "#FB9A99",
                                 "Federal or national ministry or agency" = "#E31A1C")) %>%
  + theme_void()
pie_gov_knwn_en
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_knwn_en, 
             caption = "Governance of marine protected areas in Madagascar, not funded by the FAPBM (when known)",
             type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))

ggsave(paste(tmp, "pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/gouvernance/MDG_noFAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Number of PAs

```{r, eval = FALSE}
#Statistics

## PAs in the WDAP
n_mdg = data_wdpa_mdg %>%
  filter(iso3 == "MDG") %>%
  nrow()
n_fapbm = data_pa_fapbm %>%
  filter(iso3 == "MDG") %>%
  nrow()

## PAs in the WDAP, not marine
n_mdg_nomarine = data_wdpa_mdg %>%
  filter(iso3 == "MDG" & marine %in% c(0,1)) %>%
  nrow()
n_fapbm_nomarine = data_pa_fapbm %>%
  filter(iso3 == "MDG" & marine %in% c(0,1)) %>%
  nrow()

## PA we can analyze with our methodology
yr_min = 2002
n_mdg_ie = data_wdpa_mdg %>%
  filter(iso3 == "MDG") %>%
  filter(status_yr >= yr_min & marine %in% c(0,1) & rep_area > 1 ) %>%
  nrow()
n_fapbm_ie = data_pa_fapbm %>%
  filter(iso3 == "MDG") %>%
  filter(status_yr >= yr_min & marine %in% c(0,1) & area_km2 > 1 ) %>%
  nrow()
```

#### Area of PAs : non-marine

FAPBM funded protected areas

```{r, eval = FALSE}

tbl_area_fapbm = data_pa_fapbm %>%
  filter(marine %in% c(0,1)) %>%
  summarize(n = n(),
            tot = format(sum(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(area_km2), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_fapbm) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_fapbm, 
             caption = "Statistics on non-marine protected areas funded by FAPBM",
             type = "latex"), 
      file = paste(tmp, "tbl_area_fapbm.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/FAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory 

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))  
```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}

tbl_area_mdg = data_wdpa_mdg %>%
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_mdg) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_mdg, 
             caption = "Statistics on non-marine protected areas in Madagascar",
             type = "latex"), 
      file = paste(tmp, "tbl_area_mdg.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/MDG/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar without FAPBM funded protected areas.

```{r, eval = FALSE}

tbl_area_mdg_nofapbm = data_wdpa_mdg %>%
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_mdg_nofapbm) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_mdg_nofapbm, 
             caption = "Statistics on non-marine protected areas in Madagascar, not funded by the FAPBM",
             type = "latex"), 
      file = paste(tmp, "tbl_area_mdg_nofapbm.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/MDG_noFAPBM/no_marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Area of PAs : marine

FAPBM funded protected areas

```{r, eval = FALSE}

tbl_area_fapbm = data_pa_fapbm %>%
  filter(marine == 2) %>%
  summarize(n = n(),
            tot = format(sum(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(area_km2), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(area_km2), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_fapbm) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_fapbm, 
             caption = "Statistics on marine protected areas funded by FAPBM",
             type = "latex"), 
      file = paste(tmp, "tbl_area_fapbm.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/FAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory 

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))  
```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = FALSE}

tbl_area_mdg = data_wdpa_mdg %>%
  st_drop_geometry() %>%
  filter(marine == 2) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_mdg) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_mdg, 
             caption = "Statistics on marine protected areas in Madagascar",
             type = "latex"), 
      file = paste(tmp, "tbl_area_mdg.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/MDG/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar without FAPBM funded protected areas.

```{r, eval = FALSE}

tbl_area_mdg_nofapbm = data_wdpa_mdg %>%
  st_drop_geometry() %>%
  filter(marine == 2) %>%
  filter(!(wdpaid %in% data_pa_fapbm$wdpaid)) %>%
  summarize(n = n(),
            tot = format(sum(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            min = format(min(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            max = format(max(rep_area), big.mark = ",", digits = 1, scientific = FALSE),
            mean = format(mean(rep_area), big.mark = ",", digits = 1, scientific = FALSE)
            )
names(tbl_area_mdg_nofapbm) = c("Number of PAs", "Total area (km²)", "Min. area (km²)", "Max. area (km²)", "Average area (km²)")
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_area_mdg_nofapbm, 
             caption = "Statistics on marine protected areas in Madagascar, not funded by the FAPBM",
             type = "latex"), 
      file = paste(tmp, "tbl_area_mdg_nofapbm.tex", sep = "/"))


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/surface/MDG_noFAPBM/marine", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

## Evolution of tree cover and deforestation

Tests : access to GFW via its API

```{r, eval = F}
install.packages(c("httr2", "jsonlite"))
library(httr)
library(httr2)
library(jsonlite)

#Obtain a token

##The request to perform
# curl --location --request POST 'https://data-api.globalforestwatch.org/auth/token' \ --header 'Content-Type: application/x-www-form-urlencoded' \ --data-urlencode 'username=antoine.vuillot@outlook.fr' \ --data-urlencode 'password=Av!!86451998'

##With httr2
# req_sign = request('https://data-api.globalforestwatch.org/auth/sign-up') %>%
#   req_headers("Content-Type" = "application/json") %>% 
#   req_body_json(list(name = "Antoine Vuillot", email = "antoine.vuillot@outlook.fr")) 
# resp_sign = req_perform(req_sign)
# 
# req_token = request('https://data-api.globalforestwatch.org/auth/token') %>%
#   req_headers("Content-Type" = "application/x-www-form-urlencoded") %>%
#   req_body_form(list("username = antoine.vuillot@outlook.fr", "password = Av!!86451998"))
# resp_token = req_perform(req_token)

##With httr
url_token = "https://data-api.globalforestwatch.org/auth/token"
#custom_headers = c("Content-Type" =  "application/x-www-form-urlencoded")
body_token = list(username = "vuillota@afd.fr", 
                  password = "Av!!86451998")

resp_token = httr::POST(url_token, 
                  body = body_token,
                  encode = "form") 
token = fromJSON(rawToChar(resp_token$content))$data$access_token

#Check token is still valid
## With httr
url_token_valid = "https://api.resourcewatch.org/auth/user/me"
resp_token_valid = httr::GET(url_token_valid,
                             body = body_token,
                             encode = "form")

#Create an API key

##The request to perform
# curl --location --request POST 'https://data-api.globalforestwatch.org/auth/apikey' \ --header 'Authorization: Bearer ey2923…\ --header 'Content-Type: application/json' \ --data-raw '{ "alias": "api-key-for-new-app", "email": "gfw.guides@yahoo.com", "organization": "GFW", "domains": [] }'

##With httr
url_api = "https://data-api.globalforestwatch.org/auth/apikey"
body_api = list(alias = "api-key-ie-ap",
                email = "vuillota@afd.fr",
                organization = "Agence Française de Développement")
resp_api = httr::POST(url_api,
                     add_headers("Authorization" = paste("Bearer", token, sep = " ")),
                     body = body_api,
                     encode = "json")
content(resp_api) #Error 500 Internal Server Error : try again ???

##With httr2
req_api = request('https://data-api.globalforestwatch.org/auth/apikey') %>%
  req_headers("Content-Type" = "application/json") %>%
  req_auth_bearer_token(token) %>%
  req_body_json(list("alias = api-key-ie-ap",
                     "email = vuillota@afd.fr", 
                     "organization = AFD",
                     "domains = []"))
resp_api = req_perform(req_api)
```

All protected areas in Madagascar (reported by the WDPA)

```{r, eval = F}
##2000 tree cover 
data_treecover_2000 = 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/GFW/MDG/treecover_extent_2000__ha.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

##Deforestation 2001-2022
data_treeloss = 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/GFW/MDG/treecover_loss__ha.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_plot_mdg = data_treeloss %>%
  left_join(data_treecover_2000, by = "iso") %>%
  rename("year" = "umd_tree_cover_loss__year",
         "loss_ha" = "umd_tree_cover_loss__ha",
         "emissions_Mg" = "gfw_gross_emissions_co2e_all_gases__Mg",
         "area_ha" = "area__ha",
         "treecover_2000_ha" = "umd_tree_cover_extent_2000__ha" 
         ) %>%
  arrange(year) %>%
  mutate(cum_loss = cumsum(loss_ha),
         treecover_ha_mdg = treecover_2000_ha - cum_loss,
         treecover_rel00_mdg = treecover_ha_mdg/treecover_2000_ha*100)

fig_treeloss_mdg = ggplot(data = data_plot_mdg,
                      aes(x = year, y = treecover_rel00_mdg)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover in Madagascar",
         subtitle = paste("Treecover in 2000 :", format(data_plot_mdg$treecover_2000_ha[1], digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_mdg
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_mdg.png", sep = "/"),
       plot =  fig_treeloss_mdg,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/all", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

FAPBM funded protected areas.

```{r, eval = FALSE}
#Filter the WDPA to non-marine PAs in MDG funded by the FAPBM
wdpa_fapbm = data_wdpa %>%
  filter(iso3 == "MDG" & marine %in% c(0,1) & st_geometry_type(geom) == "MULTIPOLYGON" & wdpaid %in% unique(data_pa_fapbm$wdpaid)) %>%
  st_make_valid() %>%
  st_cast(to = "POLYGON") %>%
  mutate()

#Download the data with the MAPME package 
data.tree.fapbm = init_portfolio(wdpa_fapbm,
                     years = 2000:2022,
                     add_resources = FALSE) %>%
  get_resources(resources = c("gfw_treecover", "gfw_lossyear")) %>%
  calc_indicators(indicators = "treecover_area",
                  min_size=1, # indicator-specific argument
                  min_cover=10) %>%
  unnest(treecover_area) %>%
  drop_na(treecover) %>% #get rid of units with NA values 
  mutate(across(c("treecover"), \(x) round(x, 3))) %>% # Round numeric columns
  pivot_wider(names_from = "years", values_from = "treecover", names_prefix = "treecover_") %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup()

#Build a plotting dataset
data_plot_fapbm = data.tree.fapbm %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup() %>%
  mutate(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  slice(1) %>%
  # mutate(across(.cols = starts_with("treecover"),
  #                .fns = ~.x/treecover_2000*100))  %>%
  pivot_longer(cols = c(starts_with("treecover")),
               names_to = c("var", "year"),
               names_sep = "_",
               values_to = "treecover_ha_fapbm") %>%
  mutate(treecover_rel00_fapbm = treecover_ha_fapbm/treecover_ha_fapbm[year == 2000]*100) %>%
  select(c(year, treecover_ha_fapbm, treecover_rel00_fapbm)) %>%
  mutate(year = as.numeric(year)) 
  

fig_treeloss_fapbm = ggplot(data = data_plot_fapbm,
                      aes(x = year, y = treecover_rel00_fapbm)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover in FAPBM funded protected areas",
        subtitle = paste("Treecover in 2000 :", format(data_plot_fapbm[data_plot_fapbm$year == 2000,]$treecover_ha_fapbm, digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_fapbm

# aws.s3::s3write_using(
# FUN = data.table::fwrite,
# data.tree.fapbm,
# # Mettre les options de FUN ici
# object = "data_tidy/GFW/MDG/FAPBM/data_treecover_2000_2022.csv",
# bucket = "projet-afd-eva-ap",
# opts = list("region" = ""))

```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_fapbm.png", sep = "/"),
       plot =  fig_treeloss_fapbm,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/FAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Madagascar protected areas without FAPBM funded ones.

```{r, eval = FALSE}

wdpa_nofapbm = data_wdpa %>%
  filter(iso3 == "MDG" & marine %in% c(0,1) & st_geometry_type(geom) == "MULTIPOLYGON" & !(wdpaid %in% unique(data_pa_fapbm$wdpaid))) %>%
  st_make_valid() %>%
  st_cast(to = "POLYGON")

data.tree.nofapbm = init_portfolio(wdpa_nofapbm,
                     years = 2000:2022,
                     add_resources = FALSE) %>%
  get_resources(resources = c("gfw_treecover", "gfw_lossyear")) %>%
  calc_indicators(indicators = "treecover_area",
                  min_size=1, # indicator-specific argument
                  min_cover=10) %>%
  unnest(treecover_area) %>%
  drop_na(treecover) %>% #get rid of units with NA values 
  mutate(across(c("treecover"), \(x) round(x, 3))) %>% # Round numeric columns
  pivot_wider(names_from = "years", values_from = "treecover", names_prefix = "treecover_") %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%   
  ungroup()

aws.s3::s3write_using(
FUN = data.table::fwrite,
data.tree.nofapbm,
# Mettre les options de FUN ici
object = "data_tidy/GFW/MDG/noFAPBM/data_treecover_2000_2022.csv",
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))

data_plot_nofapbm = data.tree.nofapbm %>%
  st_drop_geometry() %>%
  group_by(wdpaid) %>%
  summarize(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  ungroup() %>%
  mutate(across(.cols = starts_with("treecover"),
                   .fns = ~sum(.x, na.rm = TRUE))) %>%
  slice(1) %>%
  # mutate(across(.cols = starts_with("treecover"),
  #                .fns = ~.x/treecover_2000*100))  %>%
  pivot_longer(cols = c(starts_with("treecover")),
               names_to = c("var", "year"),
               names_sep = "_",
               values_to = "treecover_ha_nofapbm") %>%
  mutate(treecover_rel00_nofapbm = treecover_ha_nofapbm/treecover_ha_nofapbm[year == 2000]*100) %>%
  select(c(year, treecover_ha_nofapbm, treecover_rel00_nofapbm)) %>%
  mutate(year = as.numeric(year)) 
  

fig_treeloss_nofapbm = ggplot(data = data_plot_nofapbm,
                      aes(x = year, y = treecover_rel00_nofapbm)) %>%
  + geom_line(color = "#3182BD") %>%
  + geom_point(color = "#3182BD") %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover, in protected areas not FAPBM funded",
        subtitle = paste("Treecover in 2000 :", format(data_plot_nofapbm[data_plot_nofapbm$year == 2000,]$treecover_ha_nofapbm, digits = 1, big.mark = ",", scientific = F), "ha"),
         caption = "Data : Global Forest Watch") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_nofapbm
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_nofapbm.png", sep = "/"),
       plot =  fig_treeloss_nofapbm,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG/noFAPBM", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

Plotting the evolution of forest cover in Madagascar, FAPBM funded and not FAPMB funded protected areas in the same figure.

```{r, eval = FALSE}
data_plot_all = data_plot_fapbm %>%
  left_join(data_plot_nofapbm, by = "year") %>%
  left_join(select(data_plot_mdg, c(year, treecover_ha_mdg, treecover_rel00_mdg)), by = "year") %>%
  mutate(treecover_rel00_mdg = case_when(is.na(treecover_rel00_mdg) == TRUE ~ 100,
                   TRUE ~ treecover_rel00_mdg),
         treecover_ha_mdg = case_when(is.na(treecover_ha_mdg) == TRUE ~ data_plot_mdg$treecover_2000_ha[1],
                   TRUE ~ treecover_ha_mdg))
#CARFEUL NEED TO RENAME VARIABLES   

fig_treeloss_all =  ggplot(data_plot_all,
                           aes(x = year)) %>%
  + geom_line(aes(y = treecover_rel00_mdg, color = "Madagascar")) %>%
  + geom_point(aes(y = treecover_rel00_mdg, color = "Madagascar")) %>%
  + geom_line(aes(y = treecover_rel00_nofapbm, color = "Not FAPBM")) %>%
  + geom_point(aes(y = treecover_rel00_nofapbm, color = "Not FAPBM")) %>%
  + geom_line(aes(y = treecover_rel00_fapbm, color = "FAPBM")) %>%
  + geom_point(aes(y = treecover_rel00_fapbm, color = "FAPBM")) %>%
  + scale_color_manual(name = "", values = c("Madagascar" = "grey50",
                                  "Not FAPBM" = "#DE2D26",
                                  "FAPBM" = "#31A354")) %>%
  + labs(x = "", y = "% of 2000 tree cover", 
         title = "Evolution of forest cover",
        caption = paste("Data : Global Forest Watch\nTreecover in 2000 :", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_mdg, digits = 1, big.mark = ",", scientific = F), "ha in Madagascar,", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_fapbm, digits = 1, big.mark = ",", scientific = F), "ha of FAPBM funded protected areas and", format(data_plot_all[data_plot_all$year == 2000,]$treecover_ha_nofapbm, digits = 1, big.mark = ",", scientific = F), "ha of non-funded.")) %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white',  
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain', hjust = 0))
fig_treeloss_all
```

```{r, eval = FALSE}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_treeloss_all.png", sep = "/"),
       plot =  fig_treeloss_all,
       device = "png",
       height = 6, width = 9)


#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/descriptive_stats/GFW/MDG", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

## Forest cover by country

Import and clean the dataset

```{r}
#Dataset of forest as a share of land for each country
data_fc = 
  #fread("data_tidy/BDD_PA_AFD_nofund_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/misc/treecover_extent_2010_ha_GFW.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  clean_names() %>%
  rename("iso3" = "iso",
         "fc_2010_ha" = "umd_tree_cover_extent_2010_ha",
         "area_land_ha" = "area_ha") %>%
  # pivot_wider(names_from = "year",
  #              values_from = "fc_per") %>%
  filter(iso3 != "") %>%
  mutate(region = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.region.name"),
       sub_region = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.regionsub.name"),
       country_en = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.name.en"),
       country_fr = countrycode(sourcevar = iso3,
                            origin = "iso3c",
                            destination = "un.name.fr"),
       .after = "iso3") %>%
  mutate(fc_2010_km2 = 0.01*fc_2010_ha,
         area_land_km2 = 0.01*area_land_ha,
         fc_2010_per = fc_2010_ha/area_land_ha*100)

#Non-marine PA funded by the AFD : # and total area by country
## Non-marine
data_pa_afd = data_stat_nodupl %>% 
  filter(marine %in% c(0,1)) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_afd = n(),
            area_afd_km2 = sum(area_km2)) %>%
  ungroup()
## Non-marine we can analyse
data_pa_afd_ie = data_stat_nodupl %>% 
  filter(marine %in% c(0,1) & area_km2 >= 1 & status_yr >= 2002 & status != "Proposed" & is.na(wdpaid) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_afd_ie = n(),
            area_afd_ie_km2 = sum(area_km2)) %>%
  ungroup()

#Non-marine PA reported in the WDPA worldwide: # and total area by country
## Non-marine
data_pa_wdpa = data_wdpa %>% 
  st_drop_geometry() %>%
  filter(marine %in% c(0,1)) %>%
  filter(grepl(";", iso3) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_wdpa = n(),
            area_wdpa_km2 = sum(rep_area)) %>%
  ungroup()
## Non-marine we can analyse
data_pa_wdpa_ie = data_wdpa %>% 
  st_drop_geometry() %>%
  filter(marine %in% c(0,1) & rep_area >= 1 & status_yr >= 2002 & status != "Proposed" & is.na(wdpaid) == FALSE) %>%
  filter(grepl(";", iso3) == FALSE) %>%
  group_by(region, iso3, country_en) %>%
  summarize(n_wdpa_ie = n(),
            area_wdpa_ie_km2 = sum(rep_area)) %>%
  ungroup()

data_fc_africa =  data_fc %>%
  filter(region == "Africa") %>%
  left_join(dplyr::select(data_pa_afd, c(iso3, n_afd, area_afd_km2)), by = "iso3") %>%
  left_join(dplyr::select(data_pa_wdpa, c(iso3, n_wdpa, area_wdpa_km2)), by = "iso3") %>%
    left_join(dplyr::select(data_pa_afd_ie, c(iso3, n_afd_ie, area_afd_ie_km2)), by = "iso3") %>%
  left_join(dplyr::select(data_pa_wdpa_ie, c(iso3, n_wdpa_ie, area_wdpa_ie_km2)), by = "iso3")
```

Perform plots

```{r}
tbl_fc_africa = data_fc_africa %>%
  # filter(year %in% c(2000, 2010, 2020)) %>%
  dplyr::select(c(country_en, iso3, area_land_km2, n_wdpa, n_wdpa_ie, n_afd, n_afd_ie, area_wdpa_km2, area_wdpa_ie_km2, area_afd_km2, area_afd_ie_km2, fc_2010_per)) %>%
  mutate(country_en = case_when(iso3 == "MYT" ~ "Mayotte",
                             iso3 == "SHN" ~ "Saint Helena",
                             iso3 == "ESH" ~ "Western Sahara",
                             iso3 == "ATF" ~ "French Southern and Antarctic Lands",
                             iso3 == "REU" ~ "Reunion",
                             TRUE ~ country_en),
        per_pa_afd = case_when(is.na(area_afd_km2) == TRUE ~ "/",
                               is.na(area_afd_km2) == F ~ format(area_afd_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
         per_pa_wdpa = case_when(is.na(area_wdpa_km2) == TRUE ~ "/",
                                 is.na(area_wdpa_km2) == F ~ format(area_wdpa_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
        per_pa_afd_ie = case_when(is.na(area_afd_ie_km2) == TRUE ~ "/",
                               is.na(area_afd_ie_km2) == F ~ format(area_afd_ie_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
         per_pa_wdpa_ie = case_when(is.na(area_wdpa_ie_km2) == TRUE ~ "/",
                                 is.na(area_wdpa_ie_km2) == F ~ format(area_wdpa_ie_km2/area_land_km2*100, digits = 1, big.mark = ",", scientific = F)),
          included = case_when(fc_2010_per >= 5 & n_wdpa > 0 & area_wdpa_km2 > 0 ~ "Included",
                     fc_2010_per < 1 & (n_wdpa == 0 | area_wdpa_km2 == 0) ~ "Excluded",
                     fc_2010_per < 5 & n_wdpa > 0 & area_wdpa_km2 > 0 ~ "?"),
        area_land_km2 = format(area_land_km2, digit = 1, big.mark = ",", scientific = F),
         # area_afd_km2 = case_when(is.na(area_afd_km2) == TRUE ~ "/",
         #                          is.na(area_afd_km2) == F ~ format(area_afd_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_wdpa_km2 = case_when(is.na(area_wdpa_km2) == TRUE ~ "/",
         #                          is.na(area_wdpa_km2) == F ~ format(area_wdpa_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_afd_ie_km2 = case_when(is.na(area_afd_ie_km2) == TRUE ~ "/",
         #                          is.na(area_afd_ie_km2) == F ~ format(area_afd_ie_km2, digits = 1, big.mark = ",", scientific = F)),
         # area_wdpa_ie_km2 = case_when(is.na(area_wdpa_ie_km2) == TRUE ~ "/",
         #                          is.na(area_wdpa_ie_km2) == F ~ format(area_wdpa_ie_km2, digits = 1, big.mark = ",", scientific = F)),
         n_afd = as.character(n_afd),
         n_wdpa = as.character(n_wdpa),
         n_afd_ie = as.character(n_afd_ie),
         n_wdpa_ie = as.character(n_wdpa_ie),
         fc_2010_per = as.character(round(fc_2010_per, 1))
                             ) %>%
  replace_na(replace = list("n_afd" = "/",
                            "n_wdpa" = "/",
                            "n_afd_ie" = "/",
                            "n_wdpa_ie" = "/",
                            # "area_afd_km2" = "/",
                            # "area_wdpa_km2" = "/",
                            "included" = "Excluded",
                            "fc_2010_per" = "/")) %>%
  # group_by(iso3) %>%
  # pivot_wider(names_from = "year",
  #              values_from = "fc_per",
  #             names_prefix = "FC (%) in ") %>%
  # ungroup() %>%
  select(c(country_en, iso3, area_land_km2, n_wdpa, n_wdpa_ie, n_afd, n_afd_ie, per_pa_wdpa, per_pa_wdpa_ie, per_pa_afd, per_pa_afd_ie, fc_2010_per, included)) %>%
  rename("AFD (#)" = "n_afd",
         "AFD (#, IE)" = "n_afd_ie",
         "Total #" = "n_wdpa",
         "Total # (IE)" = "n_wdpa_ie",
         "AFD (%)" = "per_pa_afd",
         "AFD (%, IE)" = "per_pa_afd_ie",
         "Total (%)" = "per_pa_wdpa",
         "Total (%, IE)" = "per_pa_wdpa_ie",
         # "AFD (km²)" = "area_afd_km2",
         # "AFD (km², IE)" = "area_afd_ie_km2",
         # "Total (km²)" = "area_wdpa_km2",
         # "Total (km², IE)" = "area_wdpa_ie_km2",
         "Land area (km²)" = "area_land_km2",
         "Code" = "iso3",
         "Country" = "country_en",
         "Forest cover in 2010 (%)" = "fc_2010_per",
         "Analysis" = "included"
         ) %>%
  arrange(-as.numeric(`Forest cover in 2010 (%)`))
  # replace_na(replace = list("FC in 2010 (%)" = "/",
  #                           "FC (%) in 2020" = "/")) 

a = ggplot(tbl_fc_africa, aes(x = Code, y = `Total #`)) %>%
  + geom_line()
```

Save

```{r}
tmp = paste(tempdir(), "fig", sep = "/")

  ggsave(paste(tmp, "a.png", sep = "/"),
         plot = a,
         device = "png",
         height = 8, width = 12)

print(xtable(tbl_fc_africa, 
             type = "latex", 
             auto = T,
             caption = "Data source: Global Forest Watch. Protected areas (PA) considered are reported in the WDPA and terrestrial or coastal. IE : restriction to PA we can analysis ($>1km^2$, created after 2002, without 'proposed' status). Analysis : included if forest cover (FC) above 5% and at least one PA and total area non-null; excluded if forest cover below 1% and no PA reported/null total area reported; unknown (?) if forest cover below 5% and at least one PA reported/non-zero total area."),
      include.rownames=FALSE,
      file = paste(tmp, "tbl_fc_africa.tex", sep = "/"))

files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
{
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                    bucket = "projet-afd-eva-ap/descriptive_stats/misc/forest_cover",
                     region = "", show_progress = TRUE)
}
do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Maps of Geo4Impact results

```{r, eval = F}

#Loading directory
load_dir = paste("impact_analysis/did", "2023-10-23", sep = "/")
save_dir = paste("descriptive_stats/misc/map_att")

#Import datasets
## The sample
data_pa =
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_africa.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

data_pa2 = data_pa %>%
  dplyr::select(c(wdpaid, wdpa_pid, iso3, name, status_yr, status, iucn_cat, marine, gov_type, year_funding_first, year_funding_all)) %>%
  rename("treatment_year" = "status_yr")

## WDPA 
wdpa_wld_raw = s3read_using(
              sf::st_read,
              object = "data_raw/wdpa/wdpa_shp_global_raw.gpkg",
              bucket = "projet-afd-eva-ap",
              opts = list("region" = ""))
wdpa_poly = wdpa_wld_raw %>%
  st_as_sf() %>%
  dplyr::select(c(WDPA_PID, geom))

## Treatment effects computed from the sample
### After non-academic filtering (cf DiD)
df_fc_att_tidy_noaca = aws.s3::s3read_using(
FUN = data.table::fread,
object = paste(load_dir, "df_fc_att_tidy_noaca.csv", sep = "/"),
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))

### For PA out of focus
df_fc_att_tidy_noaca_nofocus = df_fc_att_tidy_noaca %>%
  filter(focus == F & time %in% c(5,10)) %>%
  dplyr::select(c(wdpaid, time, att_per, sig)) %>%
  pivot_wider(names_from = "time",
              values_from = c("att_per", "sig"))

## Treatment effects computed for Geo4Impact presentation, performed 2023-08-29
### The more recent version of the code are not compatible with the computation of the TE on this folder. Then, I create manually a dataset with computed treatment effects
df_fc_att_geo4impact = data.frame(wdpaid = c(1240, 555547995, 15089, 9035, 555705345, 72324, 303873, 903025, 903026, 903129, 317051, 342655, 478033, 555651504, 902838),
                                  att_per_5 = c(0.140, -0.325, 0.151, -0.085,  -0.318, 0.017, 0.005,  0.621,  0.331, -0.191, -2.988,  0.162,  0.407, -2.392,  1.071),
                                  sig_5 = c(TRUE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, TRUE, TRUE, TRUE, FALSE, TRUE, FALSE, FALSE),
                                  att_per_10 = c(0.443,  -0.891, 0.259, -0.132, -1.478,  0.009, 0.017, 1.618, 1.084, -0.082, NA, -0.130, 1.620, NA, 2.123),
                                  sig_10 = c(TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, FALSE, FALSE, TRUE, FALSE, NA, FALSE, TRUE, NA, TRUE ))

#Create a dataset to map results
df_map_fc_att_tidy_noaca_geo4impact = df_fc_att_geo4impact %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))
  
df_map_fc_att_tidy_noaca_nofocus = df_fc_att_tidy_noaca_nofocus %>%
  left_join(data_pa2, by = "wdpaid") %>% 
  left_join(wdpa_poly, by = c("wdpa_pid" = "WDPA_PID"))

#Save datasets
## GEo4Impact
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_geo4impact,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_geo4impact.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
## Non-focus PA
aws.s3::s3write_using(
FUN = sf::st_write,
df_map_fc_att_tidy_noaca_nofocus,
object = paste(save_dir, "df_map_fc_att_tidy_noaca_nofocus.gpkg", sep = "/"), 
bucket = "projet-afd-eva-ap",
opts = list("region" = ""))
```
