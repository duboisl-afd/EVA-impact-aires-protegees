# (PART\*) Impact analysis {.unnumbered}

# Difference-in-difference

In this script, the treatment effect are computed from the control and treated units defined from the matching process. The treatment effect are first computed at PA level, then aggregated at country, region and world level to obtain average treatement effects.

DESCRIPTION

## Initial settings

```{r setup, include=FALSE, eval = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

```{r, eval = FALSE}
#Install some libraries
install.packages(c("tictoc", "fixest", "cobalt", "future", "progressr", "did"))

# Load Libraries
library(dplyr)
library(tictoc) #For timing
library(xtable)
library(tidyr)
library(stringr)
library(ggplot2) # For plotting
library(RColorBrewer)
library(ggrepel)
library(aws.s3)
library(fixest) #For estimating the models
library(did)
```

```{r message=FALSE, warning=FALSE, eval = FALSE}
#Import functions
source("scripts/functions/02_fns_did.R")
```

```{r}
#Saving directories
##Temporary
tmp_did = paste(tempdir(), "did", sep = "/")
##SSPCloud
# save_dir = paste("impact_analysis/matching", Sys.Date(), sep = "/")
load_dir = paste("impact_analysis/matching", "2023-08-29", sep = "/")
save_dir = paste("impact_analysis/did", "2023-08-29", sep = "/")

#Load data 
data_pa = 
  #fread("data_tidy/BDD_PA_AFD_ie.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  object = "data_tidy/BDD_PA_AFD_ie.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  #Sangha trinational (555547988) created in 2012 actually gathers three former PAs 
  #in CAF (31458), CMR (1245) and COG (72332) implemented in 
  #1990, 2001 and 1993 respectively.
  # Evaluating the trinational PA is not relevant here : our method relies on pre-treatment obervsations (for matching and DiD) and the outcome is likely to be affected by the initial PAs. On the other hand, evaluating the three earlier PAs might be irrelevant for us : are they funded by the AFD ?? In a first approach, the trinational is removed.
  filter(is.na(wdpaid) == TRUE | wdpaid != 555547988)

list_iso = c("CMR")

#Specify the period of study to create the mapme.bidiversity portfolio
## Start year
yr_first = 2000
## End year
yr_last = 2021

#Minimum treatment year
#At least two pre-treatment periods of forest cover are needed to compute average pre-treatment deforestation
yr_T_min = yr_first+2
yr_T_max = yr_last
```

## Computing treatment effects at PA level

```{r}
#For each country in the list, the different steps of the pre-processing are performed
count_i = 0 #Initialize counter
max_i = length(list_iso) #Max value of the counter
tic = tic() #Start timer
#Initialize a dataframe to store ATT  of all PA analyzed
df_fc_att = data.frame() #Effect on forest cover
df_fl_att = data.frame() #Effect on deforestation relative to 2000

for (i in list_iso)
{
  #Update counter and show progress
  count_i = count_i+1
  print(paste0(i, " : country ", count_i, "/", max_i))
  
  #Load the matching frame
  print("--Loading the list of PAs in the country considered")
  df_pa_i = fn_did_list_pa(iso = i, load_dir = load_dir)
  list_pa_i = df_pa_i$wdpaid
  
  count_j = 0
  max_j = length(list_pa_i)
  
  for(j in list_pa_i)
  {
    
    count_j = count_j+1
    print(paste0("WDPA ID ", j, " : ", count_j, "/", max_j))
    
    #Load the datasets
    print("--Loading the working datasets")
    df_j = fn_did_load_df(iso = i,
                          wdpaid = j, 
                          load_dir = load_dir,
                          ext_input = ".csv")
    
    df_wide_m_j = df_j$df_matched_wide
    df_long_m_j = df_j$df_matched_long
    df_wide_unm_j = df_j$df_unmatched_wide
    df_long_unm_j = df_j$df_unmatched_long
    
    #Compute treatment effects
    print("--Compute treatment effects")
    df_att_j = fn_did_att(iso = i, wdpaid = j, 
                      df_long_m = df_long_m_j,
                      alpha = 0.05,
                      save_dir = save_dir)
    
    df_fc_att = rbind(df_fc_att, df_att_j$df_fc_att)
    df_fl_att = rbind(df_fl_att, df_att_j$df_fl_att)
    
    #Ensuite :
    ## Mettre sous une forme pre/post traitement
    ## Calculer did pour pre/post -> voir ce que j'ai fait pour MT
    ## Bootstrap à mettre en place(+ tard)
    ## Faire graphe pre/post
    ## Le df avec TE doit être retourné pour chaque AP, pour ensuite être aggrégée au niveau pays
  }

    # A faire
  ## Agréger au niveau pays les TE, avec CI à calculer 
  ## Ensuite, agréger niveau DR/monde
  
}

toc = toc()


avg_att_fc = df_fc_att %>%
  group_by(region, iso3, time) %>%
  summarize(n_obs = n(),
            att_mean = mean(att, na.rm = TRUE))
avg_att_fl = df_fl_att %>%
  group_by(region, iso3, time) %>%
  summarize(n_obs = n(),
            att_mean = mean(att, na.rm = TRUE))
```
