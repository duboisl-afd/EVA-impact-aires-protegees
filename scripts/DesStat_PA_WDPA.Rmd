---
title: "DesStat_PA_WDPA"
author: "Antoine Vuillot"
date: "12/06/2023"
output: 
  html_document: 
    fig_caption: yes
editor_options: 
  chunk_output_type: inline
---

# Descriptive statistics

In this document are performed and plotted descriptive statistics from the datasets built in buildingDB_PA_WDPA. The following statistics are derived :

-   Distribution of parcels among IUCN categories, at country, region and world level.
-   Distribution in terms of ecosystems
-   Distribution of PAs across countries and regions

## Importing packages

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=FALSE, warning=FALSE}

library(tidyverse)
library(stargazer)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(data.table)
#library(readxl)
#library(splitstackshape) 
library(janitor)
library(xtable)
library(questionr)
library(tidyterra)
library(terra)
library(sf)
library(mapview)
library(aws.s3)
```

## Importing datasets

```{r}
#Both datasets are imported also in UTF8 encoding, for some variables
##A first dataset with some PA on more than one row (one line per funding for instance)
data_stat = 
  #fread("data_tidy/BDD_DesStat.csv", encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_DesStat_pub.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

##A second dataset with one line per PA, more suited for some statistics
data_stat_nodupl = 
  #fread("data_tidy/BDD_DesStat_nodupl.csv" , encoding = "UTF-8")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_DesStat_nodupl_pub.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))

base_nodupl_lea = 
  #fread("data_tidy/base_nodupl_lea.xlsx")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_DesStat_nodupl_lea_pub.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  select(any_of(names(data_stat_nodupl)))
  
#import a dataset with country anmes and corresponding ISO3 code
data_iso = data_stat %>%
  select(c(pays, iso3)) %>%
  group_by(iso3) %>%
  slice(1)

base_nodupl_old = 
  #fread("data_tidy/base_nodupl_old.csv") 
  aws.s3::s3read_using(
  FUN = data.table::fread,
  encoding = "UTF-8",
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_DesStat_nodupl_old_pub.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = ""))%>%
  select(any_of(names(data_stat_nodupl))) %>%
  select(-iso3) %>%
  left_join(data_iso, by = "pays") %>%
  mutate(iso3 = case_when(
    pays %in% c("Mayotte", "P-N N.Caléd", "P-S N.Caléd", 
                "Polynesie Francaise", "Nlle Caledonie") ~ "FRA",
    pays == "Multi-Pays" ~ "ZZ",
    !(pays %in% c("Mayotte", "P-N N.Caléd", "P-S N.Caléd", 
                "Polynesie Francaise", "Nlle Caledonie", "Multi-Pays")) ~ iso3
  ))
  
# projet_nodupl_old = 
#   #readxl::read_xlsx("data_tidy/projet_nodupl_old.xlsx")
#   aws.s3::s3read_using(
#   FUN = readxl::read_xlsx,
#   # Mettre les options de FUN ici
#   object = "data_tidy/projet_nodupl_old.xlsx",
#   bucket = "projet-afd-eva-ap",
#   opts = list("region" = ""))

bdd_joint = 
  #fread("data_raw/BDD_joint.xlsx")
  aws.s3::s3read_using(
  FUN = data.table::fread,
  # Mettre les options de FUN ici
  encoding = "UTF-8",
  object = "data_tidy/BDD_joint_tidy_pub.csv",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  select(any_of(names(data_stat_nodupl)))



```

```{r}
#Tests : save image

#Créer le plot
gg <- data_stat_nodupl %>% 
  ggplot(aes(annee_octroi, superficie)) +
  geom_point(show.legend = FALSE) 

# Création du fichier png dans dossier temp -------------------------------------------------
#Sauver le plot dans un dossier temp
#Permet de ne pas stocker sur le github des images/datasets !
tmp = tempfile()
file1 <- paste(tmp, "test.png", sep = "/")
ggsave(file1, plot = gg, device = "png")

# Export S3 ---------------------------------------------------------------

#On récupère la liste des fichiers stockés dans le temp
files <- list.files(tmp, full.names = TRUE)
#Par une boucle, on upload chaque fichier du temp
for(f in files) {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     object = "test2.png",
                     bucket = "projet-afd-eva-ap/DesStat", 
                     region = "", show_progress = TRUE)
}
#On peut alors effacer le temp, pour stocker d'autres fichiers à sauvegarder par la suite !
#do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

```{r}
#Test : differences between Léa's figures and my results

#PA identified with unique WDPAID. If more than 1 WDPAID, take the earlier annee_octroi
base_id = data_stat %>% 
  filter(!is.na(wdpaid)) %>% 
  group_by(wdpaid) %>% 
  arrange(annee_octroi) %>%
  slice(1) %>%
  ungroup()

base_old_id = base_nodupl_old %>% 
  filter(grepl("NA", wdpaid) == FALSE)  %>%
  group_by(wdpaid) %>% 
  slice(1) %>%
  mutate(wdpaid = as.numeric(wdpaid)) %>%
  ungroup()

#Identify PA in common among them with WDPAID reported
test_id = base_old_id %>%
  select(c(id_projet, nom_du_projet, nom_ap, id_concours, wdpaid)) %>%
  left_join(select(base_id, 
                   c(id_projet, nom_du_projet, nom_ap, id_concours, wdpaid)),
            by = "wdpaid")

#PA whose WDPAID is unknown, identified by id1 uniquely
base_na = data_stat %>% filter(is.na(wdpaid)) %>%
  mutate(id1 = paste(id_projet, iso3, nom_ap, sep = "_"),
         .before = id_projet) %>%
  group_by(id1) %>%
  arrange(annee_octroi) %>%
  slice(1) %>%
  ungroup()

base_old_na = base_nodupl_old %>% 
  filter(grepl("NA", wdpaid) == TRUE) %>%
  mutate(id1 = paste(id_projet, iso3, nom_ap, sep = "_"),
         .before = id_projet) %>%
  group_by(id1) %>%
  arrange(annee_octroi) %>%
  slice(1) %>%
  ungroup()

test_na = base_na %>%
  select(c(id1, id_projet, nom_du_projet, nom_ap, id_concours)) %>%
  left_join(select(base_old_na, 
                   c(id1, id_projet, nom_du_projet, nom_ap, id_concours)),
            by = "id1")

nrow(test_na %>% subset(is.na(id_projet.y) == TRUE))

#base_nodupl

base_nodupl = rbind(select(base_na, -id1), base_id)
```

## Computing total area at country, region and world level

Knowing the total area covered by PAs at different level of aggregation is interesting per se. It is also necessary to compute several statistics (e.g average funding by unit of area). According to the WDPA documentation, it is likely that some reported polygons overlap. Simply summing the areas would thus lead to a biased estimate of the total area at a given level of aggregation. We follow the procedure of the WDPA (<https://www.protectedplanet.net/en/resources/calculating-protected-area-coverage>). Our case is simpler as all of the PAs we consider are given a polygon.

1.  The layer is converted to Mollweide (an equal area projection) and the area of each polygon is calculated, in km2.

2.  Intersection of polygons and the corresponding area are computed.

3.  Then the intersection can be aggregated at country, region or world level. Then it is subtracted to the sum of areas at country, region or world level. Note that intersections between PAs whose polygon is unknown won't be taken into account.

### Computations of polygons' area

```{r message=FALSE, warning=FALSE}

#Importing shapefiles
sf_use_s2(FALSE)
pa_shp = 
  #read_sf("data_tidy/BDD_SHP_nodupl_pub.gpkg") %>%
  aws.s3::s3read_using(
  FUN = sf::read_sf,
  # Mettre les options de FUN ici
  object = "data_tidy/BDD_SHP_nodupl_pub.gpkg",
  bucket = "projet-afd-eva-ap",
  opts = list("region" = "")) %>%
  st_make_valid() %>%
  #From multipolygon to polygon
  sf::st_cast(to="POLYGON") %>%
  clean_names() %>%
  #Select relevant variables
  #Note ann_c = annee_octroi
  dplyr::select(c(wdpaid, sprfc, rep_a, gis_a, geom, iso3, drct, ann_c)) %>%
  #Variable sprfc corresponds to AFD internal reported size
  rename("sprfc_int" = "sprfc") %>%
  mutate(wdpaid = as.numeric(wdpaid),
         sprfc_int = as.numeric(sprfc_int)) 

#Spatial definition of wdpaid 555547988 overlaps CMR and CAF. Wdpaid 1245 corresponds to the CMR part. The overlap is removed and iso3 redefined so that 555547988 is CAF only. 
geom_555547988_1245 = st_difference(pa_shp[pa_shp$wdpaid == 555547988,]$geom, pa_shp[pa_shp$wdpaid == 1245,]$geom)
pa_shp[pa_shp$wdpaid == 555547988,]$geom = geom_555547988_1245
pa_shp[pa_shp$wdpaid == 555547988,]$iso3 = "CAF"

#Define a tidy version of the former dataset, with modifications on wdpaid 555547988
pa_shp_tidy = pa_shp %>%
  #Project to Mollweide to compute relevant areas in km2
  st_transform(crs = "+proj=moll +datum=WGS84") %>%
  #Compute areas in km2 from the geometry, in km2. It must be equal to gis_a by definition 
  #Then to take into account potential refinements of the geometries (as for wdpaid 55547988), a variable for relevant area is defined. It takes rep_a value except for modified geometries where area_sf_moll is taken
  mutate(area_sf_moll = as.numeric(st_area(geom)/1e6),
         sprfc_km2 = ifelse(wdpaid == 555547988, yes = area_sf_moll, no = rep_a))

```

### Computing the intersection at country, region, world level

```{r message=FALSE, warning=FALSE}

#Compute intersecting areas of polygons
pa_int = st_intersection(pa_shp_tidy, pa_shp_tidy) %>%
  #Remove intersection of polygons with themselves
  subset(wdpaid != wdpaid.1) %>%
  #If one of the two intersectin polygon have unknwon area, then it is not necessary to subtract the interesction area. Indeed there is no double-counting of the intersection in this case, when both polygon areas are summed.
  subset(is.na(sprfc_km2) == FALSE & is.na(sprfc_km2.1) == FALSE) %>%
  #Compute the intersecting areas (pa_shp already in Mollweide projection) in km2
  mutate(area_int = as.numeric(st_area(geom)/1e6)) %>%
  #Now duplicates need to be removed : intersection of X with Y AND intersection of Y with X are reported. We need only one.
  #An id_int to identify the intersection of a given pair
  mutate(id_int = paste0(wdpaid, "_", wdpaid.1), .before = wdpaid) %>%
  mutate(id_int_temp = paste0(wdpaid, "_", wdpaid.1), .before = wdpaid) %>%
  #create a mirror idX_idY --> idY_idX so that we identify the both member of a pair with the same id
  separate(id_int_temp, into = c("id_temp1", "id_temp2"), sep = "_") %>%
  mutate(id_int_rev = case_when(
    id_temp1 < id_temp2 ~ paste(id_temp1, id_temp2, sep = "_"),
    id_temp1 > id_temp2 ~ paste(id_temp2, id_temp1, sep = "_"),
    TRUE ~ paste(id_temp1, id_temp2, sep = "_")),
    .after = id_int) %>%
  #finally, get rid of the duplicates (have the same id_int_rev)
  group_by(id_int_rev) %>%
  slice(1) %>%
  ungroup() %>%
  #select relevant variables only
  select(wdpaid, iso3, drct, ann_c, wdpaid.1, iso3.1, drct.1, ann_c.1, geom, area_int)

#Computing the total area of intersections
#At country level ...
pa_int_ctry = pa_int %>%
  #Only overlapping PAs in the same country are considered
  subset(iso3 ==  iso3.1) %>%
  group_by(iso3) %>%
  summarize(tot_area_int = sum(area_int)) %>%
  st_drop_geometry()

#At region level
pa_int_dr = pa_int %>%
  #Only overlapping PAs in the same DR are considered
  subset(drct == drct.1) %>%
  group_by(drct) %>%
  summarize(tot_area_int = sum(area_int)) %>%
  st_drop_geometry()

##At world level : all overlap are considered
pa_int_wld = sum(pa_int$area_int) 

#Compute the total intersection for each year
pa_int_yr = pa_int %>%
  #Define intersection year : the date ann_c of the later PA in the pair
  rowwise() %>%
  mutate(annee_int = max(ann_c, ann_c.1)) %>% 
  group_by(annee_int) %>%
  summarize(tot_int_km2 = sum(area_int)) %>%
  st_drop_geometry() 

```

### Computing total areas without intersection

```{r}

#At country level ...
pa_area_ctry = data_stat_nodupl %>%
  #Compute total area at country level
  group_by(iso3) %>%
  summarize(sprfc_tot_km2 = sum(superficie)) %>%
  ungroup() %>%
  #Add information on intersection area in each country. Modify the variable so that NA value -> 0
  left_join(pa_int_ctry, by = "iso3") %>%
  mutate(tot_area_int = case_when(is.na(tot_area_int) == TRUE ~ 0, TRUE ~ tot_area_int)) %>%
  #Compute the total area at country level without intersection
  mutate(sprfc_tot_noint_km2 = sprfc_tot_km2 - tot_area_int) 

#At DR level ...
pa_area_dr = data_stat_nodupl %>%
  #Compute total area at dr level
  group_by(direction_regionale) %>%
  summarize(sprfc_tot_km2 = sum(superficie)) %>%
  ungroup() %>%
  #Add information on intersection area in each DR. Modify the variable so that NA value -> 0
  left_join(pa_int_dr, by = c("direction_regionale" = "drct")) %>%
  mutate(tot_area_int = case_when(is.na(tot_area_int) == TRUE ~0, TRUE ~tot_area_int)) %>%
  #Compute the total area at country level without intersection
  mutate(sprfc_tot_noint_km2 = sprfc_tot_km2 - tot_area_int) %>%
  st_drop_geometry()

#At world level
pa_area_wld = sum(data_stat_nodupl$superficie) - pa_int_wld 


```

## Performing descriptive statistics

### IUCN categories

#### Share of PAs by IUCN categories

```{r}

#Building the relevant dataset
##For all PAs ..
data_cat_iucn = data_stat_nodupl %>%
  group_by(iucn_des) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = n_iucn/n_pa*100) %>%
  arrange(desc(iucn_des)) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

# test = base_nodupl_lea %>%
#   group_by(iucn_cat) %>%
#   #number of PAs per IUCN category
#   summarize(n_iucn = n()) %>%
#   ungroup() %>%
#   #Frequency of IUCN categories
#   mutate(n_pa = sum(n_iucn),
#          freq_iucn = n_iucn/n_pa*100) %>%
#   arrange(desc(iucn_cat)) %>%
#   mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 
# 
# test2 = base_nodupl_old %>%
#   group_by(iucn_cat) %>%
#   #number of PAs per IUCN category
#   summarize(n_iucn = n()) %>%
#   ungroup() %>%
#   #Frequency of IUCN categories
#   mutate(n_pa = sum(n_iucn),
#          freq_iucn = n_iucn/n_pa*100) %>%
#   arrange(desc(iucn_cat)) %>%
#   mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn)

##... and for referenced PAs only
data_cat_iucn_ref = data_stat_nodupl %>%
  #Remove not referenced PAs
  subset(!(iucn_des %in% c("Non catégorisée", "Non référencée"))) %>%
  group_by(iucn_des) %>%
  #number of PAs per IUCN category
  summarize(n_iucn = n()) %>%
  ungroup() %>%
  #Frequency of IUCN categories
  mutate(n_pa = sum(n_iucn),
         freq_iucn = n_iucn/n_pa*100) %>%
  arrange(freq_iucn) %>%
  mutate(ypos_iucn = cumsum(freq_iucn) - 0.5*freq_iucn) 

#Latex table
tbl_cat_iucn = data_cat_iucn %>%
  select(c(iucn_des, n_iucn, freq_iucn))
names(tbl_cat_iucn) <- c("Catégories IUCN","Nombre d'AP", "Proportion d'AP (%)")


#Histogram including non-referenced PAs
hist_cat_iucn = ggplot(data_cat_iucn, 
                       aes(x = reorder(iucn_des, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = 0), 
            vjust = "inward", color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées par catégorie IUCN",
         subtitle = paste("Echantillon :", sum(data_cat_iucn$n_iucn), "aires protégées. Nombre d'aires indiqué à la base du graphique"),
          x = "Catégories IUCN", 
          y = "Nombre (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_cat_iucn

#Histogram excluding non-referenced PAs
hist_cat_iucn_ref = ggplot(data_cat_iucn_ref, 
                       aes(x = reorder(iucn_des, -freq_iucn), 
                           y = freq_iucn, fill = iucn_des)) %>% 
  + geom_bar(stat = "identity", width = 0.50, fill="#3182BD") %>%
  + geom_text(aes(label = round(n_iucn, 1), y = 0), 
            vjust = "inward", color="black",
            size=3.5) %>%
  + labs(title = "Proportion d'aires protégées par catégorie IUCN (hors AP non-répertoriées)",
         subtitle = paste("Echantillon :", sum(data_cat_iucn_ref$n_iucn), "aires protégées. Nombre d'aires indiqué à la base du graphique"),
          x = "Catégories IUCN", 
          y = "Nombre (%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=9, hjust = .5, vjust = .6),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
# hist_cat_iucn_ref


#Pie chart INcluding non-referenced PAs
pie_cat_iucn = ggplot(data_cat_iucn, 
                      aes(x="", y= freq_iucn, fill = iucn_des)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées par catégorie IUCN (%)") %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn



#Pie chart EXcluding non-referenced PAs
pie_cat_iucn_ref = ggplot(data_cat_iucn_ref, 
                      aes(x="", y= freq_iucn, fill = iucn_des)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, label = paste0(round(freq_iucn, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  # + geom_label(aes(x=1.4, label = paste0(freq_iucn, "%")), 
  #              color = "white", 
  #              position = position_stack(vjust = 0.7), size=2.5, 
  #              show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Proportion d'aires protégées par catégorie IUCN (%)",
         subtitle = "hors AP non répertoriées") %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_cat_iucn_ref




```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_cat_iucn, type = "latex"),
      file = paste(tmp, "tbl_cat_iucn.tex", sep = "/"))

ggsave(paste(tmp, "hist_cat_iucn.png", sep = "/"),
       plot = hist_cat_iucn,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "hist_cat_iucn_ref.png", sep = "/"),
       plot = hist_cat_iucn_ref,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn.png", sep = "/"),
       plot = pie_cat_iucn,
       device = "png",
       height = 6, width = 9)

ggsave(paste(tmp, "pie_cat_iucn_ref.png", sep = "/"),
       plot = pie_cat_iucn_ref,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/IUCN", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### IUCN categories by countries and regions

```{r}

#Build the distribution of IUCN categories at country level ...
data_iucn_ctry = table(data_stat_nodupl$iucn_des,
                       data_stat_nodupl$iso3) %>%
  #Create a table with all iucn categories for each country, and compute the frequencies in percent
  prop.table(2) %>%
  as.data.frame() %>%
  mutate(Freq = round(Freq, 3)*100) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  rename("iucn_des" = "Var1")

#... and regional level
data_iucn_reg = table(data_stat_nodupl$iucn_des,
                       data_stat_nodupl$direction_regionale) %>%
    #Create a table with all iucn categories for each country, and compute the frequencies in percent
  prop.table(2) %>%
  as.data.frame() %>%
  mutate(Freq = round(Freq, 3)*100) %>%
  pivot_wider(names_from = Var2, values_from = Freq) %>%
  rename("iucn_des" = "Var1")

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(data_iucn_ctry, type = "latex"),
      file = paste(tmp, "tbl_iucn_ctry.tex", sep = "/"))
print(xtable(data_iucn_reg, type = "latex"),
      file = paste(tmp, "tbl_iucn_reg.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
for(f in files) 
  {
  cat("Uploading file", paste0("'", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/IUCN", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Ecosystems (excluding non-referenced PAs)

#### Proportion of PAs by marine or terrestrial areas

```{r}

#Build datasets
data_eco = data_stat_nodupl %>%
  #subset non-referencded PAs (have NA ecosysteme)
  subset(is.na(marine) == FALSE) %>%
  mutate(marine = as.factor(marine))
data_eco$ecosyst_en = fct_recode(data_eco$marine, 
                              "Terrestrial"="0", 
                              "Coastal"="1", 
                              "Marine"="2")
data_eco$ecosyst_fr = fct_recode(data_eco$marine, 
                              "Terrestre"="0", 
                              "Côtier"="1", 
                              "Marin"="2")

data_eco_hist = data_eco %>%
  group_by(ecosyst_en, ecosyst_fr) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_eco), 3)*100) %>%
  ungroup()

#/!\ résultats un peu différents que Léa j'ai une AP en plus), mais la méthode est équivalente

#Table
# tbl_eco_wdpaid = table(data_eco$wdpaid, data_eco$ecosyst) %>%
#   rprop() %>%
#   as.data.frame() %>%
#   mutate(Freq = round(Freq,2)) %>%
#   pivot_wider(names_from = Var2, values_from = Freq)

tbl_eco_world_fr = data_eco_hist %>%
  select(c(ecosyst_fr, n, freq)) %>%
  rename("Ecosystème" = "ecosyst_fr",
         "Nombre d'AP" = "n",
         "Proportion d'AP(%)" = "freq")

tbl_eco_world_en = data_eco_hist %>%
  select(c(ecosyst_en, n, freq)) %>%
  rename("Ecosystem" = "ecosyst_en",
         "Number of PAs" = "n",
         "Share of PAs(%)" = "freq")


#Histogram in share (in French)
hist_eco_shr_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = 0), 
        vjust = "inward", color="black",
        size=3.5) %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème (hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "aires protégées. Nombre d'aires indiqué à la base du graphique"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_shr_fr
# 



#Histogram in share (in English)
hist_eco_shr_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = freq, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = 0), 
        vjust = "inward", color="black",
        size=3.5) %>%
+ labs(title = "Proportion of protected areas by ecosystem type (excluding non-references PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas. Number of areas indicated below."),
         x = "Ecosystem type",
         y = "Proportion of protected areas(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_shr_en


  
#Histogram in number (in French)
hist_eco_n_fr = ggplot(data_eco_hist, 
                     aes(x = ecosyst_fr, y = n, fill = ecosyst_fr)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème (hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "aires protégées"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_n_fr




#Histogram in number (in English)
hist_eco_n_en = ggplot(data_eco_hist, 
                     aes(x = ecosyst_en, y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ labs(title = "Proportion of protected areas by ecosystem type (excluding non-referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_eco_n_en

#Pie chart (in French)
pie_eco_fr = ggplot(data_eco_hist, 
                     aes(x = "", y = freq, fill = ecosyst_fr)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion d'aires protégées par type d'écosystème (hors AP non-référencées)",
       subtitle = paste("Echantillon :", sum(data_eco_hist$n), "aires protégées"),
         x = "Type d'écosystème",
         y = "Proportion d'aires protégées") %>%
  + scale_fill_brewer(name = "Ecosystème", palette="Paired") %>%
  + theme_void()
#pie_eco_fr


#Histogram in number (in English)
pie_eco_en = ggplot(data_eco_hist, 
                     aes(x = "", y = n, fill = ecosyst_en)) %>%
+ geom_bar(width = 1, stat = "identity",color="white") %>%
+ geom_label(aes(x=1.3, label = paste0(freq, "%")), 
             color = "black", position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
+ coord_polar("y", start=0) %>%
+ labs(title = "Proportion of protected areas by ecosystem type (exluding non-referenced PAs)",
       subtitle = paste("Sample :", sum(data_eco_hist$n), "protected areas"),
         x = "Ecosystem type",
         y = "Proportion of protected areas") %>%
  + scale_fill_brewer(name = "Ecosystem", palette="Paired") %>%
  + theme_void()
#pie_eco_en
  
```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_eco_world_fr, type = "latex"), 
      file = paste(tmp, "tbl_ecosyst_fr.tex", sep = "/"))
print(xtable(tbl_eco_world_en, type = "latex"), 
      file = paste(tmp, "tbl_ecosyst_en.tex", sep = "/"))
ggsave(paste(tmp, "hist_eco_shr_fr.png", sep = "/"),
       plot = hist_eco_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_shr_en.png", sep = "/"),
       plot = hist_eco_shr_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_n_fr.png", sep = "/"),
       plot = hist_eco_n_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_eco_n_en.png", sep = "/"),
       plot = hist_eco_n_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_eco_fr.png", sep = "/"),
       plot = pie_eco_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_eco_en.png", sep = "/"),
       plot = pie_eco_en,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/ecosysteme", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Distribution of PAs across countries and regions

#### Statistics at country level

```{r message=FALSE, warning=FALSE}

data_distrib_ctry = data_stat_nodupl %>%
  group_by(pays, iso3) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
  ungroup() %>%
  mutate(pays = case_when(
    pays == "P-N N.CalÃ©d" ~ "P-N N.Caléd",
    pays == "Polynesie Francaise" ~ "Polynesie Fr.",
    pays == "P-S N.CalÃ©d" ~ "P-S N.Caléd",
    TRUE ~ pays
  ))

# test = base_nodupl_lea %>%
#     group_by(pays) %>%
#   summarize(n = n(),
#             freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
#   ungroup() %>%
#   mutate(pays = case_when(
#     pays == "P-N N.CalÃ©d" ~ "P-N N.Caléd",
#     pays == "Polynesie Francaise" ~ "Polynesie Fr.",
#     pays == "P-S N.CalÃ©d" ~ "P-S N.Caléd",
#     TRUE ~ pays
#   ))
# 
# test2 = base_nodupl_old %>%
#   group_by(pays) %>%
#   summarize(n = n(),
#             freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
#   ungroup() %>%
#   mutate(pays = case_when(
#     pays == "P-N N.CalÃ©d" ~ "P-N N.Caléd",
#     pays == "Polynesie Francaise" ~ "Polynesie Fr.",
#     pays == "P-S N.CalÃ©d" ~ "P-S N.Caléd",
#     TRUE ~ pays
#   ))

data_distrib_ctry_top = data_distrib_ctry %>%
  subset(freq >= 5)

#Histogram in share (in French) for top countries
hist_distrib_ctry_top_shr_fr = ggplot(data_distrib_ctry_top, 
                     aes(x = reorder(pays, -freq), y = freq, fill = pays)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = 0.1), 
        vjust = "inward", color="black",
        size=3.5) %>%
+ labs(title = "Les pays abritant le plus d'aires protégées",
       subtitle = paste("Echantillon :", sum(data_distrib_ctry$n), "aires protégées. Nombre d'aires indiqué à la base du graphique"),
         x = "Pays",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#hist_distrib_ctry_top_shr_fr
# 


#Histogram in number (in French)
hist_distrib_ctry_n_fr = ggplot(data_distrib_ctry, 
                     aes(x = reorder(pays, -n), y = n, fill = pays)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = n), 
        vjust = -0.2, color="black",
        size=3.5) %>%
+ labs(title = "Proportion d'aires protégées par pays",
       subtitle = paste("Echantillon :", sum(data_distrib_ctry$n), "aires protégées. Nombre d'aires indiqué sur chaque barre"),
         x = "Pays",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_ctry_n_fr
# 

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_ctry_top_shr_fr.png", sep = "/"),
       plot = hist_distrib_ctry_top_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_ctry_n_fr.png", sep = "/"),
       plot = hist_distrib_ctry_n_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/distribution", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Statistics at region level

```{r}
data_distrib_reg = data_stat_nodupl %>%
  group_by(direction_regionale) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
  ungroup() %>%
  mutate(region = gsub("Dr ", "", direction_regionale),
         .after = "direction_regionale")

#####################
# 
# test = base_nodupl_lea %>%
#   group_by(direction_regionale) %>%
#   summarize(n = n(),
#             freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
#   ungroup() %>%
#   mutate(region = gsub("Dr ", "", direction_regionale),
#          .after = "direction_regionale")
# #
# test2 = base_nodupl_old %>%
#   group_by(direction_regionale) %>%
#   summarize(n = n(),
#             freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
#   ungroup() %>%
#   mutate(region = gsub("Dr ", "", direction_regionale),
#          .after = "direction_regionale")
# 
# ap_region2 <- data.frame(table(base_nodupl_old$direction_regionale))
# ap_region2$Freq <- round(ap_region2$Freq/sum(ap_region2$Freq),3)*100
# #
# # #TOP 6 REGION
# ap_region_6 = subset(ap_region2, Freq >= 5)
# 
# ggplot(ap_region_6, aes(x = reorder(Var1,-Freq), y=Freq, fill=Var1)) +
#   geom_bar(width = 0.80, fill="blue",stat="identity") +
#   ggtitle("Les 6 régions abritant le plus d'aires protégées") +
#   theme(plot.title = element_text(size= 14, face = "bold",hjust=0.5)) +
#   xlab("Région") +
#   ylab("Proportion d'aires protégées(%)")


##############

data_distrib_reg_top = data_distrib_reg %>%
  subset(freq >= 5)

#Histogram in share (in French) for top countries
hist_distrib_reg_top_shr_fr = ggplot(data_distrib_reg_top, 
                     aes(x = reorder(region, -freq), y = freq, fill = region)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = 0.1), 
        vjust = "inward", color="black",
        size=3.5) %>%
+ labs(title = "Les régions abritant le plus d'aires protégées",
       subtitle = paste("Echantillon :", sum(data_distrib_reg$n), "aires protégées. Nombre d'aires indiqué à la base du graphique"),
         x = "Direction régionale",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 0,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_top_shr_fr
# 


#Histogram in number (in French)
hist_distrib_reg_n_fr = ggplot(data_distrib_reg, 
                     aes(x = reorder(direction_regionale, -n), y = n, fill = direction_regionale)) %>%
+ geom_bar(width = 0.50, fill= "#3182BD", stat="identity") %>%
+ geom_text(aes(label = round(n, 1), y = n), 
        vjust = -0.2, color="black",
        size=3.5) %>%
+ labs(title = "Proportion d'aires protégées par région",
       subtitle = paste("Echantillon :", sum(data_distrib_ctry$n), "aires protégées. Nombre d'aires indiqué sur chaque barre"),
         x = "Direction régionale",
         y = "Proportion d'aires protégées(%)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_distrib_reg_n_fr

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "hist_distrib_reg_top_shr_fr.png", sep = "/"),
       plot = hist_distrib_reg_top_shr_fr,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_distrib_reg_n_fr.png", sep = "/"),
       plot = hist_distrib_reg_n_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/distribution", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Surface of PAs

#### Distribution of surfaces

```{r}

tbl_distrib_area_no0 = summary(
  filter(data_stat_nodupl, superficie != 0)$superficie) %>%
  format(scientific = FALSE) %>%
  as.array() %>%
  t() %>%
  as.data.frame() %>%
  select(-c("1st Qu.","3rd Qu."))


```

#### Average surface in countries and regions

Comparison with Léa, differences that are not explained by the use of intersections :

-   Afrique centrale : 3723 vs 3274 in my case

-   Afrique de l'Est : 762 vs 614

-   Amerique centrale : 842 vs 38

-   Asie du Sud : 3925 vs 0

-   Chine 1114 vs 2000

-   Ocean Indien : 13153 vs 14483

-   Siege Paris : 2685 vs 2919

```{r}
#Distribution of PA WITH SURFACE >0 across countries and regions
##Country
data_distrib_no0_ctry = data_stat_nodupl %>%
  filter(superficie != 0) %>%
  group_by(iso3, pays) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
  ungroup() %>%
  mutate(pays = case_when(
    pays == "P-N N.CalÃ©d" ~ "P-N N.Caléd",
    pays == "Polynesie Francaise" ~ "Polynesie Fr.",
    pays == "P-S N.CalÃ©d" ~ "P-S N.Caléd",
    TRUE ~ pays
  ))

##Region
data_distrib_no0_dr = data_stat_nodupl %>%
  filter(superficie != 0) %>%
  group_by(direction_regionale) %>%
  summarize(n = n(),
            freq = round(n/nrow(data_stat_nodupl), 3)*100) %>%
  ungroup() %>%
  mutate(region = gsub("Dr ", "", direction_regionale),
         .after = "direction_regionale")

#By country..
tbl_area_avg_ctry = data_distrib_no0_ctry %>%
  select(-freq) %>%
  left_join(pa_area_ctry, by = "iso3") %>%
  select(-c(iso3, sprfc_tot_km2, tot_area_int)) %>%
  mutate(sprfc_avg_noint_km2 = sprfc_tot_noint_km2/n)
names(tbl_area_avg_ctry) = c("Pays", "Nombre d'AP", "Superficie totale (km2)", "Superficie moyenne (km2)")

#By region
tbl_area_avg_dr = data_distrib_no0_dr %>%
  select(-freq) %>%
  left_join(pa_area_dr, by = "direction_regionale") %>%
  select(-c(sprfc_tot_km2, tot_area_int, direction_regionale)) %>%
  mutate(sprfc_avg_noint_km2 = sprfc_tot_noint_km2/n)
names(tbl_area_avg_dr) = c("Direction régionale", "Nombre d'AP", "Superficie totale (km2)", "Superficie moyenne (km2)")


#Note
#test = aggregate(superficie ~ direction_regionale, data = filter(data_stat_nodupl, superficie != 0), FUN = mean)
#Does not take intersection into account : slightly different results.

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_distrib_area_no0, type = "latex"), 
      file = paste(tmp, "tbl_distrib_area_no0.tex", sep = "/"))
print(xtable(tbl_area_avg_ctry, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_ctry.tex", sep = "/"))
print(xtable(tbl_area_avg_dr, type = "latex"), 
      file = paste(tmp, "tbl_area_avg_dr.tex", sep = "/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/surface", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Temporal evolution

In this section is plotted the evolution in the number and surafe of PAs over time (cumulated number/surface and number/surface of PAs funded by year).

#### Number of PAs

*/!\\ Mon graphique ne correspond pas à celui de Léa. Elle a plus de PA pour certaines années. Je ne vois pas d'où ça peut venir : j'ai 142 observations comme elle dans la base sans duplicata a priori (cf son script).*

```{r}

data_time_range = data.frame(annee = 
                              c(min(data_stat_nodupl$annee_octroi):max(data_stat_nodupl$annee_octroi))
)


data_time_n = data_stat_nodupl %>%
  group_by(annee_octroi) %>%
  summarize(n = n()) %>%
  full_join(data_time_range, by = c("annee_octroi" = "annee")) %>%
  mutate(n = case_when(is.na(n)~0, TRUE~n)) %>%
  arrange(annee_octroi) %>%
  mutate(n_cum = cumsum(n)) 

#Number of PAs funded by year (fig)
fig_n_pa = ggplot(data_time_n,
                  aes(x = annee_octroi, y = n)) %>%
  + geom_point(color = "#3182BD", size = 1.5) %>%
  + geom_line(color = "#3182BD", size = 1) %>% 
  + labs(title = "Evolution du nombre d'aires protégées appuyées par l'AFD",
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_n_pa

#Number of PAs funded by year (histogram)
hist_n_pa = ggplot(data_time_n,
                  aes(x = factor(annee_octroi), y = n)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  + geom_text(aes(y = n, label = ifelse(n == 0, NA, n)), 
              color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Nombre d'aires protégées appuyées par année",
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
hist_n_pa



#Cumulative number over time
fig_ncum_pa = ggplot(data_time_n,
                  aes(x = factor(annee_octroi), y = n_cum)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = n_cum, label = n_cum), 
              color = "black", size=4, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée du nombre d'aires protégées appuyées par l'AFD",
         x = "Année",
         y = "Nombre d'aires protégées") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_ncum_pa


```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_n_pa.png", sep = "/"),
       fig_n_pa,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "hist_n_pa.png", sep = "/"),
       hist_n_pa,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_ncum_pa.png", sep = "/"),
       fig_ncum_pa,
       device = "png",
       height = 6, width = 9)



#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/time_evolution", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Surface of PAs

Difference with Léa : no area in 2010 because I removed the PA in India (no WDPAID nor name_ap)

```{r}
data_time_range = data.frame(annee = 
                              c(min(data_stat_nodupl$annee_octroi):max(data_stat_nodupl$annee_octroi))
)


data_time_area = data_stat_nodupl %>%
  group_by(annee_octroi) %>%
  summarize(tot_area_km2 = sum(superficie)) %>%
  left_join(pa_int_yr, by = c("annee_octroi" = "annee_int")) %>%
  full_join(data_time_range, by = c("annee_octroi" = "annee")) %>%
  mutate(tot_area_km2 = case_when(is.na(tot_area_km2)~0, TRUE~tot_area_km2),
         tot_int_km2 = case_when(is.na(tot_int_km2)~0, TRUE~tot_int_km2),
         tot_area_noint_km2 = tot_area_km2 - tot_int_km2) %>%
  arrange(annee_octroi)

#Evolution of area over time
fig_area_pa = ggplot(data_time_area,
                  aes(x = factor(annee_octroi), y = tot_area_noint_km2)) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = tot_area_noint_km2, 
                  label = ifelse(tot_area_noint_km2 != 0,
                                 format(tot_area_noint_km2, 
                                        digits = 2, 
                                        scientific = TRUE),
                                 NA)), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Evolution de la superficie des aires protégées",
         x = "Année",
         y = "Superficie (km2)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_area_pa



#Cumulative area over time
fig_area_cum_pa = ggplot(data_time_area,
                  aes(x = factor(annee_octroi),
                      y = cumsum(tot_area_noint_km2))) %>%
  # + geom_point(color = "#3182BD", size = 1.5) %>%
  # + geom_line(color = "#3182BD", size = 1) %>% 
  + geom_bar(stat = 'identity', fill = "#3182BD") %>%
  + geom_text(aes(y = cumsum(tot_area_noint_km2), 
                  label = format(cumsum(tot_area_noint_km2), 
                                 digits = 2,
                                 scientific = TRUE)), 
              color = "black", size=3, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée de la superficie des aires protégées",
         x = "Année",
         y = "Superficie (km2)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_area_cum_pa



```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_area_pa.png", sep = "/"),
       fig_area_pa,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_area_cum_pa.png", sep = "/"),
       fig_area_cum_pa,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/time_evolution", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Funding

This section provides several statistics on the funding of PAs : average funding by project, by contest, average funding by region or country, average funding by area, evolution over time, funding type.

#### Average funding

Create a dataset with one row per project (funding is given by project, so duplicates are avoided)

```{r}

data_stat_projet_nodupl = data_stat %>%
  dplyr::distinct(id_projet, .keep_all = TRUE)

```

Distribution of project funding

```{r}

#Table
tbl_fund_proj = summary(data_stat_projet_nodupl$montant_total_projet) %>%
  format(scientific = FALSE) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::select(-c("1st Qu.","3rd Qu."))


#Boxplot
# fig_fund_proj = ggplot(data = data_stat_projet_nodupl,
#                        aes(y = montant_total_projet)) %>%
#   + geom_boxplot() %>%
#   + theme(legend.position = "bottom",
#       legend.key = element_rect(fill = "white"),
#       plot.title = element_text(size = 14, face = "bold"), 
#       axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
#       axis.title.x = element_text(margin = margin(t = 10)),
#       panel.background = element_rect(fill = 'white', colour = 'white', 
#                                       linewidth = 0.5, linetype = 'solid'),
#       panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
#       panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
#       plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#fig_fund_proj

```

Average funds given by each concours

/! Weird : montant_total_projet is similar for each row of ID_concours

```{r}

# tbl_fund_avg_concours = data_stat %>%
#   group_by(id_concours) %>%
#   slice(1) %>%
#   summarize(Mean = mean(montant_total_projet))

```

**Average fund received by each project in the different concours**

/! Weird : montant_total_projet is similar for each row of ID_projet

```{r}

# tbl_fund_avg_project = data_stat %>%
#   group_by(id_projet) %>%
#   slice(1) %>%
#   summarize(Mean = mean(montant_total_projet))

```

**Average funding by country/region**

```{r}
#By country ...
tbl_fund_avg_ctry = data_stat_projet_nodupl %>%
  group_by(pays, iso3) %>%
  summarize(avg_fund = mean(montant_total_projet, na.rm = TRUE)) %>%
  arrange(avg_fund)

#By region
tbl_fund_avg_dr = data_stat_projet_nodupl %>%
  group_by(direction_regionale) %>%
  summarise(avg_fund = mean(montant_total_projet, na.rm = TRUE)) %>%
  arrange(avg_fund)



```

**Average funding per unit or area (marine and terrestrial), at regional and world level**

Some projects cover more than one country (e.g CZZ3012), but the total fund is given at project level. Thus it is not possible to compute funding per unit of area at country level for all countries. Still at country level, Tanzania, India, "Ocean Indien", "Multipays" and "Dr Asie du Sud" have no fund per area in the computations. In fact PAs are reported in these regions/countries, with area and total funding. But without WDPAID and PA name, so these PAs are not kept in the dataset without duplicates.

It is possible however at DR level. Note that the total superficie at world level is different from the total superficie from the DR, taking the overlap into account. Indeed, overlap between polygons from different DR is subtracted at world level but not at DR level.

```{r}
#By country ...
# data_fund_sum_ctry = data_stat_projet_nodupl %>%
#   group_by(pays, iso3) %>%
#   summarize(tot_fund = sum(montant_total_projet, na.rm = TRUE)) %>%
#   ungroup() %>%
#   arrange(tot_fund) 
# 
# data_fund_per_area_ctry = data_fund_sum_ctry %>%
#   left_join(select(pa_area_ctry, c(iso3, sprfc_tot_noint_km2)), by = "iso3") %>%
#   mutate(fund_per_area = tot_fund/sprfc_tot_noint_km2)
# names(data_fund_per_area_ctry) = c("Pays", "ISO3", "Montant total (€)", "Superficie totale (km2)", "Financement moyen par km2 (€/km2)")
#print(xtable(data_fund_per_area_ctry, type = "latex"), file = "DesStat/funding/tbl_fund_per_area_ctry.tex")


#By region 
data_fund_sum_dr = data_stat_projet_nodupl %>%
  group_by(direction_regionale) %>%
  summarize(tot_fund = sum(montant_total_projet, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(tot_fund)

data_fund_per_area_dr = data_fund_sum_dr %>%
  left_join(select(pa_area_dr, c(direction_regionale, sprfc_tot_noint_km2)), by = "direction_regionale") %>%
  mutate(fund_per_area = tot_fund/sprfc_tot_noint_km2)
names(data_fund_per_area_dr) = c("Direction régionale", "Montant total (€)", "Superficie totale (km2)", "Financement moyen par km2 (€/km2)")


#At world level
data_fund_per_area_wld = sum(data_stat_projet_nodupl$montant_total_projet)/pa_area_wld
tbl_fund_per_area_wld = data.frame(data_fund_per_area_wld) %>% format(digits = 4)
names(tbl_fund_per_area_wld) = c("Financement moyen par km2 (€/km2)")



```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_fund_proj, type = "latex"),
      file = paste(tmp, "tbl_fund_proj_stat.tex", sep  ="/"))
print(xtable(tbl_fund_avg_ctry, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_ctry.tex", sep  ="/"))
print(xtable(tbl_fund_avg_dr, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_dr.tex", sep  ="/"))
print(xtable(data_fund_per_area_dr, type = "latex"),
      file = paste(tmp, "tbl_fund_per_area_dr.tex", sep  ="/"))
print(xtable(tbl_fund_per_area_wld, type = "latex"),
      file = paste(tmp, "tbl_fund_per_area_wld.tex", sep  ="/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Evolution of funding over time

```{r}
data_fund_year = data_stat_projet_nodupl %>%
  group_by(annee_octroi) %>%
  summarize(tot_fund = sum(montant_total_projet))

#Total funding for each year
fig_fund_year = ggplot(data = data_fund_year,
                       aes(x = annee_octroi, y = tot_fund)) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  + geom_text(aes(y = tot_fund, label = format(tot_fund, scientific = TRUE, digits = 2)),
              color = "black", size=2.5, vjust = -0.3) %>%
  + labs(title = "Evolution du financement des aires protégées",
         x = "Année",
         y = "Montants octroyés (€)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
#fig_fund_year


#Cumulative funding over time
fig_fund_year_cum = ggplot(data = data_fund_year,
                       aes(x = annee_octroi, y = cumsum(tot_fund))) %>%
  + geom_bar(stat = 'identity', fill = "#3182BD") %>% 
  + geom_text(aes(y = cumsum(tot_fund), label = format(cumsum(tot_fund), scientific = TRUE, digits = 2)),
              color = "black", size=2.5, vjust = -0.3) %>%
  + labs(title = "Evolution cumulée du financement des aires protégées",
         x = "Année",
         y = "Montants octroyés (€)") %>%
  + theme(legend.position = "bottom",
      legend.key = element_rect(fill = "white"),
      plot.title = element_text(size = 14, face = "bold"), 
      axis.text.x = element_text(angle = 45,size=10, hjust = .5, vjust = .6),
      axis.title.x = element_text(margin = margin(t = 10)),
      panel.background = element_rect(fill = 'white', colour = 'white', 
                                      linewidth = 0.5, linetype = 'solid'),
      panel.grid.major = element_line(colour = 'grey90', linetype = 'solid'),
      panel.grid.minor = element_line(colour = 'grey90', linetype = 'solid'),
      plot.caption = element_text(color = 'grey50', size = 8.5, face = 'plain'))
fig_fund_year_cum

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

ggsave(paste(tmp, "fig_fund_year.png", sep = "/"),
       plot = fig_fund_year,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "fig_fund_year_cum.png", sep = "/"),
       plot = fig_fund_year_cum,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Type of funding

Distribution of funding types

```{r}
tbl_type_prod = data_stat_projet_nodupl_utf8 %>%
  group_by(libelle_produit) %>%
  #number of PAs per funding type
  summarize(n_type = n()) %>%
  ungroup() %>%
  #Frequency of funding types
  mutate(n_pa = sum(n_type),
         freq = n_type/n_pa*100,
         libelle_produit = case_when(libelle_produit == "PRETS SOUVERAINS FMI COMPATIBLE" ~ "Prêts souverains FMI-compatible", TRUE ~ libelle_produit)) %>%
  arrange(desc(libelle_produit)) %>%
  select(-n_pa) %>%
  arrange(-freq)
names(tbl_type_prod) <- c("Type de financement","Projets", "Proportion (%)")


#Pie chart INcluding non-referenced PAs
pie_type_prod = ggplot(tbl_type_prod, 
                      aes(x="", y= freq, fill = libelle_produit)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + coord_polar("y", start=0) %>%
  + geom_label_repel(aes(x=1.2, 
                         label = paste0(round(freq, 1), "%")), 
             color = "white", 
             position = position_stack(vjust = 0.55), 
             size=2.5, show.legend = FALSE) %>%
  + labs(x = "", y = "",
         title = "Type de financement") %>%
  + scale_fill_brewer(name = "Catégories", palette = "Dark2") %>%
  + theme_void()
pie_type_prod


```

Average fund by funding type

```{r}

tbl_fund_avg_type = data_stat_projet_nodupl_utf8 %>%
  group_by(libelle_produit) %>%
  summarize(n_type = n(),
            tot_fund = sum(montant_total_projet)
            ) %>%
  mutate(n_pa = sum(n_type),
         freq_pa = round(n_type/n_pa*100, 1),
         freq_fund = round(tot_fund/sum(tot_fund)*100, 1),
         libelle_produit = case_when(libelle_produit == "PRETS SOUVERAINS FMI COMPATIBLE" ~ "Prêts souverains FMI-compatible", TRUE ~ libelle_produit)) %>%
  select(c(libelle_produit, n_type, freq_pa, tot_fund, freq_fund)) %>%
  arrange(-freq_pa)
names(tbl_fund_avg_type) = c("Type de financement","Projets", "Proportion d'AP (%)", "Montants (€)", "Proportion des montants (%)")

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_type_prod, type = "latex"),
      file = paste(tmp, "tbl_fund_type.tex", sep  ="/"))
print(xtable(tbl_fund_avg_type, type = "latex"),
      file = paste(tmp, "tbl_fund_avg_type.tex", sep  ="/"))
ggsave(paste(tmp, "pie_type_prod.png", sep = "/"),
       plot = pie_type_prod,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

#### Co-funders

```{r}
#Create a table with number of projects funded by AFD, FFEM and KfW. Total fundings and average funds are also reported
tbl_fund_cofunder = 
  data.frame(cof = c("AFD", "FFEM", "KfW"),
             n = c(nrow(subset(data_stat_projet_nodupl, afd == TRUE)), 
                   nrow(subset(data_stat_projet_nodupl, ffem_bin == TRUE)),
                   nrow(subset(data_stat_projet_nodupl, kfw_bin == TRUE))),
             fund_tot = c(
               sum(subset(data_stat_projet_nodupl, afd == TRUE)$montant_total_projet, na.rm = TRUE),
               sum(subset(data_stat_projet_nodupl, ffem_bin == TRUE)$montant_total_projet, na.rm = TRUE),
               sum(subset(data_stat_projet_nodupl, kfw_bin == TRUE)$montant_total_projet, na.rm = TRUE))
                               
                               ) %>%
  mutate(n_tot = nrow(data_stat_projet_nodupl),
         freq = round(n/n_tot*100, 3),
         fund_avg = fund_tot/n) %>%
  select(c(cof, n, n_tot, freq, fund_tot, fund_avg))
names(tbl_fund_cofunder) = c("Cofinancier", "Nombre projets", "Nombre total projets", "Prop. projets (%)","Montant total projets (€)","Montant moyen projets (€)")

#print(xtable(tbl_fund_cofunder, type = "latex"), file = "DesStat/funding/tbl_fund_cofunder.tex")


```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_fund_cofunder, type = "latex"),
      file = paste(tmp, "tbl_fund_cofunder.tex", sep  ="/"))

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/funding", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```

### Governance

Here is plotted the distribution of PAs across governance type.

```{r}

#Table of the governance type distribution
##English version
tbl_gov_en = data_stat_nodupl %>%
  mutate(gov_type = case_when(gov_type == "" ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,3)) %>%
  select(-n_tot) %>%
  arrange(-freq)
names(tbl_gov_en) = c("Governance","Number of PAs","Share of PAs (%)")

# test = base_nodupl_lea %>%
#   mutate(gov_type = case_when(gov_type == "" ~ "Not referenced",
#                               TRUE ~ gov_type)) %>%
#   group_by(gov_type) %>%
#   summarize(n = n()) %>%
#   mutate(n_tot = sum(n),
#          freq = round(n/n_tot*100,3)) %>%
#   select(-n_tot) %>%
#   arrange(-freq)
# 
# test2 = base_nodupl_old %>%
#   mutate(gov_type = case_when(gov_type == "" ~ "Not referenced",
#                               TRUE ~ gov_type)) %>%
#   group_by(gov_type) %>%
#   summarize(n = n()) %>%
#   mutate(n_tot = sum(n),
#          freq = round(n/n_tot*100,3)) %>%
#   select(-n_tot) %>%
#   arrange(-freq)

##French Version
tbl_gov_fr = data_stat_nodupl %>%
  mutate(gov_type = case_when(gov_type == "" ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,3)) %>%
  select(-n_tot) %>%
  arrange(-freq)
names(tbl_gov_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")



#PAs with nureported or unreferences governance types are removed
##Tables
###English
tbl_gov_knwn_en = data_stat_nodupl %>%
  mutate(gov_type = case_when(gov_type == "" ~ "Not referenced",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Not Reported" & gov_type != "Not referenced") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,3)) %>%
  select(-n_tot) %>%
  arrange(-freq)
names(tbl_gov_knwn_en) = c("Governance","Number of PAs","Share of PAs (%)")

###French
tbl_gov_knwn_fr = data_stat_nodupl %>%
  mutate(gov_type = case_when(gov_type == "" ~ "Non référencée",
                              gov_type == "Collaborative governance" ~ "Gouvernance collaborative",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Federal or national ministry or agency" ~ "Ministère ou agence, fédérale ou nationale",
                              gov_type == "Government-delegated management" ~ "Gestion déléguée par le gouvernement",
                              gov_type == "Indigenous peoples" ~ "Peuples indigènes",
                              gov_type == "Joint governance" ~ "Gouvernance conjointe",
                              gov_type == "Local communities" ~ "Communautés locales",
                              gov_type == "Non-profit organisations" ~ "Organisations non-lucratives",
                              gov_type == "Not Reported" ~ "Non rapportée",
                              gov_type == "Sub-national ministry or agency" ~ "Ministère ou agence sous-nationale",
                              TRUE ~ gov_type)) %>%
  filter(gov_type != "Non référencée" & gov_type != "Non rapportée") %>%
  group_by(gov_type) %>%
  summarize(n = n()) %>%
  mutate(n_tot = sum(n),
         freq = round(n/n_tot*100,3)) %>%
  select(-n_tot) %>%
  arrange(-freq)
names(tbl_gov_knwn_fr) = c("Gouvernance","Nombre d'AP","Proportion (%)")
 

##Pie charts
###English
pie_gov_knwn_en = 
  ggplot(tbl_gov_knwn_en, 
       aes(x="", y= `Share of PAs (%)`, fill= Governance)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(`Share of PAs (%)`, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Governance type of PAs",
         subtitle = "PAs with governance not referenced/reported are omitted") %>%
  + scale_fill_brewer(palette="Paired") %>%
  + theme_void()



###French
pie_gov_knwn_fr =
  ggplot(tbl_gov_knwn_fr, 
       aes(x="", y= `Proportion (%)`, fill= Gouvernance)) %>%
  + geom_bar(width = 1, stat = "identity", color="white") %>%
  + geom_label(aes(x=1.3, 
                   label = paste0(format(`Proportion (%)`, digits = 2), "%")), 
               color = "black", 
               position = position_stack(vjust = 0.55), 
               size=2.5, show.legend = FALSE) %>%
  + coord_polar("y", start=0) %>%
  + labs(title = "Gouvernance",
         subtitle = "AP avec une gouvernance non rapportées/référencées omises") %>%
  + scale_fill_brewer(palette="Paired") %>%
  + theme_void()
pie_gov_knwn_fr

```

```{r}
#Saving figures

tmp = paste(tempdir(), "fig", sep = "/")

print(xtable(tbl_gov_en, type = "latex"),
      file = paste(tmp, "tbl_gov_en.tex", sep  ="/"))
print(xtable(tbl_gov_fr, type = "latex"),
      file = paste(tmp, "tbl_gov_fr.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_en, type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_en.tex", sep  ="/"))
print(xtable(tbl_gov_knwn_fr, type = "latex"),
      file = paste(tmp, "tbl_gov_knwn_fr.tex", sep  ="/"))

ggsave(paste(tmp, " pie_gov_knwn_en.png", sep = "/"),
       plot =  pie_gov_knwn_en,
       device = "png",
       height = 6, width = 9)
ggsave(paste(tmp, "pie_gov_knwn_fr.png", sep = "/"),
       plot = pie_gov_knwn_fr,
       device = "png",
       height = 6, width = 9)

#Export to S3 storage

##List of files to save in the temp folder
files <- list.files(tmp, full.names = TRUE)
##Add each file in the bucket (same foler for every file in the temp)
count = 0
for(f in files) 
{
  count = count+1
  cat("Uploading file", paste0(count, "/", length(files), " '", f, "'"), "\n")
  aws.s3::put_object(file = f, 
                     bucket = "projet-afd-eva-ap/DesStat/gouvernance", 
                     region = "", show_progress = TRUE)
  }

#Erase the files in the temp directory

do.call(file.remove, list(list.files(tmp, full.names = TRUE)))
```
