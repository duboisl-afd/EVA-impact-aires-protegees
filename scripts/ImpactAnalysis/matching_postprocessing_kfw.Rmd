---
title: "Template for post-processing"
author: "Kemeng Liu"
date: "25/05/2023"
output: html_document
---

## Introduction

This script is a template for implementing "Matching" strategy to select treatment and control objects, and visualizing analysis results.

## 0. Initial Settings

```{r, echo=FALSE}
library(dplyr)
library(tidyr)
library(tidyverse)
library(sf)
library(MatchIt)
library(fixest)
library(cobalt)
```

```{r}
# TO BE CUSTOMIZED...

# Define the path to a working directory
wdir = file.path("C:/EAGLE/kfw_internship/git_myBranch/MDG/mapme.pa-impact-evaluation/data/output")

wdir = file.path("/datadrive/datalake/mapme.pa-impact-evaluation/MDG/data/")

# Define the file name of the input matching frame
name_input = "matching_frame_10km.gpkg"

# Define Column Names of Covariates
colname.travelTime = "minutes_median_5k_110mio"
colname.clayContent = "clay_0.5cm_mean"
colname.elevation = "elevation_mean"
colname.tri = "tri_mean"
colname.fcIni = "treecover_2000"


# Prefix of columns for forest cover
colfc.prefix = "treecover"
# Separation between prefix and year
colfc.bind = "_"
# Prefix of columns for forest loss
colfl.prefix = "treeloss"

# Year of Funding Start
funding.start = 2007
```


## 1. Load Matching Frame

```{r}
# Load matching frame
mf = st_read(file.path(wdir, name_input)) %>%
  filter(group==0 | group==1) %>%
  drop_na() #%>%
  #st_drop_geometry()
```

```{r}
# Add column: average treeloss before funding starts, 
# In ths case, from 2001 to 2006
#mf$avgLoss_pre_fund = round(rowMeans(mf[grepl(colfl.prefix, names(mf))][1:6]), 2)
#colname.flAvg = "avgLoss_pre_fund"

# Columns treeloss 2001 ~ 2006, without geometry
df_fl0106 = mf[grepl(colfl.prefix, names(mf))][1:6] %>% st_drop_geometry()
# Add column: average treeloss before funding starts, 
mf$avgLoss_pre_fund = round(rowMeans(df_fl0106), 2)
colname.flAvg = "avgLoss_pre_fund"
rm(df_fl0106)

```


## 2a. Matching 

```{r}
# Make cut-off list ####
lst_cutoffs = c()

# Quantile in 8 parts
lst_cutoffs[[colname.travelTime]] = as.integer(quantile(mf[[colname.travelTime]], probs = seq(0, 1, 0.125), na.rm=TRUE))

#lst_cutoffs[[colname.clayContent]] = as.integer(quantile(mf[[colname.clayContent]], probs = seq(0, 1, 0.05), na.rm=TRUE))
lst_cutoffs[[colname.clayContent]] = as.integer(c(0,10,20,30, 32,34,36,38,40, 50,60,70,80,90,100))

lst_cutoffs[[colname.elevation]] = as.integer(quantile(mf[[colname.elevation]], probs = seq(0, 1, 0.125), na.rm=TRUE))

lst_cutoffs[[colname.tri]] = as.integer(quantile(mf[[colname.tri]], probs = seq(0, 1, 0.125), na.rm=TRUE))

lst_cutoffs[[colname.fcIni]] = as.integer(quantile(mf[[colname.fcIni]], probs = seq(0, 1, 0.025), na.rm=TRUE))

lst_cutoffs[[colname.flAvg]] = as.integer(quantile(mf[[colname.flAvg]], probs = seq(0, 1, 0.025), na.rm=TRUE))
```

```{r}
# Create Formula from Variables
# Ref: https://stackoverflow.com/questions/66357664/using-variable-as-function-argument-in-r
formula = eval(bquote(group ~ .(as.name(colname.travelTime)) + .(as.name(colname.clayContent)) +
                     .(as.name(colname.elevation)) + .(as.name(colname.tri)) +
                     .(as.name(colname.fcIni)) + .(as.name(colname.flAvg))
                     ))
#print(formula)

# CEM Match
out.cem = matchit(formula,
                  data = mf, 
                  method = "cem", 
                  cutpoints = lst_cutoffs)
```

```{r}
# Summary of matching output
summary(out.cem)
```


## 2b. Plot Covariate Balance

`cobalt` library naturally supports the visualization of `MatchIt` outputs,
Reference: https://cloud.r-project.org/web/packages/cobalt/vignettes/cobalt.html#bal.plot

```{r}
# Define Covariate Labels to show on plots
c_name = data.frame(old = c(colname.travelTime, colname.clayContent, colname.elevation,
                            colname.tri, colname.fcIni, colname.flAvg),
                    new = c("Accessibility", "Clay Content", "Elevation",
                            "TRI", "Forest Cover in 2000", "Avg. Annual Forest \n Loss 2001 ~ 2006"))
```

```{r}
# Refer to cobalt::love.plot()
# https://cloud.r-project.org/web/packages/cobalt/vignettes/cobalt.html#love.plot
p_covBal = love.plot(out.cem, 
                     binary = "std", 
                     abs = TRUE,
                     #thresholds = c(m = .1),
                     var.order = "unadjusted",
                     var.names = c_name,
                     sample.names = c("Discarded", "Selected"),
                     wrap = 25 # at how many characters does axis label break to new line
                    )
```

```{r}
# Finetune Layouts using ggplot
p_covBal + 
    geom_vline(aes(xintercept=0.1, linetype="Acceptable \n Balance \n (x=0.1)"), color=c("#2ecc71"), linewidth=0.35) +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text.x = element_text(angle = 20, hjust = 0.5, vjust = 0.5),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        panel.grid.major.x = element_line(color = 'grey', linewidth = 0.3, linetype = 1),
        panel.grid.minor.x = element_line(color = 'grey', linewidth = 0.3, linetype = 2)
    ) + guides(linetype = guide_legend(override.aes = list(color = "#2ecc71"))) # Add legend for geom_vline
```


## 2c. Density Plots of Matched Objects

```{r}
# Define Facet Labels
fnl = c(`Unadjusted Sample` = "Before Matching",
        `Adjusted Sample` = "After Matching")
```

```{r}
# Density plot for Travel Time
p_travel = bal.plot(out.cem, 
                    var.name = colname.travelTime,
                    #sample.names = c("Control", "Treatment"),
                    which = "both")

# Finetune Layouts using ggplot
p_travel +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for Accessibility",
         x = "Accessibility (min)",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```

```{r}
# Density plot for Clay Content
p_clay = bal.plot(out.cem, 
                    var.name = colname.clayContent,
                    which = "both")

p_clay +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for Clay Content",
         x = "Clay Content at 0~20cm soil depth (%)",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```

```{r}
# Density plot for Elevation
p_elevation = bal.plot(out.cem, 
                    var.name = colname.elevation,
                    which = "both")

p_elevation +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for Elevation",
         x = "Elevation (m)",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```

```{r}
# Density plot for TRI
p_tri = bal.plot(out.cem, 
                    var.name = colname.tri,
                    which = "both")

p_tri +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for Terrain Ruggedness Index (TRI)",
         x = "TRI",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```

```{r}
# Density plot for covariate "forest cover 2000"
p_fc = bal.plot(out.cem, 
                    var.name = colname.fcIni,
                    which = "both")

p_fc +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for Forest Cover in 2000",
         x = "Forest Cover (%)",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```

```{r}
# Density plot for covariate "avg. annual forest loss prior funding"
p_fl = bal.plot(out.cem, 
                    var.name = colname.flAvg,
                    which = "both")

p_fl +
    facet_wrap(.~which, labeller = as_labeller(fnl)) +
    #scale_fill_viridis(discrete = T) +
    scale_fill_manual(labels = c("Control", "Treatment"), values = c("#f5b041","#5dade2")) +
    labs(title = "Distributional Balance for avgerage Forest Loss 2001~2006",
         x = "Forest Loss (%)",
         fill = "Group") +
    theme_bw() +
    theme(
        plot.title = element_text(family="Arial Black", size=16, hjust=0.5),
        
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        legend.spacing.x = unit(0.5, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        
        axis.text=element_text(size=12),
        axis.title=element_text(size=14),
        axis.title.y = element_text(margin = margin(unit = 'cm', r = 0.5)),
        axis.title.x = element_text(margin = margin(unit = 'cm', t = 0.5)),
        
        strip.text.x = element_text(size = 12) # Facet Label
    )
```


## 3. Panelize (Un-)Matched Dataframe

```{r}
# Convert dataframe of matched objects to pivot wide form
matched.wide = match.data(object=out.cem, data=mf)

# Pivot Wide ==> Pivot Long
matched.long = matched.wide %>%
    select(c(group, wdpaid, assetid, weights, starts_with(colfc.prefix))) %>%
    pivot_longer(cols = c(starts_with(colfc.prefix)),
                 names_to = c("var", "year"),
                 names_sep = colfc.bind,
                 values_to = "fc_pct")

# Pivot wide Dataframe of un-matched objects
unmatched.wide = mf

# Pivot Wide ==> Pivot Long
unmatched.long = unmatched.wide %>%
    select(c(group, wdpaid, assetid, starts_with(colfc.prefix))) %>%
    pivot_longer(cols = c(starts_with(colfc.prefix)),
                 names_to = c("var", "year"),
                 names_sep = colfc.bind,
                 values_to = "fc_pct")
```


## 4. Trend Plot

```{r}
# Make dataframe for plotting Trend
df.matched.trend = matched.long %>%
    group_by(group, year) %>%
    summarise(avgFC = mean(fc_pct, na.rm=TRUE), n = n(), matched = TRUE)

df.unmatched.trend = unmatched.long %>%
    group_by(group, year) %>%
    summarise(avgFC = mean(fc_pct, na.rm=TRUE), n = n(), matched = FALSE)

df.trend = rbind(df.matched.trend, df.unmatched.trend)

head(df.trend)
```

```{r}
# Change Facet Labels
fct.labs <- c("Before Matching", "After Matching")
names(fct.labs) <- c(FALSE, TRUE)

# Trend Plot
ggplot(df.trend, aes(x = year, y = avgFC)) +
    geom_line(aes(group = group, color = as.character(group))) +
    geom_point(aes(color = as.character(group))) +
    geom_vline(aes(xintercept=as.character(funding.start), size="Funding Start"), linetype=2, linewidth=0.5, color="orange") +
    
    scale_x_discrete(breaks=seq(2000,2020,5), labels=paste(seq(2000,2020,5))) +
    scale_color_hue(labels = c("Control", "Treatment")) +

    facet_wrap(matched~., ncol = 2, #scales = 'free_x',
             labeller = labeller(matched = fct.labs)) +

    labs(x = "Year", y = "Average Tree Cover (%) per KM2", color = "Group") +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = -20, hjust = 0.5, vjust = 0.5),
        axis.text=element_text(size=11),
        axis.title=element_text(size=14),
        
        #legend.position = "bottom",
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        #legend.spacing.x = unit(1.0, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        legend.key.size = unit(2, 'line'),

        panel.grid.major.x = element_line(color = 'grey', linewidth = 0.3, linetype = 1),
        panel.grid.minor.x = element_line(color = 'grey', linewidth = 0.2, linetype = 2),
        panel.grid.major.y = element_line(color = 'grey', linewidth = 0.3, linetype = 1),
        panel.grid.minor.y = element_line(color = 'grey', linewidth = 0.2, linetype = 2),
        
        strip.text.x = element_text(size = 12) # Facet Label 
    ) + guides(size = guide_legend(override.aes = list(color = "orange"))) # Add legend for geom_vline
```

```{r}
# Trend Plot
ggplot(df.matched.trend, aes(x = year, y = avgFC)) +
    geom_line(aes(group = group, color = as.character(group))) +
    geom_point(aes(color = as.character(group))) +
    geom_vline(aes(xintercept=as.character(funding.start), size="Funding Start"), linetype=2, linewidth=0.5, color="orange") +
    
    #scale_y_continuous(breaks=seq(0,100,10), labels=paste(seq(0,100,10)),
    #                   expand=c(0,0), limits=c(0,100)) +
    scale_x_discrete(breaks=seq(2000,2020,5), labels=paste(seq(2000,2020,5))) +
    scale_color_hue(labels = c("Control", "Treatment")) +

    labs(x = "Year", y = "Average Tree Cover (%) per KM2", color = "Group") +
    theme_bw() +
    theme(
        axis.text.x = element_text(angle = -20, hjust = 0.5, vjust = 0.5),
        axis.text=element_text(size=11),
        axis.title=element_text(size=14),
        
        #legend.position = "bottom",
        legend.title = element_blank(),
        legend.text=element_text(size=14),
        #legend.spacing.x = unit(1.0, 'cm'),
        legend.spacing.y = unit(0.75, 'cm'),
        legend.key.size = unit(2, 'line'),

        panel.grid.major.x = element_line(color = 'grey', linewidth = 0.3, linetype = 1),
        panel.grid.minor.x = element_line(color = 'grey', linewidth = 0.2, linetype = 2),
        panel.grid.major.y = element_line(color = 'grey', linewidth = 0.3, linetype = 1),
        panel.grid.minor.y = element_line(color = 'grey', linewidth = 0.2, linetype = 2),
        
    ) + guides(size = guide_legend(override.aes = list(color = "orange"))) # Add legend for geom_vline
```

## 5. Regression

```{r}
feols(fc_pct ~ group | year,
      data = matched.long, 
      weights = matched.long$weights)
```
