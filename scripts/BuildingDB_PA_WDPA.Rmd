---
title: "buildingDB_PA_WDPA"
author: "Antoine Vuillot"
date: "08/06/2023"
output: html_document
---

# Building the database on PAs

## Importing relevant packages

```{r setup, include = FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

```{r message=TRUE, warning=TRUE}
library(tidyverse)
library(stargazer)
library(dplyr)
library(data.table)
library(readxl)
library(splitstackshape) 
library(janitor)
library(stringi)
library(sf)
```

## Datasets for descriptive statistics

The raw dataset has been built by Léa Poulin. It comes from the merging of SIOP extract, and PAs dataset from ARB covering 2000-2017 period. Majority of PAs had no corresponding WDPA ID, so it was found and reported manually by Léa Poulin and Ingrid Dallmann on WDPA website.

Different datasets are built. First a dataset (data_PA_tidy) enriched of information on co-investors and ISO code for the country hosting the PA :

-   Instead of having 5 co-investor variables, one dummy variable is created for each co-investor. It will be easier to subset PAs regarding it investors

-   ISOA3 code is added for each row, to facilitate future merging with other datasets of interest

Form this dataset are extracted : (1) a dataset data_siop_AP without WDPA variables, to allow future working on PAs; (2) a dataset data_stat to perform most descriptive statistics. Some statistics need size of PAs at country/region/world level (evolution of area covered by PAs at world level for instance). As many areas overlap (according to WDPA documentation), a sum of reported area would overestimate aggregated area. The computation method of WDPA is followed (<https://www.protectedplanet.net/en/resources/calculating-protected-area-coverage>).

### data_PA_tidy

```{r}
#import a dataset with country anmes and corresponding ISO3 code
data_iso = fread("data_raw/liste-197-etats-2020.csv") %>%
  rename("iso3" = "CODE",
         "nom_alpha" = "NOM_ALPHA") %>%
  dplyr::select(c("nom_alpha", "iso3")) %>%
  #get rid of accentuations and change name by hand to correspond with BDD_joint
  mutate(nom_alpha2 = iconv(nom_alpha, to = "ASCII//TRANSLIT"),
         nom_alpha2 = case_when(
           nom_alpha2 == "Cook (Iles)" ~ "Cook",
           nom_alpha2 == "Cote d'Ivoire" ~ "Cote D Ivoire",
           nom_alpha2 == "Sao Tome-et-Principe" ~ "Sao Tome",
           nom_alpha2 == "Palaos" ~ "Palau",
           nom_alpha2 == "Guinee-Bissao" ~ "Guinee-Bissau",
           !(nom_alpha %in% c("Cook (Iles)", "Cote d'Ivoire", "Sao Tome-et-Principe",
                              "Palaos", "Guinée-Bissao")) ~ nom_alpha2
         ))

#Import the initial BDD_joint
data_PA_raw = read_excel("data_raw/BDD_joint.xlsx") %>%
  as.data.frame() %>%
  mutate(across(.cols = names(.), 
                .fns = ~stri_enc_toutf8(.x)))
  

#Create relevant variables
data_PA_tidy = data_PA_raw %>%
  #Get rid of the iso code in the initial dataset, to avoid confusion when merging with data_iso
  dplyr::select(-iso3) %>%
  #Modify class of some variables
  mutate(wdpaid = as.numeric(wdpaid)) %>%
  #Create dummy variables for main investors
  #AFD is always funder, so no need of a dummy
  mutate(
    # afd_bin = case_when((cofinancier_1 == "AFD" | cofinancier_2 == "AFD" | cofinancier_3 == "AFD" |
    #                       cofinancier_4 == "AFD" | cofinancier_5 == "AFD" | cofinancier_6 == "AFD") ~ TRUE,
    #                       (is.na(cofinancier_1) & is.na(cofinancier_2) & is.na(cofinancier_3) & is.na(cofinancier_4) 
    #                       & is.na(cofinancier_5) & is.na(cofinancier_6)) ~ TRUE,
    #                       TRUE ~ FALSE),
         kfw_bin = ifelse(cofinancier_1 == "KFW" | cofinancier_2 == "KFW" | cofinancier_3 == "KFW" |
                          cofinancier_4 == "KFW" | cofinancier_5 == "KFW" | cofinancier_6 == "KFW",
                          yes = TRUE, 
                          no = FALSE),
         kfw_bin = ifelse(is.na(kfw_bin), yes = FALSE, no = kfw_bin),
         ffem_bin = ifelse(cofinancier_1 == "FFEM" | cofinancier_2 == "FFEM" | cofinancier_3 == "FFEM" |
                          cofinancier_4 == "FFEM" | cofinancier_5 == "FFEM" | cofinancier_6 == "FFEM",
                          yes = TRUE, 
                          no = FALSE),
         ffem_bin = ifelse(is.na(ffem_bin), yes = FALSE, no = ffem_bin),
         .after = "cofinancier_6") %>%
  #Create a dummy for other co-investors
  # mutate(cofin_unkwn = ifelse(is.na(cofinancier_1) & is.na(cofinancier_1) & is.na(cofinancier_1) & is.na(cofinancier_1) & is.na(cofinancier_1) & is.na(cofinancier_1),
  #                         yes = TRUE, 
  #                         no = FALSE),
  #        cofin_unkwn = ifelse(is.na(cofin_unkwn), yes = FALSE, no = cofin_unkwn),
  #        .after = "ffem_bin") %>%
  #Create a dummy for investors not AFD, KFW or FFEM
  # mutate(cofin_other = afd_bin == FALSE & 
  #       kfw_bin == FALSE & ffem_bin == FALSE & cofin_unkwn == FALSE,
  #       .after = "cofin_unkwn") %>%
  #Add the ISO3 code corresponding to the country hosting the PA. Facilitate future mergings
  left_join(data_iso, by = c("pays" = "nom_alpha2")) %>%
  #Some entries in "pays" are French department, DROM-COM, "Ocean Indien" or "Multi-Pays".
  #French related : assigned to France. Ocen Indien let NA value, Muti-pays set to ZZ as in the SIOP 
  mutate(iso3 = case_when(
    pays %in% c("Mayotte", "P-N N.Caléd", "P-S N.Caléd", 
                "Polynesie Francaise", "Nlle Caledonie") ~ "FRA",
    pays == "Multi-Pays" ~ "ZZ",
    !(pays %in% c("Mayotte", "P-N N.Caléd", "P-S N.Caléd", 
                "Polynesie Francaise", "Nlle Caledonie", "Multi-Pays")) ~ iso3
  )) %>%
  #Add the description of IUCN from its category
    mutate(iucn_des = case_when(
  !is.na(wdpaid) & iucn_cat == "Ia" ~ "Réserve naturelle intégrale",
  !is.na(wdpaid) & iucn_cat == "Ib" ~ "Zone de nature sauvage",
  !is.na(wdpaid) & iucn_cat == "II" ~ "Parc national",
  !is.na(wdpaid) & iucn_cat == "III" ~ "Monument naturel",
  !is.na(wdpaid) & iucn_cat == "IV" ~ "Gest. des habitats/espèces",
  !is.na(wdpaid) & iucn_cat == "V" ~ "Paysage protégé",
  !is.na(wdpaid) & iucn_cat == "VI" ~ "Gest. de ress. protégées",
  !is.na(wdpaid) & iucn_cat == "Not Applicable" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Reported" ~ "Non catégorisée",
  !is.na(wdpaid) & iucn_cat == "Not Assigned" ~ "Non catégorisée",
  TRUE ~ "Non référencée"), .after = iucn_cat) %>%
    mutate(across(.cols = names(.), 
                .fns = ~stri_enc_toutf8(.x)))

#fwrite(data_PA_tidy, "data_tidy/BDD_joint_tidy_nopub.csv")

```

### data_siop_AP

```{r}
#Select info corresponding to SIOP extract and AP 
list_var_siop_AP = c( "id_projet", "nom_du_projet", "nom_de_projet_pour_les_instances",
                      "id_concours", "libelle_du_concours", "description_du_projet",
                      "wdpaid", "wdpaid_2", "wdpaid_3",
                      "montant_prevu_concours_euro_octroi", "mt_global_projet_prevu_devise", 
                      "engagements_nets_euro_octroi", "montant_total_projet", "produit", 
                      "libelle_produit", "division_technique", "libelle_division_technique", "agence", 
                      "libelle_agence", "annee_octroi", "date_octroi",
                      "date_de_1er_versement_projet", "dernier_versement_en_date_projet", 
                      "date_signature_convention_cf", "duree_du_concours_annee",
                      "duree_du_concours_annee_et_mois", "id_pays_de_realisation", "pays", "iso3",
                      "direction_regionale", "autres_pays_de_realisation", 
                      "etat_du_projet", "libelle_etat_du_projet", "beneficiaire_primaire",
                      "responsable_equipe_projet", "directeur_trice_dagence",
                      "date_de_remise_du_rapport_final", "cofinancier_1", "cofinancier_2", 
                      "cofinancier_3","cofinancier_4", "cofinancier_5", "cofinancier_6",
                      "kfw_bin", "ffem_bin",
                      "maitrise_ouvrage", "superf_interne", "nb_ap_nombre_potentiel",
                      "detail", "projet", "commentaires")

#Definining dataset for future analysis : siop and AP but not WDPA 
data_siop_AP = data_PA_tidy %>%
  dplyr::select(all_of(list_var_siop_AP), iso3)
#write_csv(data_siop_AP, "data_tidy/BDD_AP_SIOP_joint.xlsx")

```

### data_stat

To perform descriptive statistics we want to keep one row per PA, characterized by WDPA ID or a name (if no ID reported). Some PAs can have several lines if they receive funds at different time or by different investors.

```{r}

#Listing relevant variables for descriptive statistics
list_var_PA = c("id_projet", "nom_du_projet", "nom_ap", "id_concours", 
                "wdpaid", "wdpaid_2", "wdpaid_3", "wdpa_pid",
                "pays", "iso3", "direction_regionale", "montant_prevu_concours_euro_octroi",
                "mt_global_projet_prevu_devise", "engagements_nets_euro_octroi",
                "montant_total_projet", "libelle_produit", "annee_octroi",
                "cofinancier_1", "cofinancier_2", "cofinancier_3", 
                "cofinancier_4", "cofinancier_5", "cofinancier_6",
                 "kfw_bin", "ffem_bin", "nb_ap_nombre_potentiel", "detail",
                "iucn_cat", "iucn_des", "marine", "superficie",
                "status", "status_yr", "gov_type","own_type", "mang_auth")

#Defining dataset for descriptive statistics
data_stat = data_PA_tidy %>%
  select(all_of(list_var_PA), iso3)

#fwrite(data_stat, "data_tidy/BDD_DesStat.csv")

#Then to keep only one row per PA, we need to consider separately PAs having WDPA ID and PAs which do not.

data_stat_wdpa = data_stat %>%
  subset(is.na(wdpaid) == FALSE) %>%
  distinct(wdpaid, .keep_all= TRUE)

data_stat_na = data_stat %>%
  subset(is.na(wdpaid) == TRUE) %>%
  distinct(nom_ap, .keep_all= TRUE)

data_stat_nodupl = rbind(data_stat_wdpa, data_stat_na) %>%
  #Remove AP with no wdpaid and no name
  subset(is.na(wdpaid) == FALSE | is.na(nom_ap) == FALSE) 

#fwrite(data_stat_nodupl, "data_tidy/BDD_DesStat_nodupl.csv")
```

### pa_shp

```{r}
pa_shp = read_sf("data_raw/WDPA_SHP/BDD_SHP_nodupl.shp") %>%
  clean_names() %>%
  select()
```

## Public datasets

### Descriptive statistics

Some variables are removed so that the dataset can be made public or uploaded to external sources (SSPCloud for instance).

```{r}
#Listing variables public or confidential

#Public variables in the PAs dataset
list_var_PA_open = c("id_projet", "nom_du_projet", "nom_ap", "id_concours", 
                "wdpaid", "wdpaid_2", "wdpaid_3", "wdpa_pid",
                "pays", "iso3", "direction_regionale", "annee_octroi",
                "cofinancier_1", "cofinancier_2", "cofinancier_3", 
                "cofinancier_4", "cofinancier_5", "cofinancier_6",
                "kfw_bin", "ffem_bin", "nb_ap_nombre_potentiel", "detail",
                "iucn_cat", "iucn_des", "marine", "superficie",
                "status", "status_yr", "gov_type","own_type", "mang_auth")
#Confidential variables in the PAs dataset
list_var_PA_conf = list_var_joint_conf = 
  c("montant_prevu_concours_euro_octroi", "mt_global_projet_prevu_devise",
    "engagements_nets_euro_octroi" , "montant_total_projet",
    "produit", "libelle_produit",
    "date_de_1er_versement_projet", "dernier_versement_en_date_projet",
    "date_signature_convention_cf", "duree_du_concours_annee",
    "duree_du_concours_annee_et_mois", "beneficiaire_primaire",
    "responsable_equipe_projet", "directeur_trice_dagence", "maitrise_ouvrage"
    )
#Confidential variables among shapefiles
list_var_shp_conf = c("mntnt", "mtglb", "e", "mnt", "prodt", "lbllp",
                      "rspns", "dr", "detal", "projt", "cmmnt")
```

```{r}

data_PA_tidy_pub = data_PA_tidy %>%
  dplyr::select(-all_of(list_var_joint_conf))
#fwrite(data_PA_tidy_pub, "data_tidy/BDD_joint_tidy_pub.csv")

data_stat_pub = data_stat %>%
  dplyr::select(all_of(list_var_PA_open))
#fwrite(data_stat_pub, "data_tidy/BDD_DesStat_pub.csv")

data_stat_nodupl_pub = data_stat_nodupl %>%
  dplyr::select(all_of(list_var_PA_open))
#fwrite(data_stat_nodupl_pub, "data_tidy/BDD_DesStat_nodupl_pub.csv")

# pa_shp_open = pa_shp %>%
#   dplyr::select(-all_of(list_var_shp_conf))
#  st_write(pa_shp_open,
#          dsn = "data_tidy/BDD_SHP_nodupl_pub.gpkg",
#          delete_dsn = TRUE)
```
